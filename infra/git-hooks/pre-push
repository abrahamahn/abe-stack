#!/usr/bin/env sh

# Git passes ref updates via stdin:
#   <local_ref> <local_sha> <remote_ref> <remote_sha>
# If there are no effective updates (already up-to-date), skip heavy checks.
has_updates=0
while read -r local_ref local_sha remote_ref remote_sha; do
  # Skip deletions.
  if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    continue
  fi
  # New remote ref (all-zero remote SHA) or changed SHA requires checks.
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ] || [ "$local_sha" != "$remote_sha" ]; then
    has_updates=1
    break
  fi
done

if [ "$has_updates" -eq 0 ]; then
  echo "ℹ️ pre-push: refs already up-to-date, skipping checks."
  exit 0
fi

pnpm hooks:cache:maintain || exit 1
pnpm pre-push
