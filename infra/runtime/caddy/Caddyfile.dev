# config/caddy/Caddyfile.dev
# Development Caddy Configuration for BSLT
#
# HTTP-only (no TLS) for local development.
# Use this when testing the full reverse proxy setup locally.
#
# Usage:
#   caddy run --config config/caddy/Caddyfile.dev
#   OR
#   docker run -p 80:80 -v $PWD/config/caddy/Caddyfile.dev:/etc/caddy/Caddyfile caddy

# Disable HTTPS redirect for development
{
	# Use HTTP only (no automatic HTTPS)
	auto_https off

	# Verbose logging for debugging
	log {
		output stdout
		level DEBUG
	}
}

# Development server on port 80
:80 {
	# Enable compression
	encode gzip

	# Health check endpoint
	handle /health* {
		reverse_proxy api:8080
	}

	# WebSocket endpoint
	@websocket {
		path /ws
		header Connection *Upgrade*
		header Upgrade websocket
	}
	handle @websocket {
		reverse_proxy api:8080 {
			header_up Connection {http.request.header.Connection}
			header_up Upgrade {http.request.header.Upgrade}
			header_up Sec-WebSocket-Key {http.request.header.Sec-WebSocket-Key}
			header_up Sec-WebSocket-Version {http.request.header.Sec-WebSocket-Version}
			header_up Sec-WebSocket-Extensions {http.request.header.Sec-WebSocket-Extensions}
			header_up Sec-WebSocket-Protocol {http.request.header.Sec-WebSocket-Protocol}

			transport http {
				read_timeout 0
				write_timeout 0
			}
		}
	}

	# API routes
	handle /api/* {
		reverse_proxy api:8080 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Static file uploads
	handle /uploads/* {
		reverse_proxy api:8080
	}

	# Frontend
	handle {
		reverse_proxy web:80
	}

	log {
		output stdout
		format console
	}
}
