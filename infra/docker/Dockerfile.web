# syntax=docker/dockerfile:1
ARG NODE_VERSION=20

# =============================================================================
# Base Stage - Common dependencies and configuration
# =============================================================================
FROM node:${NODE_VERSION}-alpine AS base

# Enable pnpm via corepack
ENV PNPM_HOME=/pnpm
ENV PNPM_STORE_PATH=/pnpm/store
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable
RUN mkdir -p /pnpm/store

WORKDIR /app

# =============================================================================
# Dependencies Stage - Fetch and cache dependencies
# =============================================================================
FROM base AS deps

# Copy only package files for better layer caching
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY src/apps/web/package.json src/apps/web/
COPY src/client/api/package.json src/client/api/
COPY src/client/engine/package.json src/client/engine/
COPY src/client/ui/package.json src/client/ui/
COPY src/client/react/package.json src/client/react/
COPY src/shared/package.json src/shared/

# Fetch all dependencies (including dev deps for build)
RUN --mount=type=cache,id=pnpm,target=/pnpm/store \
    pnpm fetch

# =============================================================================
# Build Stage - Compile TypeScript and build web app
# =============================================================================
FROM base AS build

WORKDIR /app

ENV CI=true

# Build-time configuration
# Empty VITE_API_URL means relative URLs (for reverse proxy setup)
ARG VITE_API_URL=""
ENV VITE_API_URL=$VITE_API_URL

# Copy cached pnpm store from deps stage
COPY --from=deps /pnpm/store /pnpm/store

# Copy all source files
COPY . .

# Install dependencies and build
RUN --mount=type=cache,id=pnpm,target=/pnpm/store \
    pnpm install --frozen-lockfile && \
    pnpm --filter @abe-stack/shared build && \
    pnpm --filter @abe-stack/ui build && \
    pnpm --filter @abe-stack/api build && \
    pnpm --filter @abe-stack/web build

# =============================================================================
# Production Stage - Minimal nginx image serving static files
# =============================================================================
FROM nginx:alpine AS runner

# Install security updates
RUN apk update && \
    apk upgrade && \
    rm -rf /var/cache/apk/*

# Copy custom nginx configuration
# Copy custom nginx configuration
COPY infra/docker/nginx.conf /etc/nginx/nginx.conf

# Copy built static files from build stage
COPY --from=build /app/src/apps/web/dist /usr/share/nginx/html

# Expose port 80
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost/health || exit 1

# Run nginx in foreground
CMD ["nginx", "-g", "daemon off;"]
