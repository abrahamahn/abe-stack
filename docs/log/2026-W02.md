# Week 2: January 6-12, 2026

> **Summary**: Established server architecture patterns. Adopted ServerEnvironment context object pattern (inspired by chet-stack) for explicit dependencies and easier testing. Separated infrastructure (`infra/`) from business logic (`modules/`). Added custom error types, validation patterns, and comprehensive security hardening across two phases: Phase 1 replaced bcrypt with Argon2id and added zxcvbn password strength validation; Phase 2 added database transactions, security event logging, and IP proxy validation. Build system optimized with ESLint/Prettier caching and Turbo pipeline input declarations.

---

## Table of Contents

- [2026-01-12: Architecture Refinement & Build Optimization](#2026-01-12)
- [2026-01-10: Phase 2 Security Hardening & Documentation](#2026-01-10)
- [2026-01-09: Phase 1 Security Hardening](#2026-01-09)

---

## 2026-01-12

### Hybrid Infra/Modules Architecture

Adopted a hybrid architecture separating infrastructure from business modules:

**Infrastructure Layer (`infra/`):**

- `ctx.ts` - ServerEnvironment type definition
- `factory.ts` - createEnvironment, createMockEnvironment factories
- `email/` - ConsoleEmailService, SmtpEmailService implementations
- `security/` - Login lockout, security events

**Modules Layer (`modules/`):**

- `auth/` - Authentication middleware, handlers, utilities (JWT, password, refresh-token)

**Pattern Change:**

- Routes now import handlers from `modules/auth`
- Backwards-compatible re-exports maintained in `lib/` and `services/`

### ServerEnvironment Context Object Pattern

Following the pattern from chet-stack, implemented a single `ServerEnvironment` object that acts as an entry point for all server dependencies. This is the "Context Object" pattern, standard in GraphQL (Apollo) and Go backend services.

**New Files:**

- `apps/server/src/infra/ServerEnvironment.ts` - Type definition
- `apps/server/src/infra/index.ts` - Barrel exports

**Pattern Change:**

- Before: Services decorated on Fastify (`app.db`, `app.storage`)
- After: Single `ServerEnvironment` passed to handlers (`env.db`, `env.log`)

**Benefits:**

- Explicit dependencies (handler signature shows what it needs)
- Easy to test (pass mock env object)
- Framework agnostic (handlers don't depend on Fastify)
- Single source of truth for all services

**ServerEnvironment Type:**

```typescript
type ServerEnvironment = {
  config: ServerEnv;
  db: DbClient;
  storage: StorageProvider;
  email: EmailService;
  log: FastifyBaseLogger;
};
```

**Updated Files:**

- `apps/server/main/server.ts` - Creates environment, passes to routes
- `apps/server/src/modules/index.ts` - All handlers now receive `env: ServerEnvironment`
- `apps/server/src/infra/email.ts` - Exported `ConsoleEmailService` and `SmtpEmailService` classes
- `apps/server/src/types/fastify.d.ts` - Removed storage decoration (kept db for health check)
- Test files updated with mock ServerEnvironment

### Custom HTTP Error Types

Added type-safe custom error classes with HTTP status codes to `shared/core`:

**New File:** `shared/core/src/errors.ts`

**Error Classes:**
| Class | Status | Purpose |
|-------|--------|---------|
| `HttpError` | - | Abstract base class |
| `ValidationError` | 400 | Invalid input |
| `UnauthorizedError` | 401 | Missing/invalid auth |
| `PermissionError` | 403 | Lacks permission |
| `NotFoundError` | 404 | Resource not found |
| `ConflictError` | 409 | Transaction conflict |
| `UnprocessableError` | 422 | Semantic validation error |
| `BrokenError` | 424 | Server-side invariant broken |
| `RateLimitError` | 429 | Rate limited |

**Utilities:**

- `isHttpError()` - Type guard
- `getSafeErrorMessage()` - Safe message for API responses
- `getErrorStatusCode()` - Get status code from error

### Build System Optimization

Optimized the build pipeline and developer tooling for faster iteration:

**ESLint Caching:**

- Added `--cache --cache-location .cache/eslint/.cache` to `lint` and `lint:fix` scripts
- New `lint:changed` script for linting only specific files during development
- Avoids re-linting unchanged files across runs

**Prettier Caching:**

- Added `--cache --cache-location .cache/prettier/.cache` to `format` and `format:check` scripts
- Caches format results under `.cache/` (cleaned with `pnpm clean`)

**Turbo Pipeline Improvements:**

- Added explicit `inputs` declarations for `lint`, `format:check`, `type-check`, and `test` tasks
- Ensures Turbo only re-runs tasks when relevant files change (e.g., lint only re-runs on `.ts`/`.tsx`/`.js`/`.jsx` changes)
- Added `config/.prettierrc` and `eslint.config.mjs` to `globalDependencies` for proper cache invalidation
- New `validate` task that depends on `lint`, `type-check`, and `test` in a single pipeline step

**Simplified Build Command:**

- Before: `pnpm format && turbo run build --filter='./packages/*' && pnpm lint && turbo run test && turbo run type-check && pnpm theme:build && turbo run build`
- After: `pnpm theme:build && turbo run build lint type-check test`
- Turbo handles parallelism and dependency ordering automatically

**Pre-commit Hook Simplification:**

- Removed `pnpm test` from pre-commit (was slow, now runs as part of `pnpm build` on pre-push)
- Pre-commit now only runs `lint-staged` for fast feedback
- Pre-push still runs full `pnpm build` as the gate

### Configuration Fix

- Renamed `.npmrc` to `.pnpmrc` to fix npm warning about unknown `store-dir` config

---

## 2026-01-10

### Phase 2 Security Hardening

**Database Transaction Support:**

- Created transaction wrapper utilities with `withTransaction()` helper
- Applied atomic transactions to registration, login, and token rotation
- Prevents orphaned database records during auth operations

**Token Reuse Security Event Logging:**

- Added `security_events` table with comprehensive indexing
- Created security event logging infrastructure with severity levels
- Logs token reuse attempts, family revocations, account lockouts, admin unlocks
- Added metrics and user activity query functions

**IP Extraction Proxy Validation:**

- Enhanced IP extraction with proxy validation
- Only trusts x-forwarded-for when `TRUST_PROXY=true`
- Validates immediate proxy against `TRUSTED_PROXIES` list
- Limits proxy chain depth to prevent spoofing
- Supports CIDR notation for trusted proxy ranges

**Admin Unlock Endpoint:**

- Added `POST /api/admin/auth/unlock` endpoint
- Requires admin role with JWT authentication
- Logs unlock events with admin user ID for audit trail

**Error Message Audit:**

- Centralized all error messages in constants
- Removed inline error strings from route handlers
- Prepared for future internationalization (i18n)

### Documentation Reorganization

- Reorganized documentation into hierarchical structure under `apps/docs/`
- Created consolidated README.md, CHANGELOG.md, and ROADMAP.md
- Organized architecture docs under `apps/docs/architecture/`
- Moved realtime docs to `apps/docs/architecture/realtime/`
- Security docs now under `apps/docs/todo/security/`
- Development guides under `apps/docs/dev/`

### Technical Fixes

- Fixed TypeScript strict mode errors in test files
- Added proper null checks to array access in tests
- Installed `@types/nodemailer` for email service

---

## 2026-01-09

### Phase 1 Security Hardening

Implemented foundational authentication security enhancements following January 2026 OWASP best practices. This was a WIP commit establishing the security primitives that Phase 2 built upon.

**Argon2id Password Hashing:**

Replaced bcrypt with Argon2id, the OWASP-recommended password hashing algorithm:

- New file: `apps/server/src/lib/password.ts` (rewritten)
- `hashPassword()` uses Argon2id with OWASP-recommended parameters
- `verifyPassword()` with constant-time comparison to prevent timing attacks
- `needsRehash()` detects when stored hashes use outdated parameters
- Argon2id parameters: 19 MiB memory, 2 iterations, 1 thread (OWASP minimum)

```typescript
// Argon2id configuration (OWASP recommended)
argon2: {
  type: 2,           // argon2id
  memoryCost: 19456, // 19 MiB
  timeCost: 2,       // 2 iterations
  parallelism: 1,    // 1 thread
}
```

**zxcvbn Password Strength Validation:**

Added realistic password strength checking using Dropbox's zxcvbn library:

- New file: `packages/shared/src/validation/password.ts`
- `validatePassword()` - async full-strength analysis with zxcvbn (dynamic import to avoid client bundle bloat)
- `validatePasswordBasic()` - synchronous basic checks (length, repeated chars, sequential digits) for quick client-side validation
- `getStrengthLabel()` and `getStrengthColor()` helpers for UI display
- Configurable via `PasswordConfig`: min/max length, minimum zxcvbn score
- Default policy follows NIST guidelines: 8-64 chars, minimum score of 3 ("Strong")
- Accepts `userInputs` parameter to penalize passwords containing the user's email or name

**Auth Database Schemas:**

New Drizzle schema tables in `packages/db/src/schema/auth.ts`:

| Table                       | Purpose                                    |
| --------------------------- | ------------------------------------------ |
| `refresh_token_families`    | Token family tracking for reuse detection  |
| `login_attempts`            | Rate limiting and account lockout tracking |
| `password_reset_tokens`     | Secure password reset with hashed tokens   |
| `email_verification_tokens` | Email verification with hashed tokens      |

All tables include proper foreign keys to `users`, cascade deletes, and performance indexes on frequently-queried columns (email, IP, timestamps).

**Centralized Auth Configuration:**

New file: `apps/server/src/config/auth.ts` providing a single `authConfig` object covering:

- Enabled auth strategies (local, magic link, WebAuthn, OAuth providers)
- Argon2id hashing parameters
- Token expiry settings (access: 15m, refresh: 7d, grace period: 30s)
- Per-endpoint rate limits (stricter in production)
- Account lockout policy (10 attempts, 30-minute lockout, progressive delay)
- Password policy (NIST: 8-64 chars, zxcvbn score >= 3)
- BFF mode toggle (tokens never in browser)
- Cookie configuration (httpOnly, secure in prod, SameSite strict in prod)
- OAuth provider configs loaded from environment variables

**Email Service Abstraction:**

New file: `apps/server/src/services/email.ts` (WIP - had lint issues resolved in later commits):

- `EmailService` interface with `send(options: EmailOptions): Promise<EmailResult>`
- `ConsoleEmailService` for development (logs formatted email content to console)
- `SmtpEmailService` for production (nodemailer-based, configurable via env vars)
- Added `@types/nodemailer` dependency

### UI Library Catalog Improvements

The Phase 1 commit also included significant improvements to the demo/catalog system:

**Lazy Loading Infrastructure:**

- New file: `apps/web/src/features/demo/catalog/lazyRegistry.ts` - lazy-loading registry for catalog entries
- New file: `apps/web/src/features/demo/hooks/useLazyCatalog.ts` - React hook for lazy catalog loading
- New file: `apps/web/src/features/demo/utils/lazyDocs.ts` - lazy documentation loading utilities

**Catalog Refactoring:**

- `componentCatalog.tsx` - expanded with additional component demos (625 lines, up from ~200)
- `elementCatalog.tsx` - streamlined and reorganized (727 lines)
- `layoutCatalog.tsx` - expanded with shell layout demos (640 lines)
- `DemoPage.tsx` - updated to support lazy loading

**Test Coverage:**

- New test: `lazyRegistry.test.ts` (212 lines)
- New test: `DemoDocContent.test.tsx` (143 lines)
- Expanded existing catalog tests: `componentCatalog.test.tsx`, `elementCatalog.test.tsx`, `layoutCatalog.test.tsx`
- UI component reorganization: moved Card, Image to `components/`, Toaster to `elements/`, ProtectedRoute/ResizablePanel to `layouts/`
- New layout tests: `LeftSidebarLayout.test.tsx` (215 lines), `RightSidebarLayout.test.tsx` (221 lines)
