# Week 7: February 9-15, 2026

> **Summary**: CI/CD hardening for GitHub Actions and DigitalOcean deployment flow. Stabilized pre-commit/pre-push checks, fixed monorepo test/lint breakages, and cleaned workflow reliability issues.

---

## Wednesday, February 11, 2026

### Dark Theme: Monochrome Black/White Centralization

- Centralized dark theme to pure black backgrounds (#000000) with solid white borders (#ffffff) and white text (#ffffff)
- Changed `--ui-color-primary` to white in dark mode so links, text buttons, badges, and focus rings are all white
- Added `[data-theme='dark']` CSS overrides for `.btn-primary` to render as black bg + white border/text (since primary is now white)
- Added dark mode overrides for disabled buttons (#1a1a1a bg, #666 text) to avoid white-on-white
- Added dark mode text button hover/active states (dims to muted gray)
- Updated alert/badge dark colors: black bg with semantic status borders preserved (danger=red, success=green, warning=yellow)
- Regenerated `theme.css` via `sync-css-theme`

### Side Peek Improvements

- Added solid left border to `.side-peek` using `var(--ui-color-text)` — renders black in light mode, white in dark mode
- Added slide-out close animation: panel now transitions back to `translateX(100%)` over 200ms before unmounting (previously removed from DOM immediately)
- Removed `SidePeek.Close` button from `AppSidePeekLayout` and `HomeSidePeek` — users close via overlay click or Escape key
- Changed `SidePeek.Expand` to toggle fullscreen mode in-place instead of navigating to a separate page — added local `isFullscreen` state to both app layouts
- Updated `SidePeek.Expand` component: `onExpand` callback no longer auto-closes the panel (enables in-place fullscreen toggle without closing)
- Updated 5 tests in `SidePeek.test.tsx` to account for 200ms close animation delay (using `act(() => vi.advanceTimersByTime(200))`)
- Rewrote `AppSidePeekLayout.test.tsx` for new structure (fullscreen toggle, no close button)

### App Layout Panel Toggle & Resize Bugfixes

- **Bug 1+2**: Replaced fill panels (content group, center) in `AppMainLayout` with plain `flex-1` divs instead of `ResizablePanel`. Eliminates rigid `flexBasis` overflow and phantom trailing separators.
- **Bug 3**: Memoized `handlePaneResize` and `resetLayout` in `useUILibraryPanes` with `useCallback`. Memoized inline `onResize`/`onClose` callbacks in `AppMainLayout`.
- **Bug 4**: Removed global ArrowUp/Down/Left/Right keyboard handlers from `AppLayout` that hijacked normal navigation. T/D/C shortcuts remain.
- **Bug 5**: `ResizablePanel` now measures parent container instead of `window.innerWidth/Height` for delta-to-percentage calculation, fixing sluggish resize in nested panels.
- **Bug 6**: `ResizableSeparator` stores `onResize`/`onDragEnd` in refs so the drag `useEffect` no longer re-runs on every parent render during drag.

---

## Tuesday, February 10, 2026

### CI/CD and Workflow Stabilization

- Consolidated workflow structure and naming (`deploy` workflow cleanup and infra deploy alignment).
- Fixed broken infra-test conditions caused by invalid matrix/secrets usage at job-level `if`.
- Removed invalid `snyk/actions@v4` reference (tag does not exist).
- Addressed CodeQL workflow warnings (version/language matrix cleanup plan identified).
- Confirmed artifact dependency behavior for infrastructure metadata retrieval.

### Pre-commit / Pre-push Pipeline Improvements

- Enforced header-sync check in push flow and aligned commit-time expectations.
- Kept no-Husky setup and removed extra hook folders from project root (`.husky`, `.githooks`) in favor of leaner structure.
- Diagnosed and resolved `sync:headers:check` command path/availability issues in CI.

### Test and Lint Recovery

- Fixed type-aware lint explosion in realtime package by restoring inherited TS path resolution (removed local `"paths": {}` overrides where they shadowed monorepo aliases).
- Added/updated Vitest alias mappings across packages (`server/engine`, `server/websocket`, `client/react`, `client/ui`) to resolve workspace package entry failures.
- Stabilized desktop tests with flaky timing/call-count assumptions.
- Updated websocket test mocks to avoid pulling heavy transitive runtime deps during unit tests.
- Resolved DB lint ordering failure in `src/server/db/src/queue/write-service.ts`.
- Final verification runs completed successfully for:
  - package-level realtime/websocket/ui/react/desktop suites
  - full root `pnpm test`
  - full root `pnpm lint`

### Commits (Today)

- `4edfd84c` update commit
- `66e1ecd7` update
- `07fc7f54` update github actions
- `a7d7b3b0` update
- `59692071` update fixes
- `80188eb2` update commit
- `6ee38959` fix(infra-test): remove invalid matrix reference from job-level if
- `0eec8827` update dependency
- `2d074e78` update commit
- `f0cebdf5` update infra workflow
- `961c44ce` update infra workflow
- `969de62d` test infra workflow
- `dc7ed931` test infra workflow
- `df23c73b` test infra workflow
- `95532f56` test infra workflow
- `31a66087` test infra workflow
- `7325c411` test infra workflow
- `1af86865` update cache

### Late-Day CI Parity and Sanity-Check Stabilization

- Fixed repeated local-vs-CI discrepancy where type-aware ESLint reported unresolved `error` types in CI while local appeared green.
- Root cause pattern confirmed:
  - package/app tsconfig `paths` overrides shadowing monorepo alias inheritance,
  - type-aware lint execution before package dist artifacts exist in CI,
  - stale/generated local artifacts masking issues.
- Added explicit workspace source alias mappings in client-side packages to stabilize resolver behavior during CI lint:
  - `src/client/engine/tsconfig.json`
  - `src/client/ui/tsconfig.json`
  - `src/client/react/tsconfig.json`
- Reverted unsafe server-side alias overrides that pulled external source files into package `tsc` programs and caused project-boundary type-check failures.
- Fixed persistent DB lint blocker in:
  - `src/server/db/src/queue/write-service.ts` (strict `import-x/order` grouping/alphabetization)
- Removed untracked generated JS artifacts under `src/server/db/src/**/*.js` and `*.js.map` that caused local-only lint noise and parity drift.
- Hardened workflow formatting enforcement path:
  - kept pre-commit YAML formatting coverage (`*.yml`, `*.yaml`),
  - made CI format check uncached via `pnpm format:check:ci` (`--no-cache`),
  - repaired YAML block indentation regressions in `.github/workflows/infra-test.yml`.
- Reduced flaky security timing test failures by widening CI-tolerant assertion window in:
  - `src/server/core/src/auth/__tests__/login-edge-cases.test.ts`

### Verification Snapshot (End of Session)

- `pnpm lint` passed.
- `pnpm type-check` passed.
- `pnpm test` passed.
- Targeted package lint/type checks for previously failing sets (`client-engine`, `ui`, `react`, `server-engine`, `media`, `db`) passed after fixes.

---

## Tuesday, February 11, 2026

### Sprint 1: Auth/Session Completeness + Gap Fills + Tests

#### Server Gap Fills (Phase A)

- Added `sessions` config to `AuthConfig` (`idleTimeoutMinutes`, `maxConcurrentSessions`)
- Implemented idle timeout check in `refresh.ts` handler — rejects refresh if token age exceeds idle threshold
- Implemented max concurrent sessions in `login.ts` — evicts oldest sessions when limit reached
- Added new device detection in `login.ts` — compares IP + user agent against existing sessions

#### Client Gap Fills (Phase B)

- Created `TotpQrCode.tsx` — minimal QR code encoder (no external packages), renders otpauth URLs as canvas
- Created `TurnstileWidget.tsx` — Cloudflare Turnstile invisible CAPTCHA, config-gated via `VITE_CAPTCHA_ENABLED`
- Created `TosAcceptanceModal.tsx` — Terms of Service acceptance modal for 403 TOS_ACCEPTANCE_REQUIRED
- Wired `TurnstileWidget` into `LoginForm`, `RegisterForm`, `ForgotPasswordForm` with conditional captchaToken spreading

#### Unit Tests (Phase C)

- Created `captcha.test.ts` — tests for `isCaptchaRequired`, `verifyCaptchaToken`, `verifyTurnstileToken` (disabled/enabled configs, HTTP errors, network errors, timeout)
- Confirmed existing `tos-gating.test.ts` and `sessions.test.ts` already had adequate coverage

#### Integration Tests (Phase D)

- Created `sessions.integration.test.ts` — route existence, auth guards, method enforcement for 4 session endpoints
- Created `tos.integration.test.ts` — route existence, auth guards, schema validation for ToS endpoints
- Created `captcha.integration.test.ts` — CAPTCHA disabled/enabled behavior verification
- Created `login-failure.integration.test.ts` — anti-enumeration tests (generic 401 for all failure types)

#### E2E Tests (Phase E)

- Created `auth-pages.e2e.ts` — auth page rendering, navigation links, protected route redirects
- Created `auth-forms.e2e.ts` — form field presence, client-side validation behavior

#### Bug Fixes During Verification

- Fixed `exactOptionalPropertyTypes` errors: conditional spreading for `captchaToken`, `onClose`, Turnstile callbacks
- Fixed mock compatibility: added `?? []` fallback for `findActiveByUserId` and null/undefined guard for `findByToken`

#### Files Created

- `src/server/core/src/auth/security/captcha.test.ts`
- `src/apps/server/src/__tests__/integration/sessions.integration.test.ts`
- `src/apps/server/src/__tests__/integration/tos.integration.test.ts`
- `src/apps/server/src/__tests__/integration/captcha.integration.test.ts`
- `src/apps/server/src/__tests__/integration/login-failure.integration.test.ts`
- `src/apps/web/src/__tests__/e2e/auth-pages.e2e.ts`
- `src/apps/web/src/__tests__/e2e/auth-forms.e2e.ts`
- `src/apps/web/src/features/settings/components/TotpQrCode.tsx`
- `src/apps/web/src/features/auth/components/TurnstileWidget.tsx`
- `src/apps/web/src/features/auth/components/TosAcceptanceModal.tsx`

#### Files Modified

- `src/shared/src/config/types/auth.ts` — added sessions config
- `src/server/core/src/auth/handlers/refresh.ts` — idle timeout check
- `src/server/core/src/auth/handlers/login.ts` — max sessions + device detection
- `src/apps/web/src/features/settings/components/TotpManagement.tsx` — QR code rendering
- `src/apps/web/src/features/auth/components/LoginForm.tsx` — Turnstile widget + captchaToken
- `src/apps/web/src/features/auth/components/RegisterForm.tsx` — Turnstile widget + captchaToken
- `src/apps/web/src/features/auth/components/ForgotPasswordForm.tsx` — Turnstile widget + captchaToken
- `src/apps/web/src/features/auth/components/index.ts` — barrel exports
- `src/apps/web/src/features/settings/components/index.ts` — barrel exports

#### Sprint 1 Completeness Review Gap Fills

- Added `legalDocuments`/`userAgreements` mock repos to `test-utils.ts` (`MockDbClient.query`)
- Added `createMockEmailTemplates()` factory to `test-utils.ts` with all 8 templates
- Added missing `newLoginAlert`/`passwordChangedAlert`/`emailChangedAlert` templates to `auth.integration.test.ts`
- Added `legalDocuments`/`userAgreements` repos to `auth.integration.test.ts` `createMockRepos()`
- Added `onTosRequired` callback to `ApiClientConfig` for 403 ToS interception in `src/client/api/src/api/client.ts`
- Exported `TosRequiredPayload` type from `src/client/api/src/index.ts`

### Frontend Polish: Adopt @abe-stack/ui Across apps/web

- Created `AuthFormLayout` compound component in `@abe-stack/ui` (`src/client/ui/src/components/AuthForm.tsx`) wrapping `.auth-form-*` CSS classes with sub-components: Content, Header, Title, Subtitle, Fields, Error, Footer, Divider
- Exported `AuthFormLayout` from UI library barrel (`components/index.ts` and `src/index.ts`)
- Refactored 5 auth form files to use `AuthFormLayout` instead of raw `className="auth-form-*"` strings: LoginForm, RegisterForm, ForgotPasswordForm, ResetPasswordForm, OAuthButtons (divider)
- Replaced inline `getSeverityBadgeClass()` with `Badge` component in `SecurityEventsTable.tsx` — severity levels now use `data-tone` attribute via `Badge` instead of hardcoded Tailwind color classes
- Replaced inline `PasswordStrengthIndicator` component in `PasswordChangeForm.tsx` with `PasswordInput`'s built-in `showStrength` prop, also replaced inline mismatch text with `Text` component
- Replaced Tailwind utility classes in `TosAcceptanceModal.tsx` with `Text` component from `@abe-stack/ui`
- Updated test files: `SecurityEventsTable.test.tsx` (badge assertions use `data-tone` instead of Tailwind classes), `PasswordChangeForm.test.tsx` (mock PasswordInput supports `showStrength`, added Text mock)

### Frontend Polish Phase 2: Comprehensive UI Library Adoption Sweep

#### CSS Utility Additions (`@abe-stack/ui`)

- Added `font-mono` utility class to `utilities.css`
- Added `hover-row` utility class for interactive table row hover states (uses `--ui-color-surface`)
- Added `.btn-text.text-danger` hover styles in `elements.css` for danger text buttons
- Added `bg-success`, `bg-danger`, `bg-warning` solid background utilities

#### Admin Components Refactored

- `SecurityEventCard.tsx` — Replaced `getSeverityBadgeClass()` with `Badge` + `severityToTone()`, replaced `border-gray-*` borders with `border-b`, replaced `bg-gray-50/900` with `bg-surface`
- `SecurityMetricsCard.tsx` — Replaced `getVariantClass()` Tailwind colors with semantic classes (`text-danger`, `text-warning`, `text-success`), replaced `border-gray-*` with `border-t`
- `QueueStatsCard.tsx` — Replaced `text-red-600 dark:text-red-400` with `text-danger`
- `UserDetailCard.tsx` — Replaced `border-gray-*` with `border-b`, replaced `text-gray-500 dark:text-gray-400` with `<Text tone="muted">`
- `UserTable.tsx` — Replaced `hover:bg-gray-50 dark:hover:bg-gray-800` with `hover-row`
- `SecurityEventsTable.tsx` — Same hover replacement
- `JobsTable.tsx` — Same hover replacement
- `UserFilters.tsx` — Replaced `bg-gray-50 dark:bg-gray-800` with `bg-surface`, replaced label colors with `text-muted`
- `SecurityEventsFilters.tsx` — Replaced `bg-white dark:bg-gray-800` with `bg-surface`, replaced `border-gray-*` with `border`, label colors with `text-muted`
- `ExportDialog.tsx` — Replaced `bg-gray-50 dark:bg-gray-800` with `bg-surface`, error div with `bg-danger-muted` + `<Text tone="danger">`
- `JobDetailsPanel.tsx` — Replaced `bg-gray-100 dark:bg-gray-800` with `bg-surface`, error card borders with `border-current text-danger`, error stack bg with `bg-danger-muted`

#### Settings Components Refactored

- `TotpManagement.tsx` — Replaced all raw `text-gray-*` / `bg-gray-*` / `text-green-*` with `<Text tone="muted">`, `bg-surface`, `text-success`, `bg-success`; replaced skeleton colors with `bg-surface`
- `SessionCard.tsx` — Replaced `text-gray-500` with `text-muted`, danger button classes with `text-danger`
- `SessionsList.tsx` — Added `Text` import, replaced danger button classes with `text-danger`, replaced `<p>` with `<Text tone="muted">`
- `OAuthConnectionsList.tsx` — Replaced `text-gray-500` / `bg-gray-100 dark:bg-gray-800` with `<Text tone="muted">` / `bg-surface`, danger button classes with `text-danger`
- `ProfileForm.tsx` — Replaced `bg-gray-100 dark:bg-gray-800` with `bg-surface`, help text with `<Text tone="muted">`

#### Test Updates

- `SecurityEventCard.test.tsx` — Severity assertions use `data-tone` attribute instead of Tailwind classes
- `SecurityMetricsCard.test.tsx` — Styling assertions use semantic class names (`text-danger`, `text-warning`)
- `QueueStatsCard.test.tsx` — Styling assertions use `text-danger` instead of `red`
- `TotpManagement.test.tsx` — Added `Text` mock, updated skeleton/dot selectors to `bg-surface`/`bg-success`/`text-muted`
- `SessionsList.test.tsx` — Added `Text` mock

#### Verification

- Zero raw Tailwind `dark:` color patterns remain in web app source files
- No Tailwind packages in any `package.json` — project uses pure CSS with custom utility classes
- All 218 affected tests pass
- Type-check passes for `@abe-stack/web`

### Frontend Polish Phase 3: Final Cleanup + Cursor Pointer

#### Global cursor: pointer for Interactive Elements

- Added global CSS rule in `elements.css` for `a`, `button`, `select`, `label[for]`, `input[type='checkbox']`, `input[type='radio']`, `input[type='file']::file-selector-button`, `[role='button']`, `[role='tab']`, `[role='link']`, `[role='menuitem']`, `[role='option']`, `summary`
- Added `cursor: pointer` to `.table-row` (has hover background change)
- Added `cursor: pointer` to `.hover-row` utility class
- Added `cursor: pointer` to `.markdown-content a` links

#### New CSS Utilities

- Added `.text-link` utility class for semantic link coloring (uses `--ui-color-primary` with hover darkening)

#### Remaining Raw CSS Cleanup (9 files)

- `StatusBadge.tsx` — Removed redundant `getStatusStyles()` function and hardcoded Tailwind class override; Badge now relies solely on `tone` prop for styling
- `UserActionsMenu.tsx` — Replaced 6 `text-gray-700 dark:text-gray-300` label classes with `text-muted`
- `SecurityEventDetailPage.tsx` — Replaced raw error `<div>` with `<Alert tone="danger">`
- `UserListPage.tsx` — Replaced `<p className="text-gray-500 dark:text-gray-400">` with `<Text tone="muted">`
- `ForgotPasswordShortcut.tsx` — Replaced `<p className="text-sm text-gray-500">` with `<Text size="sm" tone="muted">`, removed `dark:text-gray-200` from email span
- `AvatarUpload.tsx` — Replaced avatar placeholder `bg-gray-200 dark:bg-gray-700` with `bg-surface`, `text-gray-600 dark:text-gray-300` with `text-muted`, delete button `text-red-600 hover:text-red-700` with `text-danger`
- `TotpQrCode.tsx` — Replaced fallback `<p className="text-sm text-gray-500">` with `<Text size="sm" tone="muted">`
- `EmailChangeForm.tsx` — Replaced info `<p>` with `<Text size="sm" tone="muted">`
- `SettingsPage.tsx` — Replaced loading skeletons with `<Skeleton>` component, replaced 4 `text-gray-500` `<p>` tags with `<Text tone="muted">`, replaced `text-blue-600 hover:text-blue-700` link with `text-link` utility

#### Test Updates

- `StatusBadge.test.tsx` — Updated 3 styling assertions from Tailwind class checks to `data-tone` attribute checks

#### Verification

- Zero `dark:` patterns in non-test `.tsx` files across `apps/web`
- Zero hardcoded color classes (`text-gray-*`, `bg-gray-*`, `text-red-*`, `text-blue-*`) in non-test `.tsx` files
- All type-checks pass (`@abe-stack/ui`, `@abe-stack/web`)
- All StatusBadge tests pass (16/16)
- Lint clean on all 9 modified files

### Sprint 2: Multi-Tenant + RBAC + Account Management (continued)

#### E3: Account Lifecycle (2.6)

- Created migration `0022_account_lifecycle.sql` — adds `deactivated_at`, `deleted_at`, `deletion_grace_period_ends` columns to users table
- Updated DB schema types (`User`, `NewUser`, `UpdateUser`) and column mappings with new lifecycle fields
- Created shared domain logic in `lifecycle.schemas.ts` and `lifecycle.logic.ts`:
  - `AccountStatus` type: `'active' | 'deactivated' | 'pending_deletion'`
  - Status derivation: `getAccountStatus()`, `isAccountActive()`, `isAccountDeactivated()`, `isAccountPendingDeletion()`
  - Grace period: `calculateDeletionGracePeriodEnd()`, `isWithinDeletionGracePeriod()`
  - Validation: `canDeactivate()`, `canRequestDeletion()`, `canReactivate()`
  - Request/response schemas: `deactivateAccountRequestSchema`, `deleteAccountRequestSchema`
- Created lifecycle handler (`lifecycle.ts`) with 3 endpoints:
  - `handleDeactivateAccount` — deactivates active account, preserves data
  - `handleRequestDeletion` — initiates 30-day grace period, blocked if sole owner
  - `handleReactivateAccount` — cancels deactivation or deletion (within grace period)
- Orphan prevention: checks all workspace memberships before deletion; blocks if user is sole owner of any workspace
- Wired routes: `users/me/deactivate` POST, `users/me/delete` POST, `users/me/reactivate` POST
- Updated barrel exports through handlers/index.ts, domain/users/index.ts, domain/index.ts, shared/src/index.ts
- Created comprehensive tests:
  - `lifecycle.logic.test.ts` — 17 tests for all status derivation, grace period, and validation logic
  - `lifecycle.test.ts` — 18 handler tests covering auth, not found, state transitions, orphan prevention, grace period expiry
- Fixed mock User objects across 5 test files to include new lifecycle fields
- All type-checks pass: @abe-stack/shared, @abe-stack/db, @abe-stack/core, @abe-stack/server, @abe-stack/web
- All tests pass: shared (3281), db (2995), core (2020)

### Auth Stress Test Enforcement (5 Fixes)

Addressed 5 remaining gaps from Gemini-generated auth stress test audit (10 of 15 already passed).

#### Fix 1: JWT Clock Skew Tolerance

- Added `VerifyOptions` interface with `clockToleranceSeconds` to `src/server/engine/src/security/jwt.ts`
- Threaded options through `verify()`, `jwtVerify()`, barrel exports (crypto → security → engine)
- Updated `verifyToken()` in `src/server/core/src/auth/utils/jwt.ts` to accept and pass options
- Updated `extractTokenPayload()` in `src/server/core/src/auth/middleware.ts` to accept options
- Added `clockToleranceSeconds?: number` to `AuthConfig.jwt` in `src/shared/src/config/types/auth.ts`
- Tests: 4 new clock skew tolerance tests in `jwt.integration.test.ts`

#### Fix 2: Back-Button Data Leak Prevention

- Added `applyApiCacheHeaders()` to `src/apps/server/src/http/middleware/security.ts` — sets `Cache-Control: no-store, no-cache, must-revalidate` + `Pragma: no-cache`
- Applied in `plugins.ts` onRequest hook for `/api/` routes only
- Updated service worker `networkFirst()` in `sw.js` to check `Cache-Control: no-store` before caching responses
- Tests: 1 new test in `security.test.ts`

#### Fix 3: Offline-Aware Token Refresh

- Modified `AuthService.performRefresh()` in `src/apps/web/src/features/auth/services/AuthService.ts`
- Network errors (`NetworkError`) and timeouts now return `false` without calling `clearAuth()`
- Auth errors (401, invalid token) still call `clearAuth()` as before
- Imported `NetworkError` from `@abe-stack/api`

#### Fix 4: Deep-Link Preservation Through Login

- Updated `ProtectedRoute.tsx` to append `?returnTo=<encodedPath>` when redirecting unauthenticated users
- Added `isSafeRedirectPath()` open-redirect validation in `redirects.ts` — rejects `//`, `javascript:`, `data:`, absolute URLs
- Updated `getPostLoginRedirect()` to accept optional `returnTo` parameter
- Updated `LoginPage.tsx` to read `returnTo` from URL search params via `useSearchParams()`
- Tests: 10 new returnTo tests in `redirects.test.ts` (valid paths, query params, open-redirect attacks)

#### Fix 5: Zombie Access Token DB Check

- Added `assertUserActive()` utility to `src/server/core/src/auth/middleware.ts` — checks `lockedUntil` field
- Applied in sensitive handlers: password change, email change, TOTP setup/enable/disable, sudo elevation
- Throws `ForbiddenError('Account suspended')` for locked users, `UnauthorizedError('User not found')` for missing users
- Exported from `src/server/core/src/auth/index.ts`
- Tests: 4 new tests in `middleware.test.ts`

#### Files Modified

- `src/server/engine/src/security/jwt.ts` — `VerifyOptions`, clock tolerance
- `src/server/engine/src/security/crypto/index.ts` — barrel export
- `src/server/engine/src/security/index.ts` — barrel export
- `src/server/engine/src/index.ts` — barrel export
- `src/server/core/src/auth/utils/jwt.ts` — thread options
- `src/server/core/src/auth/middleware.ts` — `extractTokenPayload` options, `assertUserActive`
- `src/server/core/src/auth/index.ts` — export `assertUserActive`
- `src/server/core/src/auth/handlers/password.ts` — `assertUserActive` call
- `src/server/core/src/auth/handlers/totp.ts` — `assertUserActive` calls (3 handlers)
- `src/server/core/src/auth/handlers/email-change.ts` — `assertUserActive` call
- `src/server/core/src/auth/handlers/sudo.ts` — `assertUserActive` call
- `src/shared/src/config/types/auth.ts` — `clockToleranceSeconds` config
- `src/apps/server/src/http/middleware/security.ts` — `applyApiCacheHeaders`
- `src/apps/server/src/http/middleware/index.ts` — barrel export
- `src/apps/server/src/http/plugins.ts` — apply cache headers on `/api/`
- `src/apps/web/public/sw.js` — respect `no-store` in service worker
- `src/apps/web/src/features/auth/services/AuthService.ts` — offline-aware refresh
- `src/client/ui/src/layouts/layers/ProtectedRoute.tsx` — `returnTo` param
- `src/apps/web/src/features/auth/utils/redirects.ts` — `returnTo` + open-redirect guard
- `src/apps/web/src/features/auth/pages/LoginPage.tsx` — read `returnTo` from URL

#### Verification

- All targeted tests pass: engine (602), middleware (25), security (48), redirects (21)
- Type-check passes: @abe-stack/server-engine, @abe-stack/core, @abe-stack/shared, @abe-stack/server, @abe-stack/web, @abe-stack/ui
- Lint passes for all changed files

#### E4: Phone/SMS 2FA Stub (2.5) — DEFERRED

- Created SMS provider infrastructure in `server/engine/src/sms/`:
  - `types.ts` — `SmsProvider` interface, `SmsOptions`, `SmsResult`, `SmsConfig`
  - `console.ts` — `ConsoleSmsProvider` for development (logs to stdout)
  - `factory.ts` — `createSmsProvider()` factory (console implemented, twilio/aws-sns stubs throw)
  - `index.ts` — barrel exports
- Created migration `0023_sms_verification.sql` — `sms_verification_codes` table with user_id, phone, code, expires_at, verified, attempts
- Added SMS exports to `@abe-stack/server-engine` main index
- Tests: console provider (3), factory (4) — all pass
- Full implementation blocked on SMS provider vendor selection

### GitHub-Style Markdown Rendering

- Added table parsing to custom markdown parser (`markdown.tsx`):
  - Detects table start (pipe-separated header + separator row with `| --- |`)
  - Parses column alignment from separator (`:---`, `:---:`, `---:`)
  - Renders `<table>/<thead>/<tbody>/<tr>/<th>/<td>` with proper `textAlign` styles
  - Inline formatting (`**bold**`, `` `code` ``, etc.) works inside table cells
- Removed inline parser short-circuit that returned raw text when 3+ inline patterns matched (broke complex README lines)
- Replaced `.markdown-content` CSS (~300 lines) with GitHub-flavored styles:
  - Uses `--ui-*` CSS variables throughout (no hardcoded colors for light/dark)
  - Code blocks use `var(--ui-color-surface)` background instead of forced dark theme
  - Headings: h1/h2 get `border-bottom` with `var(--ui-color-border)`
  - Tables: bordered cells, `var(--ui-color-surface)` header/alternating rows
  - Blockquotes: left border with `var(--ui-color-border)`, muted text
  - Dark mode: uses `[data-theme='dark']` selector (matching project convention) instead of `@media prefers-color-scheme`
- Added 6 new tests for table parsing, alignment, inline formatting in cells, and 3+ pattern inline parsing
- All 18 markdown tests pass, type-check and lint clean

### UI Library: Remove Docs Panel + Add JSDoc + Clean Layout Titles

#### Step 1: Remove docs panel from UILibraryPage

- Removed `UILibraryDocContent` rendering and docs panel div from `UILibraryPage.tsx`
- Removed Documentation Panel test suite from `UILibraryPage.test.tsx`
- Deleted: `UILibraryDocContent.tsx`, `UILibraryDocContent.test.tsx`, `lazyDocs.ts`, `lazyDocs.test.ts`, `utils/index.ts`, empty `utils/` directory
- Removed `UILibraryDocContent` export from `components/index.ts`

#### Step 2: Delete external docs folder

- Deleted entire `src/client/ui/docs/` directory (~69 markdown files across elements/, components/, hooks/, layouts/, theme/)

#### Step 3: Add JSDoc to UI source files (~40 files)

- **Elements**: Enhanced 5 files (CloseButton, FileInput, Table, SkipLink, Toaster); 23 already documented
- **Components**: Enhanced 16 files (PeekLink, RadioGroup, Toast, ErrorBoundary, Dialog, Select, FocusTrap, Card, AuthForm, Dropdown, Popover, + 5 billing); 9 already documented
- **Layouts**: Enhanced 8 files (AuthLayout, Container, PageContainer, StackedLayout, Modal, Overlay, SidePeek, AppShell); 7 already documented
- **Theme + Utils**: Enhanced all 11 files (buildThemeCss, colors, density, motion, radius, spacing, typography, provider, cn, markdown, syntax-highlighter)

#### Step 4: Remove layout panel titles (Navigation, Details, Menu)

- `AppRightLayout.tsx` — Removed `title` prop, `Heading` import, `panel-header` div; kept only CloseButton
- `AppLeftLayout.tsx` — Same treatment as AppRightLayout
- `AppLeftMenu.tsx` — Removed "Menu" Text label
- `AppMainLayout.tsx` — Removed `rightSidebarTitle` prop from interface and usage
- `AppLayoutContext.tsx` — Removed `title` parameter from `setRightSidebar` and `useAppRightSidebar`
- `AppLayout.tsx` — Removed `rightSidebarTitleOverride` state, simplified `setRightSidebar` callback
- `UILibraryPage.tsx` — Removed 'Components' title argument from `useAppRightSidebar` call
- Updated tests: AppRightLayout, AppLeftLayout, AppLeftMenu, AppLayout (also fixed pre-existing keyboard shortcut test)

#### Verification

- All 23 affected tests pass across 5 test files
- Type-check passes: `@abe-stack/web`, `@abe-stack/ui`

### Auto-Index docs/ Folder into Right Sidebar

Replaced manually-maintained `docsMeta` / `DocKey` with automatic discovery using Vite's `import.meta.glob`. Adding, removing, or renaming `.md` files in `docs/` now automatically updates the Home page right sidebar with zero manual maintenance.

#### Approach: import.meta.glob (runtime discovery)

- `docsMeta.ts` uses `import.meta.glob('../../../../../../../docs/**/*.md')` to discover all markdown files at Vite build/HMR time
- Keys derived from file paths: `dev-testing`, `deploy-env`, `docs-readme` (kebab-case)
- Categories derived from folder names: `dev`, `deploy`, `quickstart`, `specs`, etc.
- Root `README.md` hardcoded as key `readme`, category `root`
- `types.ts` simplified: `DocKey = string`, `DocCategory = string` (no more brittle string literal unions)

#### Bug Fix: Key Collision

- `deriveKey()` was mapping both root `README.md` and `docs/README.md` to key `'readme'`
- Fixed by prefixing top-level docs files with `docs-` (e.g., `docs/README.md` → `docs-readme`)

#### Type Safety Fixes

- Fixed `noUncheckedIndexedAccess` errors in array index access (`parts[0]`, `parts[parts.length - 1]`)
- Fixed `loadDocContent` loader access with explicit undefined guard
- Updated `useDocContent.ts` parameter type from `string` to `DocKey`

#### Files Modified

- `src/apps/web/src/features/home/data/docsMeta.ts` — rewrote with `import.meta.glob`
- `src/apps/web/src/features/home/types.ts` — simplified to `string` types
- `src/apps/web/src/features/home/hooks/useDocContent.ts` — restored `DocKey` parameter type
- `src/apps/web/src/features/home/data/docsMeta.test.ts` — rewrote for runtime behavior
- `src/apps/web/src/features/home/hooks/useDocContent.test.ts` — updated key values

#### Files Created

- `src/tools/sync/sync-docs.ts` — no-op stub (keeps `pnpm sync:docs` from breaking)

#### Verification

- 42 home feature tests pass across 6 test files
- Type-check passes for `@abe-stack/web`
- Lint clean on all changed files

### API Route Registry + OpenAPI/Swagger

#### Phase 1: Route Registry + Admin Endpoint

- Created route registry singleton (`server/engine/src/routing/route-registry.ts`) — module-level array storing `RouteRegistryEntry` metadata for every registered route
- Extended `registerRouteMap()` in `routing.ts` to feed registry with route metadata (path, method, isPublic, roles, hasSchema, module, summary, tags)
- Added `module?: string` to `RouterOptions`; `deriveModule()` auto-extracts module from path when not provided
- Added module tags to all 8 `registerRouteMap` calls in `routes.ts`: auth, users, notifications, admin, tenants, realtime, system, billing
- Created admin handler `handleGetRouteManifest` → `GET /api/admin/routes` returns all registered routes with count
- Added OpenAPI route entry with summary/description/tags to admin routes

#### Phase 2: OpenAPI/Swagger

- Added `@fastify/swagger` + `@fastify/swagger-ui` packages (2 new deps)
- Created `RouteOpenApiMeta` and `JsonSchemaObject` interfaces for OpenAPI metadata on route definitions
- Extended `publicRoute()` and `protectedRoute()` with optional `openapi` parameter
- Registered swagger plugins in `server.ts` — interactive API docs at `/api/docs`
- Annotated 5 example routes with OpenAPI metadata: `GET /health`, `GET /health/live`, `POST /api/auth/login`, `GET /api/users/me`, `GET /api/admin/routes`
- Created `annotateRoutes()` helper for patching OpenAPI onto shared module routes at registration boundary (shared's `BaseRouteDefinition` doesn't include `openapi`)

#### Frontend: Admin Route Manifest Page

- Added `getRouteManifest()` to `AdminApiClient` interface and implementation
- Created `useRouteManifest` hook following `useQueueStats` pattern
- Created `RouteManifestPage` with filterable table: method color badges, auth badges, search by path, filter by module/method, group-by-module toggle
- Added "API Routes" nav item to AdminLayout
- Wired route `/admin/routes` → `RouteManifestPage`

#### Files Created

- `src/server/engine/src/routing/route-registry.ts` + test
- `src/server/core/src/admin/route-manifest.ts` + test
- `src/apps/web/src/features/admin/hooks/useRouteManifest.ts` + test
- `src/apps/web/src/features/admin/pages/RouteManifestPage.tsx` + test

#### Files Modified

- `src/server/engine/src/routing/routing.ts` — registry feed, OpenAPI types, `publicRoute`/`protectedRoute` openapi param
- `src/server/engine/src/routing/index.ts`, `src/server/engine/src/index.ts` — barrel exports
- `src/apps/server/src/routes/routes.ts` — module tags, OpenAPI annotations
- `src/apps/server/src/routes/system.routes.ts` — OpenAPI annotations on health routes
- `src/apps/server/src/server.ts` — swagger plugin registration
- `src/apps/server/src/app.ts` — dynamic route count
- `src/server/core/src/admin/routes.ts` — route manifest endpoint
- `src/apps/web/src/features/admin/` — services, hooks, pages, layouts barrel exports
- `src/apps/web/src/app/routes.tsx`, `src/apps/web/src/pages/AdminPages.ts` — routing

#### Verification

- Server engine: 618 tests pass, type-check clean
- Core: 2023 tests pass, type-check clean
- Server: 28 route tests pass, type-check clean
- Web: 8 new tests pass (RouteManifestPage + useRouteManifest)

### Auth Form Final Polish: UI Component Adoption + Button `size="inline"`

#### Button `size="inline"` (UI Package)

- Added `'inline'` to `Button` size union type in `src/client/ui/src/elements/Button.tsx`
- Added `.btn-inline` CSS rule in `src/client/ui/src/styles/elements.css` — `padding: 0; min-height: auto; font-size: inherit;`
- Eliminates all `style={{ padding: 0, minHeight: 'auto' }}` inline style overrides across auth forms

#### Auth Form Component Cleanup (5 files)

- `LoginForm.tsx` — Replaced `<p>` with `<Text>`, `<span>` with `<Text as="span">`, inline styles with `size="inline"`
- `RegisterForm.tsx` — Replaced `<strong>` with `<Text as="strong">`, `<span>` with `<Text as="span">`, two inline styles with `size="inline"`
- `ForgotPasswordForm.tsx` — Replaced inline style with `size="inline"`
- `ResetPasswordForm.tsx` — Replaced inline style with `size="inline"`
- `OAuthButtons.tsx` — Replaced `style={{ opacity: 0.5 }}` with `className="opacity-50"`, `<span>` with `<Text as="span">`

#### Verification

- Zero `style={{` inline styles remaining in auth components
- Zero raw `<p>`, `<span>`, `<strong>` text elements remaining
- Type-check passes: `@abe-stack/ui`, `@abe-stack/web`
- Lint clean on all 6 modified files

### Sprint 3 TODO: Comprehensive Checklist Creation

- Expanded Sprint 3 section in `docs/todo/TODO.md` from 22 high-level items to 22 deeply detailed items
- Each item now follows Vertical Slice Protocol: Contract + Service + Route + Client + UI + Test breakdown
- Cross-referenced every item to BUSINESS.md sections
- Added cross-reference summary table mapping BUSINESS.md → Sprint 3 items
- Key additions from BUSINESS.md gaps: billing invoicing/upgrade/downgrade/dunning, notification channel breakdown, webhook delivery pipeline, consent management details, tenant management admin, system health dashboard, onboarding flow
