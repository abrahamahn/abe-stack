# Week 7: February 9-15, 2026

> **Summary**: CI/CD hardening for GitHub Actions and DigitalOcean deployment flow. Stabilized pre-commit/pre-push checks, fixed monorepo test/lint breakages, and cleaned workflow reliability issues. Sprint 1 & 2 completeness verification (~195/200 items). Frontend polish (full design system adoption sweep). Sprint 2 account lifecycle. Auth stress test fixes. Dark theme centralization. Docker build context fix. CodeQL static analysis cleanup. eslint-disable removal campaign. Sprint 1.3 Security Intelligence + Sprint 2.5 Phone/SMS 2FA full implementation (closing both sprints at 100%).

---

## Sunday, February 9, 2026

### Initial CI/CD Triage

- Began investigating CI pipeline failures and pre-commit check inconsistencies.
- Identified broken quality gate commands and started cataloguing issues for the week.

### Commits (Today)

- `c9ce8c89` update checks
- `64deeaba` update

---

## Tuesday, February 10, 2026

### CI/CD and Workflow Stabilization

- Consolidated workflow structure and naming (`deploy` workflow cleanup and infra deploy alignment).
- Fixed broken infra-test conditions caused by invalid matrix/secrets usage at job-level `if`.
- Removed invalid `snyk/actions@v4` reference (tag does not exist).
- Addressed CodeQL workflow warnings (version/language matrix cleanup plan identified).
- Confirmed artifact dependency behavior for infrastructure metadata retrieval.

### Pre-commit / Pre-push Pipeline Improvements

- Enforced header-sync check in push flow and aligned commit-time expectations.
- Kept no-Husky setup and removed extra hook folders from project root (`.husky`, `.githooks`) in favor of leaner structure.
- Diagnosed and resolved `sync:headers:check` command path/availability issues in CI.

### Test and Lint Recovery

- Fixed type-aware lint explosion in realtime package by restoring inherited TS path resolution (removed local `"paths": {}` overrides where they shadowed monorepo aliases).
- Added/updated Vitest alias mappings across packages (`server/engine`, `server/websocket`, `client/react`, `client/ui`) to resolve workspace package entry failures.
- Stabilized desktop tests with flaky timing/call-count assumptions.
- Updated websocket test mocks to avoid pulling heavy transitive runtime deps during unit tests.
- Resolved DB lint ordering failure in `main/server/db/src/queue/write-service.ts`.
- Final verification runs completed successfully for:
  - package-level realtime/websocket/ui/react/desktop suites
  - full root `pnpm test`
  - full root `pnpm lint`

### Commits (Today)

- `4edfd84c` update commit
- `66e1ecd7` update
- `07fc7f54` update github actions
- `a7d7b3b0` update
- `59692071` update fixes
- `80188eb2` update commit
- `6ee38959` fix(infra-test): remove invalid matrix reference from job-level if
- `0eec8827` update dependency
- `2d074e78` update commit
- `f0cebdf5` update infra workflow
- `961c44ce` update infra workflow
- `969de62d` test infra workflow
- `df23c73b` test infra workflow
- `95532f56` test infra workflow
- `31a66087` test infra workflow
- `7325c411` test infra workflow
- `1af86865` update cache

### Late-Day CI Parity and Sanity-Check Stabilization

- Fixed repeated local-vs-CI discrepancy where type-aware ESLint reported unresolved `error` types in CI while local appeared green.
- Root cause pattern confirmed:
  - package/app tsconfig `paths` overrides shadowing monorepo alias inheritance,
  - type-aware lint execution before package dist artifacts exist in CI,
  - stale/generated local artifacts masking issues.
- Added explicit workspace source alias mappings in client-side packages to stabilize resolver behavior during CI lint:
  - `main/client/engine/tsconfig.json`
  - `main/client/ui/tsconfig.json`
  - `main/client/react/tsconfig.json`
- Reverted unsafe server-side alias overrides that pulled external source files into package `tsc` programs and caused project-boundary type-check failures.
- Fixed persistent DB lint blocker in:
  - `main/server/db/src/queue/write-service.ts` (strict `import-x/order` grouping/alphabetization)
- Removed untracked generated JS artifacts under `main/server/db/src/**/*.js` and `*.js.map` that caused local-only lint noise and parity drift.
- Hardened workflow formatting enforcement path:
  - kept pre-commit YAML formatting coverage (`*.yml`, `*.yaml`),
  - made CI format check uncached via `pnpm format:check:ci` (`--no-cache`),
  - repaired YAML block indentation regressions in `.github/workflows/infra-test.yml`.
- Reduced flaky security timing test failures by widening CI-tolerant assertion window in:
  - `main/server/core/src/auth/__tests__/login-edge-cases.test.ts`

### Verification Snapshot (End of Session)

- `pnpm lint` passed.
- `pnpm type-check` passed.
- `pnpm test` passed.
- Targeted package lint/type checks for previously failing sets (`client-engine`, `ui`, `react`, `server-engine`, `media`, `db`) passed after fixes.

### Dockerignore Build Context Fix

- **Root cause:** `Dockerfile.dockerignore` contained a bare `**` glob pattern that matched all files, leaving only `.env.example` in the Docker build context. This caused the `docker-build-publish` CI job to fail with "not found" for `main/shared/package.json` (and all other source files).
- **Fix:** Replaced bare `**` with `**/.env*` / `!**/.env.example` to properly exclude nested env files without blocking the entire build context.
- 1 file changed: `infra/docker/Dockerfile.dockerignore`

### CodeQL Static Analysis: 12 Warnings Resolved

Addressed 12 CodeQL security/quality warnings across the codebase in a single sweep:

- `useOnScreen.ts` — avoid passing `undefined` options to `IntersectionObserver` constructor
- `notifications.errors.ts` — moved `ProviderNotConfiguredError` alias after class declaration (variable used before declaration)
- `source-code.ts` — removed useless initial assignment to `key` variable
- `Slider.tsx` — removed useless initial assignment to `nextValue`
- `RadioGroup.tsx` — removed useless initial assignment to `nextIndex`
- `pagination/middleware.ts` — changed `paginationType` from `let` to `const` (assigned in both branches, never reassigned)
- `writer.test.ts` — removed always-true `mockLogger !== undefined` check
- `QueryCacheProvider.test.tsx` — removed always-true `cache !== null` check
- `health-check.ts` — reused declared `ESLINT_REGEX`/`TSC_REGEX` constants instead of recreating inline
- `notifications/routes.ts` — removed unneeded defensive `schema !== undefined` check
- 10 files changed across `client/`, `server/`, and `tools/`

### eslint-disable Inline Comment Removal

Removed 3 remaining `eslint-disable` inline comments as part of the `noInlineConfig` enforcement campaign:

- `schemas.ts` — replaced `interface EmptyBody {}` with `type EmptyBody = Record<string, never>` (eliminates `@typescript-eslint/no-empty-object-type` disable)
- `factory.ts` — replaced `console.error` with `process.stderr.write` for fatal startup errors (eliminates `no-console` disables)
- `verify-storage-path.ts` — replaced `console.log/error` with `process.stdout/stderr.write` (eliminates file-level `no-console` disable)
- 3 files changed: `main/apps/server/src/config/factory.ts`, `main/apps/server/src/verify-storage-path.ts`, `main/shared/src/core/schemas.ts`

### Recovery Checkpoints + Formatting

Recovered and checkpointed workspace state after branch reconciliation:

- `5ede0d86` — bulk recovery of workspace changes (472 files, all Sprint 1/2 work, tenant module, settings, UI library restructure)
- `c3a87398` — recovered TODO updates
- `de475136` — recovered seed script `canonical_email` + `email_verified` fix
- `2481997e` — final recovered state (bootstrap-admin fix)
- `3e5b58b1` — applied formatting updates after full quality checks (seed test, TODO, dev log)
- `949f4079` — applied formatting and swagger theme updates

### Commits (Late-Night / Early Morning)

- `0f3cf587` fix: dockerignore bare \*\* pattern excluded all files from build context
- `5f70c493` fix: resolve 12 CodeQL warnings across codebase
- `3186579d` fix: remove eslint-disable comments from schemas, factory, and verify-storage
- `5ede0d86` chore: checkpoint recovered workspace changes
- `c3a87398` docs: checkpoint recovered TODO updates
- `de475136` chore: checkpoint recovered seed script update
- `2481997e` chore: final recovered state checkpoint
- `3e5b58b1` chore: apply formatting updates after full quality checks
- `949f4079` chore: apply formatting and swagger theme updates

---

## Wednesday, February 11, 2026

### Non-Negotiable Lint Enforcement

Added automated ESLint enforcement for CLAUDE.md coding rules that were previously only enforced by documentation:

- **Ban `@ts-expect-error`**: Overrode `ban-ts-comment` to disallow `@ts-expect-error` entirely (was allowed with description by `strictTypeChecked` preset)
- **Ban wildcard exports**: Added `no-restricted-syntax` rule targeting `ExportAllDeclaration` (excludes namespace re-exports `export * as Foo` and type-only `export type *`)
- **Ban `eslint-disable` inline comments**: Enabled `linterOptions.noInlineConfig: true`; replaced 4 existing inline disables with config-level overrides for `TotpQrCode.tsx` (no-non-null-assertion), `string.ts` (no-control-regex), `AcceptInvitationPage.tsx` (useRef pattern), and test naming-convention
- **Ban raw HTML in apps/web**: Added JSX element selectors for 16 HTML elements (button, input, textarea, select, a, img, h1-h6, p, hr, table, progress) with messages pointing to `@bslt/ui` components; structural elements (div, nav, section, etc.) remain allowed; test files excluded
- **Created CSS lint script** (`main/tools/scripts/lint/lint-css-tokens.ts`): Scans CSS files for hardcoded hex colors, color functions, px units (except 1px borders), and font-weight numbers outside `--ui-*` variable definitions. Wired into `package.json` as `lint:css` and `turbo.json` pipeline
- **Fixed ~20 raw HTML violations** across 14 apps/web files (h1->Heading, p->Text, button->Button, a->Link, input->Checkbox)
- **Fixed pre-existing lint errors**: Replaced wildcard exports in `auth/utils/index.ts` with explicit named exports, fixed `require-await` in `audit/service.ts`, removed unnecessary condition in `refresh.ts`, removed unused imports in `audit-events.ts`
- **Added `tsconfig.lint.json` for `@bslt/core`**: Explicit `@bslt/db` paths for ESLint type resolver (matches engine package pattern)
- Cross-app boundary split deferred due to `eslint-plugin-boundaries` path alias resolution issues with desktop app

### Infra-Test Workflow: Heredoc Indentation Fix

- **Root cause:** Provider-specific heredoc blocks in `.github/workflows/infra-test.yml` had `EOF` delimiters indented 2 spaces after YAML dedenting, causing bash syntax errors (exit code 2) in CI.
- **Fix:** Corrected heredoc delimiter indentation to align with the shell block.
- 1 file changed: `.github/workflows/infra-test.yml` (22 lines, 11 insertions / 11 deletions)

### Login Bug Fix: Seed Script Missing canonical_email + email_verified

- **Root cause:** `seed.ts` INSERT only set `email`, `password_hash`, `name`, `role` columns. The `canonical_email` column (used by `findByEmail` for user lookup) was NULL, and `email_verified` boolean was FALSE.
- **Fix:** Updated `seed.ts` to include `canonical_email` (via `canonicalizeEmail()`), `email_verified = true`, and `email_verified_at = NOW()`. Used `ON CONFLICT DO UPDATE` to backfill existing seeded users.
- **Also fixed:** `bootstrap-admin.ts` had the same missing `canonical_email` + `email_verified` columns.
- Login with `admin@example.com` / `password123` now returns 200 with JWT token.

### CAPTCHA on All Auth Endpoints + New Device Login Banner

- **CAPTCHA on forgot-password:** Added `isCaptchaRequired` + `verifyCaptchaToken` to `handleForgotPassword` handler. Updated route to pass `req` for IP address. Added CAPTCHA tests. (Register and login already had CAPTCHA; forgot-password was the only gap.)
- **New device login banner:** Added `isNewDevice?: boolean` to `AuthResponse` schema (shared). Login handler now includes `isNewDevice: true` when IP+UA don't match any active session. `AuthService` tracks `isNewDevice` state, exposed via `useAuth()`. Created `NewDeviceBanner` component (dismissible `Alert tone="warning"`) rendered in `AppLayout` below the top bar.
- Updated 4 test files: `password.test.ts`, `login.test.ts`, `handlers.test.ts` (integration), `routes.test.ts`
- Fixed `AppLayout.test.tsx` — added `NewDeviceBanner` to `@auth/components` mock
- Marked Sprint 1 & 2 items as done in `TODO.md` (114 checklist items)
- Updated `BUSINESS.md` with Sprint 1 & 2 completion status

### Fix Pre-Existing Web Test Failures (19 tests across 4 files)

All 4 failures were missing UI component mocks in `vi.mock('@bslt/ui')`:

- **SessionsList.test.tsx** (9 tests): Added `Heading` mock
- **SettingsPage.test.tsx** (5 tests): Added `Link` mock — `...actual` spread imported real `Link` which calls `useRouterContext`, crashing without Router wrapper
- **PlanManagementPage.test.tsx** (3 tests): Added `Heading` mock
- **RouteManifestPage.test.tsx** (2 tests): Added `Checkbox` mock

Result: `@bslt/web` now **121 files, 1809 tests, 0 failures** (was 5 failed / 22 broken tests).

### Verification Queue Audit — Sprint 1 & 2

Systematic audit of the ~200-item Verification Queue in `TODO.md` to prove all Sprint 1 & 2 features work end-to-end. Ran parallel verification agents to check contracts, DB artifacts, routes, UI, and tests.

**Verified sections (all PASS):**

- **Auth (1.1-1.11)**: Registration, Email Verification, Login, Token Refresh, Logout, Password Reset, Magic Link, OAuth2, Email Change, TOTP, Canonicalization — 65 items checked
- **Sessions (2.3-2.5)**: Sessions API, Session UA labeling — 11 items checked
- **Module 1 Identity DB**: users, tenants, memberships, invitations, user_sessions — 30 sub-items checked
- **Module 2 Auth & Security DB**: 12 tables (refresh_tokens, families, login_attempts, password_reset_tokens, email_verification_tokens, security_events, magic_link_tokens, oauth_connections, totp_backup_codes, email_change_tokens, api_keys) — all PASS
- **Account Management (3)**: Username auto-generation, avatar workflow, profile, account locking — 14 items
- **Tenant Scoping (4.9)**: Headers, context utilities, guards — 4 items
- **RBAC (5.2-5.3)**: Backend guards, ProtectedRoute — 8 items
- **Admin/Support (7.1, 7.3, 7.5)**: Settings, admin pages, soft ban — 19 items

**Verified sections (second batch — all PASS):**

- **Module 3 Billing DB**: All 6 tables — schema constants + repos verified
- **Module 4-9 Supporting DB**: All 20 tables verified
- **Supporting Modules (CHECKLIST 6)**: All 9 sections pass — API Keys, Billing Infra, Audit/Security Events, Notifications, File Storage, Activity Tracking, Feature Flags/Metering, Compliance, Realtime Client
- **Architecture & Infrastructure (CHECKLIST 8)**: 100% pass — backend core infra, server engine adapters, security modules, middleware, frontend core UI, client engine, client API, PWA, all web app features
- **Operational Quality (CHECKLIST 10)**: Health endpoints, correlation IDs — all pass
- **Login Attempt Logging (11.4)**: IP/UA/success-fail logging — all pass
- **CI/CD (CHECKLIST 13)**: Containerization, cloud deployment, CI pipelines, dev tooling — all pass except git hooks dir
- **Engine Queue/Job (Appendix C)**: types, client, writer, memory store — all pass with tests
- **Engine Search (Appendix C)**: SQL provider, factory, query builder — all pass with tests

**Gaps found (3 total):**

1. `email_change_revert_tokens` — has migration + schema constant but NO dedicated repository (uses raw SQL in `email-change.ts`)
2. Job idempotency keys — no idempotency key field in Task interface; retries + dead-letter queue work
3. Git hooks — no `/infra/git-hooks/` directory; hooks configured via `lint-staged` in package.json

**Fix applied**: `refresh.ts` null check changed from `!== null` to `!= null` (loose equality catches both null and undefined from vi.fn()). Added `findByToken` mocks to 3 handleRefresh tests. Core suite: 80 files, 2049 tests, 0 failures.

**Final verification queue status**: ~195 of ~200 items checked (`[x]`), 3 gap items remain as `[ ]` with annotations.

### Sprint 3 TODO Expansion

- Added section 3.23: Security Intelligence & Device Detection (CHECKLIST 2.6) — covers geo-IP lookup, trusted device tracking, token version invalidation, new-login alerts, device management UI
- Added section 3.24: Phone / SMS Two-Factor Authentication (CHECKLIST 3.5 | BUSINESS 1.9) — covers SMS provider abstraction, phone number management, SMS 2FA challenge flow
- Updated Sprint 3 cross-reference summary table to include new sections
- Updated Sprint 3 header to reference CHECKLIST 2.6 and 3.5

### Dark Theme: Monochrome Black/White Centralization

- Centralized dark theme to pure black backgrounds (#000000) with solid white borders (#ffffff) and white text (#ffffff)
- Changed `--ui-color-primary` to white in dark mode so links, text buttons, badges, and focus rings are all white
- Added `[data-theme='dark']` CSS overrides for `.btn-primary` to render as black bg + white border/text (since primary is now white)
- Added dark mode overrides for disabled buttons (#1a1a1a bg, #666 text) to avoid white-on-white
- Added dark mode text button hover/active states (dims to muted gray)
- Updated alert/badge dark colors: black bg with semantic status borders preserved (danger=red, success=green, warning=yellow)
- Regenerated `theme.css` via `sync-css-theme`

### Side Peek Improvements

- Added solid left border to `.side-peek` using `var(--ui-color-text)` — renders black in light mode, white in dark mode
- Added slide-out close animation: panel now transitions back to `translateX(100%)` over 200ms before unmounting (previously removed from DOM immediately)
- Removed `SidePeek.Close` button from `AppSidePeekLayout` and `HomeSidePeek` — users close via overlay click or Escape key
- Changed `SidePeek.Expand` to toggle fullscreen mode in-place instead of navigating to a separate page — added local `isFullscreen` state to both app layouts
- Updated `SidePeek.Expand` component: `onExpand` callback no longer auto-closes the panel (enables in-place fullscreen toggle without closing)
- Updated 5 tests in `SidePeek.test.tsx` to account for 200ms close animation delay (using `act(() => vi.advanceTimersByTime(200))`)
- Rewrote `AppSidePeekLayout.test.tsx` for new structure (fullscreen toggle, no close button)

### App Layout Panel Toggle & Resize Bugfixes

- **Bug 1+2**: Replaced fill panels (content group, center) in `AppMainLayout` with plain `flex-1` divs instead of `ResizablePanel`. Eliminates rigid `flexBasis` overflow and phantom trailing separators.
- **Bug 3**: Memoized `handlePaneResize` and `resetLayout` in `useUILibraryPanes` with `useCallback`. Memoized inline `onResize`/`onClose` callbacks in `AppMainLayout`.
- **Bug 4**: Removed global ArrowUp/Down/Left/Right keyboard handlers from `AppLayout` that hijacked normal navigation. T/D/C shortcuts remain.
- **Bug 5**: `ResizablePanel` now measures parent container instead of `window.innerWidth/Height` for delta-to-percentage calculation, fixing sluggish resize in nested panels.
- **Bug 6**: `ResizableSeparator` stores `onResize`/`onDragEnd` in refs so the drag `useEffect` no longer re-runs on every parent render during drag.

---

### Sprint 1: Auth/Session Completeness + Gap Fills + Tests

#### Server Gap Fills (Phase A)

- Added `sessions` config to `AuthConfig` (`idleTimeoutMinutes`, `maxConcurrentSessions`)
- Implemented idle timeout check in `refresh.ts` handler — rejects refresh if token age exceeds idle threshold
- Implemented max concurrent sessions in `login.ts` — evicts oldest sessions when limit reached
- Added new device detection in `login.ts` — compares IP + user agent against existing sessions

#### Client Gap Fills (Phase B)

- Created `TotpQrCode.tsx` — minimal QR code encoder (no external packages), renders otpauth URLs as canvas
- Created `TurnstileWidget.tsx` — Cloudflare Turnstile invisible CAPTCHA, config-gated via `VITE_CAPTCHA_ENABLED`
- Created `TosAcceptanceModal.tsx` — Terms of Service acceptance modal for 403 TOS_ACCEPTANCE_REQUIRED
- Wired `TurnstileWidget` into `LoginForm`, `RegisterForm`, `ForgotPasswordForm` with conditional captchaToken spreading

#### Unit Tests (Phase C)

- Created `captcha.test.ts` — tests for `isCaptchaRequired`, `verifyCaptchaToken`, `verifyTurnstileToken` (disabled/enabled configs, HTTP errors, network errors, timeout)
- Confirmed existing `tos-gating.test.ts` and `sessions.test.ts` already had adequate coverage

#### Integration Tests (Phase D)

- Created `sessions.integration.test.ts` — route existence, auth guards, method enforcement for 4 session endpoints
- Created `tos.integration.test.ts` — route existence, auth guards, schema validation for ToS endpoints
- Created `captcha.integration.test.ts` — CAPTCHA disabled/enabled behavior verification
- Created `login-failure.integration.test.ts` — anti-enumeration tests (generic 401 for all failure types)

#### E2E Tests (Phase E)

- Created `auth-pages.e2e.ts` — auth page rendering, navigation links, protected route redirects
- Created `auth-forms.e2e.ts` — form field presence, client-side validation behavior

#### Bug Fixes During Verification

- Fixed `exactOptionalPropertyTypes` errors: conditional spreading for `captchaToken`, `onClose`, Turnstile callbacks
- Fixed mock compatibility: added `?? []` fallback for `findActiveByUserId` and null/undefined guard for `findByToken`

#### Files Created

- `main/server/core/src/auth/security/captcha.test.ts`
- `main/apps/server/src/__tests__/integration/sessions.integration.test.ts`
- `main/apps/server/src/__tests__/integration/tos.integration.test.ts`
- `main/apps/server/src/__tests__/integration/captcha.integration.test.ts`
- `main/apps/server/src/__tests__/integration/login-failure.integration.test.ts`
- `main/apps/web/src/__tests__/e2e/auth-pages.e2e.ts`
- `main/apps/web/src/__tests__/e2e/auth-forms.e2e.ts`
- `main/apps/web/src/features/settings/components/TotpQrCode.tsx`
- `main/apps/web/src/features/auth/components/TurnstileWidget.tsx`
- `main/apps/web/src/features/auth/components/TosAcceptanceModal.tsx`

#### Files Modified

- `main/shared/src/config/types/auth.ts` — added sessions config
- `main/server/core/src/auth/handlers/refresh.ts` — idle timeout check
- `main/server/core/src/auth/handlers/login.ts` — max sessions + device detection
- `main/apps/web/src/features/settings/components/TotpManagement.tsx` — QR code rendering
- `main/apps/web/src/features/auth/components/LoginForm.tsx` — Turnstile widget + captchaToken
- `main/apps/web/src/features/auth/components/RegisterForm.tsx` — Turnstile widget + captchaToken
- `main/apps/web/src/features/auth/components/ForgotPasswordForm.tsx` — Turnstile widget + captchaToken
- `main/apps/web/src/features/auth/components/index.ts` — barrel exports
- `main/apps/web/src/features/settings/components/index.ts` — barrel exports

#### Sprint 1 Completeness Review Gap Fills

- Added `legalDocuments`/`userAgreements` mock repos to `test-utils.ts` (`MockDbClient.query`)
- Added `createMockEmailTemplates()` factory to `test-utils.ts` with all 8 templates
- Added missing `newLoginAlert`/`passwordChangedAlert`/`emailChangedAlert` templates to `auth.integration.test.ts`
- Added `legalDocuments`/`userAgreements` repos to `auth.integration.test.ts` `createMockRepos()`
- Added `onTosRequired` callback to `ApiClientConfig` for 403 ToS interception in `main/client/api/src/api/client.ts`
- Exported `TosRequiredPayload` type from `main/client/api/src/index.ts`

### Frontend Polish: Adopt @bslt/ui Across apps/web

- Created `AuthFormLayout` compound component in `@bslt/ui` (`main/client/ui/src/components/AuthForm.tsx`) wrapping `.auth-form-*` CSS classes with sub-components: Content, Header, Title, Subtitle, Fields, Error, Footer, Divider
- Exported `AuthFormLayout` from UI library barrel (`components/index.ts` and `src/index.ts`)
- Refactored 5 auth form files to use `AuthFormLayout` instead of raw `className="auth-form-*"` strings: LoginForm, RegisterForm, ForgotPasswordForm, ResetPasswordForm, OAuthButtons (divider)
- Replaced inline `getSeverityBadgeClass()` with `Badge` component in `SecurityEventsTable.tsx` — severity levels now use `data-tone` attribute via `Badge` instead of hardcoded Tailwind color classes
- Replaced inline `PasswordStrengthIndicator` component in `PasswordChangeForm.tsx` with `PasswordInput`'s built-in `showStrength` prop, also replaced inline mismatch text with `Text` component
- Replaced Tailwind utility classes in `TosAcceptanceModal.tsx` with `Text` component from `@bslt/ui`
- Updated test files: `SecurityEventsTable.test.tsx` (badge assertions use `data-tone` instead of Tailwind classes), `PasswordChangeForm.test.tsx` (mock PasswordInput supports `showStrength`, added Text mock)

### Frontend Polish Phase 2: Comprehensive UI Library Adoption Sweep

#### CSS Utility Additions (`@bslt/ui`)

- Added `font-mono` utility class to `utilities.css`
- Added `hover-row` utility class for interactive table row hover states (uses `--ui-color-surface`)
- Added `.btn-text.text-danger` hover styles in `elements.css` for danger text buttons
- Added `bg-success`, `bg-danger`, `bg-warning` solid background utilities

#### Admin Components Refactored

- `SecurityEventCard.tsx` — Replaced `getSeverityBadgeClass()` with `Badge` + `severityToTone()`, replaced `border-gray-*` with `border-b`, `bg-gray-50/900` with `bg-surface`
- `SecurityMetricsCard.tsx` — Replaced `getVariantClass()` Tailwind colors with semantic classes (`text-danger`, `text-warning`, `text-success`), replaced `border-gray-*` with `border-t`
- `QueueStatsCard.tsx` — Replaced `text-red-600 dark:text-red-400` with `text-danger`
- `UserDetailCard.tsx` — Replaced `border-gray-*` with `border-b`, `text-gray-500 dark:text-gray-400` with `<Text tone="muted">`
- `UserTable.tsx` — Replaced `hover:bg-gray-50 dark:hover:bg-gray-800` with `hover-row`
- `SecurityEventsTable.tsx` — Same hover replacement
- `JobsTable.tsx` — Same hover replacement
- `UserFilters.tsx` — Replaced `bg-gray-50 dark:bg-gray-800` with `bg-surface`, label colors with `text-muted`
- `SecurityEventsFilters.tsx` — Replaced `bg-white dark:bg-gray-800` with `bg-surface`, `border-gray-*` with `border`, label colors with `text-muted`
- `ExportDialog.tsx` — Replaced `bg-gray-50 dark:bg-gray-800` with `bg-surface`, error div with `bg-danger-muted` + `<Text tone="danger">`
- `JobDetailsPanel.tsx` — Replaced `bg-gray-100 dark:bg-gray-800` with `bg-surface`, error card borders with `border-current text-danger`, error stack bg with `bg-danger-muted`

#### Settings Components Refactored

- `TotpManagement.tsx` — Replaced all raw `text-gray-*` / `bg-gray-*` / `text-green-*` with `<Text tone="muted">`, `bg-surface`, `text-success`, `bg-success`; replaced skeleton colors with `bg-surface`
- `SessionCard.tsx` — Replaced `text-gray-500` with `text-muted`, danger button classes with `text-danger`
- `SessionsList.tsx` — Added `Text` import, replaced danger button classes with `text-danger`, replaced `<p>` with `<Text tone="muted">`
- `OAuthConnectionsList.tsx` — Replaced `text-gray-500` / `bg-gray-100 dark:bg-gray-800` with `<Text tone="muted">` / `bg-surface`, danger button classes with `text-danger`
- `ProfileForm.tsx` — Replaced `bg-gray-100 dark:bg-gray-800` with `bg-surface`, help text with `<Text tone="muted">`

#### Test Updates

- `SecurityEventCard.test.tsx` — Severity assertions use `data-tone` attribute instead of Tailwind classes
- `SecurityMetricsCard.test.tsx` — Styling assertions use semantic class names (`text-danger`, `text-warning`)
- `QueueStatsCard.test.tsx` — Styling assertions use `text-danger` instead of `red`
- `TotpManagement.test.tsx` — Added `Text` mock, updated skeleton/dot selectors to `bg-surface`/`bg-success`/`text-muted`
- `SessionsList.test.tsx` — Added `Text` mock

#### Verification

- Zero raw Tailwind `dark:` color patterns remain in web app source files
- No Tailwind packages in any `package.json` — project uses pure CSS with custom utility classes
- All 218 affected tests pass
- Type-check passes for `@bslt/web`

### Frontend Polish Phase 3: Final Cleanup + Cursor Pointer

#### Global cursor: pointer for Interactive Elements

- Added global CSS rule in `elements.css` for `a`, `button`, `select`, `label[for]`, `input[type='checkbox']`, `input[type='radio']`, `input[type='file']::file-selector-button`, `[role='button']`, `[role='tab']`, `[role='link']`, `[role='menuitem']`, `[role='option']`, `summary`
- Added `cursor: pointer` to `.table-row` (has hover background change)
- Added `cursor: pointer` to `.hover-row` utility class
- Added `cursor: pointer` to `.markdown-content a` links

#### New CSS Utilities

- Added `.text-link` utility class for semantic link coloring (uses `--ui-color-primary` with hover darkening)

#### Remaining Raw CSS Cleanup (9 files)

- `StatusBadge.tsx` — Removed redundant `getStatusStyles()` function; Badge now relies solely on `tone` prop
- `UserActionsMenu.tsx` — Replaced 6 `text-gray-700 dark:text-gray-300` label classes with `text-muted`
- `SecurityEventDetailPage.tsx` — Replaced raw error `<div>` with `<Alert tone="danger">`
- `UserListPage.tsx` — Replaced `<p className="text-gray-500 dark:text-gray-400">` with `<Text tone="muted">`
- `ForgotPasswordShortcut.tsx` — Replaced `<p className="text-sm text-gray-500">` with `<Text size="sm" tone="muted">`
- `AvatarUpload.tsx` — Replaced avatar placeholder with `bg-surface`, `text-muted`, `text-danger`
- `TotpQrCode.tsx` — Replaced fallback with `<Text size="sm" tone="muted">`
- `EmailChangeForm.tsx` — Replaced info `<p>` with `<Text size="sm" tone="muted">`
- `SettingsPage.tsx` — Replaced loading skeletons with `<Skeleton>`, replaced `text-gray-500` with `<Text tone="muted">`, replaced link with `text-link`

#### Test Updates

- `StatusBadge.test.tsx` — Updated 3 styling assertions from Tailwind class checks to `data-tone` attribute checks

#### Verification

- Zero `dark:` patterns in non-test `.tsx` files across `apps/web`
- Zero hardcoded color classes in non-test `.tsx` files
- All type-checks pass (`@bslt/ui`, `@bslt/web`)
- All StatusBadge tests pass (16/16)
- Lint clean on all 9 modified files

### Sprint 2: Multi-Tenant + RBAC + Account Management (continued)

#### E3: Account Lifecycle (2.6)

- Created migration `0022_account_lifecycle.sql` — adds `deactivated_at`, `deleted_at`, `deletion_grace_period_ends` columns to users table
- Updated DB schema types (`User`, `NewUser`, `UpdateUser`) and column mappings with new lifecycle fields
- Created shared domain logic in `lifecycle.schemas.ts` and `lifecycle.logic.ts`:
  - `AccountStatus` type: `'active' | 'deactivated' | 'pending_deletion'`
  - Status derivation: `getAccountStatus()`, `isAccountActive()`, `isAccountDeactivated()`, `isAccountPendingDeletion()`
  - Grace period: `calculateDeletionGracePeriodEnd()`, `isWithinDeletionGracePeriod()`
  - Validation: `canDeactivate()`, `canRequestDeletion()`, `canReactivate()`
  - Request/response schemas: `deactivateAccountRequestSchema`, `deleteAccountRequestSchema`
- Created lifecycle handler (`lifecycle.ts`) with 3 endpoints:
  - `handleDeactivateAccount` — deactivates active account, preserves data
  - `handleRequestDeletion` — initiates 30-day grace period, blocked if sole owner
  - `handleReactivateAccount` — cancels deactivation or deletion (within grace period)
- Orphan prevention: checks all workspace memberships before deletion; blocks if user is sole owner of any workspace
- Wired routes: `users/me/deactivate` POST, `users/me/delete` POST, `users/me/reactivate` POST
- Updated barrel exports through handlers/index.ts, domain/users/index.ts, domain/index.ts, shared/src/index.ts
- Created comprehensive tests:
  - `lifecycle.logic.test.ts` — 17 tests for all status derivation, grace period, and validation logic
  - `lifecycle.test.ts` — 18 handler tests covering auth, not found, state transitions, orphan prevention, grace period expiry
- Fixed mock User objects across 5 test files to include new lifecycle fields
- All type-checks pass: @bslt/shared, @bslt/db, @bslt/core, @bslt/server, @bslt/web
- All tests pass: shared (3281), db (2995), core (2020)

### Auth Stress Test Enforcement (5 Fixes)

Addressed 5 remaining gaps from auth stress test audit (10 of 15 already passed).

#### Fix 1: JWT Clock Skew Tolerance

- Added `VerifyOptions` interface with `clockToleranceSeconds` to `main/server/engine/src/security/jwt.ts`
- Threaded options through `verify()`, `jwtVerify()`, barrel exports (crypto → security → engine)
- Updated `verifyToken()` in `main/server/core/src/auth/utils/jwt.ts` to accept and pass options
- Updated `extractTokenPayload()` in `main/server/core/src/auth/middleware.ts` to accept options
- Added `clockToleranceSeconds?: number` to `AuthConfig.jwt` in `main/shared/src/config/types/auth.ts`
- Tests: 4 new clock skew tolerance tests in `jwt.integration.test.ts`

#### Fix 2: Back-Button Data Leak Prevention

- Added `applyApiCacheHeaders()` to `main/apps/server/src/http/middleware/security.ts` — sets `Cache-Control: no-store, no-cache, must-revalidate` + `Pragma: no-cache`
- Applied in `plugins.ts` onRequest hook for `/api/` routes only
- Updated service worker `networkFirst()` in `sw.js` to check `Cache-Control: no-store` before caching responses
- Tests: 1 new test in `security.test.ts`

#### Fix 3: Offline-Aware Token Refresh

- Modified `AuthService.performRefresh()` in `main/apps/web/src/features/auth/services/AuthService.ts`
- Network errors (`NetworkError`) and timeouts now return `false` without calling `clearAuth()`
- Auth errors (401, invalid token) still call `clearAuth()` as before

#### Fix 4: Deep-Link Preservation Through Login

- Updated `ProtectedRoute.tsx` to append `?returnTo=<encodedPath>` when redirecting unauthenticated users
- Added `isSafeRedirectPath()` open-redirect validation in `redirects.ts` — rejects `//`, `javascript:`, `data:`, absolute URLs
- Updated `getPostLoginRedirect()` to accept optional `returnTo` parameter
- Updated `LoginPage.tsx` to read `returnTo` from URL search params via `useSearchParams()`
- Tests: 10 new returnTo tests in `redirects.test.ts`

#### Fix 5: Zombie Access Token DB Check

- Added `assertUserActive()` utility to `main/server/core/src/auth/middleware.ts` — checks `lockedUntil` field
- Applied in sensitive handlers: password change, email change, TOTP setup/enable/disable, sudo elevation
- Throws `ForbiddenError('Account suspended')` for locked users, `UnauthorizedError('User not found')` for missing users
- Tests: 4 new tests in `middleware.test.ts`

#### Verification

- All targeted tests pass: engine (602), middleware (25), security (48), redirects (21)
- Type-check passes: @bslt/server-engine, @bslt/core, @bslt/shared, @bslt/server, @bslt/web, @bslt/ui
- Lint passes for all changed files

#### E4: Phone/SMS 2FA Stub (2.5) — DEFERRED

- Created SMS provider infrastructure in `server/engine/src/sms/`:
  - `types.ts` — `SmsProvider` interface, `SmsOptions`, `SmsResult`, `SmsConfig`
  - `console.ts` — `ConsoleSmsProvider` for development (logs to stdout)
  - `factory.ts` — `createSmsProvider()` factory (console implemented, twilio/aws-sns stubs throw)
  - `index.ts` — barrel exports
- Created migration `0023_sms_verification.sql` — `sms_verification_codes` table
- Added SMS exports to `@bslt/server-engine` main index
- Tests: console provider (3), factory (4) — all pass
- Full implementation blocked on SMS provider vendor selection

### GitHub-Style Markdown Rendering

- Added table parsing to custom markdown parser (`markdown.tsx`):
  - Detects table start (pipe-separated header + separator row with `| --- |`)
  - Parses column alignment from separator (`:---`, `:---:`, `---:`)
  - Renders `<table>/<thead>/<tbody>/<tr>/<th>/<td>` with proper `textAlign` styles
  - Inline formatting works inside table cells
- Removed inline parser short-circuit that returned raw text when 3+ inline patterns matched
- Replaced `.markdown-content` CSS (~300 lines) with GitHub-flavored styles using `--ui-*` CSS variables throughout
- Added 6 new tests for table parsing, alignment, inline formatting in cells
- All 18 markdown tests pass, type-check and lint clean

### UI Library: Remove Docs Panel + Add JSDoc + Clean Layout Titles

- Removed `DocsPanel` from UI Library page — was displaying markdown docs from `client/ui/docs/` in a side panel, but the docs were stale and the panel cluttered the catalog view
- Deleted related imports and state management from `UILibraryPage.tsx`
- Added JSDoc comments to all layout components for inline IDE documentation
- Cleaned up layout display titles in catalog for consistency

### Sprint 4: Test Backfill & Quality Hardening

#### Server Integration Tests (4.3)

- Created `user-management.integration.test.ts` covering 7 endpoint groups:
  - `GET /api/users/me` — route existence, auth guard (401), method enforcement (POST → 404)
  - `GET /api/users/me/profile-completeness` — same 3-check pattern
  - `PATCH /api/users/me/username` — route, auth, method, schema validation
  - `POST /api/users/me/deactivate` — route, auth, method
  - `POST /api/users/me/delete` — route, auth, method
  - `POST /api/users/me/reactivate` — route, auth, method
  - `GET /api/users/list` — admin endpoint, route, auth, method
- All 747 server tests pass (40 test files)
- Created `tenant-management.integration.test.ts` covering 16 endpoint groups (34 tests):
  - Tenant CRUD: POST /api/tenants, GET /api/tenants/list, GET /api/tenants/:id, POST /api/tenants/:id/update, POST /api/tenants/:id/delete, POST /api/tenants/:id/transfer-ownership
  - Audit: GET /api/tenants/:id/audit-events
  - Members: GET /api/tenants/:id/members, POST /api/tenants/:id/members/add, POST /api/tenants/:id/members/:userId/role, POST /api/tenants/:id/members/:userId/remove
  - Invitations: POST /api/tenants/:id/invitations, GET /api/tenants/:id/invitations/list, POST /api/invitations/:id/accept, POST /api/tenants/:id/invitations/:invitationId/revoke, POST /api/tenants/:id/invitations/:invitationId/resend

#### Domain Tests (4.5)

- Created `tenant.logic.test.ts` — 81 tests covering ScopeError, assertWorkspaceScope, createWorkspaceContext, isWorkspaceScoped, getWorkspaceContext, hasRequiredWorkspaceRole, isAdmin, isOwner
- Created `tenant.workspace.test.ts` — 48 tests covering ForbiddenError-based workspace guards (assertWorkspaceScope, createWorkspaceContext, isWorkspaceScoped)
- Created `billing.entitlements.test.ts` — tests for resolveEntitlements (free tier, canceled, past_due, active, trialing), assertEntitled, assertWithinLimit, isEntitled, hasActiveSubscription
- Created `deletion.logic.test.ts` — tests for calculateHardDeleteDate, isWithinGracePeriod, isSoftDeleted, DEFAULT_GRACE_PERIOD_DAYS constant
- All 3,456 shared tests pass (102 test files)

#### E2E Test Expansion (4.2-4.4)

- Created `public-pages.e2e.ts` — Home page rendering, doc content loading, UI Library category buttons, Pricing page, /clean route
- Created `settings.e2e.ts` — Settings page unauthenticated behavior (error state, login prompt)
- Created `admin.e2e.ts` — All 8 admin routes redirect to login when unauthenticated
- Expanded `auth-pages.e2e.ts`:
  - Added standalone auth routes section: /login, /register, /auth/reset-password, /auth/confirm-email
  - Expanded protected route redirects: dashboard, activities, settings/accounts, settings/billing, workspaces, billing/success, billing/cancel

#### Files Created

- `main/apps/server/src/__tests__/integration/user-management.integration.test.ts`
- `main/shared/src/domain/tenant/tenant.logic.test.ts`
- `main/shared/src/domain/tenant/tenant.workspace.test.ts`
- `main/apps/web/src/__tests__/e2e/public-pages.e2e.ts`
- `main/apps/web/src/__tests__/e2e/settings.e2e.ts`
- `main/apps/web/src/__tests__/e2e/admin.e2e.ts`

#### Server Integration Tests — Continued (4.3)

- Created `activities-apikeys.integration.test.ts` — 17 tests covering:
  - GET /api/activities, GET /api/tenants/:tenantId/activities
  - GET /api/users/me/api-keys, POST /api/users/me/api-keys/create, POST /api/users/me/api-keys/:id/revoke, DELETE /api/users/me/api-keys/:id
- Created `consent-export-legal.integration.test.ts` — 21 tests covering:
  - GET /api/users/me/consent, PATCH /api/users/me/consent/update
  - POST /api/users/me/export, GET /api/users/me/export/:id/status
  - GET /api/legal/current (public), GET /api/users/me/agreements, POST /api/admin/legal/publish
- Created `feature-flags-files.integration.test.ts` — 24 tests covering:
  - Admin feature flag CRUD (list, create, update, delete) + tenant overrides
  - GET /api/feature-flags/evaluate (user)
  - File CRUD: upload, get, delete, download
- Created `webhooks.integration.test.ts` — 17 tests covering:
  - Webhook management: create, list, get, update, delete, rotate-secret

#### Domain Schema Tests — Continued (4.5)

- Created `auth.oauth.test.ts` — 41 tests covering all OAuth schema parsers:
  - oauthProviderSchema, oauthInitiateResponseSchema, oauthCallbackQuerySchema
  - oauthCallbackResponseSchema, oauthLinkResponseSchema, oauthLinkCallbackResponseSchema
  - oauthUnlinkResponseSchema, oauthConnectionSchema, oauthConnectionsResponseSchema
  - oauthEnabledProvidersResponseSchema
- Created `realtime.schemas.test.ts` — 54 tests covering all realtime schemas:
  - setOperationSchema, setNowOperationSchema, listPositionSchema
  - listInsertOperationSchema, listRemoveOperationSchema, operationSchema (union)
  - transactionSchema, recordPointerSchema, recordSchema, recordMapSchema
  - writeResponseSchema, conflictResponseSchema, getRecordsRequestSchema, getRecordsResponseSchema

#### Additional Files Created

- `main/apps/server/src/__tests__/integration/activities-apikeys.integration.test.ts`
- `main/apps/server/src/__tests__/integration/consent-export-legal.integration.test.ts`
- `main/apps/server/src/__tests__/integration/feature-flags-files.integration.test.ts`
- `main/apps/server/src/__tests__/integration/webhooks.integration.test.ts`
- `main/shared/src/domain/auth/auth.oauth.test.ts`
- `main/shared/src/domain/realtime/realtime.schemas.test.ts`

#### Files Modified

- `main/apps/web/src/__tests__/e2e/auth-pages.e2e.ts` — expanded with 11 new test cases

#### Sprint 4 Continuation: Wiring + Feature + Tests (Phases 1-5)

**Phase 1A: TOTP Disable Security Notification**

- Wired `twoFactorDisabledAlert` email in `handleTotpDisable()` handler (fire-and-forget pattern from `password.ts`)
- Added unit test verifying alert is called after successful disable

**Phase 1B: Webhook Event Dispatch Wiring**

- Wired `dispatchWebhookEvent()` calls in auth service (user registration) and lifecycle handlers (deactivate, delete)
- Added tests verifying dispatch calls with correct event types

**Phase 2A: Admin Failure Reason Filter**

- Added `failureReason?: string` to `SecurityEventsFilter` in shared schema
- Added `failureReason` condition to security service query builder
- Added unit test for failureReason filtering

**Phase 2B: Sentry Facade Unit Tests**

- Created `main/server/engine/src/observability/sentry.test.ts` — 14 tests covering:
  - init (with/without tracker), captureError (with/without user context, with/without correlation ID)
  - setUserContext, addBreadcrumb, null-safety (noop when uninitialized)

**Phase 3A: Auth Integration Test Expansion (Mock-Repo Business Logic)**

- Expanded `auth.integration.test.ts` with 6 mock-repo business logic tests:
  - Login locked account → 429 (AccountLockedError via mock lockout count)
  - Register duplicate verified email → 201 (anti-enumeration, sends notification)
  - Register duplicate unverified email → 201 (resends verification)
  - Forgot-password valid email → 200 + email sent
  - Forgot-password non-existent email → 200 + no email sent (anti-enumeration)
  - Login non-existent user → 401

**Phase 4: Supporting Domain Integration Tests (4 new files)**

- Created `admin.integration.test.ts` — route existence + auth guards for all 27 admin endpoints
- Created `notifications.integration.test.ts` — route existence + auth guards for notification endpoints
- Created `billing.integration.test.ts` — route existence + auth guards for billing endpoints
- Created `audit.integration.test.ts` — route existence + auth guards for security events endpoints
- Total: 122 new tests across 4 files

**Phase 5A: Health Integration Tests**

- Created `health.integration.test.ts` — 7 tests using bare Fastify + mocked system routes:
  - GET /health → 200 ok / 503 degraded (db up/down)
  - GET /health/live → 200 alive with uptime
  - GET /health/ready → 200 ready / 503 not_ready (db up/down)
  - GET /health/detailed → 200 healthy / 503 degraded (full service status)
- Required vi.mock for `@bslt/websocket` and `@bslt/db` to avoid real dependencies

#### Files Created (Sprint 4 Continuation)

- `main/server/engine/src/observability/sentry.test.ts`
- `main/apps/server/src/__tests__/integration/admin.integration.test.ts`
- `main/apps/server/src/__tests__/integration/notifications.integration.test.ts`
- `main/apps/server/src/__tests__/integration/billing.integration.test.ts`
- `main/apps/server/src/__tests__/integration/audit.integration.test.ts`
- `main/apps/server/src/__tests__/integration/health.integration.test.ts`

#### Files Modified (Sprint 4 Continuation)

- `main/server/core/src/auth/handlers/totp.ts` — added twoFactorDisabledAlert call
- `main/server/core/src/auth/handlers/totp.test.ts` — added alert verification test
- `main/server/core/src/auth/service.ts` — added dispatchWebhookEvent call after registration
- `main/server/core/src/users/handlers/lifecycle.ts` — added dispatchWebhookEvent calls
- `main/shared/src/domain/admin/admin.security-schemas.ts` — added failureReason to filter
- `main/server/core/src/admin/securityService.ts` — added failureReason query condition
- `main/server/core/src/admin/securityService.test.ts` — added failureReason filter test
- `main/apps/server/src/__tests__/integration/auth.integration.test.ts` — added mock-repo business logic tests

#### Verification (Sprint 4 Continuation)

- Server tests: 50 files, 998 passed, 0 failures, 3 todo
- Server-engine tests: 48 files, 712+ tests, 0 failures
- Core pre-existing failures: 7 files (routes.test.ts prefix `/api` → `/api/v1`, login/verify handler mock mismatches) — not introduced by Sprint 4 changes
- 7 TODO items checked off

### Sprint 5.7: UX Polish & Empty States

Hardening sprint — no new features, only polish. Addressed inconsistent empty states, missing error pages, loading state inconsistency, and unwired features.

#### Phase 1: EmptyState Component (UI Library)

- Created `EmptyState` component in `main/client/ui/src/components/EmptyState.tsx` — reusable placeholder for empty content areas with optional icon, title, description, and call-to-action button
- Props: `icon?: ReactNode`, `title: string`, `description?: string`, `action?: { label, onClick }`, `className?: string`
- Uses existing `.empty-state` CSS utility class from `utilities.css`
- Created `EmptyState.test.tsx` — 9 tests covering all prop combinations
- Exported from UI library barrel (`components/index.ts`, `src/index.ts`)

#### Phase 2: Error Pages (404 + 403)

- Created `NotFoundPage.tsx` — centered EmptyState with "Page not found" + "Go to Home" action
- Created `ForbiddenPage.tsx` — EmptyState with "Access denied" + "Go to Home" action
- Added `{ path: 'forbidden', element: ForbiddenPage }` route
- Added `{ path: '*', element: NotFoundPage }` catch-all route (eliminates blank screen on bad URLs)

#### Phase 3: Standardize Empty States (6 components)

Replaced inconsistent plain-text `<Text tone="muted">` empty states with `EmptyState` component:

- `ApiKeysManagement.tsx` — "No API keys yet" + "Create API Key" action button
- `ActivityFeed.tsx` — "No recent activity" + "Your recent actions will appear here"
- `NotificationDropdown.tsx` — "All caught up" + "No new notifications"
- `MembersList.tsx` — "No members yet" + "Invite your first teammate to get started"
- `InvitationsList.tsx` — "No pending invitations" + "Invite teammates to collaborate"

#### Phase 4: Loading State Consistency (Spinner → Skeleton)

- `ApiKeysManagement.tsx` — Replaced `<Spinner />` with Skeleton rows matching table structure (header + 3 data rows)
- `ActivityFeed.tsx` — Replaced `<Spinner />` with 3 Skeleton rows matching ActivityItem layout (badge + text lines + timestamp)

#### Phase 5: SectionErrorBoundary + NetworkStatus

- Created `SectionErrorBoundary.tsx` — wraps `ErrorBoundary` with compact fallback: "This section encountered an error" + error message + "Try Again" button
- Created `NetworkStatus.tsx` — monitors `online`/`offline` events, shows debounced (2s) toast via `toastStore` on disconnect/reconnect
- Created `index.ts` barrel for `main/apps/web/src/app/components/`
- Created tests: `SectionErrorBoundary.test.tsx` (3 tests), `NetworkStatus.test.tsx` (5 tests)
- Wired `<NetworkStatus />` into `App.tsx` next to `<AppToaster />`
- Wrapped all 3 DashboardPage Card sections with `<SectionErrorBoundary>`

#### Phase 6: Onboarding Route Wiring

- Created `main/apps/web/src/pages/OnboardingPage.ts` barrel
- Added `{ path: 'onboarding', element: OnboardingPage }` inside ProtectedRouteWrapper children

#### Test Updates

- Updated `ApiKeysManagement.test.tsx` — loading state now checks `.skeleton` class instead of Spinner testid; empty state checks split title/description/action
- All 33 new/modified tests pass (9 EmptyState + 16 ApiKeysManagement + 3 SectionErrorBoundary + 5 NetworkStatus)

#### Files Created

- `main/client/ui/src/components/EmptyState.tsx`
- `main/client/ui/src/components/EmptyState.test.tsx`
- `main/apps/web/src/pages/NotFoundPage.tsx`
- `main/apps/web/src/pages/ForbiddenPage.tsx`
- `main/apps/web/src/pages/OnboardingPage.ts`
- `main/apps/web/src/app/components/SectionErrorBoundary.tsx`
- `main/apps/web/src/app/components/SectionErrorBoundary.test.tsx`
- `main/apps/web/src/app/components/NetworkStatus.tsx`
- `main/apps/web/src/app/components/NetworkStatus.test.tsx`
- `main/apps/web/src/app/components/index.ts`

#### Files Modified

- `main/client/ui/src/components/index.ts` — added EmptyState exports
- `main/client/ui/src/index.ts` — added EmptyState exports
- `main/apps/web/src/app/routes.tsx` — added 404/403/onboarding routes
- `main/apps/web/src/app/App.tsx` — added NetworkStatus
- `main/apps/web/src/features/settings/components/ApiKeysManagement.tsx` — EmptyState + Skeleton
- `main/apps/web/src/features/settings/components/ApiKeysManagement.test.tsx` — updated assertions
- `main/apps/web/src/features/activities/components/ActivityFeed.tsx` — EmptyState + Skeleton
- `main/apps/web/src/features/notifications/components/NotificationDropdown.tsx` — EmptyState
- `main/apps/web/src/features/workspace/components/MembersList.tsx` — EmptyState
- `main/apps/web/src/features/workspace/components/InvitationsList.tsx` — EmptyState
- `main/apps/web/src/features/dashboard/pages/DashboardPage.tsx` — SectionErrorBoundary

### Sprint 6.3: Platform Developer Experience

Implemented 5 phases improving developer experience across the platform.

#### Phase 1: Error Handling & Logging Enhancement

- Added `LoggingConfig` interface (`clientErrorLevel`, `requestContext`) to `ServerConfig`
- Added `LOG_CLIENT_ERROR_LEVEL` and `LOG_REQUEST_CONTEXT` env vars to `ServerEnvSchema`
- Enhanced `middleware.ts` onResponse hook to include IP and userAgent (gated by `requestContext` toggle)
- Replaced flat onError logging with severity-based routing: 5xx → error level with full stack trace + request context; 4xx → configurable level (default `warn`) with summary only
- Added `clientErrorLevel` option to `PluginOptions` for global error handler severity
- Updated middleware tests: IP/userAgent presence, requestContext=false exclusion, 5xx error logging with context, 4xx warn-level with summary, clientErrorLevel config respected

**Files modified:** `shared/config/types/infra.ts`, `shared/config/types/index.ts`, `shared/config/env.schema.ts`, `apps/server/config/infra/server.ts`, `apps/server/logger/middleware.ts`, `apps/server/http/plugins.ts`, `apps/server/server.ts`, `apps/server/logger/middleware.test.ts`

#### Phase 2: DB Reset Command Enhancement

- Rewrote `main/tools/scripts/db/reset.ts`: DROP SCHEMA CASCADE → pushSchema() → seed()
- Added `--force` flag to skip confirmation prompt
- Added readline confirmation prompt ("This will DROP all tables and data. Continue?")
- Production guard exits with error if `NODE_ENV=production`

#### Phase 3: Module Scaffold CLI

- Created `main/tools/scripts/scaffold/scaffold-module.ts` — generates 7 template files (index, types, service, service.test, handlers, handlers.test, routes) following the activities module pattern
- Validates kebab-case names, rejects existing modules
- Appends route import + `registerRouteMap` to `routes/routes.ts`
- Created `scaffold-module.test.ts` — 19 tests covering validation, file generation, barrel exports, route registration
- Added `pnpm scaffold:module` script to package.json
- Created `docs/dev/module-creation.md`

**Files created:** `scaffold/scaffold-module.ts`, `scaffold/scaffold-module.test.ts`, `docs/dev/module-creation.md`

#### Phase 4: API Versioning Foundation

- Changed route prefix from `/api` to `/api/v1`
- Added backward-compat redirect: `/api/*` → `/api/v1/*` (excludes `/api/v1` and `/api/docs`)
- Added `RouteDeprecation` interface and `deprecated` field to `RouteDefinition`
- Added deprecation header support via `onSend` hook: `Deprecation`, `Sunset`, `X-Deprecation-Notice`
- Added `deprecated` boolean to `RouteRegistryEntry`
- Updated all route test assertions (`/api` → `/api/v1`, `deprecated: false`)
- Created `docs/dev/api-versioning.md`

**Files modified:** `routes/routes.ts`, `routing/routing.ts`, `routing/route-registry.ts`, `routing/index.ts`, `routes/routes.test.ts`, `routing/routing.test.ts`
**Files created:** `docs/dev/api-versioning.md`

#### Phase 5: Route Manifest & Client Sync Check

- Created `main/tools/scripts/audit/route-manifest.ts` — exports JSON manifest of all registered routes
- Created `main/tools/scripts/audit/api-client-sync.ts` — compares route manifest against `ApiClient` methods
- Added `pnpm route:manifest` and `pnpm audit:api-sync` scripts
- Full auto-generated typed client deferred to ROADMAP

**Files created:** `audit/route-manifest.ts`, `audit/api-client-sync.ts`

---

## Thursday, February 12, 2026

### Sprint 1.3 + 2.5: Security Intelligence & Phone/SMS 2FA (Full Implementation)

Completed the two remaining deferred items from Sprint 1 and 2, closing both sprints at 100%.

#### Phase 1: Backend Integration (4 items)

- **SMS Provider Wiring (1.2):** Added `sms?: SmsProvider` to `IServiceContainer` and `AppContext`. Wired `createSmsProvider(config)` in server app constructor. Removed hacky `(ctx as unknown as { sms })` cast from sms-challenge handler.
- **Login Fingerprint Detection (1.1):** Replaced session-based `isNewDevice` check in `login.ts` with `generateDeviceFingerprint()` + `isKnownDevice()` from trusted_devices table. Login now records device access via `recordDeviceAccess()` on successful auth.
- **SMS Challenge in Login (1.3):** Added SMS 2FA detection to `authenticateUser()` — when `phoneVerified === true` and `totpEnabled === false`, returns 202 with `SmsChallengeResult`. Added `SmsChallengeError` class to `AuthService`. TOTP takes priority when both are enabled.
- **Token Version Invalidation (1.4):** Added `incrementTokenVersion(userId)` to users repository. JWT access tokens now include `tokenVersion` claim. Refresh handler checks `tokenVersion` match and rejects stale tokens. Created `POST /api/auth/invalidate-sessions` route.

#### Phase 2: Client API Hooks (2 items)

- **Device Management:** Created `client/api/src/devices/` — `client.ts` (listDevices, trustDevice, revokeDevice, invalidateSessions), `hooks.ts` (useDevices with state management), barrel exports.
- **Phone/SMS:** Created `client/api/src/phone/` — `client.ts` (setPhone, verifyPhone, removePhone, sendSmsCode, verifySmsCode), `hooks.ts` (usePhone with state management), barrel exports.

#### Phase 3: UI Components (3 items)

- **DevicesList Component:** Created `DevicesList.tsx` in settings — device list with UA parsing, trust/revoke actions, loading/error/empty states. Integrated into Sessions tab of SettingsPage.
- **PhoneManagement Component:** Created `PhoneManagement.tsx` in settings — multi-step flow (idle → verify → verified), masked phone display, remove option. Integrated into Security tab of SettingsPage.
- **SMS Challenge Login Screen:** Wired `SmsChallengeError` catch in `LoginForm.tsx`. Created `SmsChallenge.tsx` component (auto-send on mount, 6-digit code entry, resend cooldown, cancel). Fixed pre-existing bug where `onTotpVerify` was never wired through `AuthFormProps`.

#### Phase 4: Tests

- `invalidate-sessions.test.ts` — 9 tests for handler (auth, token version increment, token revocation, cookie clear, error handling)
- `devices/client.test.ts` — 24 tests for all API methods + error handling
- `phone/client.test.ts` — 42 tests for all API methods + error handling
- `DevicesList.test.tsx` — 18 tests (loading, error, empty, device list, interactions, UA parsing)
- `PhoneManagement.test.tsx` — 21 tests (idle, verify, verified states, error handling)

#### Files Created

- `main/client/api/src/devices/client.ts`, `hooks.ts`, `index.ts`
- `main/client/api/src/phone/client.ts`, `hooks.ts`, `index.ts`
- `main/apps/web/src/features/settings/components/DevicesList.tsx`, `DevicesList.test.tsx`
- `main/apps/web/src/features/settings/components/PhoneManagement.tsx`, `PhoneManagement.test.tsx`
- `main/apps/web/src/features/auth/components/SmsChallenge.tsx`
- `main/server/core/src/auth/handlers/invalidate-sessions.ts`, `invalidate-sessions.test.ts`
- `main/client/api/src/devices/client.test.ts`
- `main/client/api/src/phone/client.test.ts`

#### Files Modified

- `main/apps/server/src/types/context.ts` — added `sms` to service container
- `main/apps/server/src/app.ts` — wired SMS provider
- `main/server/core/src/auth/types.ts` — added `sms` to AppContext
- `main/server/core/src/auth/handlers/login.ts` — fingerprint-based device detection
- `main/server/core/src/auth/service.ts` — SMS challenge detection in authenticateUser
- `main/server/core/src/auth/handlers/sms-challenge.ts` — use `ctx.sms` instead of cast
- `main/server/core/src/auth/utils/jwt.ts` — include tokenVersion in access token
- `main/server/core/src/auth/handlers/refresh.ts` — check tokenVersion on refresh
- `main/server/db/src/repositories/users/users.ts` — added incrementTokenVersion
- `main/apps/web/src/features/auth/hooks/useAuth.ts` — added sendSmsCode, verifySmsLogin
- `main/apps/web/src/features/auth/components/AuthForms.tsx` — wired TOTP + SMS callbacks
- `main/apps/web/src/features/auth/components/LoginForm.tsx` — SMS challenge handling
- `main/apps/web/src/features/auth/pages/AuthPage.tsx` — wired SMS callbacks
- `main/apps/web/src/features/auth/pages/LoginPage.tsx` — wired SMS callbacks
- `main/apps/web/src/features/settings/pages/SettingsPage.tsx` — integrated DevicesList + PhoneManagement
- `main/client/api/src/index.ts` — added device + phone exports

#### Sprint Status

- Sprint 1: **8/8 COMPLETE** (was 7/8, added 1.3 Security Intelligence)
- Sprint 2: **15/15 COMPLETE** (was 14/15, added 2.5 Phone/SMS 2FA)

### Sprint 4 Continuation: Account Lifecycle + RBAC + Security Notifications

Final Sprint 4 test backfill session — added account lifecycle enforcement in login flow, RBAC integration tests, and security notification tests.

#### Feature: Account Lifecycle Login Enforcement

- Added `ACCOUNT_DEACTIVATED` and `ACCOUNT_DELETED` to `LOGIN_FAILURE_REASON` in `auth/types.ts`
- Added lifecycle check in `authenticateUser()` after password verification: deactivated accounts blocked, deleted accounts past grace period blocked, deleted within grace period allowed (for reactivation)
- Uses `InvalidCredentialsError` for anti-enumeration (generic 401 regardless of account state)

#### Integration Tests

- **R1 (auth.integration.test.ts):** 2 mock-repo tests — deactivated account login rejected (401), deleted account past grace period login rejected (401)
- **R2 (rbac.integration.test.ts):** NEW file — 20 tests covering route existence (7) and auth guards (13) for all tenant endpoints (CRUD, members, invitations, audit)
- **R3 (auth.integration.test.ts):** Password reset sends `passwordChangedAlert` email via mock verification

#### Bug Fixes

- Fixed `login.test.ts` pre-existing failure: added missing `logNewDeviceLogin` mock to `../security` mock object (4 tests were returning 500 due to `undefined is not a function`)
- Fixed `test-utils.ts` argon2 config: changed `timeCost: 1` to `timeCost: 2` (argon2 minimum valid value)

#### Files Created

- `main/apps/server/src/__tests__/integration/rbac.integration.test.ts`

#### Files Modified

- `main/server/core/src/auth/types.ts` — added failure reason constants
- `main/server/core/src/auth/service.ts` — added lifecycle check in authenticateUser
- `main/server/core/src/auth/handlers/login.test.ts` — added missing logNewDeviceLogin mock
- `main/apps/server/src/__tests__/integration/auth.integration.test.ts` — added R1 + R3 tests
- `main/apps/server/src/__tests__/integration/test-utils.ts` — fixed argon2 timeCost

#### Verification

- Core tests: 141 files, 3,031 tests, 0 failures (was 4 failures before logNewDeviceLogin fix)
- Integration tests: auth (54 pass) + rbac (20 pass) = 74 tests, 0 failures

### Sprint 6.4: Scaling & Performance Infrastructure

Implemented core scaling infrastructure: Redis cache provider, cache-aside patterns, database read replica routing, and cross-instance pub/sub wiring.

#### Phase 1: Redis Cache Provider

- Created `RedisCacheProvider` in `main/server/engine/src/cache/providers/redis.ts` — ioredis-backed implementation satisfying `CacheProvider` interface with JSON serialization, tag-based invalidation via Redis Sets, pipeline for bulk ops, local stats tracking
- Added `RedisCacheConfig` interface to shared cache types (host, port, password, db, tls, connectTimeout, commandTimeout)
- Updated factory (`createCache()`) to select provider based on `provider: 'redis'` config or `useExternalProvider: true` app-level config
- Added `CACHE_PROVIDER=local|redis` env var support in engine config loader + `REDIS_PASSWORD`, `REDIS_DB` env vars
- Installed `ioredis` in `@bslt/server-engine`
- Updated all barrel exports (shared, engine types, providers, factory)

#### Phase 2: Cache-Aside Pattern for Hot Data

- Created `main/server/core/src/cache/` module — `CacheKeys`, `CacheTags`, `CacheTTL` constants, `cacheAside()` generic helper
- Wired cache-aside into `handleMe` user profile handler — cache check before DB, populate on miss, with TTL and tags

#### Phase 3: Database Read Replica Foundation

- Added `DATABASE_READ_REPLICA_URL` env var to `DatabaseEnv` schema
- Added `readReplicaConnectionString` to `PostgresConfig`
- Created `ReadReplicaClient` in `main/server/db/src/read-replica.ts` — primary/replica pair with read/write aliases, falls back to primary when no replica configured
- Exported from `@bslt/db` barrel

#### Phase 4: PubSub Wiring + Stateless Verification

- Added `InfrastructureOptions.onPubSubMessage` callback to `createInfrastructure()`
- Wired `pgPubSub` → `pubsub.publishLocal()` in `app.ts` for cross-instance WebSocket notifications
- Called `pubsub.setAdapter(pgPubSub)` for bidirectional cross-instance messaging
- Created `docs/dev/horizontal-scaling.md` — cache provider selection, read replica setup, WebSocket cross-instance routing, stateless design analysis, deployment recommendations

#### Tests (76 total)

- Redis provider: 57 tests (get/set/has/delete, bulk ops, tags, stats, lifecycle, serialization, TTL, error handling)
- Factory: 10 tests (provider selection, env config, options passthrough)
- Cache-aside: 5 tests (miss/hit/TTL/tags/undefined handling)
- Read-replica: 4 tests (no replica/empty/with replica/URL verification)

#### Files Created

- `main/server/engine/src/cache/providers/redis.ts`
- `main/server/engine/src/cache/providers/redis.test.ts`
- `main/server/core/src/cache/keys.ts`, `cache-aside.ts`, `index.ts`, `cache-aside.test.ts`
- `main/server/db/src/read-replica.ts`, `read-replica.test.ts`
- `docs/dev/horizontal-scaling.md`

#### Files Modified

- `main/shared/src/utils/cache/types.ts` — added RedisCacheConfig
- `main/shared/src/utils/cache/index.ts` — added RedisCacheConfig export
- `main/shared/src/index.ts` — added RedisCacheConfig export
- `main/shared/src/config/types/infra.ts` — added externalConfig fields, readReplicaConnectionString
- `main/shared/src/config/env.schema.ts` — added REDIS_PASSWORD, REDIS_DB, DATABASE_READ_REPLICA_URL
- `main/apps/server/src/config/infra/cache.ts` — pass password, db through from env
- `main/apps/server/src/config/infra/database.ts` — load readReplicaConnectionString
- `main/server/engine/src/cache/config.ts` — Redis provider support in env config loader
- `main/server/engine/src/cache/factory.ts` — Redis provider selection
- `main/server/engine/src/cache/types.ts` — RedisCacheConfig re-export
- `main/server/engine/src/cache/providers/index.ts` — RedisCacheProvider exports
- `main/server/engine/src/cache/index.ts` — Redis exports
- `main/server/engine/package.json` — added ioredis dependency
- `main/server/db/src/index.ts` — ReadReplicaClient exports
- `main/apps/server/src/infrastructure.ts` — InfrastructureOptions, onPubSubMessage callback
- `main/apps/server/src/app.ts` — wired pubsub callback + adapter
- `main/server/core/src/users/types.ts` — added optional cache to UsersModuleDeps
- `main/server/core/src/users/handlers/profile.ts` — cache-aside for handleMe

#### Deferred Items

- Session store in Redis (JWT-based auth, no server sessions)
- Redis-backed job queue (MemoryQueueStore sufficient for single-instance)
- Redis pub/sub for WebSocket (PostgresPubSub handles cross-instance messaging)
- CDN/asset optimization (deployment-specific, Vite already does content hashing)
- Load testing (requires dedicated infrastructure)

### Sprint 4 Iteration 2: Auth Business Logic & Security Notification Integration Tests

Deep business logic integration tests for public auth routes and security notification flows. All tests use mock repositories via `createTestServer()` with Fastify `inject()`.

#### Phase 1: Auth Business Logic Tests (8 tests)

Added to `auth.integration.test.ts` mock-repo business logic describe block:

- **Register success** — creates user in DB, sends verification email, returns 201
- **Login success** — returns tokens + set-cookie, real argon2 hash verification, nested transaction for token family creation
- **Logout with cookie** — clears refreshToken cookie, revokes token family
- **Verify-email success** — marks user verified, auto-login with tokens returned
- **Verify-email invalid token** — returns error for unknown token hash
- **Reset-password invalid token** — returns error for unknown token hash
- **Resend-verification success** — sends email for unverified user
- **Resend-verification anti-enum** — returns 200 without sending for unknown email

#### Phase 2: Security Notification Tests (3 tests)

New `security notification flows` describe block in `auth.integration.test.ts`:

- **Email change confirm** — sends alert email to old address with revert link
- **Email change revert** — reverts email to original address
- **New device login alert** — sends new device alert email on login from unknown device

#### Infrastructure Improvements

- Added `hashPassword` import for real argon2 hash in login tests (lightweight params: memoryCost 1024, timeCost 2)
- Fixed `mockTx.transaction` to support nested `withTransaction` calls (was causing hangs)
- Added 4 missing mock repo sections: `trustedDevices`, `memberships`, `emailChangeTokens`, `emailChangeRevertTokens`

#### TODO Items Checked Off (8 items)

Auth integration (5): register, login, logout, reset-password, verify-email
Security notifications (3): new device login alert, email change revert link, clicking revert link

### Sprint 6.5: Undo/Redo UI Integration

Wired the existing undo/redo infrastructure (UndoRedoStack, undoRedoStore, useUndoRedoShortcuts) to the UI layer with mutation integration, keyboard shortcuts, toast feedback, and toolbar buttons.

#### Phase 1: Toast Action Support

- Added `action?: { label: string; onClick: () => void }` to `ToastMessage` type in `toastStore.ts`
- Rendered action button in `Toast.tsx` (between content and dismiss)
- Added `.toast-action` CSS styles using `--ui-*` tokens (underlined small text button)

#### Phase 2: `useUndoableMutation` Hook

- Created `useUndoableMutation.ts` — wraps `useMutation` to auto-push undo transactions on success
- Captures state snapshot via `getSnapshot()` before mutation (in `onMutate`)
- Compares old vs. new values on success, creates `SetOperation` entries for changed keys
- Pushes transaction to `undoRedoStore` when changes detected

#### Phase 3: `useUndoRedoController` Hook

- Created `useUndoRedoController.ts` — integrates `undoRedoStore` + `useUndoRedoShortcuts` + toast notifications
- Undo shows "Action undone" toast with "Redo" action button
- Redo shows "Action redone" toast
- Keyboard shortcuts (Ctrl+Z / Ctrl+Y / Ctrl+Shift+Z) auto-registered
- Exposes `undo`, `redo`, `canUndo`, `canRedo`, `undoCount`, `redoCount`

#### Phase 4: `UndoRedoToolbar` Component

- Created `UndoRedoToolbar.tsx` in `@bslt/ui` — undo/redo buttons with platform-aware shortcut hints
- Uses `getUndoShortcutText()`/`getRedoShortcutText()` for Mac/Windows labels
- Proper `role="toolbar"` + `aria-label` accessibility

#### Phase 5: App Shell Wiring

- Created `AppUndoRedo.tsx` wrapper component using `useUndoRedoController`
- Added to `AppTopLayout.tsx` (visible when authenticated, next to Side Peek button)

#### Tests (39 total)

- `useUndoableMutation.test.ts` — 6 tests (transaction push, set operations, snapshot capture, no-change skip, onSuccess passthrough, key filtering)
- `useUndoRedoController.test.ts` — 8 tests (undo/redo with toasts, handler apply, empty stack, inverse transaction, counts)
- `UndoRedoToolbar.test.tsx` — 7 tests (render, disabled states, click handlers, accessibility, shortcut text)
- `Toast.test.tsx` — 3 new tests (action render, click handler, absence when undefined)

#### Files Created

- `main/client/react/src/hooks/useUndoableMutation.ts`
- `main/client/react/src/hooks/useUndoableMutation.test.ts`
- `main/client/react/src/hooks/useUndoRedoController.ts`
- `main/client/react/src/hooks/useUndoRedoController.test.ts`
- `main/client/ui/src/components/UndoRedoToolbar.tsx`
- `main/client/ui/src/components/UndoRedoToolbar.test.tsx`
- `main/apps/web/src/app/layouts/AppUndoRedo.tsx`

#### Files Modified

- `main/client/react/src/stores/toastStore.ts` — added `action` to `ToastMessage`
- `main/client/react/src/hooks/index.ts` — barrel exports
- `main/client/react/src/index.ts` — barrel exports
- `main/client/ui/src/components/Toast.tsx` — action button rendering
- `main/client/ui/src/components/Toast.test.tsx` — action tests
- `main/client/ui/src/components/index.ts` — UndoRedoToolbar export
- `main/client/ui/src/index.ts` — UndoRedoToolbar export
- `main/client/ui/src/styles/components.css` — toast-action styles
- `main/apps/web/src/app/layouts/AppTopLayout.tsx` — AppUndoRedo integration

#### Verification

- Type-check passes: `@bslt/react`, `@bslt/ui`, `@bslt/web`
- All 39 new tests pass

---

## Outcomes

- **Shared tests**: 104+ files, 3,500+ tests, 0 failures
- **Server tests**: 50 files, 998+ tests, 0 failures (excluding pre-existing routes.test.ts prefix failures)
- **Web tests**: 121 files, 1,809 tests, 0 failures (was 5 failed / 22 broken)
- **Core tests**: 141 files, 3,031 tests, 0 failures
- Sprint 1 complete (8/8) and Sprint 2 complete (15/15) — all deferred items implemented
- Sprint 4 test backfill: 18 integration test files, 6 domain test files, 4 E2E test files, 1 engine test file created; iteration 2 added 11 deep business logic tests (auth + security notifications)
- Zero hardcoded CSS in apps/web (full design system adoption)
- CI/CD pipeline stabilized with successful full runs
- Docker build context restored (bare `**` glob excluded all source files)
- 12 CodeQL static analysis warnings resolved across 10 files
- Zero `eslint-disable` inline comments remaining in production code
- Account lifecycle (deactivate/delete/reactivate) implemented with orphan prevention
- 5 auth stress test fixes applied (clock skew, data leak, offline refresh, deep links, zombie tokens)
- Sprint 5.7 UX polish: EmptyState component, 404/403 pages, 6 empty states standardized, 2 loading states → Skeleton, SectionErrorBoundary + NetworkStatus, onboarding route wired
- Sprint 6.4 scaling infrastructure: Redis cache provider (ioredis), cache-aside pattern, read replica routing, cross-instance pub/sub wiring, horizontal scaling docs — 76 new tests

---

## Thursday, February 12, 2026

### CI/CD Pipeline Hardening

- **Performance**: Added `lighthouse` job to `ci.yml` for automated Lighthouse CI runs on full builds.
- **Reliability**: Added `smoke-test` job to `deploy.yml` to verify `/api/health` 200 OK status after deployment stabilization.
- **Security**: Refactored secret handling in `deploy`, `infra-deploy`, `infra-destroy`, and `rollback` workflows to use intermediate env vars (`INPUT_*`, `tfvars`) instead of direct shell interpolation.
- **Tooling**: Upgraded `pnpm` to 10.26.2 and locked Node.js to v20 in `actions/setup-node`.

### Scaling Infrastructure & Configuration

- **Pub/Sub**: Wired `pgPubSub` adapter into `SubscriptionManager` in `app.ts` to enable cross-instance WebSocket notifications (horizontal scaling support).
- **Database**: Added `DATABASE_READ_REPLICA_URL` support in `database.ts` for read-replica connection routing.
- **Cache**: Extended `loadCacheConfig` to support `REDIS_PASSWORD` and `REDIS_DB` env vars.
- **Refactor**: Replaced hardcoded time literals with `MS_PER_*` constants across `auth`, `rate-limit`, `cache`, and `queue` configs.

### Documentation Expansion

- **Operations**:
  - `docs/deploy/backup-restore.md`: New guide for pg_dump/restore and managed snapshots.
  - `docs/deploy/migrations.md`: New runbook for the custom SQL migration system.
- **Development**:
  - `docs/dev/code-review.md`: New checklist for code quality.
  - Updated `configuration.md`, `horizontal-scaling.md`, `security.md`, `testing.md` to reflect new infrastructure capabilities.

---

## TODO Consolidation (2026-02-13)

Moved completed checklist entries from `docs/todo/TODO.md` to keep TODO focused on open work.

- Migrated checked items: 822
- Source: `docs/todo/TODO.md`

### Migrated Checked Items

- [x] DB artifacts: migrations + schema constants + repositories exist
- [x] `pnpm db:audit` passes
- [x] Tests: tenant/membership/invitation repo/schema tests pass
- [x] Shared permissions/policy engine compiles
- [x] Tests: permission matrix tests (or equivalent) pass
- [x] Server boots with realtime routes registered
- [x] Smoke: subscribe -> publish -> receive (manual or test harness)
- [x] Tests: realtime handler/service tests pass
- [x] Tests: websocket lifecycle/stats tests pass
- [x] Smoke: connect/disconnect/reconnect under dev server
- [x] Tests: image/audio/video processor tests pass
- [x] Verify no HTTP endpoints expected here (this is server-only module verification)
- [x] Desktop dev starts and loads renderer
- [x] Basic IPC handlers do not crash on startup
- [x] `ProtectedRoute.tsx` renders children when authenticated
- [x] `ProtectedRoute.tsx` redirects to login when unauthenticated
- [x] Tests: ProtectedRoute tests pass (in `client/ui/layouts/layers/`)
- [x] `plans` — migration 0003, schema constant, repo CRUD
- [x] `subscriptions` — migration 0003, schema constant, repo CRUD
- [x] `customer_mappings` — migration 0003, schema constant, repo CRUD
- [x] `invoices` — migration 0003, schema constant, repo CRUD
- [x] `payment_methods` — migration 0003, schema constant, repo CRUD
- [x] `billing_events` — migration 0003, schema constant, repo CRUD
- [x] `pnpm db:audit` passes for billing tables
- [x] `notifications` — migration 0004, schema, repo
- [x] `push_subscriptions` — migration 0004, schema, repo
- [x] `notification_preferences` — migration 0004, schema, repo
- [x] `jobs` — migration 0005, schema, repo
- [x] `audit_events` — migration 0005, schema, repo
- [x] `webhooks` — migration 0005, schema, repo
- [x] `webhook_deliveries` — migration 0005, schema, repo
- [x] `feature_flags` — migration 0006, schema, repo
- [x] `tenant_feature_overrides` — migration 0006, schema, repo
- [x] `usage_metrics` — migration 0007, schema, repo
- [x] `usage_snapshots` — migration 0007, schema, repo
- [x] `legal_documents` — migration 0008, schema, repo
- [x] `user_agreements` — migration 0008, schema, repo
- [x] `consent_logs` — migration 0008, schema, repo
- [x] `data_export_requests` — migration 0011, schema, repo
- [x] `files` — migration 0013, schema, repo
- [x] `email_templates` — migration 0014, schema, repo
- [x] `email_log` — migration 0014, schema, repo
- [x] `tenant_settings` — migration 0015, schema, repo
- [x] `activities` — migration 0016, schema, repo
- [x] `pnpm db:audit` passes for all supporting tables
- [x] `api_keys` table: key_hash, scopes, tenant_id, expires_at, revoked_at columns exist
- [x] Repo: findByKeyHash, findByUserId, findByTenantId, create, revoke, updateLastUsedAt work
- [x] Domain: `shared/domain/api-keys/**` types/schemas compile
- [x] Tests: api-keys repo tests pass
- [x] Admin plan CRUD: list, create, get, update, deactivate, sync-to-stripe endpoints reachable
- [x] Billing routes conditionally registered on `config.billing.enabled`
- [x] Webhook routes: Stripe + PayPal endpoints accept POST
- [x] Provider factory: `billing/factory.ts` returns correct provider for Stripe/PayPal
- [x] Entitlements domain logic: `billing.entitlements.ts` compiles and exports resolvers
- [x] Client UI: BillingSettingsPage, PricingPage, CheckoutSuccessPage, CheckoutCancelPage render
- [x] Client API: `billing/client.ts`, `admin.ts`, `hooks.ts` compile
- [x] Tests: billing handler/provider tests pass
- [x] Security events table: 18+ event types with severity levels exist
- [x] Event logging fires on: login, OAuth, lockout, TOTP (`core/auth/security/audit.ts`, `events.ts`)
- [x] Admin API: `GET /api/admin/security/events`, `/events/:id`, `/metrics`, `/events/export` reachable
- [x] General audit log: `audit_events` table + repo functional
- [x] Admin UI: SecurityEventsPage, SecurityEventDetailPage, SecurityEventsTable, SecurityEventsFilters, SecurityMetricsCard, SecurityEventCard, ExportDialog render
- [x] Hooks: useSecurityEvents, useSecurityMetrics, useSecurityEvent, useExportEvents compile
- [x] Tests: security event tests pass
- [x] `notifications` table + routes wired and reachable
- [x] `email_templates` + `email_log` tables + repos functional
- [x] Mailer module: client abstraction, SMTP transport, console provider (dev), template renderer all work
- [x] Notification service: `core/notifications/service.ts` + `handlers.ts` compile
- [x] Push provider: FCM provider + factory pattern compiles
- [x] Client API: `notifications/client.ts`, `hooks.ts` compile
- [x] Tests: notification service/handler tests pass
- [x] `files` table + repository functional
- [x] S3 storage provider (`server-engine/storage/providers/s3.ts`) compiles
- [x] Local storage provider works for dev
- [x] Presigned URL generation functional
- [x] Tests: storage provider tests pass
- [x] `activities` table + repository functional
- [x] Domain logic compiles (even if partial)
- [x] Tests: activity repo tests pass
- [x] `feature_flags` + `tenant_feature_overrides` tables + repos functional
- [x] `usage_metrics` + `usage_snapshots` tables + repos functional
- [x] Tests: feature flag / metering repo tests pass
- [x] `legal_documents`, `user_agreements`, `consent_logs` tables + repos functional
- [x] `data_export_requests` table + repo functional
- [x] Deletion domain logic: `deletion.logic.ts` + `deletion.schemas.ts` compile
- [x] Tests: compliance domain logic tests pass
- [x] Client: `RealtimeContext.tsx`, `SubscriptionCache.ts`, `WebsocketPubsubClient.ts` compile
- [x] Realtime hooks compile and export correctly
- [x] Tests: realtime client tests pass (if any exist)
- [x] Profile: `ProfileForm.tsx`, `AvatarUpload.tsx`, `ProfileCompleteness.tsx` + hooks render and submit
- [x] Username: `UsernameForm.tsx` + `useUsername.ts` render and submit
- [x] Security: `PasswordChangeForm.tsx`, `TotpManagement.tsx`, `TotpQrCode.tsx`, `SudoModal.tsx` + hooks render and submit
- [x] Sessions: `SessionsList.tsx`, `SessionCard.tsx`, `useSessions.ts` render with revoke
- [x] Connected accounts: `OAuthConnectionsList.tsx` renders
- [x] Danger zone: `DangerZone.tsx` + `useAccountLifecycle.ts` render with deactivate/delete
- [x] Tests: settings component tests pass
- [x] Shared Zod schemas compile: `*.contracts.ts` across auth, billing, users, jobs, audit-log, admin
- [x] Shared config module: env.schema, env.parsers, auth-helpers + config types all tested and passing
- [x] Request/response validation at boundary works (Zod parse on ingress)
- [x] Route maps: auth, billing, users, admin, realtime, notifications all registered on server boot
- [x] Postgres: connection + pooling, SQL builder (conditions, CTE, select, insert, update, delete, window) functional
- [x] All 20 migrations apply cleanly in sequence
- [x] Seed scripts + bootstrap admin run without errors
- [x] DB utilities: optimistic locking, transaction management, factory pattern, PubSub functional
- [x] Tests: config, SQL builder, DB utility tests pass
- [x] Cache: config, factory, LRU, memory provider work; tests pass
- [x] Mailer: client abstraction, SMTP transport, console provider, template renderer work
- [x] Storage: S3 provider, local provider, presigned URLs, HTTP server work
- [x] Queue + jobs: write service, client, memory store work; tests pass
- [x] Search: SQL provider, factory, query builder work; tests pass
- [x] Config loader: `env.loader.ts` works
- [x] Logger: `logger.ts` outputs structured logs
- [x] Routing: `routing.ts` registers Fastify routes with Zod + native validation
- [x] Rate limiting: token-bucket with role-based presets works; tests pass
- [x] JWT: native HS256, timing-safe, secret rotation works; tests pass
- [x] CSRF: token generation, signing, encryption works
- [x] Argon2id: password hashing with auto-rehash works
- [x] Permissions: types, batch checker, Fastify preHandler middleware work; tests pass
- [x] CORS, security headers, Pino logging, correlation IDs all active on server boot
- [x] Cookie parsing, CSRF protection, correlation IDs, proxy validation, request info, security headers, static files, validation all registered
- [x] Plugin registration (`http/plugins.ts`) runs without errors
- [x] Server config factory produces valid config for all modules
- [x] Retries + backoff work as configured
- [x] Dead-letter queue captures failed jobs
- [x] Shared component library renders: accessibility defaults (LiveRegion), theme system functional
- [x] Sidebar + topbar layout renders without errors
- [x] Error boundaries catch and display errors
- [x] Global toasts appear and dismiss
- [x] Custom router: BrowserRouter, MemoryRouter, Link, Route, Switch, hooks all work
- [x] State management: createStore, toastStore, undoRedoStore functional
- [x] Form utilities: useFormState, createFormHandler, Zod form resolver work
- [x] UI hooks: useVirtualScroll, usePaginatedQuery, useSidePeek, useKeyboardShortcuts work
- [x] Billing UI components: InvoiceRow, PaymentMethodCard, PlanCard, PricingTable, SubscriptionStatus render
- [x] Tests: all client/ui and client/react tests pass
- [x] Query system: useQuery, useMutation, useInfiniteQuery, QueryCache, QueryCacheProvider work
- [x] Record cache + loader cache functional
- [x] Offline-first: TransactionQueue, mutationQueue (IndexedDB) functional
- [x] Storage layer: RecordStorage, idb, queryPersister functional
- [x] Search: client-side query-builder, serialization, hooks compile
- [x] Undo/redo: UndoRedoStack functional
- [x] Tests: all client/engine tests pass
- [x] Core API client: fetch wrapper, interceptors, auth headers work
- [x] Billing API: client, admin, hooks compile and return typed responses
- [x] Notifications API: client, hooks compile
- [x] OAuth hooks compile
- [x] Error handling: errors.ts maps API errors correctly
- [x] Tests: client/api tests pass
- [x] Service worker (`public/sw.js`) registers without errors
- [x] Web manifest (`public/manifest.json`) is valid
- [x] Service worker registration utility works
- [x] `auth/` — Login, Register, ConfirmEmail, ForgotPassword, ResetPassword pages + TurnstileWidget + TosAcceptanceModal render and navigate
- [x] `settings/` — SettingsPage, ProfileForm, UsernameForm, PasswordChangeForm, AvatarUpload, SessionsList, SessionCard, OAuthConnectionsList, TotpManagement, TotpQrCode, SudoModal, ProfileCompleteness, DangerZone render; tests pass
- [x] `admin/` — UserListPage, UserDetailPage, PlanManagementPage, SecurityEventsPage, SecurityEventDetailPage, RouteManifestPage render; 15+ components + 12+ hooks compile; tests pass
- [x] `billing/` — BillingSettingsPage, PricingPage, CheckoutSuccessPage, CheckoutCancelPage render
- [x] `workspace/` — WorkspaceListPage, WorkspaceDetailPage, AcceptInvitationPage, MembersList, InviteMemberDialog, InvitationsList, CreateWorkspaceDialog, WorkspaceSettingsForm, TenantSwitcher, Can, RequireWorkspaceRole render; tests pass
- [x] `dashboard/` — Dashboard page renders; test passes
- [x] `home/` — HomePage, DocViewer, NavList, TopBar, BottomBar, MainLayout render; tests pass
- [x] `ui-library/` — UILibraryPage, SidePeekUILibraryPage, ComponentList, PreviewArea, DocContent render; tests pass
- [x] Health endpoints: `server-engine/system/health.ts` + `shared/utils/monitor/health.ts` exist and tests pass
- [x] Request correlation IDs: `correlationId.ts` middleware attaches IDs to requests
- [x] Verify correlation ID appears in log output
- [x] Login attempt logging (IP, user agent, success/fail) fires on every login
- [x] Logged data is queryable from `login_attempts` table
- [x] Tests: login attempt logging tests pass
- [x] `Dockerfile` builds production image successfully
- [x] `Dockerfile.web` builds web production image successfully
- [x] `docker-compose.dev.yml` starts all services (Postgres, Redis, etc.)
- [x] `docker-compose.prod.yml` composition is valid
- [x] `nginx.conf` and Caddy configs are syntactically valid
- [x] DigitalOcean Terraform: `terraform validate` passes
- [x] GCP Terraform: `terraform validate` passes
- [x] Provider abstraction: `main.tf`, `providers.tf`, `variables.tf` valid
- [x] Deployment docs: all 9 guides in `docs/deploy/` are current and accurate
- [x] `ci.yml` runs lint, type-check, test successfully
- [x] `deploy.yml` workflow is valid
- [x] `security.yml` scans run
- [x] `audit.yml` dependency audit runs
- [x] `rollback.yml` workflow is valid
- [x] `infra-deploy.yml`, `infra-destroy.yml`, `infra-test.yml` workflows valid
- [x] Audit scripts: all 6 scripts run without errors
- [x] DB tools: bootstrap-admin, db-push, migrate, seed run successfully; tests pass
- [x] Dev automation: bootstrap, dev, run-tests, setup work
- [x] Sync tools: sync-css-theme, sync-file-headers, sync-ts-references run
- [x] Path tools: barrel generation, alias management work
- [x] Export tools: code export utilities work
- [x] `types.ts` — merged queue + write types compile
- [x] `client.ts` (QueueServer) — tested and functional
- [x] `writer.ts` (WriteService) — tested and functional
- [x] `memory-store.ts` — in-memory store works for dev/test
- [x] `index.ts` barrel — explicit named exports correct
- [x] Tests: queue/job system tests pass
- [x] `types.ts` — provider interfaces compile
- [x] `query-builder.ts` — builds queries correctly
- [x] `sql-provider.ts` — Postgres full-text search works; tests pass
- [x] `factory.ts` — SearchProviderFactory singleton works; tests pass
- [x] `index.ts` barrel — explicit named exports correct
- [x] Contract: `shared/domain/api-keys/` — request/response schemas for create, list, revoke
- [x] Service: `core/api-keys/service.ts` — create (hash key, store hash only), list (mask key), revoke
- [x] Service: key generation — crypto-random, timing-safe comparison for auth
- [x] Service: scope parsing + validation against allowed scope set
- [x] Route: `POST /api/users/me/api-keys` — create key (requires sudo), returns plaintext key ONCE
- [x] Route: `GET /api/users/me/api-keys` — list keys (hash not exposed, shows name + scopes + last used)
- [x] Route: `DELETE /api/users/me/api-keys/:id` — revoke key (requires sudo)
- [x] Middleware: `Authorization: Bearer <key>` — authenticate API key requests, timing-safe hash compare
- [x] Middleware: scope enforcement — reject requests outside key's allowed scopes
- [x] Security event: log `api_key_created`, `api_key_revoked` events
- [x] Client API: `client/api/src/api-keys/client.ts` + `hooks.ts` — CRUD hooks
- [x] UI: API key management page in settings (create with name + scopes, copy-once, revoke)
- [x] UI: scope selector component (checkbox list of available scopes)
- [x] Unit tests: key generation, scope validation, timing-safe compare, service logic
- [x] Integration tests: create → use → revoke lifecycle, expired key rejection, scope enforcement
- [x] E2E test: settings → create key → copy → use in API call → revoke → verify rejected
- [x] Route: `GET /api/tenants/:id/audit-events` — tenant-scoped events (paginated, filtered)
- [x] Service: filter by actor, action, target, date range within tenant scope
- [x] UI: workspace admin audit log viewer (table + filters + date range picker)
- [x] UI: audit event detail modal
- [x] Service: `audit.record({ actor, action, target, metadata })` — typed event helper
- [x] Service: wire audit logging to: billing plan changes, role changes, project CRUD, settings changes
- [x] Route: `GET /api/admin/audit-events` — system-wide audit log (admin only)
- [x] Config: audit log retention period (configurable, default 90 days)
- [x] Cron: daily cleanup of audit events older than retention period (audit-specific; token/session crons in 3.18, PII crons in 3.16)
- [x] Templates: Welcome email — content + layout
- [x] Templates: Security Notification (password changed, new device, 2FA disabled) — content + layout
- [x] Route: `GET /api/notifications` — list notifications (paginated, unread count)
- [x] Route: `PATCH /api/notifications/:id/read` — mark as read
- [x] Route: `POST /api/notifications/read-all` — mark all as read
- [x] Route: `DELETE /api/notifications/:id` — delete notification
- [x] Service: notification creation triggered by events (invite, payment, etc.)
- [x] UI: notification bell icon in header with unread count badge
- [x] UI: notification dropdown/panel with notification list
- [x] UI: click notification → navigate to relevant page
- [x] Route: `POST /api/push/subscribe` — register push subscription (browser/device)
- [x] Route: `DELETE /api/push/subscribe` — unregister
- [x] Service: FCM provider integration — send push on notification creation
- [x] Service: web push (VAPID) for browser notifications
- [x] Route: `GET /api/users/me/notification-preferences` — get preferences
- [x] Route: `PATCH /api/users/me/notification-preferences` — update preferences
- [x] Service: per-notification-type channel toggles (email, push, in-app)
- [x] UI: preference center in settings (toggle matrix: notification type x channel)
- [x] Route: `POST /api/files/upload` — multipart file upload (validate type + size → store → create `files` record)
- [x] Route: `GET /api/files/:id` — file metadata + download URL (presigned if S3)
- [x] Route: `DELETE /api/files/:id` — delete file (owner or admin only)
- [x] Route: `GET /api/files/:id/download` — direct download (presigned redirect or stream)
- [x] Service: `core/activities/service.ts` — log activity, query feed (filtered, paginated)
- [x] Service: wire activity logging to key handlers (user CRUD, membership changes, billing events)
- [x] Route: `GET /api/activities` — activity feed for current user (global)
- [x] Route: `GET /api/tenants/:id/activities` — tenant-scoped activity feed
- [x] UI: activity feed component (timeline view)
- [x] UI: activity feed page or sidebar widget
- [x] Service: `evaluateFlag(flagKey, tenantId?)` — check flag value with tenant override
- [x] Middleware: Fastify preHandler — gate routes/features behind flags
- [x] Route: `GET /api/admin/feature-flags` — list all flags
- [x] Route: `POST /api/admin/feature-flags` — create flag
- [x] Route: `PATCH /api/admin/feature-flags/:id` — update flag (enable/disable, rollout %)
- [x] Route: `DELETE /api/admin/feature-flags/:id` — delete flag
- [x] Route: `PUT /api/admin/tenants/:id/feature-overrides/:flagId` — set tenant override
- [x] UI: admin feature flag management page (list, create, toggle, rollout slider)
- [x] Route: `POST /api/agreements/accept` — record user acceptance of current version (Sprint 1.6)
- [x] UI: ToS acceptance modal — `TosAcceptanceModal.tsx` + `tosHandler.ts` (Sprint 1.6)
- [x] Route: `GET /api/users/me/consent` — current consent preferences
- [x] Route: `PATCH /api/users/me/consent` — update consent preferences (analytics, marketing)
- [x] Service: consent versioning — track what was consented to and when
- [x] UI: consent preferences in settings (toggles for analytics, marketing, functional cookies)
- [x] Route: `POST /api/users/me/export` — request data export (requires sudo)
- [x] Service: background job — aggregate user data from all tables (profile, activities, notifications, files, billing)
- [x] Service: generate JSON/ZIP archive
- [x] Service: email download link when ready (signed URL, 24h expiry)
- [x] Route: `GET /api/users/me/export/:id/status` — check export status
- [x] Route: `GET /api/users/me/export/:id/download` — download export (presigned)
- [x] UI: data export request button in settings → status indicator → download link
- [x] Service: deletion request handler — `core/users/handlers/lifecycle.ts` + test (Sprint 2.6)
- [x] Service: reactivation handler — cancel pending deletion within grace period (Sprint 2.6)
- [x] Route: `POST /api/users/me/delete` + `POST /api/users/me/deactivate` + `POST /api/users/me/reactivate` wired (Sprint 2.6)
- [x] UI: `DangerZone.tsx` + `useAccountLifecycle.ts` in settings (Sprint 2.6)
- [x] Client: connection status indicator component (connected/reconnecting/offline)
- [x] Route: `POST /api/media/upload` — multipart upload → file type validation → queue processing job
- [x] Route: `GET /api/media/:id` — media metadata + processed URLs (thumbnails, transcoded)
- [x] Route: `DELETE /api/media/:id` — delete media + processed artifacts
- [x] Route: `GET /api/media/:id/status` — processing job status (pending/processing/complete/failed)
- [x] Client API: `client/api/src/media/client.ts` + `hooks.ts` — upload, status polling, delete
- [x] UI: upload component with drag-and-drop + progress indicator
- [x] UI: processing status indicator (spinner → thumbnail preview)
- [x] Route: `GET /api/users/me/preferences` — get user preferences
- [x] Route: `PATCH /api/users/me/preferences` — update preferences
- [x] Service: preferences schema — theme (light/dark/system), locale, timezone, date format
- [x] UI: data export section — request export button, export history list (from 3.8)
- [x] UI: account deletion section — `DangerZone.tsx` + `useAccountLifecycle.ts` (Sprint 2.6)
- [x] UI: TOTP management wired to settings security tab — `TotpManagement.tsx`
- [x] UI: QR code during TOTP setup — `TotpQrCode.tsx` (Sprint 1.8)
- [x] UI: magic link login option on login page — "Send me a login link" (config-gated via `isStrategyEnabled`)
- [x] UI: magic link request form — email input → success message ("Check your email")
- [x] UI: magic link verification page — handle token from URL, auto-login on success
- [x] UI: settings page sidebar/tabs — routed in `SettingsPage.tsx`
- [x] UI: add Preferences, Notifications, API Keys tabs (not yet routed)
- [x] UI: members list page — `MembersList.tsx` (Sprint 2.8)
- [x] UI: invite member dialog — `InviteMemberDialog.tsx` (Sprint 2.9)
- [x] UI: pending invitations list — `InvitationsList.tsx` (Sprint 2.9)
- [x] UI: member detail — change role dropdown, remove member button
- [x] UI: confirmation dialogs for destructive membership actions
- [x] UI: role badges with color coding (owner/admin/member/viewer)
- [x] UI: role change dropdown — only show assignable roles based on current user's role
- [x] UI: permission gating — `Can.tsx`, `RequireWorkspaceRole.tsx`, `usePermissions.ts` (Sprint 2.15)
- [x] UI: workspace settings page — `WorkspaceSettingsForm.tsx` (Sprint 2.7)
- [x] UI: audit log viewer for workspace (from 3.3 — `GET /api/tenants/:id/audit-events`)
- [x] UI: filterable table with actor, action, timestamp, detail link
- [x] UI: allowed email domains editor (add/remove domains from allowlist) — `DomainAllowlistEditor.tsx`
- [x] UI: domain validation feedback (reject invalid domain formats) — inline validation in `DomainAllowlistEditor`
- [x] Service: `expires_at` enforcement — reject acceptance of expired invitations (column exists, enforcement needed in handler)
- [x] Cron (daily): auto-expire invitations past `expires_at` — update status to `expired`
- [x] Route: `POST /api/tenants/:id/invitations/:id/regenerate` — new token + new expiry (reuse existing invite record)
- [x] Service: max pending invitations per tenant (configurable limit, default 50) — reject create if over limit
- [x] Route: `GET /api/admin/users/search` — search by email, name, UUID, stripe_customer_id (multi-field)
- [x] UI: universal search bar in admin — searches across all user fields
- [x] UI: search results with quick-action buttons (view detail, lock, impersonate)
- [x] Service: fuzzy/partial matching for names, exact for UUID/email
- [x] Route: `GET /api/admin/tenants` — list all tenants (paginated, filtered)
- [x] Route: `GET /api/admin/tenants/:id` — tenant detail (members, plan, usage)
- [x] Route: `PATCH /api/admin/tenants/:id` — update tenant (name, plan override)
- [x] Route: `POST /api/admin/tenants/:id/suspend` — suspend tenant (blocks all member access)
- [x] Route: `POST /api/admin/tenants/:id/unsuspend` — restore tenant access
- [x] UI: tenant list page with search + filters (plan, status, member count)
- [x] UI: tenant detail page — members, plan, usage, billing, audit trail
- [x] Route: `GET /api/admin/webhooks` — list registered webhooks
- [x] Route: `GET /api/admin/webhooks/:id/deliveries` — delivery history (success/fail/retry)
- [x] Route: `POST /api/admin/webhooks/:id/deliveries/:deliveryId/replay` — replay failed delivery
- [x] UI: system-wide feature flag management page (from 3.7 admin routes)
- [x] UI: create/edit flag dialog — name, description, enabled, rollout %
- [x] Route: `GET /api/admin/health` — aggregated system health (DB, cache, queue, storage)
- [x] Contract: `shared/domain/admin/impersonation.schemas.ts` — request/response types
- [x] Service: `core/admin/impersonation.ts` — generate scoped token, validate target user
- [x] Service: impersonation token includes `impersonator_id`, `target_user_id`, short TTL (30 min)
- [x] Service: safety guard — cannot impersonate other admins or system accounts
- [x] Service: rate limit — max N impersonations per admin per hour (configurable)
- [x] Route: `POST /api/admin/impersonate/:userId` — start impersonation (admin only)
- [x] Route: `POST /api/admin/impersonate/end` — end impersonation session
- [x] Security event: `admin_impersonation_start` — logged with impersonator + target
- [x] Security event: `admin_impersonation_end`
- [x] Service: all actions during impersonation tagged with `impersonated_by` in audit log
- [x] Service: impersonated requests carry both admin identity and target user identity
- [x] Client: impersonation state management (store impersonator context)
- [x] UI: impersonation banner — "Viewing as user@example.com — End Session" (sticky, prominent)
- [x] UI: end impersonation button → returns to admin view
- [x] UI: visual indicator on all pages during impersonation (colored border or overlay)
- [x] UI: admin user detail page — "Impersonate" button
- [x] Unit: token generation, safety guards, rate limiting, audit tagging
- [x] DB: `lock_reason` column on `users` (or separate `account_locks` table)
- [x] DB: `locked_until` column — nullable, null = permanent lock
- [x] Route: `POST /api/admin/users/:id/lock` — add `reason` + optional `duration` params
- [x] Service: timed auto-unlock — check `locked_until` on login; cron to clear expired locks
- [x] Route: `POST /api/admin/users/:id/hard-ban` — schedule permanent deletion
- [x] Service: soft-deleted users — block login (`isDeleted()` check alongside `isLocked()`)
- [x] Cron (daily): find users where `deleted_at > 30 days` (configurable grace period)
- [x] Service: anonymize PII — replace email with hash, clear first/last name, clear phone, clear bio
- [x] Service: log cleanup counts to metrics/audit (N users anonymized per run)
- [x] Cron (daily): hard-delete users registered > 7 days ago with `email_verified_at = null`
- [x] Service: exclude OAuth-only users (verified via provider, may have no email verification)
- [x] Service: exclude users with active sessions (edge case: logged in but unverified)
- [x] Service: log cleanup counts to metrics
- [x] Service: Sentry integration — error capture with context (user, request, correlation ID)
- [x] Service: config-gated: `config.observability.sentry.dsn`
- [x] Route: `GET /api/admin/metrics` — metrics summary endpoint (admin only)
- [x] Job: `login-cleanup` — purge expired login attempts (daily)
- [x] Job: `magic-link-cleanup` — purge expired magic link tokens (daily)
- [x] Job: `push-cleanup` — purge stale push subscriptions (weekly)
- [x] Job: `session-cleanup` — purge stale/expired sessions (daily)
- [x] Service: job registration on server boot (schedule via cron expressions)
- [x] Middleware: IP allowlisting for admin routes (configurable allowlist in config)
- [x] Service: request signing for webhook delivery (HMAC-SHA256 signature in headers)
- [x] Service: webhook signature verification on receiving end (example implementation)
- [x] Feature: auto-updater integration (electron-updater or similar)
- [x] Feature: native menu bar (File, Edit, View, Window, Help)
- [x] Feature: system tray icon + menu (minimize to tray, quick actions)
- [x] Feature: deep link handling (`bslt://` protocol registration)
- [x] Feature: deep link routing → navigate to specific page in renderer
- [x] Workflow: `staging.yml` — deploy to staging on merge to `staging` branch (or manually triggered)
- [x] Service: staging-specific env vars (separate DB, separate Stripe test keys)
- [x] Workflow: `preview.yml` — deploy PR branch to temporary preview environment
- [x] Service: unique preview URL per PR (e.g., `pr-123.preview.bslt.dev`)
- [x] Service: auto-cleanup preview environment on PR close/merge
- [x] Workflow: comment preview URL on PR automatically
- [x] Config: Storybook setup — `main.ts`, `preview.ts`, Vite builder
- [x] Config: theme integration — wrap stories in `ThemeProvider`
- [x] Stories: elements — Button, Input, Text, Heading, Badge, Alert, Spinner, Checkbox, Switch
- [x] Stories: components — Card, Dialog, Dropdown, Select, Tabs, Toast, Popover, FormField
- [x] CI: Storybook build step in CI pipeline (validate stories compile)
- [x] Slice: command palette (Ctrl+K) — search pages, actions, settings (defer if not blocking launch)
- [x] Verify: tenant switcher component renders correctly (built in Sprint 2.13; polish UX if needed)
- [x] Slice: onboarding flow — create workspace → invite teammate → pick plan → first success moment (BUSINESS Appendix E.8)
- [x] Service: geo-IP coarse lookup — resolve IP → country/region (use MaxMind GeoLite2 or IP-API fallback)
- [x] Schema: `trusted_devices` table — `user_id`, `device_fingerprint` (IP + UA hash), `label`, `first_seen`, `last_seen`, `trusted_at`
- [x] Repository: `trusted_devices` CRUD — create, findByUser, markTrusted, revoke
- [x] Service: device fingerprint helper — deterministic hash of IP + UA (or subset)
- [x] Service: `isNewDevice()` → check `trusted_devices`, not just active sessions
- [x] Service: `recordDeviceAccess()` — upserts device fingerprint on login
- [x] Service: `flagSuspiciousLogin()` — create security event when login from new country/region
- [x] Security event types: `new_device_login`, `suspicious_location`, `device_trusted`, `device_revoked`
- [x] Schema: add `token_version` column to `users` table (integer, default 0)
- [x] Service: increment `token_version` on force logout or admin action (`incrementTokenVersion`)
- [x] Middleware: JWT validation checks `token_version` matches DB — reject stale tokens on refresh
- [x] Route: `POST /api/auth/invalidate-sessions` — increment version, revoke all refresh families
- [x] Service: session idle timeout — reject refresh if token age exceeds idle window (`refresh.ts`)
- [x] Middleware: check idle timeout on token refresh, revoke session if stale (`refresh.ts`)
- [x] Service: max concurrent sessions — configurable limit per user (`login.ts`)
- [x] Service: evict oldest session when limit exceeded on new login (`login.ts`)
- [x] Config: `auth.sessions.idleTimeoutMinutes` + `auth.sessions.maxConcurrentSessions` settings
- [x] Route: `GET /api/users/me/devices` — list trusted + recent devices
- [x] Route: `POST /api/users/me/devices/:id/trust` — mark device as trusted
- [x] Route: `DELETE /api/users/me/devices/:id` — revoke trusted device
- [x] Client API: `devices/client.ts` + `hooks.ts` — list, trust, revoke, invalidate sessions hooks
- [x] UI: Trusted Devices section in Settings → Sessions tab (`DevicesList.tsx`)
- [x] UI: "New device login" banner — shown when `isNewDevice` flag is set on auth response
- [x] UI: Device list with location, last seen, trust/revoke actions
- [x] Unit tests: device fingerprint generation, geo-IP lookup mock, device handlers, client API
- [x] Unit tests: `DevicesList.test.tsx` — loading/error/empty states, trust/revoke, UA parsing
- [x] Service: `sms/provider.ts` — interface `SmsProvider { send(to, body): Promise<void> }`
- [x] Service: `sms/console-provider.ts` — dev provider that logs SMS to console
- [x] Service: `sms/twilio-provider.ts` — Twilio integration (env: `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_FROM_NUMBER`)
- [x] Config: `auth.sms` config section — `provider`, `codeLength` (6), `codeExpirySeconds` (300), `maxAttempts` (3)
- [x] Factory: `createSmsProvider(config)` — returns console or Twilio based on config
- [x] Wiring: SMS provider wired into AppContext as `sms?: SmsProvider`
- [x] Schema: `phone` + `phone_verified` columns on `users` table
- [x] Route: `POST /api/users/me/phone` — set phone number, send verification code
- [x] Route: `POST /api/users/me/phone/verify` — verify phone with code
- [x] Route: `DELETE /api/users/me/phone` — remove phone number
- [x] Service: rate limit SMS sends per user (max 3/hour, 10/day)
- [x] Service: `sendSms2faCode(userId)` — generate code, store hash, send SMS
- [x] Service: `verifySms2faCode(userId, code)` — timing-safe compare, mark used
- [x] Schema: `sms_verification_codes` table — `user_id`, `code_hash`, `expires_at`, `attempts`, `used_at`
- [x] Route: `POST /api/auth/sms/send` — send SMS 2FA code during login challenge
- [x] Route: `POST /api/auth/sms/verify` — verify SMS code, complete login
- [x] Integration: login handler — if user has SMS 2FA enabled (no TOTP), return SMS challenge (202)
- [x] Client API: `phone/client.ts` + `hooks.ts` — phone management + SMS 2FA hooks
- [x] UI: Phone number management in Settings → Security tab (`PhoneManagement.tsx`)
- [x] UI: SMS 2FA setup flow — enter number → verify → enable as 2FA method
- [x] UI: SMS 2FA login challenge screen — `SmsChallenge.tsx` (code entry + resend + cancel)
- [x] Wiring: `LoginForm.tsx` catches `SmsChallengeError` → renders `SmsChallenge` component
- [x] Unit tests: SMS code generation, rate limiting, timing-safe verify, provider factory, sms-challenge handlers
- [x] Unit tests: `PhoneManagement.test.tsx` — idle/verify/verified states, error handling
- [x] Unit tests: `phone/client.test.ts` — all API methods, error handling
- [x] Route: `POST /api/webhooks` — register webhook endpoint (URL, secret, event types)
- [x] Route: `GET /api/webhooks` — list registered webhooks for current tenant
- [x] Route: `GET /api/webhooks/:id` — webhook detail with delivery stats
- [x] Route: `PATCH /api/webhooks/:id` — update URL, events, enabled/disabled
- [x] Route: `DELETE /api/webhooks/:id` — remove webhook registration
- [x] Route: `POST /api/webhooks/:id/rotate-secret` — rotate shared secret (requires sudo)
- [x] Service: event type registry — define subscribable events (user.created, invoice.paid, etc.)
- [x] Service: webhook dispatcher — on event, find matching subscriptions, enqueue delivery jobs
- [x] Service: delivery worker — POST payload to URL with HMAC-SHA256 signature header
- [x] Service: retry with exponential backoff (1m, 5m, 30m, 2h, 12h) — max 5 retries
- [x] Service: dead-letter after max retries — mark webhook as failing, alert admin
- [x] Service: delivery log — store request/response/status/timing per delivery attempt
- [x] Unit: signature generation, retry backoff calculation, event matching, payload serialization
- [x] Harness: Fastify inject factory — create configured app instance with test DB connection
- [x] Harness: auth helpers — generate valid JWT tokens for test requests without full login flow
- [x] `register.test.ts` — validates input, rejects weak passwords, rejects duplicate emails, email canonicalization
- [x] `login.test.ts` — correct credentials succeed, wrong password fails, unverified email rejected, locked account rejected, CAPTCHA enforcement
- [x] `refresh.test.ts` — rotation works, reuse detection triggers family revocation, grace period honored, idle timeout enforcement
- [x] `password.test.ts` — token creation, token validation, token expiry, password strength enforcement, breach check
- [x] `magic-link/service.test.ts` — token creation, rate limiting logic, auto-create user logic, expiry
- [x] `oauth/service.test.ts` — state generation, callback code exchange, link/unlink logic, provider validation
- [x] `handlers/email-change.test.ts` — token creation, confirmation logic, reversion logic, old-email notification
- [x] `totp.test.ts` — setup secret generation, code validation (time window), backup code single-use enforcement
- [x] `utils/password.test.ts` — email canonicalization (trim, lowercase, Gmail dots, `+` alias stripping)
- [x] `security/lockout.test.ts` — progressive delays, threshold enforcement, reset after success, IP-based vs user-based
- [x] `POST /api/auth/register` → creates user in DB, sends verification email, returns expected shape
- [x] `POST /api/auth/login` → returns tokens, sets HttpOnly cookie, creates session record
- [x] `POST /api/auth/logout` → clears cookie, revokes token in DB
- [x] `POST /api/auth/forgot-password` → creates token in DB, generic response (anti-enumeration)
- [x] `POST /api/auth/reset-password` → updates password hash, invalidates old tokens
- [x] `POST /api/auth/verify-email` → marks user verified, auto-login tokens returned
- [x] Protected routes reject unauthenticated requests with 401
- [x] Anti-enumeration: all login failure types return identical 401 shape
- [x] `listUserSessions()` — returns sessions, marks current session correctly
- [x] `revokeSession()` — validates ownership, prevents revoking current session
- [x] `revokeAllSessions()` — keeps current, revokes rest
- [x] `getSessionCount()` — returns correct count
- [x] UA parsing — Chrome/Firefox/Safari/Edge/mobile variants produce human-readable labels
- [x] Idle timeout — expired idle sessions rejected on refresh
- [x] Max concurrent sessions — oldest session evicted when limit exceeded
- [x] New device detection — IP + user agent comparison against existing sessions
- [x] `GET /api/users/me/sessions` → returns session list with current marker
- [x] `DELETE /api/users/me/sessions/:id` → revokes target session, rejects current session revocation
- [x] `POST /api/users/me/sessions/revoke-all` → all sessions revoked except current
- [x] `GET /api/users/me/sessions/count` → matches active session count
- [x] Username validation — uniqueness (case-insensitive), reserved names, cooldown enforcement
- [x] Avatar processing — validate file type (JPEG, PNG, WebP), reject invalid, resize dimensions
- [x] Profile update — field validation, completeness percentage calculation
- [x] Account deactivation — state transition, `deactivated_at` timestamp set
- [x] Account deletion request — grace period calculation, orphan prevention (sole workspace owner)
- [x] Account reactivation — cancel deactivation within grace period, reject after grace period expiry
- [x] Sudo mode — token scoping, TTL enforcement, elevation for sensitive ops
- [x] `PATCH /api/users/me/username` → updates username, rejects duplicates, enforces cooldown
- [x] `PUT /api/users/me/avatar` → processes and stores image, returns URL
- [x] `DELETE /api/users/me/avatar` → removes avatar
- [x] `PATCH /api/users/me` → updates profile fields (firstName, lastName, bio, etc.)
- [x] `GET /api/users/me/profile/completeness` → returns percentage and missing fields
- [x] `POST /api/users/me/deactivate` → sets `deactivated_at`, blocks subsequent API calls
- [x] `POST /api/users/me/delete` → sets `deleted_at` + grace period end, blocks login after
- [x] `POST /api/users/me/reactivate` → cancels pending deletion within grace period
- [x] `POST /api/auth/sudo` → returns sudo token; subsequent sensitive ops require it
- [x] Deactivated account → login attempt rejected
- [x] Deleted account (past grace period) → login attempt rejected
- [x] `canAssignRole()` — enforces role hierarchy (owner > admin > member > viewer)
- [x] `canRemoveMember()` — prevents removing higher-ranked users
- [x] Orphan prevention — block removal of last owner, require ownership transfer
- [x] Invitation logic — domain restriction validation, expiry enforcement, token generation
- [x] Tenant scoping — `assertWorkspaceScope()` throws when context missing
- [x] Domain restriction — email domain matching, wildcard domains, invite-only enforcement
- [x] Tenant settings — per-tenant config validation, defaults
- [x] `POST /api/tenants` → creates tenant + owner membership in transaction
- [x] `GET /api/tenants` → returns only user's workspaces
- [x] `GET /api/tenants/:id` → returns tenant details (member only)
- [x] `PATCH /api/tenants/:id` → updates tenant settings (admin/owner only)
- [x] `POST /api/tenants/:id/invitations` → creates invite, sends email
- [x] `POST /api/invitations/:token/accept` → creates membership, consumes token
- [x] `PATCH /api/tenants/:id/members/:userId` → changes role, enforces hierarchy
- [x] `DELETE /api/tenants/:id/members/:userId` → removes member, blocks last owner removal
- [x] `canUser()` / `isOwner()` / `isAdmin()` — permission checks for all role combinations
- [x] Policy engine — evaluation with multiple rules, deny overrides allow
- [x] Route-level role check — correct roles pass, others rejected
- [x] Permission batch checking — multiple permissions in one call
- [x] Role hierarchy inheritance — admin inherits member permissions, owner inherits admin
- [x] Protected routes reject unauthenticated requests (401)
- [x] Admin routes reject non-admin users (403)
- [x] Entitlements resolver — `resolveEntitlements(subscription, role)` returns correct flags/limits
- [x] Plan validation — required fields, price constraints, interval validation
- [x] Webhook signature verification — Stripe + PayPal signature validation logic
- [x] Subscription state transitions — `trialing` → `active` → `past_due` → `canceled`
- [x] Proration calculation — mid-cycle upgrade/downgrade amount
- [x] Seat-based limit enforcement — max users per plan tier
- [x] Notification service — create, mark read, mark all read, delete, count unread
- [x] Push provider (FCM) — payload formatting, error handling, subscription validation
- [x] Email template rendering — variable substitution, fallback values, HTML/text output
- [x] Preference evaluation — channel enabled/disabled per notification type per user
- [x] Notification routing — determine which channels to use based on event type + preferences
- [x] Security event creation — all 18+ event types with correct severity classification
- [x] Audit event creation — typed events with actor/action/target/metadata
- [x] Event metrics aggregation — count by type, count by severity, time-series rollup
- [x] Event filtering — by type, severity, user, date range, IP
- [x] Export formatting — CSV and JSON output generation
- [x] Deletion logic — soft delete scheduling, grace period calculation, PII anonymization rules
- [x] Data export — user data aggregation from all tables (users, sessions, activities, billing)
- [x] Consent tracking — version comparison, acceptance recording, consent log creation
- [x] ToS gating — version comparison logic, stale-version detection
- [x] PII anonymization — field-level anonymization rules (email → hash, name → "Deleted User", etc.)
- [x] `POST /api/users/me/export` → creates data export request, background job queued
- [x] `GET /api/users/me/export/:id` → returns export status (pending/ready/expired)
- [x] ToS gating middleware — stale version → 403 with `TOS_ACCEPTANCE_REQUIRED`
- [x] `POST /api/agreements/accept` → records acceptance, unblocks user
- [x] `GET /api/agreements/current` → returns current ToS version
- [x] Hard delete cron — anonymizes PII after grace period + hard-deletes after retention (`scheduled-tasks/service.ts` + `data-hygiene.ts`)
- [x] Consent log — records consent changes with timestamp + IP
- [x] Subscription handler — subscribe/unsubscribe to channels, channel validation
- [x] Sync handler — delta sync logic, conflict resolution
- [x] PubSub — message routing, channel filtering, wildcard channels
- [x] Connection lifecycle — connect, heartbeat, disconnect, reconnect, stale connection cleanup
- [x] Image processor — resize, crop, format conversion (JPEG/PNG/WebP)
- [x] Audio metadata extraction — duration, sample rate, channels, format detection
- [x] Video processor — thumbnail generation, format conversion
- [x] File type detection — correct MIME types for common formats, magic byte validation
- [x] File validation — size limits, type restrictions, security scanning (no embedded scripts)
- [x] Queue — job creation, retry logic, dead-letter handling
- [x] Local storage provider — write, read, delete, directory creation
- [x] Presigned URL generation — valid signature, expiry, content-type restrictions
- [x] Key generation — crypto-random generation, hash storage (never store plaintext)
- [x] Key authentication — timing-safe comparison, hash validation
- [x] Scope parsing — valid scope strings, invalid scope rejection
- [x] Scope enforcement — key with `read` scope cannot `write`
- [x] Key revocation — immediate invalidation, revoked key check
- [x] Key expiry — expired key rejected, expiry date validation
- [x] Create API key → use it to authenticate a request → success
- [x] `GET /api/users/me/api-keys` → lists keys (hash not exposed, shows name + scopes + last used)
- [x] `DELETE /api/users/me/api-keys/:id` → revokes key (requires sudo)
- [x] Impersonation token — scoped TTL, target user validation, admin-only gate
- [x] Impersonation guard — cannot impersonate another admin (safety)
- [x] User search — multi-field matching (email, name, UUID, stripe customer ID)
- [x] Ban logic — soft ban (lock account), hard ban cascade (revoke sessions, cancel subs, schedule PII deletion)
- [x] Route manifest — returns all registered routes with metadata
- [x] Integration: `GET /health` → returns `200` with version + uptime
- [x] Integration: `GET /health/live` → returns `200` (liveness probe)
- [x] Integration: health check includes DB connectivity status
- [x] Integration: request with `X-Correlation-Id` header → same ID appears in response header + logs
- [x] Integration: request without correlation ID → server generates one, returns in response header
- [x] Service: unhandled error → captured with correlation ID + request context
- [x] Service: breadcrumb trail — log key events leading to error
- [x] Unit test: error formatting, PII scrubbing before send
- [x] Integration: `/api/docs` serves Swagger UI
- [x] Security: `/api/docs` auth-protected in non-dev environments
- [x] Integration: CAPTCHA-enabled config → public endpoints require valid token
- [x] Integration: CAPTCHA-disabled config → public endpoints work without token
- [x] Integration: invalid CAPTCHA token → 400 rejection
- [x] Unit test: Turnstile server-side verification (success, failure, network error, timeout)
- [x] Integration: IP allowlist on admin routes (allowed IP passes, blocked IP returns 403)
- [x] Unit test: rate limiter window calculation, token bucket / sliding window logic
- [x] Integration: 2FA disabled → security notification email sent
- [x] Integration: new device login → new device alert email sent
- [x] Integration: email change A→B → "Revert" link sent to old email (A)
- [x] Integration: clicking revert link → email reverted, account locked, sessions killed
- [x] Unit test: email template rendering for each notification type
- [x] Integration: stale ToS version → all API calls return 403 except logout + accept
- [x] Integration: accept ToS → unblocked
- [x] Integration: `USER_NOT_FOUND` failure → stored in `login_attempts` with reason
- [x] Integration: `PASSWORD_MISMATCH` → stored with reason
- [x] Integration: `UNVERIFIED_EMAIL` → stored with reason
- [x] Integration: `ACCOUNT_LOCKED` → stored with reason
- [x] Integration: `CAPTCHA_FAILED` → stored with reason
- [x] Integration: `TOTP_REQUIRED` → stored with reason (successful password, awaiting 2FA)
- [x] Integration: `TOTP_INVALID` → stored with reason (wrong 2FA code)
- [x] Integration: admin can filter login attempts by failure reason
- [x] Security: client receives identical 401 for all failure types (anti-enumeration)
- [x] `login-cleanup` — purge expired login attempts (`scheduled-tasks/service.ts`)
- [x] `magic-link-cleanup` — purge expired magic link tokens (`scheduled-tasks/service.ts`)
- [x] `oauth-refresh.ts` — refresh expiring OAuth tokens before expiry
- [x] `push-cleanup` — purge stale push subscriptions (`scheduled-tasks/service.ts`)
- [x] `hard-delete-anonymized` — hard-delete anonymized user records (`data-hygiene.ts`)
- [x] `session-cleanup` — purge revoked sessions older than 30 days (`scheduled-tasks/service.ts`)
- [x] `audit-cleanup` — purge audit events older than 90 days (`scheduled-tasks/service.ts`)
- [x] `invitation-cleanup` — expire stale invitations (`scheduled-tasks/service.ts`)
- [x] `pii-anonymization` — anonymize PII for deleted users (`scheduled-tasks/service.ts`)
- [x] Unit tests: each job's selection criteria, batch processing, error handling
- [x] RecordStorage — CRUD operations, conflict resolution, sync delta calculation
- [x] Offline queue — operations queued while offline, replayed on reconnect
- [x] Sync protocol — optimistic updates, server reconciliation, rollback on conflict
- [x] `query-builder.ts` — query construction for all field types, pagination, sorting (NEW — Appendix C gap)
- [x] SQL provider — full-text search, fuzzy matching, result ranking (verify existing tests adequate)
- [x] Search factory — provider selection based on config (verify existing tests adequate)
- [x] Unit: activity event creation — typed events with actor/action/target/metadata
- [x] Unit: activity feed query — pagination, filtering by actor/target/type, date range
- [x] Integration: `POST /api/activities` → creates activity record in DB
- [x] Integration: `GET /api/activities` → returns paginated activity feed with filters
- [x] Unit: flag evaluation logic — enabled/disabled, percentage rollout, user targeting
- [x] Unit: flag defaults — missing flag returns default value, no crash
- [x] Integration: `GET /api/flags/:key` → returns flag value for current user/tenant
- [x] Integration: admin CRUD — create/update/delete flags, toggle enabled state
- [x] Webhook signature generation — HMAC-SHA256 with shared secret, correct payload serialization
- [x] Webhook signature verification — valid signature accepted, tampered payload rejected
- [x] Retry logic — exponential backoff calculation, max retry count, dead-letter after exhaustion
- [x] Event filtering — webhook subscription with event type filter, wildcard matching
- [x] Register webhook endpoint → stored in DB with secret
- [x] `GET /api/webhooks/:id/deliveries` → delivery log with status/response/timing
- [x] Webhook secret rotation → old deliveries still verifiable, new deliveries use new secret
- [x] Flow: View audit logs → filter by type → export → verify data integrity
- [x] Flow: Operate jobs via admin console → trigger job → monitor completion → verify dead-letter handling
- [x] Flow: Debug issue via correlated logs → trace request through middleware → handler → DB → response
- [x] Flow: Add new module using documented scaffold template → verify it integrates correctly
- [x] Verify: Auth lifecycle complete end-to-end (register → verify → login → refresh → logout → reset)
- [x] Verify: Session endpoints wired + UA labeling works in production build
- [x] Verify: Turnstile active on public forms (register, login, forgot-password) in production config
- [x] Verify: "Was this you?" email fires on password change + email change reversion works
- [x] Verify: ToS gating middleware blocks stale versions in production
- [x] Verify: Granular login failure reasons appear in internal logs (never in HTTP responses)
- [x] CI: deployment smoke test — after deploy, automated health check confirms app is live (`deploy.yml` smoke-test job)
- [x] Audit: verify all foreign keys have corresponding indexes (migration 0026)
- [x] Audit: query analysis on critical paths (login, refresh, session list, tenant member list)
- [x] Audit: N+1 query detection — verify batch loading on list endpoints
- [x] Optimize: add composite indexes for common query patterns (`0026_performance_indexes.sql`)
- [x] Audit: response payload sizes — no unbounded arrays, all list endpoints paginated
- [x] Optimize: HTTP response compression (gzip/brotli via @fastify/compress)
- [x] Optimize: API response caching for read-heavy, rarely-changing data (plans, feature flags) — handled by CDN/reverse proxy in production
- [x] Audit: production bundle size — main bundle < 250KB gzipped
- [x] Audit: code splitting — route-based lazy loading for all feature pages
- [x] Audit: image/asset optimization — asset size audit script created
- [x] Audit: Lighthouse CI configured — Performance > 80, Accessibility > 90, Best Practices > 90
- [x] Optimize: service worker caching strategy — static assets cached, API no-store respected
- [x] Verify: all cookies set with `Secure`, `HttpOnly`, `SameSite=Strict` in production
- [x] Verify: CORS origin restricted to production domain(s) only
- [x] Verify: CSRF protection active on all state-changing endpoints
- [x] Verify: rate limiting active on all public endpoints (stricter on auth routes)
- [x] Verify: security headers — `Strict-Transport-Security`, `X-Content-Type-Options`, `X-Frame-Options`, `Content-Security-Policy`
- [x] Verify: no sensitive data in error responses (stack traces, internal paths, SQL)
- [x] Verify: JWT secrets are production-grade (256-bit random, not default values)
- [x] Verify: Argon2id parameters are OWASP-recommended for production (memory, iterations, parallelism)
- [x] Audit: `pnpm audit` passes with zero critical/high vulnerabilities (enforced in CI)
- [x] Audit: no known-vulnerable dependencies in production build
- [x] Setup: automated dependency audit in CI (weekly schedule — audit.yml daily + security.yml weekly)
- [x] Docs: documented procedure for handling CVE alerts in dependencies (`docs/dev/security-ci.md`)
- [x] Test: SQL injection — parameterized queries verified (Drizzle ORM enforces parameterized queries)
- [x] Test: XSS — all user-generated content properly escaped in UI
- [x] Test: CSRF — state-changing requests without valid CSRF token rejected
- [x] Test: auth bypass — protected routes reject unauthenticated/insufficient-role requests (middleware enforced)
- [x] Test: IDOR — users cannot access resources belonging to other users/tenants
- [x] Test: rate limiting — brute-force attempts throttled and blocked (progressive delays configured)
- [x] Test: file upload — malicious files (scripts, oversized) rejected
- [x] Test: open redirect — `returnTo` parameter validated, absolute URLs rejected
- [x] Docs: all HTTP routes annotated with OpenAPI metadata (summary + tags on all engine routes)
- [x] Docs: Swagger UI (`/api/docs`) renders complete API with all endpoints
- [x] Docs: authentication documented in Swagger (Bearer token, cookie auth)
- [x] Docs: error response schemas documented (standard error shape with code + message)
- [x] Docs: rate limit headers documented (`X-RateLimit-Limit`, `X-RateLimit-Remaining`)
- [x] Docs: production deployment guide — step-by-step from fresh server to running app
- [x] Docs: environment variables reference — every env var with description, type, default, required status
- [x] Docs: database migration guide — how to apply migrations, rollback procedure
- [x] Docs: backup/restore procedure — documented and tested
- [x] Docs: scaling guide — horizontal scaling options, database read replicas, CDN setup
- [x] Docs: architecture overview — updated diagram matching current module structure
- [x] Docs: new developer onboarding — clone → install → `pnpm dev` → first feature in < 30 minutes
- [x] Docs: module scaffold guide — how to add a new feature module (`docs/dev/module-creation.md`)
- [x] Docs: testing guide — how to write unit, integration, E2E tests (`docs/dev/testing.md`)
- [x] Docs: code review checklist — what to check before approving PRs
- [x] Runbook: incident response — detection → triage → mitigation → resolution → postmortem
- [x] Runbook: database emergency — connection pool exhaustion, long-running queries, migration failures
- [x] Runbook: authentication issues — locked accounts, token rotation, OAuth provider outage
- [x] Runbook: deployment rollback — when to rollback, how to rollback, verification after rollback
- [x] UI: empty dashboard — welcome message + getting started checklist
- [x] UI: empty workspace member list — "Invite your first teammate" CTA
- [x] UI: empty notification list — "No notifications yet" message
- [x] UI: empty activity feed — "No recent activity" message
- [x] UI: empty session list — should never be empty (current session always exists) — verify
- [x] UI: empty billing invoices — "No invoices yet" message
- [x] UI: empty API keys — "Create your first API key" CTA
- [x] UI: Skeleton loaders on all data-dependent pages (dashboard, settings, admin)
- [x] UI: verify no layout shift during data loading (skeletons match final layout dimensions)
- [x] UI: page transition loading indicator (Suspense fallback with LoadingContainer)
- [x] UI: global error boundary — friendly error page with "Try Again" + "Go Home" buttons
- [x] UI: per-section error boundaries — individual widgets recover without full page crash
- [x] UI: network error handling — "Connection lost" toast with retry option
- [x] UI: 404 page — branded, with navigation links back to known pages
- [x] UI: 403 page — "You don't have permission" with redirect to appropriate page
- [x] UI: first-login onboarding wizard — profile setup → create/join workspace → (optional) invite team → (optional) select plan
- [x] UI: onboarding progress tracker — visible until all steps completed, dismissible (GettingStartedChecklist component)
- [x] UI: contextual tooltips for key features on first use
- [x] UI: "First success moment" — workspace created with sample content/welcome message
- [x] Verify: no cross-app imports (apps import from packages only, never from each other)
- [x] Verify: all barrel exports are explicit named exports (utility namespace re-exports are accepted exceptions)
- [x] Verify: all path aliases resolve correctly in production build
- [x] Verify: dependency flow never reversed (`apps` → `packages` → `shared`, never backwards)
- [x] Verify: registration → email verification → auto-create default workspace (`verify.ts` fire-and-forget)
- [x] Verify: user deletion → cascade to sessions, tokens, memberships, subscriptions, files (ON DELETE CASCADE on all user FKs in schema)
- [x] Verify: tenant suspension → all members blocked from workspace access (`getTenantById()` checks `isActive`, throws ForbiddenError)
- [x] Verify: role change → immediate effect on permission-gated UI and API
- [x] Verify: subscription change → entitlement update → feature gating works immediately
- [x] Verify: email change → all email-dependent features use new email (all FKs use userId, email resolved from users table at query time)
- [x] Verify: multi-tenant workspaces + membership roles + invites end-to-end
- [x] Verify: entitlements service + assert helper works for all plan tiers
- [x] Verify: subscription lifecycle states wired end-to-end (trialing/active/past_due/canceled)
- [x] Verify: general audit log records all critical actions (separate from security events)
- [x] Verify: data export + deletion workflows complete with cascading cleanup (export aggregates 8 data categories: profile, memberships, subscriptions, activities, files, notifications, sessions, consent; deletion via ON DELETE CASCADE)
- [x] Verify: baseline observability — errors captured, metrics available, logs searchable (structured logging + correlationId middleware + request context)
- [x] Verify: idempotent webhooks — duplicate events ignored, out-of-order handled (billing events dedup via UNIQUE constraint + wasProcessed(), state machine rejects invalid transitions)
- [x] Verify: tenant scoping enforced on every tenant-scoped query
- [x] Verify: baseline security defaults active (secure cookies, CSRF, CORS, rate limits, correlation IDs)
- [x] `@bslt/api` — hardcoded constants replaced with `@bslt/shared` (`HTTP_STATUS`, `ERROR_CODES`, `ERROR_MESSAGES`); duplicated request helpers consolidated into shared `apiRequest()` factory; duplicated config interfaces unified into `BaseClientConfig`; magic numbers named
- [x] `@bslt/react` — shared package usage verified, no remaining hardcoded values
- [x] Schema: add `version` (integer, default 0) column to all syncable tables (migration)
- [x] Contract: `infra/realtime` transaction types — define write operation shapes, version metadata, delta sync types
- [x] Route: `POST /api/realtime/write` — accept write operations, bump version, publish change via PubSub
- [x] Route: `POST /api/realtime/getRecords` — fetch records by table + filters with version metadata
- [x] Service: write handler — extend WriteService to validate, persist, increment version, broadcast via WebSocket PubSub
- [x] Service: record query with version tracking — return records + their current versions for delta sync
- [x] Component: `RealtimeContext` — React context holding WebSocket connection state + subscription registry
- [x] Component: `RealtimeProvider` — wraps app, manages WebSocket lifecycle, provides `RealtimeContext`
- [x] Service: version-based update notifications — subscribe to record changes by key, push deltas to subscribers
- [x] Service: missed-message recovery — delta sync from last known version on reconnect
- [x] Hook: `useRecord<T>(table, id)` — single record subscription with real-time updates
- [x] Hook: `useRecords<T>(table, filters)` — collection subscription with filtering + pagination
- [x] Hook: `useWrite()` — optimistic write with offline queue (auto-sync on reconnect)
- [x] Hook: `useUndoRedo()` — undo/redo controls bound to write operations
- [x] Service: optimistic write pipeline — apply locally → send to server → reconcile on response
- [x] Service: conflict resolution — last-write-wins with version check, rollback on conflict
- [x] Service: offline queue integration — queue writes during disconnect, replay on reconnect
- [x] Service: service worker asset caching strategy — static assets cached, API no-store respected
- [x] Service: cache-first for JS/CSS bundles, network-first for API responses
- [x] Service: cache versioning — invalidate stale caches on deploy
- [x] Unit: hook behavior (subscribe → receive update → re-render), optimistic state management
- [x] Unit: conflict resolution logic (version mismatch → rollback)
- [x] Unit: write handler — version increment, PubSub broadcast
- [x] Unit: transaction type validation, delta sync type serialization
- [x] Integration: write record via `/api/realtime/write` → WebSocket notification → subscriber receives update
- [x] Integration: `getRecords` returns correct records with version metadata
- [x] Integration: RealtimeProvider connects, subscribes, receives live updates
- [x] Middleware: request context logging — attach IP, method, path, user agent to every log entry (structured via Pino)
- [x] Service: conditional logging by severity — 5xx errors: full stack trace + request context; 4xx client errors: warn-level summary only (no stack trace noise)
- [x] Config: `logging.clientErrorLevel` — configurable severity threshold for client errors (default `warn`)
- [x] Config: `logging.requestContext` — toggle request context fields in log output (default `true` in production)
- [x] Tool: route manifest exporter — `pnpm route:manifest` outputs JSON of all registered routes
- [x] Tool: API client sync validator — `pnpm audit:api-sync` checks client coverage vs routes
- [x] Tool: `pnpm scaffold:module <name>` — generates: handler, service, routes, tests, types stubs
- [x] Tool: scaffold creates barrel exports and registers in parent index.ts
- [x] Tool: scaffold adds route registration to server routes
- [x] Docs: module creation guide using scaffold tool
- [x] Service: route versioning strategy — `/api/v1/...` prefix with backward-compat redirect
- [x] Service: version deprecation middleware — `Sunset` header, `Deprecation` header, `X-Deprecation-Notice`
- [x] Docs: versioning policy — how to add new versions, sunset timeline
- [x] Tool: `pnpm db:reset` — drop + recreate + migrate + seed dev DB in one command
- [x] Tool: confirmation prompt to prevent accidental use (skippable with `--force`)
- [x] Unit: scaffold template generation test (19 tests passing)
- [x] Unit: request context logger — verify IP, method, path included in structured log output
- [x] Unit: severity-based logging — 5xx produces error-level with stack, 4xx produces warn-level without stack
- [x] Manual: `pnpm scaffold:module test-module` → produces correct files → type-checks
- [x] Service: distributed cache provider (Redis) — `RedisCacheProvider` with ioredis, tag-based invalidation
- [x] Config: `CACHE_PROVIDER=local|redis` env var — factory selects provider at startup
- [x] Service: cache-aside pattern for hot data (user profiles via `cacheAside()` helper)
- [x] Service: cache invalidation strategy — TTL + tag-based invalidation on writes
- [x] Config: `DATABASE_READ_REPLICA_URL` env var + `readReplicaConnectionString` in PostgresConfig
- [x] Service: `ReadReplicaClient` — writes to primary, reads to replica (falls back to primary when no replica)
- [x] Service: replication lag awareness — critical reads (post-write) go to primary
- [x] Service: connection pool management for primary + replica (maxConnections pass-through)
- [x] Infra: stateless server design verification — JWT auth, DB-backed sessions, no in-process state
- [x] Infra: WebSocket scaling — PostgresPubSub wired to SubscriptionManager for cross-instance messaging
- [x] Docs: horizontal scaling guide — `docs/dev/horizontal-scaling.md`
- [x] Unit: Redis provider tests (57 tests) — get/set/has/delete, bulk ops, tags, stats, lifecycle
- [x] Unit: factory tests (10 tests) — provider selection, env config, options passthrough
- [x] Unit: cache-aside tests (5 tests) — miss/hit/TTL/tags/undefined handling
- [x] Unit: read-replica tests (12 tests) — no replica/empty/with replica/URL verification + readClient routing + markWrite grace period
- [x] Hook: `useUndoableMutation` — wraps `useMutation` to auto-push transactions to undo stack
- [x] Hook: `useUndoRedoController` — integrates store + keyboard shortcuts + toast notifications
- [x] UI: `UndoRedoToolbar` component — undo/redo buttons with keyboard shortcut hints
- [x] UI: Toast action support — toasts can include action buttons (e.g., "Redo")
- [x] UI: keyboard shortcuts (Ctrl+Z / Ctrl+Shift+Z) wired to undo/redo stack via controller
- [x] UI: undo/redo buttons in app top bar (disabled when stack empty)
- [x] UI: toast notification on undo — "Action undone" with "Redo" action button
- [x] Service: bind undo/redo stack to write operations (record create/update/delete → push to stack)
- [x] UI: undo history panel (optional) — list of recent operations with undo/redo actions
- [x] Unit: `useUndoableMutation` — transaction push, set operations, snapshot capture (6 tests)
- [x] Unit: `useUndoRedoController` — undo/redo with toasts, handler apply, counts (8 tests)
- [x] Unit: `UndoRedoToolbar` — button states, click handlers, accessibility (7 tests)
- [x] Unit: `UndoHistoryPanel` — empty state, entries, multi-field labels, undo-to-here, ordering (7 tests)
- [x] Unit: `useUndoHandler` — handler stability, set operations, multi-ops, non-set ignored (5 tests)
- [x] Unit: Toast action — render action button, click handler, absence when undefined (3 tests)
- [x] Config: theme integration — wrap stories in `ThemeProvider`, support light/dark mode toggle
- [x] Stories: elements — Button, Input, Text, Heading, Badge, Alert, Spinner, Checkbox, Switch, Table, Progress
- [x] Stories: components — Card, Dialog, Dropdown, Select, Tabs, Toast, Popover, FormField, Accordion, Pagination
