# Week 6: February 2–8, 2026

> **Summary**: Massive week of architectural refinement across all layers of the monorepo.
>
> - **Monorepo restructure**: `packages/` + `client/` + `apps/` → unified `src/` hierarchy; 5 packages consolidated into `@abe-stack/core`; full build green (42/42 build + 13/13 test tasks)
> - **`@abe-stack/db`**: Functional repository refactor (11 repos, 213 tests), Phase 2 expansion (16 repos, 615 tests), schema completion (7 files, 554 tests), package reorg (`write/` → `queue/`, routing to engine), 4 new schema modules (files, email, tenant-settings, activities), build toolchain cleanup (tsup → tsc)
> - **`@abe-stack/shared`**: Zod removal (23 files → manual `createSchema`), barrel export cleanup (all `export *` eliminated), 4 rounds of deep security audits (SQL injection, ReDoS, timing leaks, `as` cast removal, crypto hardening — 106 test files, 3,580 tests), contracts → domain+core migration, utils reorg, +1,002 tests across 15 new files
> - **`@abe-stack/server-engine`**: 8-phase refactor, comprehensive 6-workstream audit (JWT timing fix, SQL injection parameterization, SMTP socket leak fix, O(1) rate limiter, dead router deletion — 32 new tests)
> - **`@abe-stack/media`**: 4-phase refactor (remove fluent-ffmpeg/music-metadata, memory safety, entitlement gating), 3 rounds of security audit (FD leaks, buffer bounds, FFmpeg filter injection, dimension validation, unbounded queue, crypto file IDs — 331 tests)
> - **`@abe-stack/web`**: HomePage rebuild (resizable panel layout, 24 files), demo → ui-library rename, config consolidation
> - **Schema consistency**: 3 rounds of DB ↔ domain audits, user profile expansion (`name` → `username`/`firstName`/`lastName` + 6 fields), `isVerified` → `emailVerified` rename across ~30 files
> - **`main/tools/`**: CJS `require()` elimination, stale directory paths, ESM entry guards, shebang corrections

---

## Table of Contents

- [Tuesday (02-03)](#tuesday-february-3-2026) — Shared test audit, db functional repo refactor (11 repos + Phase 2: 16 repos), DB schema completion, codebase consolidation, demo → ui-library rename, config consolidation
- [Wednesday (02-04)](#wednesday-february-4-2026) — Domain module expansion (4 modules, 138 tests), shared verification (86/86 files), HomePage rebuild (24 files), barrel export cleanup, Zod removal, server-engine 8-phase refactor, module consolidation (5 → core), `modules/` → `packages/core/` move
- [Thursday (02-06)](#thursday-february-6-2026) — Complete monorepo restructure (`src/` hierarchy), project-wide error fix (146 files, 12 packages), `main/shared` security audits (rounds 1-4), +1,002 tests (15 files), db package reorg, build toolchain cleanup (tsup → tsc), user profile expansion, schema consistency audit (3 rounds)
- [Friday (02-07)](#friday-february-7-2026) — Schema consistency audit (DB → domain → API), utils directory reorganization, contracts → domain+core migration, utils cleanup
- [Sunday (02-08)](#sunday-february-8-2026) — Media 4-phase refactor + 3 security audit rounds (331 tests), server-engine comprehensive audit (6 work streams, 32 new tests), `main/tools/` audit (CJS elimination, ESM conversion), auth flow Part 1 completion (email change page, TOTP backup hint, 4 test files / 162 tests)

---

## Tuesday, February 3, 2026

### Deep Audit of `packages/shared` Unit Tests

Reviewed all 31 test files. 26 had complete coverage. Fixed 5 files with gaps:

| File                    | Gap                                                   | Fix Summary                                                                     |
| ----------------------- | ----------------------------------------------------- | ------------------------------------------------------------------------------- |
| `billing.logic.test.ts` | Only 1 of 14+ exported functions tested               | Added tests for 13 functions + `PLAN_FEES`                                      |
| `errors.test.ts`        | 11 specialized error subclasses untested              | Added tests for all 11 error subclasses                                         |
| `storage.test.ts`       | 3 of 4 exported functions untested                    | Added tests for `joinStoragePath`, `generateUniqueFilename`, `validateFileType` |
| `pagination.test.ts`    | `PaginationError` class and schema factories untested | Added `PaginationError` + schema tests                                          |
| `schemas.test.ts`       | `passwordSchema` and `errorCodeSchema` untested       | Added tests for both schemas                                                    |

**Verification**: 31/31 files, 716/716 tests pass, 0 lint errors.

---

### packages/db: Functional Repository Refactor (Phases 1–5)

**Problem**: `factory.ts` defined a 17-key `Repositories` interface but only 6 billing repositories were implemented. 11 were missing.

**Phase 1 — Fix Foundations**: Replaced `any` with `unknown` in `QueryResult`, reimplemented `toCamelCase`/`toSnakeCase` locally, added billing tables to `REQUIRED_TABLES`.

**Phase 2 — Create 11 Functional Repositories**: Each follows the `createXxxRepository(db: RawDb)` factory pattern.

| Directory     | Repository                         | Key Methods                                                                                     |
| ------------- | ---------------------------------- | ----------------------------------------------------------------------------------------------- |
| `users/`      | `UserRepository`                   | `findByEmail`, `findById`, `update`, `create`                                                   |
| `auth/`       | `RefreshTokenRepository`           | `deleteByToken`, `create`, `findByFamilyId`, `deleteByUserId`, `deleteExpired`                  |
| `auth/`       | `RefreshTokenFamilyRepository`     | `findActiveByUserId`, `findById`, `create`, `revoke`                                            |
| `auth/`       | `LoginAttemptRepository`           | `create`, `findRecentByEmail`, `countRecentByIp`                                                |
| `auth/`       | `PasswordResetTokenRepository`     | `findValidByTokenHash`, `create`, `markAsUsed`, `deleteExpiredByUserId`                         |
| `auth/`       | `EmailVerificationTokenRepository` | `findValidByTokenHash`, `create`, `markAsUsed`                                                  |
| `auth/`       | `SecurityEventRepository`          | `create`, `findByUserId`, `findRecent`                                                          |
| `magic-link/` | `MagicLinkTokenRepository`         | `countRecentByEmail`, `countRecentByIp`, `create`, `deleteExpired`, `findValidByTokenHash`      |
| `oauth/`      | `OAuthConnectionRepository`        | `findByProviderUserId`, `findByUserIdAndProvider`, `findByUserId`, `create`, `update`, `delete` |
| `push/`       | `PushSubscriptionRepository`       | `create`, `findByUserId`, `findByEndpoint`, `deleteByEndpoint`                                  |
| `push/`       | `NotificationPreferenceRepository` | `findByUserId`, `upsert`                                                                        |

Created 5 barrel `index.ts` files: `users/`, `auth/`, `magic-link/`, `oauth/`, `push/`.

**Phase 3 — Rewire Factory & Barrels**: Replaced broken `../migrations/index` imports, converted all `export *` to explicit named exports. Renamed legacy repos with `-legacy` suffix.

**Phase 5 — Tests**: 12 files, **213/213 tests pass**.

**Architectural decisions**: Functional pattern over class-based (matches billing repos); consumer API unchanged (zero breaking changes); legacy repos renamed to `*-legacy.ts`.

---

### DB Schema Completion (All 34 Tables)

Created TypeScript schema files for 7 remaining domain modules, plus test files for sessions (46 tests) and tenants (109 tests).

| File               | Tables | Tests |
| ------------------ | ------ | ----- |
| `notifications.ts` | 1      | 55    |
| `system.ts`        | 4      | 119   |
| `features.ts`      | 2      | 80    |
| `metering.ts`      | 2      | 73    |
| `compliance.ts`    | 3      | 72    |
| `sessions.ts`      | 1      | 46    |
| `tenant.ts`        | 3      | 109   |

**Total schema layer**: 13 test files, **951/951 tests, 0 failures**.

Key decisions: `NotificationLevel` named to avoid collision with `NotificationType`; append-only tables have no `Update*` type; `unknown` used instead of `unknown | null` for JSONB fields (ESLint `no-redundant-type-constituents`).

---

### Fix `packages/db` ESLint & TypeScript Registration

**Root cause**: `packages/db` was never registered in:

1. Root `tsconfig.json` project references
2. ESLint `parserOptions.project` overrides
3. ESLint `boundaries/elements` element types

This affected ALL files in `packages/db`, not just new ones.

**Fix**: Created `packages/db/tsconfig.lint.json` (extends base, includes test files), added `db` to project references, ESLint import resolver, and boundary rules. The `db` package sits at the infrastructure layer:

- **Can import from**: `shared` (core types)
- **Can be imported by**: `app`, `module`, `engine`
- **Cannot import from**: `client`, `premium`, `app`

---

### Dedup & Housekeeping

- Removed 370 lines misplaced in W05 log (background agents wrote Feb 3 entries to wrong file)
- Deleted 8 byte-identical duplicate scripts in `packages/db/src/scripts/` (canonical copies in `tools/scripts/db/`)

---

### packages/db: Post-Refactor Improvement Loop

Found and fixed 3 critical, 3 high, 4 medium issues:

- **CRITICAL**: `UserRepository` missing `listWithFilters`/`lockAccount`/`unlockAccount`; `plans.ts` `existsByName` logic bug (`or(eq())` → `ne()`); broken transaction export path
- **HIGH**: `@abe-stack/shared/utils` import fails at runtime (inlined conversion functions); `utils.test.ts` called wrong functions; factory test asserted wrong key count
- **MEDIUM**: Missing barrel exports, stale path comments, minimal JSDoc

**Verification**: 43 test files, 2,012 tests pass.

---

### Codebase Consolidation: DB + Shared Package Restoration & Import Repair

Restored missing code from prior refactoring scattered across `core/`, `infra/`, `kernel/`, `tools/`.

| Package           | Before | After | Restored Files | Deduplicated |
| ----------------- | ------ | ----- | -------------- | ------------ |
| `packages/db`     | ~40    | 103   | ~60            | —            |
| `packages/shared` | 93     | 231   | 155            | 17           |

Key restored directories for `packages/shared`:

- `contracts/` (38 files from `infra/contracts/src/` + `kernel/src/contracts/`)
- `config/` (17 files from `packages/engine/src/config/`)
- `utils/search/`, `logger/`, `utils/monitor/`, `utils/pubsub/` (30 files from `core/src/infrastructure/`)
- `domain/auth/`, `domain/billing/`, `domain/notifications/` (17 files — errors, types, schemas)

Fixed **205 broken cross-package imports**:

| Old Package              | New Package                | Files Fixed |
| ------------------------ | -------------------------- | ----------- |
| `@abe-stack/core/config` | `@abe-stack/shared/config` | 32          |
| `@abe-stack/core` (bare) | `@abe-stack/shared`        | 12          |
| `@abe-stack/infra`       | `@abe-stack/db`            | 161         |

Updated 7 barrel `index.ts` files and `package.json` exports. Namespace exports used for large modules (`Contracts`, `Config`, `Search`, `Logger`, `Monitor`, `PubSub`) to avoid naming collisions.

---

### packages/db: Phase 2 Repository Expansion (16 Repos, 615 Tests)

Created functional repositories for all 7 remaining schema domains, expanding factory from 17 to 33 keys.

| Domain        | Repos | Key Design Note                                                 |
| ------------- | ----- | --------------------------------------------------------------- |
| sessions      | 1     | Standard CRUD + deleteExpired                                   |
| tenant        | 3     | Tenant, Membership, Invitation                                  |
| notifications | 1     | Paginated findByUserId, countUnread, markAllAsRead              |
| system        | 4     | AuditEvent + WebhookDelivery are append-only (no update/delete) |
| features      | 2     | TenantFeatureOverride uses upsert with onConflictDoUpdate       |
| metering      | 2     | UsageSnapshot uses composite-key upsert                         |
| compliance    | 3     | UserAgreement + ConsentLog are append-only                      |

**Tests**: 17 files, **615/615 passed**. Fixed 12 assertion errors from parallel agent generation (SQL builder parameterization behavior: LIMIT/OFFSET values baked into text, not `values` array).

**Key design notes**: All 16 repos follow functional `createXxxRepository(db: RawDb)` pattern. Upsert for idempotent writes: `onConflictDoUpdate(['tenant_id', 'key'], ['is_enabled', 'value'])`. TEXT primary keys for `FeatureFlagRepository` and `UsageMetricRepository` (not UUID).

---

### Rename Demo Feature to UI Library

Renamed `features/demo/` → `features/ui-library/`, all `Demo*` → `UILibrary*`, routes `/demo` → `/ui-library`. ~55 files touched via `git mv`. Retained `@catalog` alias (only path updated).

---

### Config Consolidation

Established two canonical config locations:

- `packages/engine/src/config/` — types, schemas, parsers (reusable core)
- `apps/server/src/config/` — domain-specific loaders (app-specific)

Added `./config` subpath export to `packages/engine/package.json`, enabling `import { AuthConfig } from '@abe-stack/engine/config'`. Rewired ~60 files from scattered config imports. Deleted ~30 duplicate config files across `packages/shared/src/config/`, `modules/auth/src/config/`, `modules/billing/src/config.ts`, and their server copies.

Created `Argon2Config` type alias (`AuthConfig['argon2']`) as single source of truth. Fixed pre-existing tsconfig bug: `modules/auth/tsconfig.json` had double `packages/packages/shared` path.

**Verification**: 141 tests passing across 10 test suites. Zero remaining `@abe-stack/shared/config` imports.

---

### Tuesday Summary

| Category                        | Count                        |
| ------------------------------- | ---------------------------- |
| Schema files created            | 7                            |
| Functional repositories created | 11 + 16 = 27                 |
| Shared test files fixed         | 5                            |
| New tests written               | ~1,244 (schema) + 615 (repo) |
| Tables with schema coverage     | 34/34                        |

---

## Wednesday, February 4, 2026

### Domain Module Expansion (4 Modules, 138 Tests)

Created 4 new domain modules completing all 33 tables' domain coverage:

| Module     | Tables Covered               | Logic Functions                                                     | Tests |
| ---------- | ---------------------------- | ------------------------------------------------------------------- | ----- |
| Sessions   | user_sessions                | `isSessionActive`, `isSessionRevoked`, `getSessionAge`              | 10    |
| Jobs       | jobs                         | `isTerminalStatus`, `canRetry`, `shouldProcess`, `calculateBackoff` | 22    |
| Webhooks   | webhooks, webhook_deliveries | `matchesEventFilter`, `isDeliveryTerminal`, `shouldRetryDelivery`   | 26    |
| Compliance | legal_documents + 2          | `needsReacceptance`, `isConsentGranted`, `getEffectiveConsent`      | 14    |

Added 7 branded UUID types to `types/ids.ts`. Renamed domain `Job` to `DomainJob` to avoid collision with `core/ports.ts` `Job<T>`.

---

### packages/shared: Complete Verification & Test Repair (86 Files, 2,288 Tests)

Fixed all issues from the consolidation (155+ restored files, 17 deduplicated, 205 import fixes):

1. **ErrorCode type strictness** (~45 TS2345 errors): Widened `code` from `ErrorCode` to `string` in base error classes — domain codes are open-ended strings
2. **Barrel export cleanup**: Converted `export *` to explicit named exports in `core/index.ts`
3. **Test import path fixes** (19 files): Updated stale paths from old directory structure
4. **toJSON format alignment** (4 files): Updated assertions to match `{ ok: false, error: { code, message, details } }` format
5. **BatchedQueue API fix**: Updated constructor format and replaced `destroy()` → `clear()`

**Result**: 86/86 test files, 2,288/2,288 tests, 0 type errors.

---

### HomePage Rebuild (24 Files)

Rebuilt HomePage as full-featured resizable panel layout (top/bottom/left/right panes) at `features/home/`.

**DRY approach**: Parameterized existing `useUILibraryPanes` and `useUILibraryTheme` hooks with optional `storageKey` argument instead of duplicating. Two unique hooks kept separate: `useHomeKeyboard` (different shortcuts: T/L/R/B/D/Esc) and `useDocContent` (doc-loading with Map cache).

#### Directory Structure

```text
apps/web/src/features/home/
├── components/
│   ├── HomeTopBar.tsx          — SidePeek toggle, heading, auth buttons
│   ├── HomeBottomBar.tsx       — Version badges, keyboard hints, theme toggles
│   ├── HomeMainLayout.tsx      — 3-column ResizablePanel layout
│   ├── HomeDocViewer.tsx       — Markdown viewer with loading/welcome states
│   └── HomeNavList.tsx         — Page links + doc entries
├── hooks/
│   ├── useHomeKeyboard.ts
│   └── useDocContent.ts
├── data/
│   └── docsMeta.ts             — Doc metadata, categories, lazy loader
├── pages/
│   └── HomePage.tsx
└── types.ts                    — HomePaneConfig, DocKey, DocMeta
```

Added `@home` path alias to 4 config files. Deleted old `pages/HomePage.tsx`. 410/410 tests passing.

---

### Barrel Export Cleanup: Eliminate All `export *`

Converted all non-namespaced `export *` wildcards in `packages/shared/src/` to explicit named exports:

- `domain/index.ts`: 13 wildcards → ~260 explicit exports
- `contracts/index.ts`: 1 wildcard → ~70 explicit exports
- `utils/index.ts`: 1 wildcard → 8 explicit exports
- `index.ts`: 2 wildcards → ~345 explicit exports with collision resolution

Kept 9 namespaced `export * as X` patterns (safe — creates namespace boundary). Fixed 4 bugs found during cleanup (duplicate `toCamelCase`, misplaced `SORT_ORDER`, missing `HTTP_STATUS`, debug `console.log`).

**Name collision resolution** (root barrel): `Logger` namespace renamed to `LoggerNs`; `toCamelCase` flat-exported from `./utils/string` (casing version via direct import); `validatePassword` from `./domain/auth` (canonical); `SetOperation`/`Transaction` from `./core/transactions` (realtime versions via `Contracts.*`).

**Verification**: 0 non-namespaced `export *` remaining, 84/84 files, 2,228/2,228 tests.

---

### Config Helpers DRY + System Module Migration

**Config helpers**: Consolidated triple-duplicated `isStrategyEnabled`/`getRefreshCookieOptions` (in `modules/auth/src/utils/`, `apps/server/src/modules/auth/utils/`, and `apps/server/src/config/auth/`) into single canonical file at `packages/engine/src/config/auth-helpers.ts`. All consumers now import from `@abe-stack/server-engine/config`. Deleted 4 duplicate files. 12 tests passing.

**System module**: Moved health orchestration logic from `modules/system/` (standalone workspace package) into `packages/engine/src/system/`, keeping only Fastify HTTP adapters in `apps/server/src/modules/system/`. Deleted `modules/system/` package entirely (9 files).

Key decision: `getDetailedHealth()` and `logStartupSummary()` accept optional `WebSocketStats` parameter (dependency injection). This prevents engine (Tier 2) from importing `@abe-stack/realtime` (Tier 3+ premium module). The app-level caller (`apps/server`) passes the stats in. Created 4 files, 24 tests passing.

---

### File Organization Refactor (4 Moves in `packages/shared`)

1. Deleted duplicate `utils/constants/http.ts` (core version more complete)
2. Consolidated duplicate `PaginationError` classes
3. Moved `utils/password.ts` into `domain/auth/` (where it semantically belongs)
4. Verified barrel export cleanliness

---

### Zod Removal from `packages/shared`

**Problem**: `packages/shared` had a "split-brain" architecture — `contracts/` used manual `createSchema` (zero Zod), while `domain/`, `core/`, `types/`, `utils/` used Zod schemas. Both validation paths coexisted, causing duplication and an unnecessary runtime dependency.

**Migration**:

1. Enhanced `contracts/schema.ts` with helper primitives (`parseString`, `parseNumber`, `parseBoolean`, `parseOptional`, `parseNullable`, `createEnumSchema`, `createBrandedUuidSchema`, `createArraySchema`, `createLiteralSchema`, `createUnionSchema`)
2. Migrated `types/ids.ts` (15 branded IDs → `createBrandedUuidSchema`), `core/schemas.ts`, `core/api.ts`, `core/env.ts`, `utils/pagination.ts`
3. Migrated all `domain/*.schemas.ts` files (23 files total)
4. Rewrote 3 test files still importing from `zod`
5. Fixed behavioral parity: `emailSchema` added `.trim().toLowerCase()`, `isoDateTimeSchema` added regex to reject date-only strings
6. Removed `zod` from `package.json` (dependencies + peerDependencies)

**Key decision**: Branded types via phantom branding (`type UserId = string & { readonly __brand: 'UserId' }`) — structurally compatible, no Zod dependency. Password validation simplified to minimum length in schema; comprehensive strength validation in `domain/auth/`.

**Result**: 84/84 files, 2,228/2,228 tests, zero Zod imports remaining.

---

### Backend-Core Refactor (8-Phase Cleanup)

Fixed broken code, removed dead code, eliminated `any`, deduplicated types, consolidated signing, moved Fastify middleware to server, cleaned re-exports in `packages/engine/`:

- **Critical fixes**: `cache/config.ts` property name, phantom exports, SMTP `exactOptionalPropertyTypes`
- **`any` removal + dedup**: Cache types deduplicated (re-export 10 types from shared), signature data typed
- **Dead code**: Removed shadowed JWT rotation code
- **Signing consolidation**: Merged duplicate `normalizeFilename`, improved regex
- **Middleware moved**: Fastify `preHandler` hooks → `apps/server/src/middleware/`
- **Re-export cleanup**: Removed `@abe-stack/db` re-exports from engine barrel

**Verification**: 310/312 tests pass (2 pre-existing failures).

---

### Fix All TypeScript Errors in packages/db (141 → 0)

**Root cause**: tsconfig misconfiguration — `search/search-factory.ts` imported from `../../migrations/index` (outside src/) violating `rootDir: "./src"`. The `composite: false` setting prevented project references, and there was no reference to `@abe-stack/shared`.

**Fix**:

1. Updated `search/search-factory.ts` imports to `../client` and `../factory`
2. Deleted deprecated `migrations/index.ts` (verified no external usage)
3. Set `composite: true` + added `tsBuildInfoFile` for incremental caching
4. Added project reference to `@abe-stack/shared`

**Why delete `migrations/index.ts` instead of moving**: Marked @deprecated, no external consumers after fixing search-factory. Deletion cleaner than maintaining dead code.

---

### Module Consolidation: 5 Packages → `@abe-stack/core`

Merged `modules/admin`, `modules/auth`, `modules/billing`, `modules/notifications`, `modules/users` into single `@abe-stack/core` with subpath exports (`@abe-stack/core/auth`, `@abe-stack/core/admin`, etc.). The 5 packages were tightly coupled (admin imports from auth and billing, users imports from auth) but maintained as separate workspace packages requiring inter-package dependency declarations.

**Implementation**: Created unified package scaffold (merged deps, subpath exports, single tsconfig). Moved ~161 files via `git mv`. Converted ~20 internal cross-module imports from package aliases to relative paths. Updated ~12 external consumers. Used TypeScript project references with `composite: true` requiring built `.d.ts` files — `exports` field uses `"types": "./dist/{module}/index.d.ts"`.

Then moved filesystem from `modules/` to `packages/core/` for consistent naming. Zero import changes needed since all imports use `@abe-stack/core` (resolved by pnpm workspace). Updated `pnpm-workspace.yaml`, `tsconfig.json` (replaced 6 broken individual module refs with 1), `eslint.config.ts` (9 changes + deleted stale realtime block), and 149 file headers.

---

## Thursday, February 6, 2026

### Complete Monorepo Restructure: → `src/` Hierarchy

Consolidated all source packages from flat `packages/`, `client/`, `apps/` top-level directories into unified `src/` hierarchy:

```text
src/
  apps/
    web/          → @abe-stack/web
    server/       → @abe-stack/server
    desktop/      → @abe-stack/desktop
  client/
    api/          → @abe-stack/api
    engine/       → @abe-stack/client-engine
    react/        → @abe-stack/react
    ui/           → @abe-stack/ui
  server/
    core/         → @abe-stack/core
    db/           → @abe-stack/db
    engine/       → @abe-stack/server-engine
    media/        → @abe-stack/media
    realtime/     → @abe-stack/realtime
    websocket/    → @abe-stack/websocket
  shared/         → @abe-stack/shared
```

Updated `pnpm-workspace.yaml`, `turbo.json`, `tsconfig.json`, `eslint.config.ts`, `vitest.config.ts`, and all per-package config files. Zero import statement changes — pnpm workspace resolution handles package name → path mapping.

---

### Fix All Errors Project-Wide (146 Files, 12 Packages)

Fixed lint, type-check, and test errors after restructure. 146 files changed, 1186 insertions, 1088 deletions across 12 packages.

Key fix patterns:

| Category                          | Packages Affected                | Fix                                                                             |
| --------------------------------- | -------------------------------- | ------------------------------------------------------------------------------- |
| Branded type casting              | web, api, ui, client-engine      | Cast string IDs: `'id' as unknown as UserId`                                    |
| `exactOptionalPropertyTypes`      | core (admin, auth tests)         | Omit properties instead of `undefined`; `createUnauthenticatedRequest()` helper |
| Test assertion mismatches         | core (magic-link, notifications) | Aligned with implementation shapes (removed `success` field, fixed VAPID)       |
| `PlanFeature` discriminated union | web, api                         | Added `key` property, built type guards for limit vs toggle                     |
| `EmailService`/`AuthEmailService` | core (service tests)             | Retyped test variables to match handler signatures                              |
| `CursorSearchResult` shape        | client-engine                    | Added missing `prevCursor` and `hasPrev` properties to mocks                    |

**Key architectural decision**: `createUnauthenticatedRequest()` factory over `{ user: undefined }` — with `exactOptionalPropertyTypes: true`, optional properties cannot be explicitly set to `undefined`.

**Result**: 42/42 build tasks, 13/13 test tasks — full green `pnpm build`.

---

### `main/shared` Security Audits (4 Rounds)

#### Round 1 — Security Vulnerabilities (12 Issues)

| Severity | Issue                                      | Fix                                                           |
| -------- | ------------------------------------------ | ------------------------------------------------------------- |
| CRITICAL | SQL injection in `pagination/helpers.ts`   | `safeSqlIdentifier()` — validates + double-quotes field names |
| CRITICAL | ReDoS in `search/operators.ts`             | Iterative two-pointer `matchLikePattern()`, no regex          |
| HIGH     | O(n) rate limiter                          | Complete rewrite to sliding-window counter, O(1) per check    |
| MEDIUM   | Non-null assertions in DeferredPromise     | Local variables initialized to no-ops                         |
| MEDIUM   | SubscriptionManager throw during iteration | try-catch + dead socket pruning                               |
| MEDIUM   | LRU `has()` mutates cache                  | Pure `has()`, proactive eviction in `set()`                   |
| LOW      | Timing leak in `constantTimeCompare`       | Iterate `Math.max` length, XOR lengths                        |
| LOW      | Modular bias in `generateSecureId`         | Rejection sampling                                            |
| LOW      | Weak `checkTokenSecret`                    | Require `secret.length >= 32`                                 |

**Architectural decisions**: SQL identifier quoting (double-quoting validated identifiers) over allowlist — self-maintaining when new columns added. Iterative pattern matching immune to catastrophic backtracking by design. Sliding-window counter provides smoother rate limiting than fixed windows with O(1) per operation. Pure `has()` on LRU — side-effectful queries violate principle of least surprise.

#### Round 2 — Quality & Type Safety (12 Issues)

| #   | Severity | File               | Issue                                                  | Fix                                                 |
| --- | -------- | ------------------ | ------------------------------------------------------ | --------------------------------------------------- |
| 1   | HIGH     | `storage.ts`       | ReDoS — `validateFileType` built regex from user input | Iterative MIME wildcard matcher, O(n), no regex     |
| 2   | HIGH     | `security.ts`      | Timing leak — `verifyToken` early return on length     | Padded constant-time comparison                     |
| 3   | MEDIUM   | `security.ts`      | 4x `as string` escape hatches                          | Explicit `=== undefined` guards, TypeScript narrows |
| 4   | MEDIUM   | `result.ts`        | Unsafe `as E` cast in `fromPromise`                    | Two function overloads, zero casts                  |
| 5   | MEDIUM   | `billing.logic.ts` | `as unknown as T` double cast in `getFeatureValue`     | Two overloads returning `number` and `boolean`      |
| 6   | MEDIUM   | `policy.ts`        | `as [PolicyResource, PolicyAction]` cast               | `isPolicyResource()`/`isPolicyAction()` type guards |
| 7   | MEDIUM   | `reactive-map.ts`  | Listener throw breaks atomicity of `write()`           | try-catch around listener invocations               |

#### Round 3 — Remaining Files (11 Issues, 7 Files)

JWT timing leak (padded buffers), `as Record` casts replaced with guards, `Math.max(...values)` stack overflow replaced with loop, recursive `sanitizeMetadata` capped at depth 10 with `WeakSet` circular detection, cursor pagination deduplication.

#### Round 4 — Cross-Cutting Sweep

Audited all 398 `as` casts. Fixed 5 issues: missing `Array.isArray` guards in security/audit contracts, `isFilterPrimitive` type guard replacing 8 casts, `JSON.parse` validation before `ClientMessage` cast.

**Final verification**: 106 test files, 3,580 tests, 0 type errors.

---

### Comprehensive Schema & Utility Tests (+1,002 Tests, 15 New Files)

Created 15 new test files covering all untested schema and utility files:

| Category                                                                                                                                       | Files | Tests |
| ---------------------------------------------------------------------------------------------------------------------------------------------- | ----- | ----- |
| Domain schemas (auth, billing, admin, compliance, jobs, membership, notifications, tenant, usage-metering, webhooks, feature-flags, audit-log) | 12    | ~852  |
| Contract modules (deletion, entitlements)                                                                                                      | 2     | 92    |
| Utils (security)                                                                                                                               | 1     | 43    |

All use `safeParse` pattern, factory functions with overrides, zero `any`/`@ts-ignore`.

---

### `@abe-stack/db` Package Reorganization

1. **Deleted duplicate `transaction.ts`** — root `src/transaction.ts` was exact copy of `src/utils/transaction.ts`
2. **Merged `utils.ts` into `utils/` directory** — created `utils/database.ts`, updated barrel with all 14 exports. 33+ consumers importing `../../utils` resolve transparently via `index.ts` fallthrough
3. **Removed `rate-limiter.ts`** — in-memory `RateLimiter` had no DB interaction; server-engine already had compatible Token Bucket with superset interface. Updated 3 consumers
4. **Moved `routing.ts` to server-engine** — Fastify-specific routing (route registration, auth guards) belongs in infrastructure adapter, not DB package. Created `src/routing/` module in server-engine. Updated 5 core route files + 4 test files. Added `zod` dependency for `RouteSchema` union type
5. **Renamed `write/` → `queue/`** — reflects actual purpose (job queue system)

**Verification**: db 2,602 tests, core 63 tests, server routes 26 tests — all passing.

---

### 4 New Schema Modules + Migration/Schema Audit

Created 4 new schema modules filling Enterprise SaaS gaps:

| File                 | Migration                  | Tables                     | Tests | Key Design Decision                                        |
| -------------------- | -------------------------- | -------------------------- | ----- | ---------------------------------------------------------- |
| `files.ts`           | `0013_files.sql`           | files                      | 40    | `FileRecord` (not `File`) to avoid DOM collision           |
| `email.ts`           | `0014_email.sql`           | email_templates, email_log | 54    | email_log is append-only (immutable audit trail)           |
| `tenant-settings.ts` | `0015_tenant_settings.sql` | tenant_settings            | 37    | Composite PK `(tenant_id, key)` matching feature_overrides |
| `activities.ts`      | `0016_activities.sql`      | activities                 | 37    | Append-only, `resource_id` as TEXT for non-UUID IDs        |

Audited all 17 migrations (0000–0016) against schema files. Fixed 2 trigger bugs (`update_updated_at()` → `update_updated_at_column()`), rewrote 2 migrations for consistency (named constraints, ENUM types), fixed `SecurityEvent.metadata` type (`string | null` → `Record<string, unknown> | null` matching JSONB column).

---

### Build Toolchain Cleanup (tsup → tsc)

Migrated `@abe-stack/db` and `@abe-stack/shared` from `tsup` bundling to `tsc --build` + `ensure-js-extensions`. Removed dual CJS/ESM output (monorepo is ESM-only). Removed unused `fastify`/`zod` devDependencies from db.

---

### User Profile Expansion (~50 Files, 4 Packages)

Replaced single `name` field with richer profile model across shared/db/core/server:

| Before                                        | After                                                                                  |
| --------------------------------------------- | -------------------------------------------------------------------------------------- |
| `LoginRequest: { email, password }`           | `LoginRequest: { identifier, password }`                                               |
| `RegisterRequest: { email, password, name? }` | `RegisterRequest: { email, username, firstName, lastName, password }`                  |
| `User.name: string \| null`                   | `username`, `firstName`, `lastName`, `phone`, `phoneVerified`, `dateOfBirth`, `gender` |
| Admin sort by `name`                          | Admin sort by `username`                                                               |

**Phase summary**:

1. **Database**: Migration `0012_user_profile.sql` — added 7 columns, migrated `name` → `firstName`, auto-generated usernames from email prefix, unique lowercase username index
2. **Shared validation**: Added `usernameSchema` (1-15 alphanumeric+underscore), `identifierSchema` (trim+lowercase), `phoneSchema`, `dateOfBirthSchema`, `genderSchema`
3. **Repository**: Added `findByUsername()`, updated search to include new fields
4. **Auth service**: Auto-detects email vs username via `@` character; `generateUniqueUsername()` and `splitFullName()` helpers for OAuth/magic-link flows
5. **Tests**: Updated ~30 test files across shared/core/server

Key decisions: identifier auto-detection via `@` (no ambiguity since usernames cannot contain `@`); lockout stays email-based; phone login deferred (requires SMS provider); 6 fields removed (`city`, `state`, `country`, `bio`, `language`, `website`) to reduce scope.

**Tests**: core 1,797 tests, shared 3,935 tests, server 713 tests — all passing.

---

### Refactor Shared Contracts into Core and Domain

Merged `main/shared/src/contracts/` into `core/` and `domain/`:

- **Core foundation**: `core/api.ts` (HttpMethod, Schema, EndpointDef, Contract), `core/schema.utils.ts` (createSchema, createEnumSchema, createUnionSchema), `core/schemas.ts` (uuidSchema, emailSchema, errorResponseSchema), `core/ports.ts` (AuditService, DeletionService, EmailService, JobQueueService, CacheService, MetricsService, ConfigService), `core/pagination.ts`
- **Domain-specific**: compliance/deletion, admin, users, auth+oauth, billing+entitlements, jobs, tenant/workspace
- All barrel exports converted to explicit named exports

**Key decision**: Infrastructure port interfaces in `core/ports.ts` decouple core logic from implementations (hexagonal architecture alignment).

---

### Schema Consistency Audit (DB ↔ Shared Alignment)

Fixed 13 type errors (OAuth import paths, missing job schemas, status mismatch) and 30 pre-existing test failures:

| Category                | Files | Tests Fixed | Root Cause                                                               |
| ----------------------- | ----- | ----------- | ------------------------------------------------------------------------ |
| User profile expansion  | 5     | 23          | Test data used old `name` field; userSchema now requires new fields      |
| Pagination import paths | 3     | 4           | `utils/pagination.ts` moved without updating relative imports or barrel  |
| coerceDate strictness   | 4     | 7           | Tests expected date-only strings rejected, but `new Date()` accepts them |
| Billing logic + domain  | 2     | 2           | Feature value defaults, `PaginationError` import from deleted path       |

**Result**: 115/115 files, 3,935/3,935 tests passing.

---

### `contracts/` → `domain/` + `core/` Migration (Complete)

6-phase migration eliminating the monolithic `contracts/` directory:

1. Cross-cutting utilities to `core/` (context, environment, native)
2. Domain contracts to respective `domain/` folders (oauth → auth, security → admin, realtime → realtime, entitlements → billing, workspace → tenant)
3. Updated 19 internal domain imports (`../../contracts/schema` → `../../core/schema.utils`, `../../contracts/common` → `../../core/schemas`)
4. Updated 10+ external server consumers
5. Updated barrels, package.json, vite/vitest configs
6. Fixed lint/type/test errors

**Final**: Deleted `contracts/` entirely. Zero `contracts/` imports remain project-wide.

---

## Friday, February 7, 2026

### Schema Consistency Audit (DB → Domain → API)

Fixed 12 discrepancies comparing DB schema (source of truth) against domain and API layers:

**CRITICAL fixes**:

1. **AUDIT_CATEGORIES mismatch** — aligned constants with DB schema values, added missing `AUDIT_SEVERITIES` array
2. **Job statuses** — fixed `JOB_STATUSES` to array form matching DB schema
3. **User profile fields missing from DB** — added 6 fields (city, state, country, bio, language, website) to `users.ts` + migration `0017_user_profile_extended.sql`

**MAJOR fixes**: 4. **`isVerified` → `emailVerified` rename** across ~30 files spanning `@abe-stack/shared`, `@abe-stack/core`, `@abe-stack/web` to match DB field name `email_verified` 5. **Security Event Types** — added 8 missing `SecurityEventType` values to contracts layer 6. **DataExportRequest domain schema** — added `DATA_EXPORT_TYPES`, `DATA_EXPORT_STATUSES`, interfaces and validation schemas to `compliance.schemas.ts` 7. **Shared `User` type alignment** — expanded from 8-field simplified type to 14-field full profile type matching API responses

**Test updates**: Updated `users.test.ts` (59 tests for 27-field USER_COLUMNS), `users.schemas.test.ts`, `users.permissions.test.ts` with new factories.

**Architectural note**: DB schema is the single source of truth. Shared `User` type is API-facing (ISO date strings, no internal fields like `passwordHash`/`totpSecret`).

---

### Utils Directory Reorganization

Organized flat `utils/` files into semantic subdirectories:

| New Group       | Files Moved                       |
| --------------- | --------------------------------- |
| `utils/http/`   | http.ts, http-types.ts, routes.ts |
| `utils/crypto/` | crypto.ts, jwt.ts, token.ts       |
| `utils/string/` | string.ts, casing.ts              |

Deleted dead code: duplicate `core/pagination.ts`, unexported `utils/security.ts`. Remaining flat files (`rate-limit.ts`, `storage.ts`, `port.ts`) kept as standalone.

---

### Schema Consistency — Round 3

- Added 9 missing `SecurityEventType` values (domain now has all 26 matching DB)
- Added `NOTIFICATION_LEVELS` const and type
- Added `id` field to domain `UsageSnapshot`
- Added `BILLING_EVENT_TYPES` const and type
- Added `DOCUMENT_TYPES`/`CONSENT_TYPES` to DB schema
- Fixed `dateOfBirth` `instanceof Date` check in profile handler

---

### Utils Cleanup & Post-Reorg Polish

- Removed duplicate `port.ts` from server-engine
- Moved `token.ts` into `crypto/` subdirectory
- Fixed missing barrel exports (storage utilities)
- Fixed ~60 stale path comments (`packages/shared/src/` → `shared/src/`)

---

## Sunday, February 8, 2026

### TOTP Handler Tests + TOTP Backup Codes Repository Tests

**TOTP handlers** (`main/server/core/src/auth/handlers/totp.test.ts`): 39 tests covering `handleTotpSetup` (6), `handleTotpEnable` (5), `handleTotpDisable` (5), `handleTotpStatus` (5), `handleTotpLoginVerify` (18 — success flow, invalid challenge token, invalid TOTP code, user not found, error handling). Follows `login.test.ts` patterns with vi.hoisted mocks.

**TOTP backup codes repository** (`main/server/db/src/repositories/auth/totp-backup-codes.test.ts`): 12 tests across `create` (3), `findUnusedByUserId` (3), `markAsUsed` (3), `deleteByUserId` (3). Follows `password-reset-tokens.test.ts` pattern.

---

### `main/server/engine` Comprehensive Audit (6 Work Streams, 32 New Tests)

#### WS1: P0 Security

- **JWT timing vulnerability**: Buffer-padded `timingSafeEqual()` preventing length side-channel
- **JWT payload validation**: `Array.isArray` + `typeof` guards after JSON parse
- **SQL injection in queue/writer.ts**: All raw interpolation → `$N` parameterized queries with `escapeIdentifier()` for column names

#### WS2: P1 Resource Leaks

- **SMTP socket leaks**: `settled` flag + `cleanup()` helper, `removeAllListeners()` in TLS upgrade
- **Queue AbortController**: `{ once: true }` on abort listener preventing accumulation
- **Writer setImmediate**: Added `close()` for graceful shutdown

#### WS3: Code Deduplication

- Search query builder re-exported from shared instead of reimplemented
- Deleted dead `apps/server/src/http/router/` (4 files) — re-exports from engine

#### WS4: Performance

- Rate limiter `limitedClientsCount` field — O(1) stats instead of O(n) iteration
- Cache stats capping at 1M to prevent unbounded growth
- S3 `iterator.return()` for proper async iterator cleanup

#### WS5: Wire Dead Modules

- Queue handlers for `cleanup-expired-tokens` and `cleanup-completed-tasks`
- SQL search provider for users table
- Permission checker with owner-based rules

#### Test Coverage

| Test file                             | New tests | Total |
| ------------------------------------- | --------- | ----- |
| `security/jwt.integration.test.ts`    | 9         | 44    |
| `queue/writer.test.ts`                | 6         | 35    |
| `queue/client.test.ts`                | 2         | 20    |
| `security/rate-limit/limiter.test.ts` | 11        | 48    |
| `cache/providers/memory.test.ts`      | 4         | 37    |

All 5 test files passing. 0 type errors in `@abe-stack/server-engine` and `@abe-stack/server`.

---

### `main/server/media` Deep Audit (3 Rounds, 331 Tests)

#### Round 1 — Critical Fixes

- **FD leak** in `security.ts`: `fd.read()` could throw leaving `fd.close()` unreachable. Wrapped in `try/finally`
- **Dimension bounds** in `image-processing.ts`: Added `MAX_IMAGE_DIMENSION = 65,536` constant, throws on decompression bombs. Replaced `as` cast with properly typed intersection
- **FFmpeg process timeout/kill**: Added `timeoutMs` option (default 5 minutes), sends `SIGKILL` on timeout preventing zombie processes. Added `validatePath()` rejecting control characters (0x00-0x1F) in all input/output paths. Added 30-second timeout to `runFFprobe()`
- **FLAC/OGG metadata**: Replaced hardcoded `channels=2, sampleRate=44100` with actual STREAMINFO block parsing (FLAC) and Vorbis identification header parsing (OGG)

#### Round 2 — Additional Fixes (15 findings)

- **FD leak** in `file-type.ts` (same `try/finally` pattern as Round 1)
- **WAV buffer bounds**: Added `buffer.length < 44` guard + sanity checks for `channels === 0`, `sampleRate === 0`
- **FLAC bounds**: Added `sampleRate > 655350 || channels > 8` matching FLAC spec limits
- **FFmpeg filter injection**: Added `validateDimension()` — rejects NaN, Infinity, negative, non-integer, > 65,536. Applied to all 5 interpolated dimensions (thumbnail size, waveform width/height, resolution width/height)
- **Security scanner false-positive**: Null-byte check was triggering on all binary files (images, audio, video naturally contain null bytes). Restricted to `isTextBased` check block
- **Unbounded queue**: Added `maxWaitingQueueSize` option (default 1,000). `add()` rejects when at capacity

#### Round 3 — Path Headers & Code Quality

- Fixed 18 stale `premium/media/src/` → `server/media/src/` path headers
- Replaced `Math.random()` with `crypto.randomUUID()` for file IDs
- `Map.clear()` instead of delete-during-iteration in processor cleanup

**Verification**: 331/331 tests passing, 0 type errors, 0 lint errors.

---

### Media Package: Dependency Cleanup & Entitlement Gating

4-phase refactor of `@abe-stack/media`:

1. **Rewired processors**: Removed `fluent-ffmpeg` + `music-metadata` lazy-loaders → internal `ffmpeg-wrapper` and `audio-metadata`
2. **Memory & performance**: `MAX_BUFFER_SIZE = 10MB` in FFmpeg, `MAX_AUDIO_FILE_SIZE = 200MB`, actual `cleanupTempFiles()` implementation
3. **Entitlement gating**: Added `MEDIA_PROCESSING` and `MEDIA_MAX_FILE_SIZE_MB` feature keys, optional entitlement checking in `addJob()`
4. **Test updates**: Rewrote 6 test files for internal module mocks

**Verification**: 304/304 tests passing.

---

### `main/tools/` Deep Audit

- **CJS elimination** (`health-check.ts`): 3 `require()` calls → ESM imports, `any` → `PnpmPackageInfo` interface
- **Stale paths** (`dependency-audit.ts`): Updated to scan `main/apps/`, `main/client/`, `main/server/`, `main/shared/`
- **ESM entry guards** (4 audit files): `require.main === module` → `import.meta.url` pattern
- **Shebangs**: `#!/usr/bin/env node` → `#!/usr/bin/env tsx` in 3 files
- **Test mock**: `vi.mock('node:crypto')` → `vi.mock('crypto')`

---

### Complete Authentication Flow (Part 1)

#### TOTP Login Challenge

- **Shared**: Added `TotpLoginChallengeResponse`, `TotpLoginVerifyRequest` types + schemas, updated login contract with 202 response, added `totpVerifyLogin` contract
- **Server**: Modified `authenticateUser()` to detect `user.totpEnabled === true` and return `TotpChallengeResult` (signed JWT challenge token with 5-min expiry). Updated `handleLogin` to return `{ status: 202 }` for TOTP challenges with `isTotpChallenge` type guard. Created `handleTotpLoginVerify` handler (verifies challenge JWT, validates TOTP code, creates auth tokens). Registered `auth/totp/verify-login` as public route.
- **Client**: Updated `ApiClient` with 7 new methods (`totpSetup`, `totpEnable`, `totpDisable`, `totpStatus`, `totpVerifyLogin`, `changeEmail`, `confirmEmailChange`). Added `TotpChallengeError` class and `isTotpChallengeResponse` type guard to `AuthService`. Updated `login()` to throw on TOTP challenge, added `verifyTotpLogin()` to `AuthService` and `useAuth` hook. Rewrote `LoginForm.tsx` with TOTP verification step.

#### TOTP Settings UI + Email Change

- `useTotpManagement.ts` hook (states: loading, enabled, disabled, setup-in-progress)
- `TotpManagement.tsx` component (secret display, backup codes, enable/disable flows)
- `EmailChangeForm.tsx` component (new email + password verification, calls `POST /auth/change-email`)
- `ConfirmEmailChangePage.tsx` (reads `?token=` from URL, shows loading/success/error states)
- TOTP backup code login hint in LoginForm ("Lost your authenticator? Enter one of your backup codes instead.")
- Fixed email change URL in server to point to frontend route instead of API endpoint

Key decisions: JWT challenge tokens over DB table (avoids schema changes, 5-min expiry keeps attack window small); discriminated union (`requiresTotp: true`) for type narrowing without `instanceof`; custom error class carries `challengeToken` property.

#### Tests Created (4 Files, 162 Tests)

| Test file                         | Tests | Coverage                                 |
| --------------------------------- | ----- | ---------------------------------------- |
| `useTotpManagement.test.ts`       | 32    | State transitions, error handling        |
| `TotpManagement.test.tsx`         | 56    | All 4 states, clipboard, forms           |
| `EmailChangeForm.test.tsx`        | 35    | Validation, submission, errors           |
| `totp.test.ts` (server)           | 39    | All 5 handlers                           |
| `ConfirmEmailChangePage.test.tsx` | 25    | Loading, success, error, API integration |

**Verification**: All type-checks clean across 6 packages. All test suites passing.

---

### Sessions + Dev Environment Updates

**Session endpoints wired**:

- `GET /api/users/me/sessions` — list active sessions
- `DELETE /api/users/me/sessions/:id` — revoke specific session
- `POST /api/users/me/sessions/revoke-all` — revoke all sessions
- `GET /api/users/me/sessions/count` — active session count

**Session security integration**:

- Create `user_sessions` record on login
- Update `last_active_at` on token refresh
- Revoke all sessions on password change/reset

**User-agent labeling**: Added UA parser + tests, stored `device_name` and `device_type` in sessions. Migration `0019_user_sessions_device_fields.sql`. Aligned `@abe-stack/db` session table exports for core usage.

**Dev environment**: `.env.development` (Docker, port 5432, password `development`), `.env.local` (local Postgres, port 5433, password `postgres`). DB scripts now support `ENV_FILE` override (`db:push`, `db:seed`, `db:audit:db`).

---

### Complete Zod Removal from `@abe-stack/server-engine`

Removed the last `zod` dependency in the entire monorepo. The `@abe-stack/server-engine` package had a type-only import (`import type { ZodType } from 'zod'`) in `RouteSchema` union. Since `hasSafeParse()` uses duck-typing (checks for `safeParse` method structurally), the `ZodType` in the union was redundant.

Simplified `RouteSchema` from `ZodType | FastifySchema | ValidationSchema` to `FastifySchema | ValidationSchema`. Removed `zod` from `package.json`. Updated config README with `createSchema` examples.

**Result**: 608/608 tests passing. Zero `zod` imports or dependencies anywhere in the monorepo.
