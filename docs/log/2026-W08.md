# Week 8: February 16-22, 2026

> **Summary**: Massive shared package restructuring — enforced internal DAG (`primitives → engine → core → contracts → api`), consolidated all errors into engine, split monolithic auth schemas into domain files, standardized file naming (dots convention), and rebuilt all barrel exports. Followed by three waves of adversarial unit tests adding ~4,000 tests across the shared package. Updated CLAUDE.md with adversarial TDD methodology, security principles, monorepo DAG, and API contract discipline. Tooling improvements to line-count audit script.

---

## Sunday, February 16, 2026

### Shared Package Restructuring — Phase 1: Engine Layer Cleanup

Deep restructuring of `main/shared` to enforce the internal DAG and eliminate cross-layer imports.

**Engine barrel cleanup:**
- Cleaned all engine barrels — removed cross-module re-exports (`9f7e94a3`)
- Moved external consumers to sub-path imports (`557a11c1`)
- Fixed contracts barrel + files barrel for moved modules (`e9a8c4c2`)
- Fixed shared import paths to respect internal DAG (`a0c58236`)
- Updated engine import paths to correct locations (`fc27968d`)
- Corrected all engine file headers to match actual paths (`a8b85b07`)
- Removed duplicate `pubsub/pubsub-types.test.ts` (`bcda91f2`)
- Engine `index.ts` now exports only engine-local modules (`91e1bafe`)
- Cleaned engine barrels, removed duplicates, fixed broken re-exports (`015894d3`)
- Fixed all `index.ts` barrel re-export violations (`ae2d3f6a`)

**Engine layer moves:**
- Moved pure crypto functions to `primitives/helpers/crypto.ts` (`1027d05a`)
- Removed duplicates across engine modules

### Shared Package Restructuring — Phase 2: Core Layer Cleanup

**Dead code and re-export removal:**
- Phase 1: Deleted dead code and re-export stubs from core (`9e5b1182`)
- Phase 2: Deleted `schema.utils.ts` re-export barrel (`5f6cf793`)
- Phase 3: Consolidated remaining duplicates in core (`972baeb5`)

**Error consolidation:**
- Split `core/errors.ts` — HTTP errors moved to engine, auth errors to `core/auth` (`7485b930`)
- Consolidated ALL error classes into `engine/errors/errors.ts` (`770e23b2`)

**Auth restructuring:**
- Restructured `core/auth/` — moved passwords to subfolder, deleted redundant files (`560ced94`)
- Split monolithic `core/schemas.ts` — response envelopes to `engine/http`, field schemas stay (`78560e5b`)
- Moved `policy.ts` → `core/auth/auth.policy.ts` (`771983ac`)
- Deleted `core/env.ts` — canonical version in `engine/env/` (`25633e40`)
- Cleaned `core/index.ts` — removed all engine re-exports (`3782b2d9`)

**Auth schema splitting:**
- Renamed auth schema files from dashes to dots convention (`6433625a`)
- Fixed broken imports from auth restructuring (`f50a092b`)
- Updated test expectation for `EmailAlreadyExistsError` code (`361752f6`)

### File Naming Standardization

- Renamed `engine/module-registration` to `engine/di` (`ee8fcaab`)
- Updated file headers after rename from dashes to dots (`9cfc1acf`)
- Standardized all file names from dashes to dots convention (`05546a82`)

### Barrel Architecture Rebuild

- Restructured shared package barrels and fixed export architecture (`1ccc1e52`)
- Updated consumer imports to use root shared barrel — 3 passes (`e125de88`, `9d12327a`, `960c5c60`)
- Updated test file imports to use root shared barrel (`a84c4176`)
- Added shared package README (`891fddc9`)
- Config split, membership merge, barrel cleanup (`0706c8fa`)

**Net result:** 464 files changed, 13,816 insertions, 61,874 deletions. Massive reduction in dead code and cross-layer violations.

### Commits (Sunday)

- `9a449e4b` through `0706c8fa` (30 commits) — full restructuring sequence

---

## Monday, February 17, 2026

### Adversarial Unit Tests — Wave 1 (2,092 tests)

First batch of adversarial tests across the shared package targeting boundary analysis, failure states, and security probing.

- 489 files changed, 24,239 insertions, 61,874 deletions
- Covered: primitives (crypto, object, parse, result, response), engine (cache, crypto, env, errors, health, http, logger, media, pagination, pubsub, realtime, search, security, usage-metering)
- Focus: `null`/`undefined` inputs, malformed JSON, oversized payloads, prototype pollution, injection attempts, concurrent execution safety

**Commit:** `a1deeebf` test: add 2,092 adversarial unit tests across shared package

### Adversarial Unit Tests — Wave 2 (746 tests)

Second batch targeting auth schemas, reactive map, media, and pagination.

- 1,140 files changed, 9,894 insertions, 4,258 deletions
- Covered: auth schema files (core, devices, email, magic-link, mfa, oauth, passkey, scalars, tos, webauthn), reactive map, media schemas, cursor pagination

**Commits:** `84cf2b5a`, `c71bd55f` test: add 746 adversarial unit tests for auth schemas, reactive map, media, and pagination

### Shared Package Refactor Finalization

- Final cleanup and fixes to shared package restructuring (`4a56777b`, `0568a532`)

---

## Tuesday, February 18, 2026

### Adversarial Unit Tests — Wave 3 (1,180 tests)

Third batch adding adversarial coverage to 45 existing test files.

- 47 files changed, 9,702 insertions, 192 deletions
- Enhanced existing test suites with failure-state coverage: boundary inputs, error paths, concurrent async safety, idempotency checks
- Covered: response parsing, audit log, auth helpers, compliance logic/schemas, cache (errors, LRU, memoize), crypto (JWT, token), env validation, error mapper, errors, health, HTTP, multipart, pagination (cursor, helpers, pagination), pubsub, realtime, search (errors, operators, schemas, serialization), security (input, prototype), usage metering, object/parse/result helpers

**Commit:** `6f99b43d` test: add adversarial coverage to 45 existing test files (+1,180 tests)

### CLAUDE.md — Adversarial TDD & Architecture Updates

Updated `.claude/CLAUDE.md` with specs extracted from `principles.md`, `agents/testing.md`, `BUSINESS.md`, `TODO-dag.md`, and `TODO-api.md`:

- **New "Testing — Adversarial TDD" section**: TDD workflow (red-green-refactor), adversarial mindset (60% failure-state coverage minimum), boundary analysis, layer handshake testing, async integrity, idempotency, security probing, test pyramid, risk assessment, killer test per suite
- **Security rules**: "Security by default" and "Validate all input" added to Non-Negotiable Rules
- **Monorepo DAG**: Full client/server/apps dependency graph added to Project Architecture
- **UI hierarchy rule**: theme → elements → components → layouts (never reverse)
- **Import order**: External → `@bslt/*` → alias → styles
- **Error handling**: Server (typed errors) / Client (React Query states) / Never (silent failures)
- **API contract discipline**: Contract-first, BFF-only auth, `pnpm audit:api-governance:strict` in CI
- **Performance**: Complexity analysis mandatory before writing code
- **JSDoc mandatory**: For every exported function, type, and constant
- **Deep dives table**: Added references to adversarial testing, BUSINESS.md, TODO-dag.md, TODO-api.md

### Shared Package — Primitives Consolidation (uncommitted)

Continued structural cleanup of the shared package:

- Deleted `primitives/logger.ts`, `primitives/observability.ts`, `primitives/environment.ts` — interfaces moved to `engine/ports/ports.ts`
- Created `engine/ports/ports.ts` with `Logger`, `ServerLogger`, `ErrorTracker`, `ServerEnvironment` interfaces
- Slimmed `engine/logger/types.ts` — removed duplicated interface definitions
- Deleted `api/response.ts` and `api/response.test.ts` — moved to engine layer
- Deleted `engine/api-keys/api-keys.ts` and test — consolidated elsewhere
- Updated `engine/context/context.ts` imports to use ports
- Updated `shared/src/index.ts` barrel with correct export sources
- Net: 15 files changed, 83 insertions, 1,447 deletions

### Tooling — Line Count Audit Script

Updated `main/tools/scripts/audit/line-count.ts`:

- Excludes `index.ts` barrel files from line counts (barrels are re-export noise, not source logic)
- Only counts files within `src/` directories per package (excludes config files, scripts, etc.)

---

## Wednesday, February 19, 2026

### Engine → System Rename (Shared + Server Infrastructure)

Completed the global rename of the infrastructure layer from `engine` to `system` across two packages:

**Shared package (`main/shared/src/`):**
- `engine/` directory renamed to `system/`
- Package export path updated: `./system` (was `./engine`)
- ESLint boundary type changed: `shared-system` (was `shared-engine`)
- All external importers updated to use `@bslt/shared/system`
- Added `./system` sub-path export to `main/shared/package.json`

**Server infrastructure package (`main/server/`):**
- `main/server/engine/` renamed to `main/server/system/`
- Package name: `@bslt/server-engine` → `@bslt/server-system`
- ESLint boundary type: `s-system` (was `s-engine`)
- All tsconfig project references, vitest configs, and relative imports updated
- `@bslt/client-engine` unchanged (separate package, unaffected)

**Server system package refinements (same wave):**
- `jwt.ts` split: shared JWT types extracted to `main/shared/src/system/crypto/jwt.ts`; server-side signing/verification stays in `@bslt/server-system`
- `storage/errors.ts` created — typed error hierarchy for storage layer (103 lines + 187-line test suite)
- Mailer restructured: `smtp-client`, `smtp-index` renamed to dots convention; dead `mailer/client.ts` and `mailer/console.ts` deleted
- `cache/errors.ts` deleted — consolidated into main cache module
- File renames to dots convention: `geo-ip` providers, `observability` providers, `queue/memory-store`, `routing/route-registry`, `search/query-builder`, `storage/s3-client-wrapper`, `security/jwt-rotation` → `security/crypto/jwt.rotation`
- `utils/swagger.ts` deleted — swagger theming moved to app layer
- `system/metrics.test.ts` — added 14 tests for metrics system

**Config:**
- `config/env/.env*.example` files updated with new `SYSTEM_*` key naming

### DB Index Audit + Repository Cleanup

Pre-production audit of hot-path queries, cleanup tasks, and FK columns. Added 19 new indexes across 5 migration files. Migrations reorganized from 30 granular numbered files into domain-grouped files.

**Indexes added (19 total):**

`0000_users.sql` (5): `idx_users_locked_until` (partial, login lockout), `idx_users_deletion_grace` (partial, hard-delete batch), `idx_password_reset_tokens_expires`, `idx_email_verification_tokens_expires`, `idx_security_events_type` (composite `event_type, created_at DESC`)

`0001_auth_extensions.sql` (5): `idx_email_change_tokens_expires` (partial `WHERE used_at IS NULL`), `idx_email_change_revert_tokens_expires` (partial), `idx_sms_verification_codes_unverified` (composite `(user_id, expires_at) WHERE verified = FALSE`), `idx_trusted_devices_last_seen` (composite `(user_id, last_seen_at DESC)`), `idx_webauthn_cred_last_used` (partial)

`0002_sessions.sql` (2): `idx_user_sessions_revoked_at` (partial), `idx_oauth_connections_expires` (partial, hourly OAuth refresh task)

`0200_billing.sql` (7): `idx_plans_active_sorted` (partial), `idx_subscriptions_user_status_period` (composite, covers `findActiveByUserId` + `findExpiringSoon`), `idx_subscriptions_trial_expiry` (partial, trial-expiry task), `idx_subscriptions_plan_status` (composite, admin count), `idx_invoices_user_status` (composite), `idx_payment_methods_user_default` (partial, hot path), `idx_billing_events_type` (composite)

`0500_compliance.sql` (1): `idx_data_export_requests_expires` (partial `WHERE expires_at IS NOT NULL AND status != 'completed'`)

**`push.ts`:** All 19 indexes mirrored with `IF NOT EXISTS` guards for idempotent dev schema push.

**Repository changes:**
- `EmailChangeTokenRepository.deleteExpired()` — deletes expired + unused tokens (`WHERE expires_at < now AND used_at IS NULL`)
- `DataExportRequestRepository.deleteExpired()` — deletes expired + non-completed requests
- `invoices.ts`: `or(...status.map(s => eq('status', s)))` → `inArray('status', filters.status)`

**Scheduled tasks — 3 new daily cleanup tasks (taskCount 11 → 14):**
- `email-change-tokens-cleanup`, `email-change-revert-tokens-cleanup`, `data-export-cleanup`

**Tests:** `deleteExpired()` suites added to both repo test files; `service.test.ts` mocks + taskCount updated; mock fixes in `data-export/handlers.test.ts` and `data-export/service.test.ts`.

**Key finding:** `DeleteBuilder.where()` overwrites (no chaining) — multi-condition deletes require `and(cond1, cond2)`.

### Tooling — `graph:db` Audit Script

- Created `main/tools/scripts/audit/graph-db.ts` — madge dependency graph for `main/server/db`
- Targets: `db-src`, `db-builder`, `db-schema`, `db-repositories`, `db-queue`, `db-search`, `db-utils`
- Outputs SVGs to `main/server/db/_graphs/`; added `pnpm graph:db` to root `package.json`

### DB Table Consolidation (46 → 40 tables)

Collapsed six redundant tables into three unified tables, eliminating ~1,000 lines of schema/repo/service code with zero business-logic regression.

**Consolidations:**

1. **5 token tables → `auth_tokens`**: `password_reset_tokens`, `email_verification_tokens`, `email_change_tokens`, `email_change_revert_tokens`, `magic_link_tokens` unified under a `type` discriminator column. Single `AuthTokenRepository` with type-scoped methods (`findValidByTokenHash(type, hash)`, `invalidateForUser(type, userId)`, etc.). `metadata` JSONB carries sparse fields (`newEmail`, `oldEmail`).

2. **`refresh_token_families` absorbed into `refresh_tokens`**: Family metadata denormalized into every token row (`family_id`, `family_ip_address`, `family_user_agent`, `family_created_at`, `family_revoked_at`, `family_revoke_reason`). `RefreshTokenRepository` gains `findActiveFamilies`, `findFamilyById`, `revokeFamily`. Eliminates a join-heavy auxiliary table.

3. **`user_agreements` + `consent_logs` → `consent_records`**: Two separate append-only compliance tables merged under a `record_type` discriminator (`'legal_document'` | `'consent_preference'`). Single `ConsentRecordRepository` exposes typed methods for both concerns.

**Files changed:** SQL migrations (4), DB schema types (3), DB repositories (16 deleted, 2 created, 1 extended), `factory.ts` + `index.ts`, server/core call sites (~12), server/core test files (~24), shared compliance schemas, `push.ts`.

**Result:** 46 → 40 tables, 5 scheduled cleanup tasks → 1 (`auth-tokens-cleanup`), `@bslt/db` and `@bslt/core` type-check clean, 139 test files / 2,896 tests passing.

### Commits (Wednesday)

- `9483fdaa` shared package finished — docs, TODO, DAG diagram updates
- `ef6654c5` update — server config, client UI theme, PayPal provider
- `0476b1c8` update — shared system constants export, sudo auth fixes, env examples
- `89f7efe6` update — engine→system rename, server-system restructure, DB index audit
- `bf9ac0e3` fix: data-export mock types + graph:db audit script

---

## Week 8 Summary

| Metric | Value |
|---|---|
| Commits | 45 |
| Files changed | ~1,700+ |
| Lines added | ~48,000 |
| Lines deleted | ~68,500 |
| Net reduction | ~20,500 lines |
| Adversarial tests added | ~4,018 |
| New SQL indexes | 19 (+5 for auth_tokens/consent_records/refresh_tokens family) |
| New scheduled tasks | 3 |
| Tables consolidated | 46 → 40 (−6 tables) |

### Key outcomes

1. **Internal DAG enforced**: `primitives → system → core → contracts → api` with zero cross-layer violations
2. **Layer renamed**: `engine` → `system` across shared + server infrastructure packages
3. **Error system consolidated**: All error classes canonical in `system/errors/errors.ts`
4. **Auth schemas modularized**: Monolithic file split into 10 domain-specific schema files
5. **File naming standardized**: All files use dots convention (`auth.core.schemas.ts`)
6. **Barrel exports rebuilt**: Clean `index.ts` files with explicit named exports, no cross-module re-exports
7. **~4,000 adversarial tests**: Boundary analysis, failure-state coverage, security probing, async integrity
8. **CLAUDE.md hardened**: Adversarial TDD methodology, security rules, DAG documentation, API contract discipline
9. **Dead code eliminated**: ~20,500 net lines removed (redundant re-exports, duplicate schemas, dead utilities)
10. **19 DB indexes**: Hot-path partial + composite indexes across users, auth, sessions, billing, compliance
11. **3 daily cleanup tasks**: email-change-tokens, email-change-revert-tokens, data-export-requests (taskCount 11→14)
12. **46 → 40 tables**: Three consolidations — 5 token tables → `auth_tokens`, `refresh_token_families` absorbed into `refresh_tokens`, `user_agreements` + `consent_logs` → `consent_records`. Zero regressions, 2,896 tests passing.
