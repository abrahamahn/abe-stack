# Week 8: February 16-22, 2026

> **Summary**: Massive shared package restructuring — enforced internal DAG (`primitives → engine → core → contracts → api`), consolidated all errors into engine, split monolithic auth schemas into domain files, standardized file naming (dots convention), and rebuilt all barrel exports. Followed by three waves of adversarial unit tests adding ~4,000 tests across the shared package. Updated CLAUDE.md with adversarial TDD methodology, security principles, monorepo DAG, and API contract discipline. Tooling improvements to line-count audit script.

---

## Sunday, February 16, 2026

### Shared Package Restructuring — Phase 1: Engine Layer Cleanup

Deep restructuring of `main/shared` to enforce the internal DAG and eliminate cross-layer imports.

**Engine barrel cleanup:**
- Cleaned all engine barrels — removed cross-module re-exports (`9f7e94a3`)
- Moved external consumers to sub-path imports (`557a11c1`)
- Fixed contracts barrel + files barrel for moved modules (`e9a8c4c2`)
- Fixed shared import paths to respect internal DAG (`a0c58236`)
- Updated engine import paths to correct locations (`fc27968d`)
- Corrected all engine file headers to match actual paths (`a8b85b07`)
- Removed duplicate `pubsub/pubsub-types.test.ts` (`bcda91f2`)
- Engine `index.ts` now exports only engine-local modules (`91e1bafe`)
- Cleaned engine barrels, removed duplicates, fixed broken re-exports (`015894d3`)
- Fixed all `index.ts` barrel re-export violations (`ae2d3f6a`)

**Engine layer moves:**
- Moved pure crypto functions to `primitives/helpers/crypto.ts` (`1027d05a`)
- Removed duplicates across engine modules

### Shared Package Restructuring — Phase 2: Core Layer Cleanup

**Dead code and re-export removal:**
- Phase 1: Deleted dead code and re-export stubs from core (`9e5b1182`)
- Phase 2: Deleted `schema.utils.ts` re-export barrel (`5f6cf793`)
- Phase 3: Consolidated remaining duplicates in core (`972baeb5`)

**Error consolidation:**
- Split `core/errors.ts` — HTTP errors moved to engine, auth errors to `core/auth` (`7485b930`)
- Consolidated ALL error classes into `engine/errors/errors.ts` (`770e23b2`)

**Auth restructuring:**
- Restructured `core/auth/` — moved passwords to subfolder, deleted redundant files (`560ced94`)
- Split monolithic `core/schemas.ts` — response envelopes to `engine/http`, field schemas stay (`78560e5b`)
- Moved `policy.ts` → `core/auth/auth.policy.ts` (`771983ac`)
- Deleted `core/env.ts` — canonical version in `engine/env/` (`25633e40`)
- Cleaned `core/index.ts` — removed all engine re-exports (`3782b2d9`)

**Auth schema splitting:**
- Renamed auth schema files from dashes to dots convention (`6433625a`)
- Fixed broken imports from auth restructuring (`f50a092b`)
- Updated test expectation for `EmailAlreadyExistsError` code (`361752f6`)

### File Naming Standardization

- Renamed `engine/module-registration` to `engine/di` (`ee8fcaab`)
- Updated file headers after rename from dashes to dots (`9cfc1acf`)
- Standardized all file names from dashes to dots convention (`05546a82`)

### Barrel Architecture Rebuild

- Restructured shared package barrels and fixed export architecture (`1ccc1e52`)
- Updated consumer imports to use root shared barrel — 3 passes (`e125de88`, `9d12327a`, `960c5c60`)
- Updated test file imports to use root shared barrel (`a84c4176`)
- Added shared package README (`891fddc9`)
- Config split, membership merge, barrel cleanup (`0706c8fa`)

**Net result:** 464 files changed, 13,816 insertions, 61,874 deletions. Massive reduction in dead code and cross-layer violations.

### Commits (Sunday)

- `9a449e4b` through `0706c8fa` (30 commits) — full restructuring sequence

---

## Monday, February 17, 2026

### Adversarial Unit Tests — Wave 1 (2,092 tests)

First batch of adversarial tests across the shared package targeting boundary analysis, failure states, and security probing.

- 489 files changed, 24,239 insertions, 61,874 deletions
- Covered: primitives (crypto, object, parse, result, response), engine (cache, crypto, env, errors, health, http, logger, media, pagination, pubsub, realtime, search, security, usage-metering)
- Focus: `null`/`undefined` inputs, malformed JSON, oversized payloads, prototype pollution, injection attempts, concurrent execution safety

**Commit:** `a1deeebf` test: add 2,092 adversarial unit tests across shared package

### Adversarial Unit Tests — Wave 2 (746 tests)

Second batch targeting auth schemas, reactive map, media, and pagination.

- 1,140 files changed, 9,894 insertions, 4,258 deletions
- Covered: auth schema files (core, devices, email, magic-link, mfa, oauth, passkey, scalars, tos, webauthn), reactive map, media schemas, cursor pagination

**Commits:** `84cf2b5a`, `c71bd55f` test: add 746 adversarial unit tests for auth schemas, reactive map, media, and pagination

### Shared Package Refactor Finalization

- Final cleanup and fixes to shared package restructuring (`4a56777b`, `0568a532`)

---

## Tuesday, February 18, 2026

### Adversarial Unit Tests — Wave 3 (1,180 tests)

Third batch adding adversarial coverage to 45 existing test files.

- 47 files changed, 9,702 insertions, 192 deletions
- Enhanced existing test suites with failure-state coverage: boundary inputs, error paths, concurrent async safety, idempotency checks
- Covered: response parsing, audit log, auth helpers, compliance logic/schemas, cache (errors, LRU, memoize), crypto (JWT, token), env validation, error mapper, errors, health, HTTP, multipart, pagination (cursor, helpers, pagination), pubsub, realtime, search (errors, operators, schemas, serialization), security (input, prototype), usage metering, object/parse/result helpers

**Commit:** `6f99b43d` test: add adversarial coverage to 45 existing test files (+1,180 tests)

### CLAUDE.md — Adversarial TDD & Architecture Updates

Updated `.claude/CLAUDE.md` with specs extracted from `principles.md`, `agents/testing.md`, `BUSINESS.md`, `TODO-dag.md`, and `TODO-api.md`:

- **New "Testing — Adversarial TDD" section**: TDD workflow (red-green-refactor), adversarial mindset (60% failure-state coverage minimum), boundary analysis, layer handshake testing, async integrity, idempotency, security probing, test pyramid, risk assessment, killer test per suite
- **Security rules**: "Security by default" and "Validate all input" added to Non-Negotiable Rules
- **Monorepo DAG**: Full client/server/apps dependency graph added to Project Architecture
- **UI hierarchy rule**: theme → elements → components → layouts (never reverse)
- **Import order**: External → `@bslt/*` → alias → styles
- **Error handling**: Server (typed errors) / Client (React Query states) / Never (silent failures)
- **API contract discipline**: Contract-first, BFF-only auth, `pnpm audit:api-governance:strict` in CI
- **Performance**: Complexity analysis mandatory before writing code
- **JSDoc mandatory**: For every exported function, type, and constant
- **Deep dives table**: Added references to adversarial testing, BUSINESS.md, TODO-dag.md, TODO-api.md

### Shared Package — Primitives Consolidation (uncommitted)

Continued structural cleanup of the shared package:

- Deleted `primitives/logger.ts`, `primitives/observability.ts`, `primitives/environment.ts` — interfaces moved to `engine/ports/ports.ts`
- Created `engine/ports/ports.ts` with `Logger`, `ServerLogger`, `ErrorTracker`, `ServerEnvironment` interfaces
- Slimmed `engine/logger/types.ts` — removed duplicated interface definitions
- Deleted `api/response.ts` and `api/response.test.ts` — moved to engine layer
- Deleted `engine/api-keys/api-keys.ts` and test — consolidated elsewhere
- Updated `engine/context/context.ts` imports to use ports
- Updated `shared/src/index.ts` barrel with correct export sources
- Net: 15 files changed, 83 insertions, 1,447 deletions

### Tooling — Line Count Audit Script

Updated `main/tools/scripts/audit/line-count.ts`:

- Excludes `index.ts` barrel files from line counts (barrels are re-export noise, not source logic)
- Only counts files within `src/` directories per package (excludes config files, scripts, etc.)

---

## Week 8 Summary

| Metric | Value |
|---|---|
| Commits | 40 |
| Files changed | 1,534+ |
| Lines added | ~45,500 |
| Lines deleted | ~68,000 |
| Net reduction | ~22,500 lines |
| Adversarial tests added | ~4,018 |
| Test files created/updated | 45+ |

### Key outcomes

1. **Internal DAG enforced**: `primitives → engine → core → contracts → api` with zero cross-layer violations
2. **Error system consolidated**: All error classes canonical in `engine/errors/errors.ts`
3. **Auth schemas modularized**: Monolithic file split into 10 domain-specific schema files
4. **File naming standardized**: All shared files use dots convention (`auth.core.schemas.ts`)
5. **Barrel exports rebuilt**: Clean `index.ts` files with explicit named exports, no cross-module re-exports
6. **~4,000 adversarial tests**: Boundary analysis, failure-state coverage, security probing, async integrity
7. **CLAUDE.md hardened**: Adversarial TDD methodology, security rules, DAG documentation, API contract discipline
8. **Dead code eliminated**: ~22,500 net lines removed (redundant re-exports, duplicate schemas, dead utilities)
