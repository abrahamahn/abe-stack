# Week 4: January 20-26, 2026

> **Summary**: Major SDK maturation and security hardening. Reorganized `packages/core` separating contracts from domain logic. Added logout-all endpoint and security documentation. Migrated auth utilities to SDK, performed deep security audit fixing critical vulnerabilities. Added production-ready caching (RecordCache, RecordStorage), offline support (TransactionQueue), and real-time subscriptions (WebsocketPubsubClient). Comprehensive README documentation for all apps and packages. Integration tests bringing total to ~7,500+ tests. OAuth and Magic Links authentication. 73% bundle size reduction.

---

## Table of Contents

- [2026-01-20 (Monday)](#2026-01-20-monday)
- [2026-01-21 (Tuesday)](#2026-01-21-tuesday)
- [2026-01-22 (Wednesday)](#2026-01-22-wednesday)
- [2026-01-22 (Thursday)](#2026-01-22-thursday)

---

## 2026-01-20 (Monday)

### Core Architecture Refactoring

#### Moved Contracts from Domains to Contracts Directory

Reorganized `packages/core` to properly separate API contracts from domain logic.

**New Structure:**

```
packages/core/src/
├── contracts/           # API contracts + Zod schemas
│   ├── admin.ts         # Admin contract
│   ├── auth.ts          # Auth contract + request/response schemas
│   ├── common.ts        # Shared schemas (email, password, uuid)
│   ├── pagination.ts    # Pagination schemas
│   ├── users.ts         # Users contract + user schemas
│   └── api.ts           # Combined API contract
├── domains/
│   ├── auth/            # Auth errors + password validation (business logic)
│   └── pagination/      # Cursor helpers (business logic)
```

**Deleted:** `domains/users/`, `domains/admin/`, `domains/common.ts`, `domains/*/schemas.ts`

#### Domain-Based Architecture for packages/core

Reorganized `packages/core` from a mixed flat structure into a clear domain-based architecture with full test coverage.

**New Structure:**

```
packages/core/src/
├── domains/           # Business domains
│   ├── auth/          # Auth schemas, errors, validation
│   ├── users/         # User types, schemas, contracts
│   ├── pagination/    # Cursor pagination utilities
│   └── admin/         # Admin schemas and contracts
├── infrastructure/    # Technical infrastructure
│   ├── async/         # BatchedQueue, DeferredPromise, ReactiveMap
│   ├── constants/     # HTTP status codes, time constants
│   ├── crypto/        # JWT utilities (server-only)
│   ├── errors/        # Base AppError + HTTP error classes
│   ├── http/          # Cookie parsing utilities
│   ├── stores/        # toastStore, undoRedoStore
│   └── transactions/  # Operation/undo utilities
├── contracts/         # API contract definitions
├── shared/            # Token store, utilities
└── utils/             # Pure utilities

# Note: media/ was extracted to packages/media on 2026-01-22
# Note: stores/ was extracted to packages/stores on 2026-01-22
```

**Created 16 new test files for complete coverage:**

- `contracts/__tests__/native.test.ts` - NativeBridge interface tests
- `domains/admin/__tests__/schemas.test.ts` - Admin schemas and contract
- `domains/auth/validation/__tests__/password-patterns.test.ts` - Password pattern detection
- `domains/auth/validation/__tests__/password-scoring.test.ts` - Password scoring utilities
- `domains/users/__tests__/schemas.test.ts` - User response schema
- `infrastructure/crypto/__tests__/jwt.test.ts` - JWT sign/verify/decode
- `infrastructure/errors/__tests__/response.test.ts` - API response types
- `infrastructure/http/__tests__/cookie.test.ts` - Cookie parsing
- `infrastructure/transactions/__tests__/types.test.ts` - Transaction types and guards
- `media/__tests__/audio-metadata.test.ts` - Audio metadata parsing
- `media/__tests__/ffmpeg-wrapper.test.ts` - FFmpeg wrapper types
- `media/__tests__/image-processing.test.ts` - Image processing
- `media/__tests__/security.test.ts` - Security scanner
- `media/__tests__/types.test.ts` - Media types
- `shared/__tests__/utils.test.ts` - randomId utility
- `utils/__tests__/storage.test.ts` - normalizeStorageKey

**Test Results:** 42 test files, 764 tests passing

---

### Auth & Security Features

#### Logout All Devices Endpoint

- Created `POST /api/auth/logout-all` - revokes all refresh tokens for authenticated user
- Handler: `apps/server/src/modules/auth/handlers/logout-all.ts`
- Uses existing `revokeAllUserTokens()` function

#### Security Documentation

Created `docs/dev/security.md` covering:

- Password hashing (Argon2id parameters)
- JWT access/refresh token lifecycle
- Token reuse detection with family tracking
- Rate limiting per endpoint
- Account lockout with progressive delays
- CSRF protection strategy
- Database indexes for auth tables
- Production checklist

#### Security Improvements for Auth Endpoints

Added stricter rate limiting for auth endpoints, CSRF documentation, and correlation IDs for error tracking.

**apps/server/src/infra/security/rateLimitPresets.ts:**

- `AUTH_RATE_LIMITS` configuration with endpoint-specific rate limits:
  - Login: 5 attempts per minute (prevents credential stuffing)
  - Register: 3 attempts per hour (prevents spam account creation)
  - Forgot/Reset Password: 3-5 attempts per hour (prevents email abuse)
  - Token Refresh: 30 attempts per minute (more lenient for automatic calls)
- `authRateLimiters` singleton registry managing per-endpoint rate limiters
- `createAuthRateLimitHook()` factory for Fastify preHandler hooks with proper rate limit headers
- Progressive delay support for repeated violations

**apps/server/src/infra/http/correlationId.ts:**

- `registerCorrelationIdHook()` Fastify middleware for distributed tracing
- Extracts correlation ID from `x-correlation-id` header or generates new UUID
- Sets correlation ID on request object (`req.correlationId`) and response headers
- `generateCorrelationId()` utility function for external use
- Validation to prevent header injection attacks

**apps/server/src/infra/http/csrf.ts:**

- Added comprehensive documentation for CSRF-exempt endpoints explaining security rationale

#### CSRF Validation for WebSocket Upgrades

Added CSRF token validation to WebSocket upgrade requests to prevent cross-site WebSocket hijacking attacks.

- WebSocket upgrades now require valid CSRF token before allowing connection
- CSRF token can be provided via query parameter (`?csrf=<token>`) or `Sec-WebSocket-Protocol` header
- Invalid CSRF tokens result in HTTP 403 rejection before upgrade completes
- Added `validateCsrfToken()` function for standalone CSRF validation

---

### SDK Improvements

#### Migrated Auth Navigation Hook and SDK Improvements

Migrated auth-specific navigation from `apps/web` to `packages/sdk` and enhanced SDK architecture.

**Part 1: Migrated Utilities**

- **`packages/sdk/src/hooks/useAuthModeNavigation.ts`** - Auth navigation hook migrated from apps/web
- **`packages/sdk/src/queryKeys.ts`** - Centralized query key factory with type-safe, hierarchical query keys

**Part 2: SDK Architecture Improvements**

- **Error Handling**: Created `packages/sdk/src/errors.ts` with `ApiError`, `NetworkError`, `TimeoutError` classes
- **API Client Documentation**: Added comprehensive JSDoc to `packages/sdk/src/api/index.ts`

**Tests Created:**

- `useAuthModeNavigation.test.ts` - 7 tests
- `queryKeys.test.ts` - 20 tests
- `errors.test.ts` - 26 tests

#### RecordStorage for Persistent IndexedDB Record Storage

Added a persistent record storage system using IndexedDB with automatic fallbacks to localStorage and in-memory storage.

**packages/sdk/src/cache/RecordStorage.ts:**

- `RecordStorage<TTables>` generic class for persistent record storage with table namespacing
- Version-based optimistic concurrency
- Automatic storage backend selection: IndexedDB > localStorage > in-memory
- Async CRUD operations, bulk operations, query helpers, change subscriptions
- Factory function: `createRecordStorage()`

**Tests:** 31 tests covering all operations

#### RecordCache for Type-Safe In-Memory Record Storage

Added a generic, type-safe cache for storing records by type and ID with optimistic update support.

**packages/sdk/src/cache/RecordCache.ts:**

- `RecordCache<TTables>` generic class with full TypeScript support
- Version-based conflict resolution
- Optimistic updates with rollback support
- Change subscriptions with before/after values

**Tests:** 48 tests

---

## 2026-01-22 (Thursday)

### Developer Experience & Logging Cleanup

- Added a compact, structured dev logger (no external deps) for server output.
  - New `packages/core/src/infrastructure/logger/console.ts`
  - Fastify dev logs now emit `server: [HH:MM:SS] LEVEL msg key=value` style lines
- Dev bootstrap output is now structured and consistent (header + `[dev]`/`[db]` lines).
- Turbo logs standardized across dev/build/test/type-check for clearer ordering and prefixes.

### Auth Contract Consistency

- Unified `userSchema` and removed redundant `userResponseSchema` alias.
- Added `createdAt` everywhere user objects are returned in auth flows.
- Updated auth response helpers and test fixtures to include `createdAt` (ISO).

### Config Generator Stability

- Made alias discovery deterministic to stop tsconfig churn.
- Prevents unnecessary Vite full-reloads caused by regenerated tsconfig ordering changes.

#### UndoRedoStack for Operation History Management

Added a generic undo/redo stack implementation.

**packages/sdk/src/undo/UndoRedoStack.ts:**

- `UndoRedoStack<T>` generic class for tracking undoable operations
- Operation grouping with `beginGroup()`/`endGroup()` and `withGroup(fn)` helper
- Configurable max undo stack size (default: 100)
- Factory function: `createUndoRedoStack<T>(options)`

**Tests:** 38 tests

#### WebsocketPubsubClient for Real-Time Subscriptions

Added a production-ready WebSocket-based PubSub client.

**packages/sdk/src/pubsub/WebsocketPubsubClient.ts:**

- Automatic reconnection using exponential backoff
- Online/offline detection for smart reconnection
- Connection state management

**Tests:** 20 tests

#### SubscriptionCache for Reference-Counted Subscription Tracking

Added a reference counting subscription manager with delayed cleanup.

- Prevents subscription thrashing on React component re-mount
- Configurable delay (default 10s) before unsubscribing

#### LoaderCache for Request Deduplication with TTL

Added a cache for deferred loading promises.

- `Loader<T>` class with explicit resolve/reject control
- TTL support with automatic stale detection
- Request deduplication with `getOrCreate(key)`

#### TransactionQueue for Offline-First Mutation Support

Added a transaction queue for offline-first applications.

- Automatic processing when back online
- Batch processing with configurable max batch size
- Conflict resolution with retry logic
- Persistence to localStorage

---

### UI Improvements

#### Migrated Utilities to packages/ui and Improved Accessibility

**Part 1: Migrated Utilities**

- **`packages/ui/src/hooks/useFormState.ts`** - Generic form state management hook
- **`packages/ui/src/hooks/useResendCooldown.ts`** - Cooldown timer hook for resend actions
- **`packages/ui/src/utils/createFormHandler.ts`** - Form handler factory utility

**Part 2: packages/ui Refactoring**

- Standardized class name handling using `cn()` utility
- Moved context utilities to separate `providers/` directory
- Accessibility Improvements: Pagination, Popover, Avatar components

---

### Row-level Permissions System (Phase 5 Realtime)

Implemented comprehensive row-level permissions system for realtime features.

**Core Components:**

- **`types.ts`** - Permission type definitions with helper functions
- **`checker.ts`** - Permission checking logic with ownership, membership, and role-based permissions
- **`middleware.ts`** - Fastify integration with preHandlers

**Tests:** 72 tests (37 checker + 35 middleware)

---

### Deep Security Audit & Comprehensive Fixes

#### Critical Security Vulnerabilities Fixed

| Issue                     | File                            | Fix                                                           |
| ------------------------- | ------------------------------- | ------------------------------------------------------------- |
| Prototype Pollution       | `infra/http/security.ts`        | Added `sanitizeObject()`, `hasDangerousKeys()`                |
| Path Traversal            | `infra/files/fastify-server.ts` | Added `isValidId()`, `isValidFilename()`, `isPathContained()` |
| WebSocket Table Injection | `infra/websocket/websocket.ts`  | Added `ALLOWED_SUBSCRIPTION_TABLES` whitelist                 |
| CSRF on Logout            | `infra/http/csrf.ts`            | Removed `/api/auth/logout` from CSRF exempt paths             |
| Rate Limiter Role Bypass  | `infra/rate-limit/limiter.ts`   | Added `VALID_ROLES` whitelist                                 |

#### Critical Memory Leak Fixes

| Issue                    | File                                  | Fix                                                       |
| ------------------------ | ------------------------------------- | --------------------------------------------------------- |
| Retry State Leak         | `infra/media/retry.ts`                | Added periodic cleanup interval (5 min), max age (1 hour) |
| Audit Logger Buffer Leak | `infra/security/audit.ts`             | Added `MAX_BUFFER_SIZE` (10k) with 10% eviction           |
| Timeout Promise Leak     | `infra/media/processor.ts`            | Store timeout ID and clear in finally block               |
| BatchedQueue Leak        | `packages/core/async/BatchedQueue.ts` | Added `flushTimeoutId` tracking and `destroy()`           |
| QueueServer Sleep Leak   | `infra/queue/queueServer.ts`          | Added AbortController to cancel pending sleeps            |

#### API Contract & Type Alignment

| Issue                   | File                                | Fix                                           |
| ----------------------- | ----------------------------------- | --------------------------------------------- |
| Error Schema Mismatch   | `packages/core/contracts/common.ts` | Updated `errorResponseSchema` to match server |
| User Type Missing Field | `apps/web/AuthService.ts`           | Added `createdAt: string`                     |
| Token Refresh Race      | `apps/web/AuthService.ts`           | Added `refreshPromise` mutex                  |

#### Email Service Improvements

| Issue                  | File                   | Fix                                               |
| ---------------------- | ---------------------- | ------------------------------------------------- |
| Missing Retry Logic    | `infra/email/smtp.ts`  | Added 3 retries with exponential backoff          |
| Missing Env Validation | `packages/core/env.ts` | Added SMTP configuration variables                |
| No Production Check    | `config/loader.ts`     | Added validation for email provider in production |

#### Dead Code Removed

- Deleted `packages/core/src/uploads/` (orphaned)
- Removed deprecated `PermissionError`, `RateLimitError` exports

#### Duplicate Code Consolidated

- `USER_ROLES/UserRole` now imported from `@abe-stack/core`
- Time constants now imported from `@abe-stack/core`
- Converted wildcard exports to explicit named exports

#### Environment & Base URL Configuration

- Added `appBaseUrl` and `apiBaseUrl` config from environment variables
- Removed hardcoded localhost fallbacks

---

### Other Improvements

#### Reorganized Changelog Split into Weekly Files

- Split monolithic `CHANGELOG.md` into `docs/log/2026-W01.md` through `2026-W04.md`
- Main index at `docs/log/README.md`

#### Email Send Failure Handling in Auth Handlers

- Added `EmailSendError` class for distinguishing email delivery failures
- `handleRegister`: Returns 201 with `emailSendFailed: true` flag if email fails
- `handleForgotPassword`: Logs error but returns success to prevent user enumeration

#### Auth Service: Fix Silent Password Rehash Failures

- Added `logger: Logger` parameter to `rehashPassword` function
- Errors are now always logged via the structured logger

#### Documentation: Public API Utilities

Added comprehensive JSDoc documentation to public API utilities:

- `DeferredPromise`, `BatchedQueue`, `ReactiveMap`
- `createUndoRedoStore`, `useUndoRedoStore`
- `useDeepMemo`, `useShallowMemo`, `TTLCache`, `LRUCache`

---

## 2026-01-21 (Tuesday)

### Comprehensive Integration Tests (~805 tests)

Created integration tests for all 6 packages/apps with comprehensive coverage.

**apps/desktop** (36 new tests): IPC flow, window lifecycle, preload context bridge, app init/shutdown

**apps/server** (140 new tests): Auth, HTTP, WebSocket, queue, permissions integration tests

**apps/web** (111 new tests): Auth page, modal, flow, email verification, error handling, navigation

**packages/core** (240 new tests): Contracts, auth domain, pagination, errors, async utilities, JWT, media

**packages/sdk** (128 new tests): Cache storage, WebSocket subscription, offline workflow, undo/redo, API client errors

**packages/ui** (~150 new tests): Form composition, layout interaction, hook combination, theme, keyboard navigation, focus management, accessibility

**Test totals:**

- apps/desktop: 113 tests
- apps/server: 1,432 tests
- apps/web: 606 tests
- packages/core: 1,253 tests
- packages/sdk: 567 tests
- packages/ui: 1,277 tests

---

### Documentation Updates

#### Comprehensive README Files for All Apps and Packages

Created narrative-style README files following the chet-stack documentation philosophy.

**Files created/updated:**

- `apps/web/README.md` - Frontend application documentation
- `apps/desktop/README.md` - Electron application documentation
- `apps/server/README.md` - Backend API documentation
- `packages/ui/README.md` - Shared UI library documentation
- `packages/sdk/README.md` - Client SDK documentation
- `packages/core/README.md` - Core package documentation

#### Consolidated TODO Documentation

- Verified Complete: File Uploads & Media, Pagination, WebSocket Client, Security Phase 2, Real-time features
- Deleted redundant files: `docs/todo/realtime/*.md`, `docs/dev/media-processing.md`, `docs/dev/pagination-guide.md`

#### Docs Cleanup: Consolidated and Reduced Documentation

**Final docs/dev/ structure (9 essential files):**

```
docs/dev/
├── architecture.md     # System architecture
├── config-setup.md     # Configuration guide
├── dev-environment.md  # Development setup
├── legacy.md           # Migration reference
├── performance.md      # Optimization guide
├── principles.md       # Coding standards
├── security.md         # Security overview
├── sync-scripts.md     # DX automation
└── testing.md          # Testing strategy
```

---

### Code Quality Improvements

#### Fixed Zod Deprecation Warnings

- `ZodTypeAny` → `ZodType` (6 occurrences)
- `z.string().uuid()` → `z.uuid()` (9 occurrences)
- `z.string().datetime()` → `z.iso.datetime()`

#### Removed MSW Dependency

Removed Mock Service Worker (MSW) dependency to reduce package footprint. API mocking now uses Vitest's `vi.mock()`.

#### Auth UI Consistency Refactor

Unified authentication UI styling across all auth pages and the auth modal using shared `AuthLayout` + `AuthForm` components.

---

### Integration Test Quality Improvements

#### Audit Findings

| Category                  | Priority | Files Affected |
| ------------------------- | -------- | -------------- |
| Superficial assertions    | High     | 6 files        |
| Over-mocking              | Medium   | 4 files        |
| Timer-related fragility   | Medium   | 5 files        |
| Redundant/duplicate tests | Low      | 2 file pairs   |

#### Fixed Test Quality Across All Packages

Strengthened assertions and fixed weak test patterns based on audit findings.

- Replaced `toBeDefined()` with value verification
- Added proper error content/message verification
- Verified parsed shapes, not just success booleans
- Added actual behavior tests instead of mock behavior tests

---

### Server Integration Tests (220 new tests)

**Route & Middleware Tests (102 tests):** User routes, admin routes, health endpoints, error handling, middleware

**Auth & Permissions Tests (118 tests):** Auth flows, HTTP integration, permissions

---

### Realtime and WebSocket Integration Tests (64 new tests)

**realtime.integration.test.ts (24 tests):** Authentication, table validation, SET/SET_NOW operations, list operations, optimistic locking, getRecords

**websocket.integration.test.ts (40 tests):** Subscription lifecycle, message publishing, client message handling, JWT integration, concurrent operations

---

### Mutation Testing: SDK Package Analysis

| File             | Mutation Score | Mutants Killed | Survived |
| ---------------- | -------------- | -------------- | -------- |
| `LoaderCache.ts` | 99.10%         | 110            | 1        |
| `RecordCache.ts` | 76.27%         | 225            | 64       |
| **Overall**      | 83.75%         | 335            | 65       |

---

### Test Cleanup and Configuration

#### Fixed Test Cleanup Issues

Fixed DOM cleanup failures in jsdom tests by removing redundant vitest environment configuration from individual test files.

**apps/web (25 test files fixed):** Removed `@vitest-environment jsdom` pragma and direct imports

#### Consolidated Vitest Configuration

Simplified to single `vitest.workspace.ts` at root.

**Files Removed:**

- `config/vitest.config.ts`
- `config/generators/vitest.gen.ts`
- `apps/server/vitest.config.ts`
- `apps/web/vitest.config.ts`

#### Refactored Config Schema Structure

**New Structure:**

```
config/schema/
├── aliases.ts      # Path alias definitions (single source of truth)
├── build.ts        # Vite/Vitest settings only
├── typescript.ts   # TypeScript compiler options
├── lint.ts         # Prettier, ESLint, VS Code settings
├── packages.ts     # Package scripts
└── index.ts        # Barrel exports
```

---

### Infrastructure Reorganization

#### Renamed `infra` to `infrastructure`

Renamed `apps/server/src/infra` to `apps/server/src/infrastructure` for better clarity and consistency with hexagonal architecture naming.

#### Reorganized into Category-Based Structure

Reorganized from a flat structure (19 modules) into 7 logical categories:

```
apps/server/src/infrastructure/
├── data/           # Database, storage, files
├── messaging/      # Email, pubsub, websocket
├── security/       # Crypto, permissions, rate-limit
├── http/           # Middleware, router, pagination
├── jobs/           # Queue, write service
├── monitor/        # Health, logger
└── media/          # Media processing
```

**Login Security Moved to Auth Module:**

Moved login-related security from infrastructure to `modules/auth/security/`: lockout.ts, audit.ts, events.ts

---

### Realtime Module Unit Tests (51 tests)

**service.test.ts (35 tests):** Table configuration, field validation, operations, version conflicts

**handlers.test.ts (16 tests):** Auth, table validation, success path, error handling

---

### Consolidated UI Package Test Structure

Moved `packages/ui/src/test/` to `packages/ui/src/__tests__/` for consistency.

---

### Security Hardening (4 parallel tasks)

#### 1. Database Transaction Support

- Updated `createRefreshTokenFamily()`, `revokeTokenFamily()`, `revokeAllUserTokens()` to use atomic transactions
- Added 9 transaction rollback tests

#### 2. Token Reuse Security Events

- Added `tokenReuseAlert` email template
- Added `sendTokenReuseAlert()` and `logAndNotifyTokenReuse()`
- Enhanced `TokenReuseError` to carry user details

#### 3. Account Lockout Edge Cases

- Added `lockout_expires_at` column to users schema
- Implemented sliding window protection
- Admin unlock now requires reason parameter for audit trail

#### 4. Error Message Audit

- Verified existing code already secure
- Fixed hardcoded strings to use constants
- Added comprehensive security documentation

**Result:** All 2558 server tests passing

---

### Dependency Reduction

#### Removed 4 External Packages with Manual Implementations

| Package                                | Location     | Replacement                            | Savings |
| -------------------------------------- | ------------ | -------------------------------------- | ------- |
| `react-markdown`                       | apps/web     | Custom `Markdown` from `@abe-stack/ui` | ~45KB   |
| `remark-gfm`                           | apps/web     | Built into custom Markdown             | ~15KB   |
| `@tanstack/react-query-persist-client` | apps/web     | Manual `useQueryPersistence` hook      | ~5KB    |
| `@tanstack/query-persist-client-core`  | packages/sdk | Inlined type definitions               | minimal |

**Bundle Impact:** Web app main chunk reduced from 1,021KB to 867KB (~154KB)

---

### UI Enhancements

#### HomePage Renders Main README.md

Updated to display the main repository README.md with markdown rendering and syntax highlighting.

#### Desktop App UI and HomePage Doc Index

- Fixed desktop app styling with proper theme classes
- Doc index uses UI package Button components

#### Enhanced Markdown Content Styling

Typography, code styling, blockquotes, tables, lists improvements with dark mode support.

#### Enhanced Code Block Styling (CSS-only)

- macOS-style header bar with red/yellow/green dots
- Darker background with subtle gradient header
- Custom styled scrollbar

---

### Removed All eslint-disable Comments

Eliminated all `eslint-disable` comments by fixing underlying issues:

- Used `vi.hoisted()` pattern for mock function references
- Created `asPreHandler` wrapper for Fastify hooks
- Changed `parseJsonResponse<T>()` to return `unknown`
- Used `process.stdout.write` instead of `console.log`

Updated CLAUDE.md: Added explicit prohibition of `@ts-ignore` and `@ts-expect-error`.

---

### Magic Link Authentication (Backend)

**Database Schema:** `magic_link_tokens` table with id, email, token_hash, expires_at, used_at, ip_address, user_agent

**API Contracts:** `magicLinkRequestSchema`, `magicLinkVerifySchema`, `magicLinkRequestResponseSchema`, `magicLinkVerifyResponseSchema`

**Magic Link Service:**

- `requestMagicLink()` - Generates 32-byte token, stores SHA-256 hash, sends email
- `verifyMagicLink()` - Validates token, marks as used, finds/creates user
- `cleanupExpiredMagicLinkTokens()` - Deletes old tokens

**Security Features:**

- Cryptographically random tokens (32 bytes, base64url)
- SHA-256 hashing before storage
- Single-use tokens, 15-minute expiry
- Rate limiting (3 requests per email per hour)
- Always returns success to prevent email enumeration

**Routes:**

- `POST /api/auth/magic-link/request`
- `POST /api/auth/magic-link/verify`

**Tests:** 18 tests for service and handlers

---

### Security Enhancements

#### 1. Dummy Hash Pool Rotation

- Pool of 10 pre-computed Argon2id dummy hashes for timing attack prevention
- `verifyPasswordSafe()` - Timing-safe password verification
- Tests: 25 passing

#### 2. Login Attempt Cleanup Job

- `cleanupOldLoginAttempts(db, options)` with configurable retention
- Tests: 22 passing

#### 3. JWT Secret Rotation

- `signWithRotation()`, `verifyWithRotation()` for seamless key rotation
- Config support: `AUTH_CONFIG.jwt.previousSecret` via env var
- Tests: 23 passing

#### 4. IP Proxy Validation

- `isFromTrustedProxy(ip, trustedProxies)` with CIDR support
- `getValidatedClientIp()` for X-Forwarded-For chain validation
- IPv4/IPv6 support
- Tests: 43 passing

**Total: 113 new tests for security features**

---

### Accessibility Improvements

#### ResizablePanel Keyboard Accessibility

- Arrow keys resize by 2%, Shift+Arrow by 10%
- Home/End keys jump to min/max size
- Proper ARIA attributes, focus-visible styles

#### Theme Density Variants

- `compact`: 0.75x spacing
- `normal`: 1x spacing
- `comfortable`: 1.25x spacing

**Tests:** 36 tests (density + useDensity)

#### High-Contrast Mode Support

- `system`: Follows OS `prefers-contrast: more` setting
- `normal`: Standard contrast
- `high`: Maximum contrast with increased color distinction

**Tests:** 45 tests (contrast + useContrast)

---

## 2026-01-22 (Wednesday)

> **Day Summary:** Authentication expansion (OAuth, Magic Links), dependency reduction (zustand removal), 73% bundle size reduction, and security hardening. All core features production-ready.

---

### OAuth Authentication (Google, GitHub, Apple)

Complete OAuth 2.0 authentication with security hardening.

**Components:**

| Component | Key Files                                                  |
| --------- | ---------------------------------------------------------- |
| Core      | `oauth/service.ts`, `oauth/handlers.ts`, `oauth/routes.ts` |
| Providers | `oauth/providers/google.ts`, `github.ts`, `apple.ts`       |
| Database  | `schema/oauth.ts` (oauth_connections table)                |
| Contracts | `packages/core/contracts/oauth.ts`                         |

**Endpoints:**

- `GET /oauth/:provider` - Initiate flow
- `GET /oauth/:provider/callback` - Handle callback
- `POST /oauth/:provider/link` - Link to account
- `DELETE /oauth/:provider/unlink` - Unlink provider
- `GET /oauth/connections` - List connections

**Security (all fixed in audit):**

- HMAC-signed state parameter for CSRF
- Apple id_token JWT signature verification with Apple public keys
- Config-based redirect URIs (not from headers)
- Provider enabled validation before use

---

### Removed Zustand Dependency

Replaced zustand with custom lightweight store.

**New:** `packages/core/src/stores/createStore.ts`

```typescript
const useStore = createStore<State>((set, get) => ({
  count: 0,
  increment: () => set((s) => ({ count: s.count + 1 })),
}));
```

- Uses React 18's `useSyncExternalStore`
- Same API: `getState()`, `setState()`, `subscribe()`
- Works in non-React test environments

---

### Web Bundle Size (73% Reduction)

| Metric         | Before     | After                        |
| -------------- | ---------- | ---------------------------- |
| Initial bundle | 874KB      | 234KB                        |
| Vendor chunks  | monolithic | split (react, router, query) |

**Changes:**

- Removed `zustand`, `@ts-rest/react-query`
- Route-based code splitting (`React.lazy()`)
- Dynamic markdown imports
- Vite vendor chunking

---

### Security Hardening

#### Search & Filtering

| Issue                   | Fix                                                 |
| ----------------------- | --------------------------------------------------- |
| LIKE wildcard injection | `escapeLikePattern()` for `%`, `_`, `\`             |
| Query complexity        | Enforce `maxQueryDepth: 5`, `maxConditions: 50`     |
| Error type loss         | Fixed `wrapError()` to preserve `SearchError` types |

#### Push Notifications

| Issue                 | Fix                                      |
| --------------------- | ---------------------------------------- |
| Missing push handlers | Added to `sw.js`                         |
| In-memory storage     | Database with `push_subscriptions` table |
| No cleanup job        | `pushSubscriptionCleanup.ts`             |
| Timezone handling     | `Intl.DateTimeFormat` for quiet hours    |

**New tables:** `push_subscriptions`, `notification_preferences`

---

### Magic Links Deep Audit & Implementation

#### Security Fixes (High Priority)

| Issue                                | Fix                               |
| ------------------------------------ | --------------------------------- |
| Race condition in token verification | Atomic UPDATE...RETURNING pattern |
| No scheduled cleanup                 | Created `magicLinkCleanup.ts`     |

#### Security Improvements (Medium Priority)

| Issue                         | Fix                                  |
| ----------------------------- | ------------------------------------ |
| No IP-based rate limiting     | Added `isIpRateLimited()`            |
| No verification audit logging | Added logging functions              |
| Hardcoded config values       | Now uses `ctx.config.auth.magicLink` |

#### Feature Completions (Low Priority)

| Feature                   | Implementation                                    |
| ------------------------- | ------------------------------------------------- |
| Strategy enablement check | `isStrategyEnabled(ctx.config.auth, 'magic')`     |
| Database indexes          | `(email, createdAt)` and `(ipAddress, createdAt)` |
| Set-password flow         | `POST /api/auth/set-password` endpoint            |

---

### OAuth Code Review - All Remaining Items

#### Rate Limiting

| Endpoint        | Limit      |
| --------------- | ---------- |
| `oauthInitiate` | 10 req/min |
| `oauthCallback` | 20 req/min |
| `oauthLink`     | 5 req/hour |
| `oauthUnlink`   | 5 req/hour |

#### N+1 Query Optimizations

| Function                  | Before               | After              |
| ------------------------- | -------------------- | ------------------ |
| `findUserByOAuthProvider` | 2 sequential queries | 1 JOIN query       |
| `unlinkOAuthAccount`      | 3 sequential queries | 3 parallel queries |
| `linkOAuthAccount`        | 3 sequential queries | 3 parallel queries |

#### Audit Logging for OAuth Events

New event types: `oauth_login_success`, `oauth_login_failure`, `oauth_account_created`, `oauth_link_success`, `oauth_link_failure`, `oauth_unlink_success`, `oauth_unlink_failure`

#### OAuth Token Refresh Background Job

Created `apps/server/src/infrastructure/jobs/scheduled/oauthTokenRefresh.ts`:

- `refreshExpiringOAuthTokens()` - Batch refresh
- `countExpiringOAuthTokens()` - Count tokens needing refresh
- `getOAuthTokenStats()` - Statistics for monitoring

---

### Push Notifications End-to-End Implementation

#### Service Worker Event Handlers

Added to `apps/web/public/sw.js`: `push`, `notificationclick`, `notificationclose`

#### Database Persistence

**New Schema:**

| Table                      | Columns                                                                                                          |
| -------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| `push_subscriptions`       | id, userId, endpoint, expirationTime, keysP256dh, keysAuth, deviceId, userAgent, isActive, createdAt, lastUsedAt |
| `notification_preferences` | id, userId, globalEnabled, quietHours, types, updatedAt                                                          |

#### Service Layer Updates

- All functions now async with `DbClient` as first parameter
- Upserts to database with device deduplication
- Timezone-aware quiet hours using `Intl.DateTimeFormat`

---

### Test Suite Fixes

Fixed test failures caused by code changes and flaky tests:

| Test File               | Issue                  | Fix                      |
| ----------------------- | ---------------------- | ------------------------ |
| `oauth/service.test.ts` | JOIN instead of query  | Added `select` mock      |
| `health.test.ts`        | Missing new tables     | Added to mock            |
| `email.test.ts`         | Console.log usage      | Use custom logger        |
| `sql-provider.test.ts`  | Mock chain issues      | Restored full mock chain |
| `websocket.test.ts`     | Dynamic import timeout | Increased to 10000ms     |
| `queue.test.ts`         | Timing variance        | Relaxed multiplier       |

**Final Test Results:**

| Package            | Tests    | Status       |
| ------------------ | -------- | ------------ |
| @abe-stack/server  | 2966     | Pass         |
| @abe-stack/web     | 793      | Pass         |
| @abe-stack/ui      | 1394     | Pass         |
| @abe-stack/sdk     | 672      | Pass         |
| @abe-stack/core    | 1592     | Pass         |
| @abe-stack/desktop | 113      | Pass         |
| **Total**          | **7530** | **All Pass** |

---

### Deploy Pack Implementation

#### Files Created

| File                                    | Purpose                                   |
| --------------------------------------- | ----------------------------------------- |
| `config/docker/Dockerfile.web`          | Multi-stage build for web app (nginx)     |
| `config/docker/nginx.conf`              | Nginx with SPA routing, caching, security |
| `config/docker/docker-compose.prod.yml` | Production compose with Caddy             |
| `config/docker/docker-compose.dev.yml`  | Development compose (postgres only)       |
| `config/caddy/Caddyfile`                | Production Caddy with auto TLS            |
| `config/caddy/Caddyfile.dev`            | Development Caddy (HTTP only)             |
| `docs/deploy/README.md`                 | Deployment documentation                  |

#### Architecture

```
Internet → Caddy (80/443 + TLS) → Internal Network
                |
                +→ /health* → api:8080
                +→ /ws      → api:8080 (WebSocket)
                +→ /api/*   → api:8080
                +→ /*       → web:80
```

#### pnpm Scripts

| Script                 | Purpose                          |
| ---------------------- | -------------------------------- |
| `pnpm deploy`          | Build and start production stack |
| `pnpm deploy:down`     | Stop production stack            |
| `pnpm deploy:logs`     | Follow production logs           |
| `pnpm deploy:dev`      | Start development database       |
| `pnpm deploy:dev:down` | Stop development database        |

---

### Reverse Proxy + TLS Documentation

**New Files:**

| File                                 | Purpose                        |
| ------------------------------------ | ------------------------------ |
| `config/caddy/Caddyfile`             | Production Caddy with auto TLS |
| `config/caddy/Caddyfile.dev`         | Development (HTTP only)        |
| `docs/deploy/reverse-proxy.md`       | Complete reverse proxy guide   |
| `docs/deploy/trusted-proxy-setup.md` | Security guide for proxy trust |

---

### Deploy Target Documentation

**New Files:**

| File                          | Purpose                                |
| ----------------------------- | -------------------------------------- |
| `docs/deploy/digitalocean.md` | DigitalOcean Droplet deployment        |
| `docs/deploy/gcp.md`          | Google Cloud Compute Engine deployment |

Both include: Creation steps, DNS, Docker, systemd, backups, monitoring, security checklist, troubleshooting, cost summary.

---

### Database + Migrations Story

#### Root-Level Commands

| Command                   | Purpose                        |
| ------------------------- | ------------------------------ |
| `pnpm db:generate`        | Generate migration files       |
| `pnpm db:migrate`         | Run pending migrations         |
| `pnpm db:push`            | Sync schema directly (dev)     |
| `pnpm db:studio`          | Open Drizzle Studio GUI        |
| `pnpm db:seed`            | Seed with test data (dev only) |
| `pnpm db:bootstrap:admin` | Create production admin user   |

**Created:** `apps/server/src/scripts/bootstrap-admin.ts` - Generates cryptographically secure random password, safe for production.

**Created:** `docs/deploy/migrations.md` - Complete migration documentation.

---

### Documentation Updates

#### Updated Package READMEs

| Package       | Lines   | Key Updates                                   |
| ------------- | ------- | --------------------------------------------- |
| apps/desktop  | 109→254 | Port config, IPC channels, platform behavior  |
| apps/server   | 317→574 | Realtime, permissions, media, notifications   |
| apps/web      | 239→341 | Query persistence, lazy routes, demo catalog  |
| packages/core | 165→388 | OAuth, realtime, search, cache, notifications |
| packages/sdk  | 225→408 | Push notifications, search, MutationQueue     |
| packages/ui   | 209→398 | Accurate counts, router, providers, utils     |

#### Documentation Structure Reorganization

**Created:**

- `docs/dev/README.md` - Developer documentation index
- `docs/README.md` - Main documentation index (replaced INDEX.md)
- `docs/todo/` directory with TODO.md, ROADMAP.md, QUALITY-TEST.md

#### Priority Zero - Package Reduction Plan

Added to TODO.md: Transition from Product Engineer to Systems Engineer.

**Packages to Remove:**

- `react-router-dom` → 20-line `useRouter` hook
- `@tanstack/react-query` → Custom RecordCache
- `@ts-rest/*` → Pure TypeScript contracts
- `drizzle-orm/kit` → Raw SQL query builder
- `@testing-library/*` → Pure TypeScript tests + Playwright

---

### Custom Router System (Priority Zero: Package Reduction)

Completed the first item of Priority Zero by removing `react-router-dom` and building a custom router with Notion-style side-peek views.

**Replaced with custom minimal router implementation (~150 lines) in `packages/ui/src/router/`:**

- Native browser APIs (`window.history`, `popstate` event)
- `useSyncExternalStore` for React state synchronization
- Full route matching with dynamic params (`:id`) and wildcards (`*`)
- Nested routes with layout support via `<Outlet>`
- `MemoryRouter` for testing

**Components & Hooks:**

- `Router` / `BrowserRouter`, `MemoryRouter`
- `Routes`, `Route`, `Link`, `Navigate`, `Outlet`
- `useNavigate`, `useLocation`, `useParams`, `useSearchParams`

**Files Created (router):**

- `packages/ui/src/router/context.tsx`
- `packages/ui/src/router/hooks.ts`
- `packages/ui/src/router/components.tsx`
- `packages/ui/src/router/index.ts`

**Side-Peek Views (Notion-style):**

- `packages/ui/src/layouts/layers/SidePeek.tsx` - Slide-in panel component
- `packages/ui/src/hooks/useSidePeek.ts` - Hook for managing side-peek state
- `packages/ui/src/components/PeekLink.tsx` - Link component that opens content in side-peek

---

### Lint and Type Error Fixes

Fixed 46 lint errors and multiple type errors.

#### Router System Improvements

- Added `children` and `index` props support for nested routes
- Enhanced MemoryRouter with location objects and state
- Added explicit return type annotations

#### Results

- **Lint**: 0 errors, 0 warnings (was 46 errors, 22 warnings)
- **Type-check**: All 9 packages pass
- **Tests**: 7,519 passing
- **Build**: Successful

**Commit**: `57c6168` - fix: resolve all lint and type errors across codebase

---

### Day Summary

| Category             | Items                            |
| -------------------- | -------------------------------- |
| Features             | OAuth (3 providers), Magic Links |
| Dependencies removed | zustand, react-router-dom        |
| Bundle reduction     | 73%                              |
| Security fixes       | 8                                |
| Bug fixes            | 7                                |
| Tests passing        | 7,530+                           |

---

### Server Startup Fix: Vitest Runtime Import

Fixed server crash caused by vitest being imported at runtime.

**Root Cause:** Test utilities (`createMockDb`, `MockDbClient`) in `test-utils.ts` import from `vitest`. These were exported through barrel files, causing vitest to load during server startup. Vitest 4.x only supports ESM imports and fails when loaded via CommonJS `require()`.

**Files Fixed:**

| File                                          | Change                                              |
| --------------------------------------------- | --------------------------------------------------- |
| `infrastructure/data/database/utils/index.ts` | Removed `createMockDb`, `MockDbClient` exports      |
| `infrastructure/data/database/index.ts`       | Removed test utility re-exports                     |
| `infrastructure/data/index.ts`                | Removed test utility re-exports                     |
| `apps/server/src/main.ts`                     | Added error logging to catch block                  |
| `config/drizzle.config.ts`                    | Fixed schema path (`infra` → `infrastructure/data`) |

**Lesson:** Test utilities that import test frameworks (vitest, jest) must never be exported through barrel files used by production code. Import directly from the test utility file in test files only.

---

### Removed ts-rest Dependency (Priority Zero: Package Reduction)

Replaced `@ts-rest/core` and `@ts-rest/react-query` with custom pure TypeScript implementation.

**Dependencies Removed:**

| Package                | From          | Savings |
| ---------------------- | ------------- | ------- |
| `@ts-rest/core`        | packages/core | ~15KB   |
| `@ts-rest/core`        | packages/sdk  | ~15KB   |
| `@ts-rest/react-query` | packages/sdk  | ~8KB    |

**New Files Created:**

| File                                   | Purpose                                                                     |
| -------------------------------------- | --------------------------------------------------------------------------- |
| `packages/core/src/contracts/types.ts` | Contract type definitions (`EndpointDef`, `RequestBody`, `SuccessResponse`) |
| `packages/sdk/src/api/hooks.ts`        | React Query hook factories + `ApiError` class                               |

**Files Modified:**

- **6 contract files** - Replaced `initContract()` + `c.router({...})` with plain objects + `satisfies Contract`
  - `packages/core/src/contracts/auth.ts`
  - `packages/core/src/contracts/users.ts`
  - `packages/core/src/contracts/admin.ts`
  - `packages/core/src/contracts/oauth.ts`
  - `packages/core/src/contracts/realtime.ts`
  - `packages/core/src/contracts/api.ts`
- `packages/sdk/src/api/react-query.ts` - Custom hook factory implementation
- `packages/core/src/contracts/index.ts` - Export new types
- `packages/core/src/index.ts` - Export new types

**API Surface Unchanged:**

```typescript
// Components continue using the same API:
const { mutate: login } = useApi().auth.login.useMutation();
const { data: user } = useApi().users.me.useQuery();
```

**Quality Checks:**

- ✅ Core: type-check passes, 1,304 tests pass
- ✅ SDK: type-check passes, 659 tests pass
- ✅ ESLint: No errors
- ✅ Build: Successful

---

---

### Package Extraction: stores and media

Extracted two packages from `packages/core` to improve modularity and separation of concerns.

#### Extracted `packages/stores` (React state management)

Moved React-dependent store utilities from core to dedicated package.

**Files Created:**

| File                                   | Purpose                            |
| -------------------------------------- | ---------------------------------- |
| `packages/stores/package.json`         | `@abe-stack/stores` package config |
| `packages/stores/tsconfig.json`        | TypeScript configuration           |
| `packages/stores/src/createStore.ts`   | Custom React store factory         |
| `packages/stores/src/toastStore.ts`    | Toast notification state           |
| `packages/stores/src/undoRedoStore.ts` | Undo/redo state management         |
| `packages/stores/src/index.ts`         | Barrel exports                     |
| `packages/stores/src/__tests__/*.ts`   | Test files                         |

**Consumers Updated:**

- `apps/web` - Import from `@abe-stack/stores`
- `packages/ui` - Import `ToastMessage` type from `@abe-stack/stores`

**Result:** Core package is now framework-agnostic (no React peer dependency).

---

#### Extracted `packages/media` (server-only utilities)

Moved media processing utilities to dedicated package for better modularity.

**Files Created:**

| File                                     | Purpose                           |
| ---------------------------------------- | --------------------------------- |
| `packages/media/package.json`            | `@abe-stack/media` package config |
| `packages/media/tsconfig.json`           | TypeScript configuration          |
| `packages/media/src/types.ts`            | Type definitions                  |
| `packages/media/src/file-type.ts`        | Magic byte file type detection    |
| `packages/media/src/audio-metadata.ts`   | MP3/WAV/FLAC/OGG metadata parsing |
| `packages/media/src/ffmpeg-wrapper.ts`   | FFmpeg command wrapper            |
| `packages/media/src/image-processing.ts` | ImageProcessor class              |
| `packages/media/src/security.ts`         | BasicSecurityScanner              |
| `packages/media/src/validation.ts`       | File validation utilities         |
| `packages/media/src/index.ts`            | Barrel exports                    |
| `packages/media/src/__tests__/*.ts`      | 7 test files (184 tests)          |

**Configuration Updated:**

- `vitest.config.ts` - Added media project + `@abe-stack/media` alias
- `config/vitest.config.ts` - Updated media alias
- `packages/core/README.md` - Updated to reference `@abe-stack/media`

**Quality Checks:**

- ✅ Media: 184 tests passing
- ✅ Core: 1,304 tests passing
- ✅ Type-check: All packages pass

---

---

### Removed @tanstack/react-query Dependency (Priority Zero: Package Reduction)

Replaced `@tanstack/react-query` with custom hooks built on existing SDK infrastructure.

**Dependencies Removed:**

| Package                | From          | Savings |
| ---------------------- | ------------- | ------- |
| `@tanstack/react-query`| apps/web      | ~40KB   |
| `@tanstack/react-query`| packages/sdk  | ~40KB   |
| `@tanstack/react-query`| packages/ui   | peer dep|

**New Files Created:**

| File                                          | Purpose                                    |
| --------------------------------------------- | ------------------------------------------ |
| `packages/sdk/src/query/QueryCache.ts`        | Query state management with TTL and GC     |
| `packages/sdk/src/query/useQuery.ts`          | Custom useQuery hook                       |
| `packages/sdk/src/query/useMutation.ts`       | Custom useMutation hook                    |
| `packages/sdk/src/query/useInfiniteQuery.ts`  | Custom useInfiniteQuery for pagination     |
| `packages/sdk/src/query/QueryCacheProvider.tsx`| React context provider                    |
| `packages/sdk/src/query/index.ts`             | Barrel exports                             |

**Key Features:**

- `QueryCache` class with stale time tracking, GC, and subscriptions
- `useSyncExternalStore` pattern for React state synchronization
- Retry logic with exponential backoff
- Window focus refetch support
- Full API compatibility with React Query signatures

**Files Modified:**

- `apps/web/src/features/auth/services/AuthService.ts` - Removed QueryClient dependency, uses internal state
- `apps/web/src/app/ClientEnvironment.tsx` - QueryCache instead of QueryClient
- `apps/web/src/main.tsx` - Create QueryCache instead of QueryClient
- `apps/web/src/app/App.tsx` - QueryCacheProvider instead of QueryClientProvider
- `packages/sdk/src/search/hooks.ts` - Use custom useQuery/useInfiniteQuery
- `packages/ui/src/hooks/usePaginatedQuery.ts` - Use custom useInfiniteQuery from SDK

**Files Deleted:**

- `packages/sdk/src/api/react-query.ts` - Was using @ts-rest/react-query

---

### Simplified User Types/Schemas

Consolidated user-related types by removing redundant exports.

**Removed:**

- `USER_ROLES` array constant
- `USER_ROLE` object constant (e.g., `USER_ROLE.ADMIN`)
- `UserResponse` type alias
- `userResponseSchema` (duplicate of `userSchema`)

**Kept:**

- `userRoleSchema` - Zod schema: `z.enum(['user', 'admin', 'moderator'])`
- `UserRole` - Type inferred from schema
- `userSchema` - Zod schema with createdAt field
- `User` - Type inferred from schema

**Files Updated:**

- `packages/core/src/contracts/users.ts` - Simplified exports
- `packages/core/src/contracts/index.ts` - Removed redundant exports
- `apps/server/src/modules/auth/middleware.ts` - Use string literals
- `apps/server/src/infrastructure/security/permissions/checker.ts` - Use string literals
- `apps/server/src/scripts/seed.ts` - Use string literals
- Multiple test files - Updated to use `userSchema` instead of `userResponseSchema`

---

### Fixed usePaginatedQuery Error Handling Tests

Added `retry` option to pagination hooks to prevent test timeouts.

**Changes:**

- Added `retry?: number | boolean` option to `UsePaginatedQueryOptions`
- Added `retry?: number | boolean` option to `UseOffsetPaginatedQueryOptions`
- Passed `retry` to underlying `useInfiniteQuery` calls
- Updated error tests to use `retry: false` for immediate failure

**Quality Checks:**

- ✅ Core: 1,297 tests pass
- ✅ SDK: 659 tests pass
- ✅ UI: 1,394 tests pass
- ✅ Web: type-check passes
- ✅ Server: Pre-existing type errors (unrelated to this task)

---

### Completed State/Data Package Reduction (Priority Zero)

Finalized the removal of `@tanstack/react-query` from the SDK package.

**Changes:**

- Removed `@tanstack/react-query` from `packages/sdk/package.json` dependencies
- Removed dead `./react-query` export path
- Updated SDK README to reference custom QueryCache instead of React Query

**Architecture Summary:**

```
Real-time records:
  WebSocket → RecordCache (in-memory) → RecordStorage (IndexedDB) → UI
  ✅ Direct sync, no external library overhead

Generic queries (lists/search):
  API fetch → QueryCache (custom ~580 lines) → useQuery → UI
  ✅ Framework-agnostic, no external deps
```

**Quality Checks:**

- ✅ SDK: 659 tests pass
- ✅ Web: type-check passes
- ✅ Lockfile updated

---

**Pending:**

- OAuth rate limiting (partial)
- Smoke test on clean machine
