# Week 4: January 20-26, 2026

> **Summary**: Major SDK maturation and security hardening. Reorganized `packages/core` separating contracts from domain logic. Added logout-all endpoint and security documentation. Migrated auth utilities to SDK, performed deep security audit fixing critical vulnerabilities. Added production-ready caching (RecordCache, RecordStorage), offline support (TransactionQueue), and real-time subscriptions (WebsocketPubsubClient).

---

## 2026-01-20

### Refactored: Moved Contracts from Domains to Contracts Directory

Reorganized `packages/core` to properly separate API contracts from domain logic.

**New Structure:**

```
packages/core/src/
â”œâ”€â”€ contracts/           # API contracts + Zod schemas
â”‚   â”œâ”€â”€ admin.ts         # Admin contract
â”‚   â”œâ”€â”€ auth.ts          # Auth contract + request/response schemas
â”‚   â”œâ”€â”€ common.ts        # Shared schemas (email, password, uuid)
â”‚   â”œâ”€â”€ pagination.ts    # Pagination schemas
â”‚   â”œâ”€â”€ users.ts         # Users contract + user schemas
â”‚   â””â”€â”€ api.ts           # Combined API contract
â”œâ”€â”€ domains/
â”‚   â”œâ”€â”€ auth/            # Auth errors + password validation (business logic)
â”‚   â””â”€â”€ pagination/      # Cursor helpers (business logic)
```

**Deleted:** `domains/users/`, `domains/admin/`, `domains/common.ts`, `domains/*/schemas.ts`

---

### Added: Logout All Devices Endpoint

- Created `POST /api/auth/logout-all` - revokes all refresh tokens for authenticated user
- Handler: `apps/server/src/modules/auth/handlers/logout-all.ts`
- Uses existing `revokeAllUserTokens()` function

---

### Added: Security Documentation

Created `docs/dev/security.md` covering:

- Password hashing (Argon2id parameters)
- JWT access/refresh token lifecycle
- Token reuse detection with family tracking
- Rate limiting per endpoint
- Account lockout with progressive delays
- CSRF protection strategy
- Database indexes for auth tables
- Production checklist

---

### Reorganized: Changelog Split into Weekly Files

Split monolithic `CHANGELOG.md` into weekly logs:

- `docs/log/2026-W01.md` through `2026-W04.md`
- Each file has summary at top
- Main index at `docs/log/README.md`

---

### Added: Migrated Auth Navigation Hook and SDK Improvements

Migrated auth-specific navigation from `apps/web` to `packages/sdk` and enhanced SDK architecture with query key factory and improved error handling.

**Part 1: Migrated Utilities**

- **`packages/sdk/src/hooks/useAuthModeNavigation.ts`** - Auth navigation hook migrated from apps/web
  - Provides `navigateToMode`, `navigateToLogin`, `navigateToRegister`, `navigateToForgotPassword`
  - Supports custom route mapping via `routeMap` option
  - Supports `onBeforeNavigate` callback and `replace` navigation option
  - Includes `AuthMode` type definition: `'login' | 'register' | 'forgot-password' | 'reset-password'`

- **`packages/sdk/src/queryKeys.ts`** - Centralized query key factory
  - Type-safe, hierarchical query keys for React Query
  - Covers `auth`, `users`, `posts`, `notifications`, and `settings` domains
  - Each domain has `all`, `list`, `detail` key patterns for easy cache invalidation

- Updated `apps/web/src/features/auth/` to import `useAuthModeNavigation` and `AuthMode` from `@abe-stack/sdk`

**Part 2: SDK Architecture Improvements**

- **Category 3 - Error Handling**: Created `packages/sdk/src/errors.ts`
  - `ApiError` class extending core `AppError` with `status`, `isClientError()`, `isServerError()`, `isRetryable()`
  - `NetworkError` for fetch failures with original error preservation
  - `TimeoutError` with timeout duration tracking
  - `createApiError()` factory that maps HTTP status codes to typed core errors
  - Type guards: `isApiError()`, `isNetworkError()`, `isTimeoutError()`, `isUnauthorizedError()`
  - `getErrorMessage()` utility for user-friendly error extraction

- **Category 2 - API Client Documentation**: Added comprehensive JSDoc to `packages/sdk/src/api/index.ts`
  - Documents when to use `createApiClient` vs `createReactQueryClient`
  - Includes usage examples for both patterns

- **Category 1 - Code Analysis**: Reviewed `mutationQueue.ts` (320 lines)
  - Retry logic is well-contained and purpose-specific (linear retry with configurable delay)
  - Different from `TransactionQueue.ts` (exponential backoff with conflict handling)
  - No extraction needed as they serve distinct use cases

- Added `react-router-dom` as optional peer dependency in SDK package.json

**Tests Created:**

- `packages/sdk/src/hooks/__tests__/useAuthModeNavigation.test.ts` - 7 tests covering all navigation scenarios
- `packages/sdk/src/__tests__/queryKeys.test.ts` - 20 tests validating key structure
- `packages/sdk/src/__tests__/errors.test.ts` - 26 tests for error handling

---

### Added: Row-level Permissions System (Phase 5 Realtime)

Implemented comprehensive row-level permissions system for realtime features in `apps/server/src/infra/permissions/`.

**Core Components:**

- **`types.ts`** - Permission type definitions
  - `PermissionType`: 'read', 'write', 'delete', 'admin'
  - `PermissionResult` with allowed/denied and reason
  - `PermissionRecord` interface for records with ownership/membership fields
  - Rule types: `OwnershipRule`, `MembershipRule`, `RoleRule`, `CustomRule`
  - `PermissionConfig` for global and table-specific rules
  - Helper functions: `allowed()`, `denied()`, `isAllowed()`, `isDenied()`

- **`checker.ts`** - Permission checking logic
  - `PermissionChecker` class for row-level access control
  - `checkReadPermission(userId, userRole, table, recordId)` - can user read this record?
  - `checkWritePermission(userId, userRole, table, recordId, operation)` - can user write?
  - `filterReadableRecords(userId, table, records)` - filter to only readable
  - `batchCheckPermissions()` - check multiple permissions efficiently
  - Support for ownership-based permissions (user owns the record)
  - Support for workspace/team membership permissions
  - Support for role-based permissions (admin can access all)
  - Support for custom permission rules with async check functions
  - Factory functions: `createDefaultPermissionConfig()`, `createAdminRule()`, `createOwnerRule()`, `createMemberRule()`, `createCustomRule()`

- **`middleware.ts`** - Fastify integration
  - `createPermissionMiddleware()` factory for permission checks
  - `requireReadPermission()`, `requireWritePermission()`, `requireDeletePermission()`, `requireAdminPermission()` preHandlers
  - `createPermissionGuard()` for custom permission guards
  - `filterRecordsMiddleware()` for filtering response records
  - `createStandalonePermissionGuard()` for one-off checks
  - Helper functions: `hasPermission()`, `getPermissionDenialReason()`, `getRecordIdFromParams()`
  - `PreHandlerHook` type for middleware without `this` binding

- **`index.ts`** - Barrel exports for all public APIs

**Tests Created:**

- `__tests__/checker.test.ts` - 37 tests covering all permission scenarios
- `__tests__/middleware.test.ts` - 35 tests covering middleware integration

**Integration:**

- Exported from `apps/server/src/infra/index.ts`
- Updated `docs/todo/realtime/implementation-guide.md` to mark Phase 5 complete

---

### Added: Migrated Utilities to packages/ui and Improved Accessibility

Migrated generic form utilities from `apps/web` to `packages/ui` and refactored UI components for better consistency and accessibility.

**Part 1: Migrated Utilities**

- **`packages/ui/src/hooks/useFormState.ts`** - Generic form state management hook (renamed from `useAuthFormState`)
  - Provides `isLoading`, `error`, `setIsLoading`, `setError`, `clearError`, and `wrapHandler`
  - `wrapHandler` wraps async functions with automatic loading/error state management

- **`packages/ui/src/hooks/useResendCooldown.ts`** - Cooldown timer hook for resend actions
  - Provides `cooldown`, `isOnCooldown`, `startCooldown`, and `resetCooldown`
  - Handles interval cleanup on unmount to prevent memory leaks

- **`packages/ui/src/utils/createFormHandler.ts`** - Form handler factory utility
  - Creates wrapped async handlers with loading/error state management
  - Supports lifecycle callbacks: `onStart`, `onSuccess`, `onError`, `onFinally`

- Updated `apps/web/src/features/auth/` files to re-export from `@abe-stack/ui` for backwards compatibility

**Part 2: packages/ui Refactoring**

- **Category 2 - Code Duplication**: Standardized class name handling using `cn()` utility
  - Updated `Heading`, `Text`, `Card`, `Dialog`, `Avatar` components to use `cn()` instead of template string `.trim()` patterns

- **Category 5 - Architecture**: Moved context utilities to separate `providers/` directory
  - Created `packages/ui/src/providers/OptimizedProvider.tsx` with `createMemoizedContext`, `createSelectiveContext`, `createReducerContext`, `createLazyContext`, `createSubscriptionContext`, `Memoized`, `SelectiveMemo`, and `useRenderPerformance`
  - Components index re-exports from providers for backwards compatibility

- **Category 6 - Accessibility Improvements**:
  - `Pagination`: Added `nav` element with `role="navigation"`, `aria-label`, `aria-current="page"` for active page, `aria-label` for prev/next buttons
  - `Popover`: Added `aria-label` prop for trigger, `aria-haspopup="dialog"`, `aria-controls`, and `role="dialog"` for popover content
  - `Avatar`: Added `role="img"`, proper `aria-label` fallbacks, and default alt text handling

---

### Refactored: Domain-Based Architecture for packages/core

Reorganized `packages/core` from a mixed flat structure into a clear domain-based architecture with full test coverage.

**New Structure:**

```
packages/core/src/
â”œâ”€â”€ domains/           # Business domains
â”‚   â”œâ”€â”€ auth/          # Auth schemas, errors, validation
â”‚   â”œâ”€â”€ users/         # User types, schemas, contracts
â”‚   â”œâ”€â”€ pagination/    # Cursor pagination utilities
â”‚   â””â”€â”€ admin/         # Admin schemas and contracts
â”œâ”€â”€ infrastructure/    # Technical infrastructure
â”‚   â”œâ”€â”€ async/         # BatchedQueue, DeferredPromise, ReactiveMap
â”‚   â”œâ”€â”€ constants/     # HTTP status codes, time constants
â”‚   â”œâ”€â”€ crypto/        # JWT utilities (server-only)
â”‚   â”œâ”€â”€ errors/        # Base AppError + HTTP error classes
â”‚   â”œâ”€â”€ http/          # Cookie parsing utilities
â”‚   â”œâ”€â”€ stores/        # toastStore, undoRedoStore
â”‚   â””â”€â”€ transactions/  # Operation/undo utilities
â”œâ”€â”€ contracts/         # API contract definitions
â”œâ”€â”€ media/             # Media processing (server-only)
â”œâ”€â”€ shared/            # Token store, utilities
â””â”€â”€ utils/             # Pure utilities
```

**Created 16 new test files for complete coverage:**

- `contracts/__tests__/native.test.ts` - NativeBridge interface tests
- `domains/admin/__tests__/schemas.test.ts` - Admin schemas and contract
- `domains/auth/validation/__tests__/password-patterns.test.ts` - Password pattern detection
- `domains/auth/validation/__tests__/password-scoring.test.ts` - Password scoring utilities
- `domains/users/__tests__/schemas.test.ts` - User response schema
- `infrastructure/crypto/__tests__/jwt.test.ts` - JWT sign/verify/decode
- `infrastructure/errors/__tests__/response.test.ts` - API response types
- `infrastructure/http/__tests__/cookie.test.ts` - Cookie parsing
- `infrastructure/transactions/__tests__/types.test.ts` - Transaction types and guards
- `media/__tests__/audio-metadata.test.ts` - Audio metadata parsing
- `media/__tests__/ffmpeg-wrapper.test.ts` - FFmpeg wrapper types
- `media/__tests__/image-processing.test.ts` - Image processing
- `media/__tests__/security.test.ts` - Security scanner
- `media/__tests__/types.test.ts` - Media types
- `shared/__tests__/utils.test.ts` - randomId utility
- `utils/__tests__/storage.test.ts` - normalizeStorageKey

**Fixed test imports:**

- Updated `password.test.ts` and `passwordStrength.test.ts` to use relative imports
- Updated `domain-structure.test.ts` to test new domain-based paths

**Test Results:** 42 test files, 764 tests passing

---

### Added: Security Improvements for Auth Endpoints

Added stricter rate limiting for auth endpoints, CSRF documentation, and correlation IDs for error tracking.

**apps/server/src/infra/security/rateLimitPresets.ts**

- `AUTH_RATE_LIMITS` configuration with endpoint-specific rate limits:
  - Login: 5 attempts per minute (prevents credential stuffing)
  - Register: 3 attempts per hour (prevents spam account creation)
  - Forgot/Reset Password: 3-5 attempts per hour (prevents email abuse)
  - Token Refresh: 30 attempts per minute (more lenient for automatic calls)
- `authRateLimiters` singleton registry managing per-endpoint rate limiters
- `createAuthRateLimitHook()` factory for Fastify preHandler hooks with proper rate limit headers
- Progressive delay support for repeated violations

**apps/server/src/infra/http/correlationId.ts**

- `registerCorrelationIdHook()` Fastify middleware for distributed tracing
- Extracts correlation ID from `x-correlation-id` header or generates new UUID
- Sets correlation ID on request object (`req.correlationId`) and response headers
- `generateCorrelationId()` utility function for external use
- Validation to prevent header injection attacks

**apps/server/src/infra/http/csrf.ts**

- Added comprehensive documentation for CSRF-exempt endpoints explaining security rationale:
  - `/api/auth/login` - No session to exploit (unauthenticated)
  - `/api/auth/register` - No existing session (new user creation)
  - `/api/auth/forgot-password` - Public endpoint, sends email to account owner
  - `/api/auth/reset-password` - Protected by one-time token
  - `/api/auth/verify-email` - Protected by verification token
  - `/api/auth/refresh` - Protected by HTTP-only SameSite cookie
  - Explains why `/api/auth/logout` requires CSRF protection

**apps/server/src/server.ts**

- Registered correlation ID hook in plugin chain
- Updated error handler to include `correlationId` in error responses
- Enhanced error logging with correlation ID for debugging

**packages/core/src/infrastructure/errors/response.ts**

- Added optional `correlationId` field to `ApiErrorResponse` type

---

### Added: RecordStorage for Persistent IndexedDB Record Storage

Added a persistent record storage system using IndexedDB with automatic fallbacks to localStorage and in-memory storage, inspired by chet-stack's RecordStorage pattern.

**packages/sdk/src/cache/RecordStorage.ts**

- `RecordStorage<TTables>` generic class for persistent record storage with table namespacing
- Version-based optimistic concurrency - only writes records with newer versions
- Automatic storage backend selection: IndexedDB > localStorage > in-memory
- Async CRUD operations: `getRecord()`, `setRecord()`, `deleteRecord()`
- Bulk operations: `writeRecordMap()`, `getRecords()`, `getAllRecords()`
- Query helpers: `queryRecords()`, `findRecord()`, `countRecords()`
- Maintenance: `clearTable()`, `reset()`
- Change subscriptions via `subscribe()` with `RecordStorageEvent` callbacks
- `RecordStorageError` custom error class with categorized error types: `QUOTA_EXCEEDED`, `NOT_SUPPORTED`, `TRANSACTION_ERROR`, `SERIALIZATION_ERROR`, `UNKNOWN`
- Storage introspection: `getBackendType()`, `isPersistent()`
- Factory function: `createRecordStorage()`
- Utility functions: `iterateRecordMap()`, `createRecordMap()`
- Exported types: `VersionedRecord`, `RecordStoragePointer`, `RecordWithTable`, `RecordMap`, `RecordStorageOptions`, `RecordStorageEvent`, `RecordStorageListener`, `RecordStorageErrorType`

**packages/sdk/src/cache/index.ts**

- Updated barrel exports to include RecordStorage, RecordStorageError, and all associated types

**packages/sdk/src/cache/**tests**/RecordStorage.test.ts**

- Comprehensive test suite (31 tests) covering CRUD operations, version-based writes, force updates, bulk writes, record queries, clear/reset, and event subscriptions

---

### Added: RecordCache for Type-Safe In-Memory Record Storage

Added a generic, type-safe cache for storing records by type and ID with optimistic update support, inspired by chet-stack's implementation.

**packages/sdk/src/cache/RecordCache.ts**

- `RecordCache<TTables>` generic class with full TypeScript support for record tables
- Store records by table name and ID with `get()`, `set()`, `has()`, `delete()` operations
- Version-based conflict resolution - only updates records with higher version numbers
- Force updates available via `set(table, id, record, { force: true })`
- Pointer-based access: `getByPointer()`, `deleteByPointer()`, `subscribeByPointer()`
- Bulk operations: `setMany()`, `deleteMany()`
- Optimistic updates with rollback: `optimisticUpdate()` returns rollback function
- Commit or check optimistic state: `commitOptimisticUpdate()`, `hasOptimisticUpdate()`
- Change subscriptions: `subscribe()` for specific records, `subscribeAll()` for global changes
- RecordChange callbacks provide `{ table, id, before, after }` for reactive updates
- Table operations: `getAll()`, `getIds()`, `count()`, `getTables()`
- Clear operations: `clear()`, `clearTable()`, `reset()`
- Custom version extraction via `getVersion` option for non-standard version fields
- Exported types: `RecordPointer`, `RecordChange`, `RecordChangeListener`, `SetRecordOptions`, `RecordCacheOptions`, `CacheStats`, `IdentifiableRecord`, `TableMap`

**packages/sdk/src/cache/index.ts**

- Updated barrel exports to include RecordCache and all associated types

**packages/sdk/src/cache/**tests**/RecordCache.test.ts**

- Comprehensive test suite (48 tests) covering get/set, version conflicts, force updates, delete, pointers, bulk operations, optimistic updates, rollback, subscriptions, global listeners, table queries, clear/reset, and custom version extraction

---

### Added: UndoRedoStack for Operation History Management

Added a generic undo/redo stack implementation to the SDK for tracking and reverting operations with support for operation grouping.

**packages/sdk/src/undo/UndoRedoStack.ts**

- `UndoRedoStack<T>` generic class for tracking undoable operations
- Push operations with `push(data, groupId?)` - clears redo stack on new operation
- `undo()` and `redo()` methods return affected operations
- Operation grouping with `beginGroup()`/`endGroup()` and `withGroup(fn)` helper
- Grouped operations undo/redo together as a batch
- Configurable max undo stack size (default: 100)
- Callbacks: `onUndo`, `onRedo`, `onStateChange` for integration with UI
- State getters: `canUndo`, `canRedo`, `getState()`, `getCheckpoint()`
- Stack inspection: `peek()`, `getUndoStack()`, `getRedoStack()`
- Utility methods: `clear()`, `clearRedo()`, `reset()`
- Factory function: `createUndoRedoStack<T>(options)`
- Exported types: `UndoableOperation`, `OperationGroup`, `UndoRedoState`, `UndoRedoStackOptions`

**packages/sdk/src/undo/index.ts**

- Barrel exports for `UndoRedoStack`, `createUndoRedoStack`, and associated types

**packages/sdk/src/undo/**tests**/UndoRedoStack.test.ts**

- Comprehensive test suite (38 tests) covering push, undo, redo, operation grouping, state management, peek, clear/reset, factory function, and complex scenarios

---

### Added: WebsocketPubsubClient for Real-Time Subscriptions

Added a production-ready WebSocket-based PubSub client to the SDK for real-time data subscriptions with automatic reconnection.

**packages/sdk/src/pubsub/WebsocketPubsubClient.ts**

- `WebsocketPubsubClient` class with automatic reconnection using exponential backoff
- Supports subscribe/unsubscribe to topics with message callbacks
- Handles online/offline detection for smart reconnection
- Configurable options: secure connection, max reconnect attempts, base delay, debug logging
- Connection state management with `getConnectionState()` and `isConnected()` methods
- Custom WebSocket implementation injection for testing
- Exported types: `ClientPubsubMessage`, `ServerPubsubMessage`, `ConnectionState`, `WebsocketPubsubClientConfig`

**packages/sdk/src/pubsub/index.ts**

- Barrel exports for `WebsocketPubsubClient` and associated types

**packages/sdk/src/pubsub/**tests**/WebsocketPubsubClient.test.ts**

- Comprehensive test suite (20 tests) covering connection, subscribe/unsubscribe, message handling, reconnection, close/reconnect, error handling, and debug logging

---

### Added: SubscriptionCache for Reference-Counted Subscription Tracking

Added a reference counting subscription manager with delayed cleanup to prevent subscription thrashing on React component re-mounts.

**packages/sdk/src/subscriptions/SubscriptionCache.ts**

- `SubscriptionCache` class for managing subscription lifecycle
- Reference counting: tracks multiple subscribers to same key
- Delayed cleanup: configurable delay (default 10s) before unsubscribing after last subscriber leaves
- Prevents thrashing on React component re-mount (e.g., StrictMode double-mount)
- Callbacks: `onSubscribe` (first subscriber), `onUnsubscribe` (last subscriber leaves after delay)
- Query methods: `keys()`, `getCount()`, `has()`, `pendingCleanupCount`
- Force cleanup: `forceUnsubscribe()`, `clear()`
- Exported types: `SubscriptionCacheOptions`

**packages/sdk/src/subscriptions/**tests**/SubscriptionCache.test.ts**

- Test suite covering subscribe/unsubscribe, reference counting, delayed cleanup, force unsubscribe, and clear operations

---

### Added: LoaderCache for Request Deduplication with TTL

Added a cache for deferred loading promises with TTL support for deduplicating concurrent requests and caching async operation results.

**packages/sdk/src/cache/LoaderCache.ts**

- `Loader<T>` class - deferred promise wrapper with explicit resolve/reject control
- State tracking: `isPending`, `isResolved`, `isRejected`, `isSettled`, `isStale`
- TTL support: `ttlMs`, `timeRemaining`, automatic stale detection
- `LoaderCache<T>` class for managing multiple loaders by key
- Request deduplication with `getOrCreate(key)` - returns existing loader or creates new
- Auto-eviction of stale entries on access (configurable)
- Invalidation: `invalidate()`, `invalidateWhere()`, `invalidateByPrefix()`, `evictStale()`
- Utility queries: `keys()`, `values()`, `entries()`, `size`, `forEach()`
- Helper function: `loadWithCache(cache, key, loader)` for simple use cases
- Exported types: `LoaderState`, `LoaderOptions`, `LoaderCacheOptions`

**packages/sdk/src/cache/**tests**/LoaderCache.test.ts**

- Test suite covering loader states, TTL, cache operations, deduplication, invalidation, and stale eviction

---

### Added: TransactionQueue for Offline-First Mutation Support

Added a transaction queue for offline-first applications with automatic sync, conflict resolution, and rollback support.

**packages/sdk/src/offline/TransactionQueue.ts**

- `TransactionQueue` class for queueing mutations when offline
- Automatic processing when back online
- Batch processing for efficiency with configurable max batch size
- Conflict resolution with retry logic (exponential backoff for server errors, immediate retry for conflicts)
- Permanent failure handling with rollback callback
- Persistence to localStorage for offline durability
- Pending write tracking with `isPendingWrite(pointer)` and `subscribeIsPendingWrite(pointer, callback)`
- Status monitoring: `getStatus()`, `onOnlineStatusChange`, `onProcessingStatusChange`, `onQueueSizeChange`
- Queue management: `enqueue()`, `flush()`, `reset()`, `getQueuedTransactions()`
- Factory function: `createTransactionQueue(options)`
- Exported types: `TransactionRecordPointer`, `QueuedTransaction`, `TransactionQueueOptions`, `TransactionResponse`, `TransactionQueueStatus`

**packages/sdk/src/offline/**tests**/TransactionQueue.test.ts**

- Comprehensive test suite covering enqueue, processing, offline/online handling, batch processing, conflict resolution, rollback, persistence, and pending write tracking

---

### Fix: Email Send Failure Handling in Auth Handlers

Improved error handling for email sending failures during registration and password reset flows. Users no longer get stuck when email delivery fails after account creation.

**packages/core/src/errors/auth.ts**

- Added `EmailSendError` class for distinguishing email delivery failures from other errors

**apps/server/src/modules/auth/service.ts**

- Wrapped email sending in try-catch blocks in `registerUser`, `requestPasswordReset`, and `resendVerificationEmail`
- Throws `EmailSendError` with original error context when email fails

**apps/server/src/modules/auth/handlers.ts**

- `handleRegister`: Returns 201 with `emailSendFailed: true` flag if email fails, allowing users to use resend endpoint
- `handleForgotPassword`: Logs error but returns success to prevent user enumeration (user can retry)
- `handleResendVerification`: Returns 503 with clear error message since user explicitly requested resend

**apps/server/src/shared/constants.ts**

- Added `EMAIL_SEND_FAILED` error message constant

---

### Security: CSRF Validation for WebSocket Upgrades

Added CSRF token validation to WebSocket upgrade requests to prevent cross-site WebSocket hijacking attacks.

**apps/server/src/infra/websocket/websocket.ts**

- WebSocket upgrades now require valid CSRF token before allowing connection
- CSRF token can be provided via query parameter (`?csrf=<token>`) or `Sec-WebSocket-Protocol` header (format: `csrf.<token>`)
- Invalid CSRF tokens result in HTTP 403 rejection before upgrade completes

**apps/server/src/infra/http/csrf.ts**

- Added `validateCsrfToken()` function for standalone CSRF validation (used by WebSocket and other non-Fastify contexts)
- Exported `CsrfValidationOptions` interface

---

### Documentation: Public API Utilities

Added comprehensive JSDoc documentation to unused but valuable public API utilities.

**packages/core/src/async/**

- `DeferredPromise` - Promise with external resolve/reject for bridging callback APIs
- `BatchedQueue` - Batches multiple async calls to solve N+1 query problems
- `ReactiveMap` - Observable key-value store with per-key subscriptions

**packages/core/src/stores/**

- `createUndoRedoStore` - Factory for isolated undo/redo contexts
- `useUndoRedoStore` - Default global undo/redo store instance

**packages/ui/src/hooks/useOptimizedMemo.ts**

- `deepEqual`, `shallowEqual` - Comparison utilities
- `useDeepMemo`, `useShallowMemo` - Optimized memo hooks
- `useDeepCallback`, `useShallowCallback` - Optimized callback hooks
- `useDeepEffect`, `useShallowEffect` - Smart effect hooks
- `TTLCache`, `LRUCache` - Cache data structures
- `useTTLCache`, `useLRUCache` - React hooks for caches
- `useExpensiveComputation` - Debounced expensive calculations
- `useDebouncedState`, `useThrottle`, `useDebounce` - Rate-limiting hooks

All utilities include `@example` tags with practical usage patterns.

---

### ðŸ”’ Deep Security Audit & Comprehensive Fixes

**Major security, memory, and code quality improvements from a comprehensive codebase audit.**

#### Critical Security Vulnerabilities Fixed

| Issue                         | File                            | Fix                                                                                                                                                            |
| ----------------------------- | ------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Prototype Pollution**       | `infra/http/security.ts`        | Added `sanitizeObject()`, `hasDangerousKeys()`, `registerPrototypePollutionProtection()` to strip `__proto__`, `constructor`, `prototype` keys from JSON input |
| **Path Traversal**            | `infra/files/fastify-server.ts` | Added `isValidId()`, `isValidFilename()`, `isPathContained()` validation to prevent directory escape attacks                                                   |
| **WebSocket Table Injection** | `infra/websocket/websocket.ts`  | Added `ALLOWED_SUBSCRIPTION_TABLES` whitelist and `isValidSubscriptionKey()` to prevent unauthorized table access                                              |
| **CSRF on Logout**            | `infra/http/csrf.ts`            | Removed `/api/auth/logout` from CSRF exempt paths - logout now requires CSRF token                                                                             |
| **Rate Limiter Role Bypass**  | `infra/rate-limit/limiter.ts`   | Added `VALID_ROLES` whitelist and `isValidRole()` type guard to prevent role escalation                                                                        |

#### Critical Memory Leak Fixes

| Issue                        | File                                  | Fix                                                                                                  |
| ---------------------------- | ------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| **Retry State Leak**         | `infra/media/retry.ts`                | Added periodic cleanup interval (5 min), max age (1 hour), and `destroy()` method                    |
| **Audit Logger Buffer Leak** | `infra/security/audit.ts`             | Added `MAX_BUFFER_SIZE` (10k) with 10% eviction, intrusion state cleanup (24h), enhanced `destroy()` |
| **Timeout Promise Leak**     | `infra/media/processor.ts`            | Store timeout ID and clear in finally block after processing completes                               |
| **BatchedQueue Leak**        | `packages/core/async/BatchedQueue.ts` | Added `flushTimeoutId` tracking and `destroy()` method to clear pending timers                       |
| **QueueServer Sleep Leak**   | `infra/queue/queueServer.ts`          | Added AbortController to cancel pending sleeps on stop for clean shutdown                            |

#### API Contract & Type Alignment

| Issue                       | File                                | Fix                                                                                            |
| --------------------------- | ----------------------------------- | ---------------------------------------------------------------------------------------------- |
| **Error Schema Mismatch**   | `packages/core/contracts/common.ts` | Updated `errorResponseSchema` to `{message, code?, details?}` matching actual server responses |
| **User Type Missing Field** | `apps/web/AuthService.ts`           | Added `createdAt: string` to `User` type to match server response                              |
| **Token Refresh Race**      | `apps/web/AuthService.ts`           | Added `refreshPromise` mutex to deduplicate concurrent 401 refresh requests                    |

#### Email Service Improvements

| Issue                      | File                   | Fix                                                                                       |
| -------------------------- | ---------------------- | ----------------------------------------------------------------------------------------- |
| **Missing Retry Logic**    | `infra/email/smtp.ts`  | Added 3 retries with exponential backoff (1s/2s/4s) for transient SMTP failures           |
| **Missing Env Validation** | `packages/core/env.ts` | Added SMTP*HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, EMAIL_PROVIDER, EMAIL_FROM*\* to schema |
| **No Production Check**    | `config/loader.ts`     | Added validation: error if console provider in production, error if smtp without host     |

#### Dead Code Removed

| Item                   | Location                       | Action                                                         |
| ---------------------- | ------------------------------ | -------------------------------------------------------------- |
| **Orphaned uploads/**  | `packages/core/src/uploads/`   | Deleted entire unused directory                                |
| **Deprecated aliases** | `packages/core/errors/http.ts` | Removed `PermissionError`, `RateLimitError` deprecated exports |

#### Duplicate Code Consolidated

| Issue                   | Files                                | Fix                                                                      |
| ----------------------- | ------------------------------------ | ------------------------------------------------------------------------ |
| **USER_ROLES/UserRole** | `schema/users.ts`, `shared/types.ts` | Now import from `@abe-stack/core` instead of local duplicates            |
| **Time Constants**      | `shared/constants.ts`                | Now import `MS_PER_SECOND`, etc. from `@abe-stack/core`                  |
| **Wildcard Exports**    | `config/schema/index.ts`             | Converted `export *` to 34 explicit named exports per project convention |

#### Environment & Base URL Configuration

| Issue                          | File                       | Fix                                                                                    |
| ------------------------------ | -------------------------- | -------------------------------------------------------------------------------------- |
| **Hardcoded localhost**        | `config/server.config.ts`  | Added `appBaseUrl` and `apiBaseUrl` config from `APP_BASE_URL`/`API_BASE_URL` env vars |
| **Hardcoded URLs in handlers** | `modules/auth/handlers.ts` | Now uses `ctx.config.server.appBaseUrl` instead of hardcoded localhost                 |
| **Hardcoded URLs in service**  | `modules/auth/service.ts`  | Removed localhost fallbacks, baseUrl now required from handlers                        |

---

### Security and Configuration Improvements

Fixed various security configuration issues and false positive detection patterns.

**Changes:**

| File                                       | Change                                                                                                                                                                           |
| ------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `apps/server/src/infra/http/validation.ts` | Improved SQL injection detection patterns to require actual SQL syntax context, not just keywords. Added `SQLInjectionDetectionOptions` interface for per-endpoint configuration |
| `apps/server/src/scripts/seed.ts`          | Added production environment guard - script now refuses to run if `NODE_ENV === 'production'`. Added warning comments about development-only usage                               |
| `apps/server/src/server.ts`                | Sanitize 5xx error messages in production to prevent leaking sensitive information. Added default 1MB body size limit for JSON requests                                          |
| `apps/server/src/infra/http/security.ts`   | Added `getProductionSecurityDefaults()` helper function for stricter security in production. Enhanced CSP documentation                                                          |
| `apps/server/src/infra/http/index.ts`      | Exported `getProductionSecurityDefaults` and `SecurityHeaderOptions`                                                                                                             |

**Security Improvements:**

- SQL injection detection now only flags actual SQL injection patterns (e.g., `UNION SELECT`, `SELECT ... FROM`), not common words like "select" or "update"
- Seed script cannot accidentally run in production, preventing creation of accounts with known test passwords
- Production error responses for 5xx errors now return generic messages, keeping detailed errors in server logs only
- CSP is automatically enabled in production via `getProductionSecurityDefaults()`
- Default body limit of 1MB prevents denial-of-service via large payloads

---

### API Contract Alignment: Error Response and User Type

Fixed mismatches between client-side type expectations and actual server responses.

**Problem Solved:**

- `errorResponseSchema` in core contracts expected `{ error, message, code?, details? }` but server handlers return `{ message }` only
- Client `User` type was missing `createdAt` field that the server returns

**Changes:**

| File                                                                | Change                                                              |
| ------------------------------------------------------------------- | ------------------------------------------------------------------- |
| `packages/core/src/contracts/common.ts`                             | Removed required `error` field from `errorResponseSchema`           |
| `packages/core/src/contracts/__tests__/common.test.ts`              | Updated tests for new error response schema (message only required) |
| `packages/core/src/contracts/__tests__/contracts.test.ts`           | Updated tests for new error response schema                         |
| `apps/web/src/features/auth/services/AuthService.ts`                | Added `createdAt: string` to `User` type                            |
| `apps/web/src/features/auth/hooks/__tests__/useAuth.test.tsx`       | Updated mock user objects to include `createdAt`                    |
| `apps/web/src/features/auth/pages/__tests__/AuthPage.test.tsx`      | Updated mock user and fixed typing for `mockUseAuth`                |
| `apps/web/src/features/auth/services/__tests__/AuthService.test.ts` | Updated `createMockUser` to include `createdAt`                     |

---

### Auth Service: Fix Silent Password Rehash Failures

Fixed the `rehashPassword` function in auth service to always log errors for observability.

**Problem Solved:**

- The fire-and-forget `rehashPassword` function silently swallowed errors when no callback was provided
- Rehash failures were invisible in production logs unless the caller explicitly passed an error callback
- Made debugging password hash upgrade issues difficult

**Changes:**

| File                                                      | Change                                                                                                                  |
| --------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| `apps/server/src/modules/auth/service.ts`                 | Added `logger: Logger` parameter to `rehashPassword` function; always log errors regardless of callback                 |
| `apps/server/src/modules/auth/handlers.ts`                | Updated `handleLogin` to pass `ctx.log` to `authenticateUser`; simplified callback to only log success                  |
| `apps/server/src/modules/auth/__tests__/service.test.ts`  | Added mock logger helper; updated all `authenticateUser` tests with logger parameter; added assertion for error logging |
| `apps/server/src/modules/auth/__tests__/handlers.test.ts` | Updated test assertions for new `authenticateUser` signature; fixed mock context to include `appBaseUrl`                |

**Behavior:**

- Errors are now **always logged** via the structured logger
- The optional callback is still supported for additional handling (e.g., success logging)
- The function remains fire-and-forget (does not block login)

---

### Auth UI Consistency Refactor

Unified authentication UI styling across all auth pages and the auth modal by using shared `AuthLayout` + `AuthForm` components.

**Problem Solved:**

- `LoginPage` and `RegisterPage` used `PageContainer` + `Card` with custom form implementations
- `AuthModal` used `AuthLayout` + `AuthForm`
- Inconsistent styling and behavior between modal and page implementations

**Changes:**

| File                    | Before                        | After                                    |
| ----------------------- | ----------------------------- | ---------------------------------------- |
| `Login.tsx`             | `PageContainer` + custom form | `AuthLayout` + `AuthForm`                |
| `Register.tsx`          | `PageContainer` + custom form | `AuthLayout` + `AuthForm`                |
| `ResetPasswordPage.tsx` | Already using pattern         | Unchanged                                |
| `ConfirmEmailPage.tsx`  | Custom implementation         | Uses `AuthLayout` with auth-form classes |

**Key Pattern:**

- **Modal behavior**: `onModeChange` changes internal state (stays in modal)
- **Page behavior**: `onModeChange` triggers navigation (goes to different page)

**Updated Tests:**

- `Login.test.tsx` - Updated for new component structure
- `Register.test.tsx` - Updated for new component structure

**New Tests:**

- `ConfirmEmailPage.test.tsx` - Tests for email verification page (loading, success, error states)
- `ResetPasswordPage.test.tsx` - Tests for password reset page (form submission, navigation, error handling)
- `AuthPage.test.tsx` - Tests for unified auth page (mode switching, all auth flows, redirects)

**Documentation:**

- `packages/ui/docs/layouts/containers/AuthLayout.md` - Updated with:
  - Correct import path (`@abe-stack/ui`)
  - Recommended pattern using `AuthLayout` + `AuthForm`
  - Modal vs Page behavior explanation
  - CSS classes reference
  - Code examples for all auth page types

---
