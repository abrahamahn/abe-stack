# Week 5: January 26-31, 2026

> **Summary**: Hexagonal architecture package extraction — decomposed `apps/server` into 10+ standalone packages. ~26,000+ lines removed. Shared `BaseContext` contract eliminates duplicate type definitions. 3,000+ new tests. Directory restructure (`packages/` → `infra/`, `modules/`, `shared/`, `client/`). SDK rename (`@abe-stack/sdk` → `@abe-stack/engine`). Config migration to packages. Feature flags for modular route gating. 2FA/TOTP + email change flows. UI accessibility (ErrorBoundary, focus management, toast tones). Integration tests for auth API routes. Production Postgres docs, operations manual, security decision documentation, quickstart guides per profile. All migration phases P0–P7 complete.

---

## Table of Contents

- [Monday (01-26)](#monday-january-26-2026) — Lint fixes, ESLint config alignment, tooling overhaul
- [Tuesday (01-27)](#tuesday-january-27-2026) — Monorepo strictness, health-check utility, Playwright integration
- [Wednesday (01-28)](#wednesday-january-28-2026) — Comprehensive test creation (3,000+ tests), file naming standardization
- [Thursday (01-29)](#thursday-january-29-2026) — Infrastructure package extraction (cache, billing, storage, email, security, jobs, http)
- [Friday (01-30)](#friday-january-30-2026) — Feature package extraction (auth, users, realtime, notifications), server rewiring, dead code cleanup
- [Saturday (01-31)](#saturday-january-31-2026) — Server migration completion, module extraction, BaseContext contract, directory restructure, SDK rename, config migration, feature flags, 2FA/TOTP, email change, UI standardization, integration tests, profile quickstarts, production Postgres docs, monorepo error fixes, DB scripts migration

---

## Monday, January 26, 2026

### Lint Error Fixes & Configuration Alignment

- **Consolidated TypeScript Configs**: Merged separate `tsconfig.lint.json` files into main `tsconfig.json` for all apps (`desktop`, `server`, `web`). Updated `eslint.config.ts` and `vitest.config.ts` to rely on the single source of truth.
- **Fixed ~35 files**: Addressed nullish coalescing, `strict-boolean-expressions`, and type-only exports across `apps/server` (config/infra).
- **Rule alignment**: Confirmed ESLint and TypeScript at maximum strictness, VSCode settings updated to match.

### Tooling & Configuration Overhaul

**Path Alias Automation:**

- Created `tooling/sync/sync-aliases.ts` to auto-generate `tsconfig.json` paths from directory structure.
- Scans `apps/server/src/modules`, `shared/ui/src/components`, etc.
- Eliminates manual alias maintenance. Integrated into `pnpm dev` pipeline.

**Generator Cleanup:**

- Removed legacy generators (`tooling/generators/`) and obsolete schemas (`tooling/schema/`). Renamed `tooling/lint` → `tooling/sync`.

**TypeScript & Linting:**

- Refactored `sync-ts-references.ts` for strict type safety.
- Updated `eslint.config.ts` as single source of truth (removed auxiliary schema files).
- Standardized `tsconfig.json` paths across Server, Desktop, and UI packages.

---

## Tuesday, January 27, 2026

### Monorepo Tooling, Strictness & Health Check

#### Configuration & Strictness

- **TypeScript 5.7+**: Enabled `exactOptionalPropertyTypes` and `noPropertyAccessFromIndexSignature`.
- **ESLint**: Enforced `naming-convention`, regex filter for kebab-case headers, enabled `import-x/no-cycle` and `no-deprecated`.

#### Health Check Utility

- Created `pnpm health-check` with parallel execution via turbo, unified per-package reporting, ANSI code stripping.
- **OOM Resolution**: Baked `--continue` into root scripts (`lint`, `type-check`) for multi-process execution.
- **Cache cleanup**: Centralized `.eslintcache`, `.prettiercache`, `.turbo` into `node_modules/.cache`.

#### Playwright Integration

- Hooked `config/playwright.config.ts` to the monorepo env loader (`shared/core/.../env.loader.ts`). Zero new dependencies — reuses existing logic for consistent env vars.

#### Architecture Decisions

- **Database**: Validated layer-based `infra/db` structure (schema/builder/repositories) for SQL relational complexity.
- **Agent protocol**: Added `.tmp/` directory rule for non-code files and end-of-session checklist to `CLAUDE.md`.

### Lint Error Resolution

Fixed 45 lint errors across 2 packages:

- `@abe-stack/stores`: 13 `no-confusing-void-expression` errors — converted arrow shorthand to block syntax
- `@abe-stack/shared`: 27 `no-unnecessary-boolean-literal-compare` + 5 unused `eslint-disable` directives

---

## Wednesday, January 28, 2026

### Test Coverage Summary

| Package         | Tests  | Key Areas                                                         |
| --------------- | ------ | ----------------------------------------------------------------- |
| infra/contracts | 170+   | environment, billing/service                                      |
| shared/core     | 450+   | config types (auth, infra, services, index)                       |
| infra/db        | 245+   | schema (auth, oauth, push), repositories/billing                  |
| sdk             | 240+   | QueryCache, QueryCacheProvider, useMutation, billing/admin        |
| shared/ui       | 650+   | router (context, components, hooks), SidePeek, billing components |
| apps/server     | 1,100+ | auth, admin, billing, system, users, scripts                      |
| apps/web        | 60+    | main, admin components                                            |

**Major test areas created:**

- **Router** (115 tests): BrowserRouter, MemoryRouter, navigation types, Link, Navigate, Routes, Outlet, useParams, full navigation flows, protected routes pattern
- **Auth handlers** (237 tests): Magic link handlers/routes, OAuth handlers/routes (103 tests covering all providers), refresh token management, login security events
- **Billing** (255 tests): Handlers (60), service (55), webhook routes (33), Stripe provider (61), admin billing (46)
- **Query system** (162 tests): QueryCache (95) with GC/subscriptions/invalidation, QueryCacheProvider (29), useMutation (38) with retries/race conditions
- **Server infrastructure** (355 tests): Routes module (36), error mapper (46), constants (91), request utils (74), server factory (37), system routes (71)
- **UI** (402 tests): SidePeek (76) with accessibility/animations/chaos scenarios, admin components (326 across 11 files)
- **Schema & config** (540 tests): OAuth schema (50), auth schema (79), push schema (61), config types (272 across 4 files), billing service contract (48), server environment (22)
- **Services** (228 tests): Profile service (37), sessions service (33), db-push scripts (34), Google OAuth (60), GitHub OAuth (32), notification handlers (32)

### Admin Component Tests

326 tests across 11 files with 7 fully passing and 4 requiring router context fixes:

| File                                                             | Tests | Status                |
| ---------------------------------------------------------------- | ----- | --------------------- |
| ExportDialog, JobActionsMenu, JobDetailsPanel, SecurityEventCard | 126   | All passing           |
| JobsTable, QueueStatsCard, SecurityMetricsCard                   | 74    | 92-96%                |
| UserActionsMenu                                                  | 29/36 | 81%                   |
| SecurityEventsFilters, SecurityEventsTable, UserTable            | 6/85  | Router context needed |

### TypeScript Module Resolution & Test Exclusion

- Changed `tsconfig.node.json` `moduleResolution` from `NodeNext` to `Bundler`
- Added test file exclusions (`**/*.test.ts`, `**/*.test.tsx`, `**/__tests__/**`) to all package/app tsconfig files
- Error progression: 830 → 2451 (Bundler analyzes more files) → 793 (after test exclusion)

### File Naming Standardization & Barrel Export Cleanup

**Config renames**: `config/parsers.ts` → `config/env.parsers.ts`, `config/types/config-types.ts` → `config/types/index.ts`

**Kebab-case standardization** (8 files in shared/core): `BatchedQueue.ts` → `batched-queue.ts`, `DeferredPromise.ts` → `deferred-promise.ts`, `ReactiveMap.ts` → `reactive-map.ts`, `validationError.ts` → `validation-error.ts`, `postgresPubSub.ts` → `postgres-pubsub.ts`, `subscriptionManager.ts` → `subscription-manager.ts`, `httpMapper.ts` → `http-mapper.ts`, `passwordStrength.ts` → `password-strength.ts`

**Barrel cleanup**: Removed re-exports from `@abe-stack/shared` in `apps/server/src/shared/index.ts`. Updated ~25 consumer files to import errors directly. Golden standard: barrels export only local items.

### Error Counts After Test Exclusion

| Package           | Lint | Type | Total |
| ----------------- | ---- | ---- | ----- |
| @abe-stack/server | 196  | 262  | 458   |
| @abe-stack/engine | 93   | 72   | 165   |
| @abe-stack/web    | 148  | 5    | 153   |
| @abe-stack/shared | 16   | 1    | 17    |

Passing packages (0 errors): @abe-stack/shared, @abe-stack/infra, @abe-stack/ui, @abe-stack/stores, @abe-stack/media, @abe-stack/desktop

---

## Thursday, January 29, 2026

### Infrastructure Package Extraction (Hexagonal Architecture)

Extracted server infrastructure into reusable packages following hexagonal architecture principles.

#### New Packages Created

| Package           | Extracted From                    | Key Contents                                                                         | Tests |
| ----------------- | --------------------------------- | ------------------------------------------------------------------------------------ | ----- |
| `infra/cache`     | `infrastructure/cache/`           | Single LRU engine (consolidated 3x duplicate), memoize, memory provider              | 108   |
| `modules/billing` | `infrastructure/billing/`         | Stripe/PayPal providers, factory, types                                              | —     |
| `infra/email`     | `infrastructure/messaging/email/` | Console/SMTP providers, templates, factory                                           | 64    |
| `infra/security`  | `infrastructure/security/`        | JWT rotation, permission checker + middleware, rate limiter + presets                | 133   |
| `infra/jobs`      | `infrastructure/jobs/`            | Memory/Postgres queue stores, write service, 4 scheduled cleanup jobs                | 238   |
| `infra/http`      | `infrastructure/http/`            | Plugins, 8 middleware (cookie/CSRF/CORS/security/validation/etc), pagination, router | 339   |

**Key architectural decisions:**

- **Cache LRU consolidation**: Triplicated LRU logic (from `lru-cache.ts`, `memory-provider.ts`, `memoize.ts`) consolidated into single `LRUCache<K, V>` class with O(1) doubly-linked list + Map and cache stampede prevention (memoize caches Promise, not result).

- **HTTP generic context**: Replaced server-specific `AppContext` with `HandlerContext = Record<string, unknown>`. Auth guard creation via `AuthGuardFactory` dependency injection. `registerPlugins()` accepts `PluginOptions` interface with `RateLimiterLike`, `isAppError`/`getErrorInfo` callbacks, and `StaticServeConfig`.

- **HTTP export collision**: Both `security.ts` and `validation.ts` export `sanitizeObject` — resolved by aliasing validation version as `sanitizeInput` in middleware barrel.

- **Jobs queue stores**: `MemoryQueueStore` for development/testing, `PostgresQueueStore` for production. Write service follows Chet-stack unified database write pattern with hooks. Scheduled jobs: login cleanup, push cleanup, magic link cleanup, OAuth token refresh.

- **Security architecture**: Full `PermissionChecker` with `createPermissionMiddleware` and `createStandalonePermissionGuard` for row-level permission checking. `RateLimiter` with `MemoryStore` and `RateLimitPresets` for standard configurations (token bucket algorithm).

- **Email package**: Console provider (dev), SMTP provider (production) with low-level client, email template functions. Factory pattern: `createEmailService()`.

- **Security package**: `signWithRotation`/`verifyWithRotation`/`createJwtRotationHandler` with `checkTokenSecret` helper for JWT. Permission middleware factory. Token bucket rate limiter with memory store.

#### Storage Test Recovery & Data Infrastructure Consolidation

Previous session deleted `apps/server/src/infrastructure/data/` (39 files) which contained database, storage, and 8 storage test files — test files were accidentally deleted rather than moved. Recovered from git history:

1. `factory.test.ts` → `infra/src/storage/factory.test.ts` (16 tests)
2. `localStorageProvider.test.ts` → `infra/src/storage/providers/local.test.ts`
3. `s3StorageProvider.test.ts` → `infra/src/storage/providers/s3.test.ts`
4. `signedUrls.test.ts` → `infra/src/storage/signing.test.ts`
5. `normalizeKey.test.ts` → `infra/src/storage/normalize-key.test.ts` (20 tests)
6. `fastify-server.test.ts` → `infra/src/storage/http/server.test.ts`
7. `helpers.test.ts` → `infra/src/storage/http/helpers.test.ts`
8. `signatures.test.ts` → `infra/src/storage/http/signatures.test.ts`

Updated mock paths, type imports (changed from `@abe-stack/shared` → local `./types`), and added vitest sub-path alias resolution (`@abe-stack/shared/*` → `shared/core/src/*`). All 136 storage tests passing.

#### Database & Search Expansion (`infra/db`)

Expanded `infra/db` with scripts, search, and config:

| Addition                           | Purpose                                         | Tests |
| ---------------------------------- | ----------------------------------------------- | ----- |
| `scripts/db-push.ts`               | Schema push (11 tables, 12 indexes)             | 20    |
| `scripts/seed.ts`                  | Database seeding with 4 test users              | —     |
| `scripts/bootstrap-admin.ts`       | Production admin creation                       | —     |
| `search/sql-provider.ts`           | SqlSearchProvider with offset/cursor pagination | 20    |
| `search/elasticsearch-provider.ts` | Stub provider (throws until implemented)        | 32    |
| `search/search-factory.ts`         | Provider registry and singleton                 | 13    |
| `config/database.ts`               | Config loader for 4 providers                   | 11    |

**Decision**: Scripts accept `PasswordHasher` callback to avoid circular dependency on `@abe-stack/auth`.

**Verification**: 31 test files, 1,301 tests, all passing. Type-check: 0 errors.

#### Server Rewiring (Phase 1B)

Updated `apps/server` barrel exports to import from packages:

| Section        | Before (local)             | After (package)      |
| -------------- | -------------------------- | -------------------- |
| Email          | `'./messaging/email'`      | `'@abe-stack/infra'` |
| Write Service  | `'./jobs/write'`           | `'@abe-stack/infra'` |
| Rate Limiting  | `'./security/rate-limit'`  | `'@abe-stack/infra'` |
| JWT Rotation   | `'./security/crypto'`      | `'@abe-stack/infra'` |
| Queue          | `'./jobs/queue'`           | `'@abe-stack/infra'` |
| Scheduled Jobs | `'./jobs/scheduled'`       | `'@abe-stack/infra'` |
| Permissions    | `'./security/permissions'` | `'@abe-stack/infra'` |

Not rewired: HTTP middleware/CORS, Router, Pagination, WebSocket, Search, Health, Logger, Media, Notifications (server-specific `AppContext` vs generic `HandlerContext` mismatch).

**Verification**: Server type-check 0 errors, 139 test files, 3,789 tests all passing.

#### HTTP Package Structure Detail

```
infra/src/http/
├── plugins.ts                # Parameterized Fastify plugin registration
├── middleware/
│   ├── cookie.ts             # Cookie signing (HMAC-SHA256)
│   ├── correlationId.ts      # X-Correlation-ID middleware
│   ├── csrf.ts               # CSRF double-submit cookie (AES-256-GCM)
│   ├── security.ts           # Security headers (CSP, HSTS, CORS)
│   ├── requestInfo.ts        # Request metadata extraction
│   ├── proxyValidation.ts    # Proxy validation with CIDR matching
│   ├── static.ts             # Static file serving
│   └── validation.ts         # Input validation & sanitization
├── pagination/
│   ├── helpers.ts            # Offset & cursor pagination helpers
│   └── middleware.ts         # Pagination middleware factory
└── router/
    ├── types.ts              # HandlerContext, AuthGuardFactory, route types
    └── router.ts             # Route registration with injected auth guards
```

#### Logger Infrastructure Expansion

Expanded `shared/core/src/infrastructure/logger/` with framework-agnostic types:

- `BaseLogger` interface matching pino's data-first signature `(data, msg)` for zero-cost Fastify interop
- Pure `getOrCreateCorrelationId(headers)` — priority: x-correlation-id > x-request-id > traceparent (W3C) > generate new
- `LOG_LEVELS` numeric severity mapping, `shouldLog(messageLevel, configuredLevel)` filtering
- `CoreLogger`/`CoreLogLevel` aliases in barrel to avoid collision with contracts Logger and config LogLevel

Server logger rewired: pure functions from `@abe-stack/shared`, Fastify-specific `createLogger`/`createRequestLogger` kept local. Test deduplication: 25 → 10 server logger tests (pure function tests now in core: 30 tests).

#### Billing Package Expansion

Expanded `modules/billing` from provider-only to full module: service (14 functions), handlers (error mapping), routes (10 routes), webhooks (Stripe + PayPal with signature verification + idempotency).

**Key decisions:**

- Framework-agnostic narrow interfaces (`BillingRepositories`, `BillingLogger`, `BillingAppContext`) in `types.ts`
- Error assertions use `toMatchObject({ name: 'ErrorName' })` instead of `toBeInstanceOf` (class identity differs across monorepo module boundaries)
- Both webhook handlers follow same pattern: construct provider → verify signature → check idempotency → parse normalized event → dispatch by type → record event

**Verification**: 256 tests across 8 files, all passing.

#### Notifications Package Extraction

Extracted notification infrastructure into `infra/notifications`:

- **Service** (15 functions): Subscription management, preference management, channel routing
- **Handlers** (7 handlers): HTTP handlers for notification preferences and subscriptions
- **Routes** (7 routes): Route definitions with `notificationPublicRoute`/`notificationProtectedRoute` helpers
- **Providers**: FCM stub implementation, `createNotificationProviderServiceFromEnv` factory

**Key decisions**: `NotificationModuleDeps` interface (only `db`, `repos`, `log`) replaces server-specific `AppContext`. Route bridge pattern narrows generic `HandlerContext` at runtime. Renamed to `NotificationProviderService` to avoid collision with core `NotificationService` type.

---

## Friday, January 30, 2026

### Auth Package Extraction (`modules/auth`)

Extracted auth module from `apps/server/src/modules/auth/` into standalone package with ~190+ exports.

**Package structure:**

```
modules/auth/src/
├── config/          # Auth config, JWT rotation, rate limit loading
├── handlers/        # login, logout, register, password, verify, refresh
├── magic-link/      # service, handlers, routes (2 routes)
├── oauth/           # service, handlers, routes (15 routes), providers (Google/GitHub/Apple)
├── security/        # events (23 functions), lockout, audit, rate limit presets
├── utils/           # JWT, argon2id password, refresh tokens, request, response, cookies
├── middleware.ts     # createRequireAuth, createRequireRole, createAuthGuard
├── routes.ts         # Main auth route map (10 routes)
├── service.ts        # 12 core auth service functions
└── types.ts          # AuthLogger, AuthEmailService, AuthEmailTemplates, AppContext, constants
```

**Key architectural decisions:**

1. **Import transformation (hexagonal decoupling)**: `@/infrastructure` decomposed to `@abe-stack/infra` (DB, transactions), `@abe-stack/infra` (rate limiting), local `./types` (narrow interfaces). `@shared` decomposed to `@abe-stack/shared` (error mapping) + local types.

2. **Context bridge pattern**: `asAppContext()` narrows generic `HandlerContext` to auth-specific `AppContext` at call boundary — preserves type safety without coupling HTTP package to auth types.

3. **Dependency inversion for email**: Auth package defines `AuthEmailTemplates` interface, accepts as parameter on `registerUser`, `requestPasswordReset`, `resendVerificationEmail`, `requestMagicLink`, `sendTokenReuseAlert`.

4. **DRY error mapping**: `createErrorMapperLogger()` adapts `AuthLogger` to `ErrorMapperLogger` interface — replaced inline adapter code duplicated across 10+ handler files.

5. **Fastify type safety**: Local intersection types (`AuthenticatedFastifyRequest = FastifyRequest & { user?: TokenPayload }`) instead of unreliable global module augmentation across package boundaries with `verbatimModuleSyntax`.

### Users Package Extraction (`infra/users`)

Extracted user management with narrow `UsersModuleDeps` (only `repos`, `log`, `storage`, `config.auth.argon2`). Split handlers into domain-focused files:

- `handlers/profile.ts` — HTTP handlers (handleMe, handleListUsers)
- `handlers/sessions.ts` — Session listing, revoking, counting
- `handlers/avatar.ts` — Profile updates, password changes, avatar management (uploadAvatar validates JPEG/PNG/WebP/GIF, size limits)
- `service.ts` — getUserById, listUsers (pure business logic)

55 tests across 5 files (service: 4, profile: 4, sessions: 18, avatar: 20, routes: 9).

### Realtime Package Extraction (`infra/realtime`)

Extracted realtime module with `RealtimeModuleDeps` interface and `asRealtimeDeps()` bridge function:

- **Service**: `loadRecords`, `applyOperations` (optimistic locking), `checkVersionConflicts`, `saveRecords`, `isTableAllowed`, `registerRealtimeTable`
- **Handlers**: `handleWrite` (optimistic locking with RecordNotFoundError, VersionConflictError), `handleGetRecords`
- **WebSocket**: Registration with injected `TokenVerifier` type `(token: string) => Promise<{ userId, email, role }>`, CSRF validation, subscription management

Converted module-level state mutations to discrete functions (`incrementConnections`, `decrementConnections`, `markPluginRegistered`, `resetStats`) for testability. 90 tests across 6 files (service: 20, routes: 17, sync handlers: 19, subscribe handlers: 11, stats: 10, lifecycle: 13).

### Server Rewiring (Phase 2B, 3C, 4)

**Phase 2B**: Auth security functions (lockout, events) rewired to `@abe-stack/auth`. Route maps kept local due to `AppContext` vs `HandlerContext` incompatibility — local modules serve as adapter layer.

**Phase 3C**: Added `@abe-stack/realtime` as dependency. WebSocket exports remain local due to function signature difference (2-arg local vs 3-arg package with `TokenVerifier` injection) and shared mutable state.

**Phase 4**: Rewired remaining local imports across 19+ source files and 16+ test files:

- `@auth/*` → `@abe-stack/auth` (hashPassword, verifyPassword, security events, lockout)
- `@users/*` → `@abe-stack/users` (getUserById, listUsers)
- `@/infrastructure` → `@abe-stack/infra` (DB types, email, jobs, storage)
- `@monitor/logger` → `@abe-stack/shared` (Logger type — compatible since files only use info/warn/error/debug)
- `@http` → `@abe-stack/infra` (validateCsrfToken)

**Imports kept local**: Router types, auth handlers, server plugins (type incompatibility). Updated test mocks to match new import paths, added vitest aliases for proper mock interception.

**Verification**: Type-check 0 errors, 139 test files, 3,781 tests all passing.

### Monitor Infrastructure Migration to shared/core

Migrated from `apps/server/src/infrastructure/monitor/`:

- **Base logger** (`base-logger.ts`): `createLogger`, `createRequestLogger`, `createJobCorrelationId`, `createJobLogger` — all using generic `BaseLogger` interface matching pino's data-first signature
- **Health checks** (`health.ts`): 9 functions accepting narrow dependency interfaces (`HealthCheckDatabase`, `HealthCheckPubSub`, `WebSocketStats`, etc.) — `DetailedHealthResponse.services` as `Record<string, ServiceHealth>` for extensibility
- 51 new tests (23 base-logger, 28 health). Fastify-specific `registerLoggingMiddleware` NOT migrated (inherently framework-specific).

### Media Infrastructure Migration (Phase 2)

Migrated remaining media infrastructure to `infra/media`:

| Category     | Contents                                                                                                                           |
| ------------ | ---------------------------------------------------------------------------------------------------------------------------------- |
| Processors   | `VideoProcessor` (FFmpeg), `AudioProcessor` (FFmpeg + music-metadata), `ImageProcessor` (Sharp)                                    |
| Job Queue    | `CustomJobQueue<T>` (in-memory priority with concurrency), `MediaProcessingQueue`, `MediaProcessingRetryHandler` (circuit breaker) |
| Streaming    | `StreamingMediaProcessor` — memory-aware chunked processing with configurable threshold                                            |
| Orchestrator | Routes by format, timeout protection, integrates package's `BasicSecurityScanner`                                                  |
| Database     | `MediaDatabaseAdapter` interface + `InMemoryMediaDatabase` reference implementation                                                |
| Facade       | `ServerMediaQueue` + `createServerMediaQueue` factory                                                                              |

All native module imports (sharp, fluent-ffmpeg, music-metadata) use lazy `import()` for tree-shaking. 287 tests across 16 files.

### Dead Code Cleanup

Removed old server files migrated to packages. Conditions: equivalent code in package, zero imports remain, barrel re-exports from package.

| Metric                | Before | After | Delta |
| --------------------- | ------ | ----- | ----- |
| Non-test source files | ~229   | ~160  | -69   |
| Test files            | 139    | 117   | -22   |
| Tests                 | 3,781  | 3,156 | -625  |

Deleted: `infrastructure/security/` (~20 files), `infrastructure/messaging/email/` (~14), `infrastructure/jobs/` (~26), `infrastructure/utils/` (3), auth/users module duplicates (5 files + tests).

---

## Saturday, January 31, 2026

### BaseContext Contract (Phases 0-3)

Defined shared `BaseContext` in `infra/contracts` eliminating 5+ duplicate Logger, RequestInfo, and context interface definitions.

**Contract types** (`infra/contracts/src/context.ts`):

- `BaseContext`: Minimal context (`db: unknown`, `repos: unknown`, `log: Logger`)
- `AuthenticatedUser`, `RequestInfo`, `RequestContext`, `ReplyContext`

**Logger interface expanded** with Pino-compatible overloads: `(data: Record<string, unknown>, msg: string)` for `info`, `warn`, `error`, `debug`. `trace`, `fatal`, `child` remain optional.

**Package consolidation** — replaced duplicate definitions:

| Package                    | Duplicates Removed                                | Context Pattern                                     |
| -------------------------- | ------------------------------------------------- | --------------------------------------------------- |
| `@abe-stack/auth`          | `RequestInfo`, `ReplyWithCookies`                 | `AppContext extends BaseContext`                    |
| `@abe-stack/users`         | `UsersLogger`, `UsersRequestInfo`, `UsersRequest` | `UsersModuleDeps extends Omit<BaseContext, 'db'>`   |
| `@abe-stack/billing`       | `BillingLogger`, `BillingRequest`                 | `BillingAppContext extends BaseContext`             |
| `@abe-stack/realtime`      | `RealtimeLogger`, `RealtimeRequest`               | `RealtimeModuleDeps extends Omit<BaseContext, ...>` |
| `@abe-stack/notifications` | `NotificationLogger`, `NotificationRequest`       | `NotificationModuleDeps extends BaseContext`        |

**Key decisions:**

- `BaseContext.db/repos` use `unknown` to avoid circular dependency (contracts → db → core → contracts). Module contexts narrow via `extends` + explicit re-declaration.
- Server uses compile-time assertion pattern instead of `extends` (TypeScript requires identical property types):
  ```typescript
  type VerifyBaseContext<T extends BaseContext> = T;
  export type AppContextSatisfiesBaseContext = VerifyBaseContext<AppContext>;
  ```
- Transition aliases (`ReplyWithCookies = ReplyContext`) for backward compatibility — no big-bang migration required.
- Strangler fig pattern: `AppContext` and `BaseContext` coexist; unmigrated handlers use `AppContext`, migrated use module-specific contexts.

**Verification**: All packages 0 type errors. Server: 3,156 tests passing (117 files).

### Server Migration Completion

- Wired `AuthEmailTemplates` from `@abe-stack/auth` into `IServiceContainer`
- Switched route imports (`authRoutes`, `notificationRoutes`, `realtimeRoutes`) to `@abe-stack/*` packages directly
- Deleted 49 duplicate source files (auth: 38, realtime: 5, notifications: 4, users: 2)
- Added subpath regex aliases to vitest config for correct `vi.mock()` resolution
- Fixed RateLimiter mock for Vitest 4 constructor requirement (`function` keyword vs arrow function)

### Monorepo-Wide Error Resolution (PR #26)

Fixed all errors after package extraction wave:

| Category             | Fix                                                                                           |
| -------------------- | --------------------------------------------------------------------------------------------- |
| tsconfig rootDir     | `"./"` → `"./src"` in sdk, stores, ui, media, db (was producing `dist/src/`)                  |
| Package.json exports | Added missing `"types"` field to contracts, stores, sdk, media                                |
| Import ordering      | Auto-fixed across server and email packages                                                   |
| Auth email types     | Fixed optional properties for `exactOptionalPropertyTypes` (`html/text: string \| undefined`) |
| SDK vitest config    | Added resolve aliases preventing duplicate module `instanceof` failures (38 tests)            |
| jsdom environment    | Added `@vitest-environment jsdom` to WebSocket tests needing browser APIs (23 tests)          |

**Result**: 17 packages lint pass, 38 type-check tasks pass, 7,500 tests pass.

### Package Architecture & Module Migration (PR #27)

**Package architecture boundary spec** (`docs/dev/packages.md`):

- Server vs package responsibility (Capability vs Composition)
- 4-tier architecture: Kernel, Infrastructure, Modules, Applications
- Import direction golden rule and litmus tests for file placement
- Current codebase audit: 0 import violations, ~116 server files (target 10-15)

**Module migration** — created `modules/admin` with full admin functionality:

- `AdminAppContext`, `adminProtectedRoute` helper
- All admin handlers/services/routes (user management, billing plans, security audit, job monitoring)
- Deleted duplicate billing, users, and admin modules from server

**shared/ cleanup**: Removed dead auth types (`TokenPayload`, `AuthResult`, `OAuthUserInfo`, etc.), user types (`User`, `UserRole`, `UserWithPassword`), `shared/constants.ts`, `shared/errorMapper.ts` — all consumers were deleted modules. Slimmed barrel to 5 exports.

**infrastructure/ cleanup**: Deleted `infrastructure/media/` (29 files, 7,600+ lines — completely unused). Removed ALL package re-exports from `infrastructure/index.ts`. Updated `app.ts` to import from packages directly.

- **Net**: -17,380 lines (modules) + -9,615 lines (infrastructure) = **-26,995 lines**
- Restored 11 admin test files (218 tests)
- Server: ~116 → ~76 non-test source files

### Test Migration: Server to Packages (PR #28)

Migrated 30 auth test files (946 tests) and 5 notification test files (172 tests) from server to packages. Deleted 19 duplicate test files. Updated vitest configs to use `mergeConfig(baseConfig)` pattern.

### Monorepo Directory Restructure

Replaced flat `packages/` with semantically meaningful layout:

| Old Location                                                                                               | New Location | Rationale                                      |
| ---------------------------------------------------------------------------------------------------------- | ------------ | ---------------------------------------------- |
| `packages/{cache,contracts,db,email,http,jobs,media,notifications,realtime,security,storage,stores,users}` | `infra/*`    | Infrastructure adapters (hexagonal outer ring) |
| `packages/{admin,auth,billing}`                                                                            | `modules/*`  | Business domain modules                        |
| `packages/{core,ui}`                                                                                       | `shared/*`   | Shared libraries (hexagonal inner ring)        |
| `client`                                                                                                   | `sdk/`       | Standalone SDK                                 |

1,050+ files changed across workspace config, tsconfig, turbo, CI workflows, scripts, and source. Package names unchanged (`@abe-stack/*`).

### SDK Rename: `@abe-stack/sdk` → `@abe-stack/engine`

282+ files changed. Renamed directory and package for clarity (`client/` describes the API client layer better than `sdk/`):

| Category             | Files | Changes                                  |
| -------------------- | ----- | ---------------------------------------- |
| Package configs      | 2     | Name, description, repository directory  |
| Workspace/TypeScript | 5     | References, path aliases                 |
| Vite/Vitest          | 4     | Resolve aliases including regex patterns |
| Dependencies         | 2     | `@abe-stack/sdk` → `@abe-stack/engine`   |
| ESLint/CI/Docker     | 3     | File globs, cache paths, build filters   |
| Source code          | ~150  | All import statements                    |
| Test mocks           | ~30   | `vi.mock()` paths                        |
| File headers         | ~90   | Path comments                            |
| Documentation        | 6     | Package name references                  |

Fixed stale pnpm symlink (`@abe-stack/sdk -> ../../../../sdk`) causing old directory recreation.

### Stores Package Relocation

Moved `@abe-stack/stores` from `infra/stores/` to `client/stores/` — package has React peer dependency, better fit alongside SDK layer. 26 files updated. Added `'sdk/*'` to `pnpm-workspace.yaml` for nested package discovery.

### Server `src/` Directory Flattening

Flattened from 4-level to 2-level nesting:

| Before                           | After                       |
| -------------------------------- | --------------------------- |
| `infra/monitor/health/health.ts` | `health/health.ts`          |
| `infra/monitor/logger/logger.ts` | `logger/logger.ts`          |
| `modules/routes.ts`              | `routes/routes.ts`          |
| `modules/system/handlers.ts`     | `routes/system.handlers.ts` |
| `shared/types.ts`                | `types/context.ts`          |

Deleted dead `infra/search/` (5 files duplicated in `@abe-stack/infra`). Removed 6 stale tsconfig aliases, added 3 new (`@health`, `@logger`, `@routes`). 8 barrel files → 3.

### Monorepo-wide Error Fix Pass

Fixed all remaining errors after directory restructure:

| Package   | Tests     | Status          |
| --------- | --------- | --------------- |
| core      | 1,485     | All passing     |
| client    | 1,135     | All passing     |
| stores    | 57        | All passing     |
| server    | 368       | All passing     |
| web       | 1,712     | All passing     |
| **Total** | **4,757** | **All passing** |

Key fixes: storage mock config (`localPath` → `rootPath`), router options missing `authGuardFactory`, dynamic import paths for renamed system files, relative-vs-alias `vi.mock()` path mismatches (Vitest intercepts based on resolved module path), query hook race conditions (increased delay, moved assertions inside `waitFor`, added `retry: 0`).

### Config Migration to External Packages

Moved all 12 config loaders from `apps/server/src/config/` to their owning packages:

| Source                             | Target                                       |
| ---------------------------------- | -------------------------------------------- |
| `config/auth/*` (3 files)          | `modules/auth/src/config/` (already existed) |
| `config/infra/database.ts`         | `infra/src/db/config/` (already existed)     |
| `config/infra/cache.ts`            | `infra/cache/src/config.ts`                  |
| `config/infra/queue.ts`            | `infra/src/jobs/config.ts`                   |
| `config/infra/server.ts`           | `infra/src/http/config.ts`                   |
| `config/infra/storage.ts`          | `infra/src/storage/config.ts`                |
| `config/services/billing.ts`       | `modules/billing/src/config.ts`              |
| `config/services/email.ts`         | `infra/src/email/config.ts`                  |
| `config/services/notifications.ts` | `infra/notifications/src/config.ts`          |
| `config/services/search.ts`        | `infra/src/db/config/search.ts`              |

**Dead config removed**: `PackageManagerConfig` — populated but never consumed. Deleted types, schema, and tests across 6 files.

**Final server config structure**:

```
apps/server/src/config/
├── factory.ts      ← orchestrator (imports from packages, wires loaders together)
├── factory.test.ts
├── index.ts        ← barrel (re-exports from packages)
└── README.md
```

**Architectural justification**: Config loaders belong in their owning packages per hexagonal architecture. The server's `config/` directory is now a thin composition root — wires package-provided loaders but contains zero domain-specific config logic.

### DB Scripts Migration to `tools/scripts/db/`

Moved `bootstrap-admin`, `seed`, `db-push` from server to `tools/scripts/db/`. Decoupled from `@/config` — uses `DEFAULT_ARGON2_CONFIG` from `@abe-stack/auth` directly. Inlined `UserRole` type to avoid pulling `@abe-stack/shared` for a single union type. 94 tests passing.

### P1 Cache Service Migration

Replaced server-local sync `CacheService` (133 LOC simple TTL Map) with `@abe-stack/cache` `MemoryCacheProvider`:

- **Sync → Async**: `CacheProvider` interface is fully Promise-based, enabling future swap to Redis without contract change
- **O(1) LRU vs O(n) Map**: Doubly-linked list LRU with O(1) get/set/evict, replacing O(n) cleanup sweeps
- **Updated `app.ts`**: `createCacheService({ ttl, maxSize })` → `createMemoryCache({ defaultTtl, maxSize })`, `stop()` now async
- **Updated `shared/types.ts`**: `IServiceContainer.cache` type from `import('@abe-stack/cache').CacheProvider`
- **Deleted**: `services/cache-service.ts`, `services/cache-service.test.ts` (tests exist in `infra/cache/`)
- **Pre-existing fix**: 8 broken `tsconfig.json` references from directory restructure (stale `../core` → `../../shared/core`)

### Feature Flags and Deployment Profiles

Added `FeatureFlags` type (`admin`, `realtime` booleans) with env schema (`ENABLE_ADMIN`, `ENABLE_REALTIME`, default `false`). Routes conditionally registered — disabling fully removes runtime wiring.

Four profiles defined in `docs/profiles.md`:

- **Minimal**: core + auth + DB + basic UI (default, ~200MB RAM)
- **SaaS**: + billing/subscriptions + customer portal
- **Admin**: + command center, security viewer, job monitor
- **Advanced**: + realtime/offline sync, push notifications, search, desktop

### Migration Phases P0-P7 Completion

| Phase | Description                              | Status    |
| ----- | ---------------------------------------- | --------- |
| P0    | Orphaned test cleanup                    | Completed |
| P1    | Cache → `@abe-stack/cache`               | Completed |
| P2    | HTTP middleware → `@abe-stack/infra`     | Completed |
| P3    | Pagination → `@abe-stack/infra`          | Completed |
| P4    | Router types → `@abe-stack/infra`        | Completed |
| P5    | Request utils → `@abe-stack/infra`       | Completed |
| P6    | Type unification (capability interfaces) | Completed |
| P7    | Server import cleanup                    | Completed |

**Capability interfaces** added to `infra/contracts/src/context.ts`: `HasEmail`, `HasStorage`, `HasBilling`, `HasNotifications`, `HasPubSub`, `HasCache`. Packages compose context from `BaseContext & HasEmail & HasCookies` etc., eliminating 6+ independent `AppContext` variants.

**Re-export cleanup**: Stripped `config/index.ts` to local factory only, removed re-exported core functions from `logger/`, deleted `logger/types.ts`. All consumers import directly from packages.

### 2FA/TOTP Implementation

Added TOTP-based 2FA with recovery codes:

- **totp.ts** (335 LOC): 20-byte base32 secrets via `otpauth`, standard `otpauth://totp/` QR URI, 1-step window verification with replay protection, 8 random 10-char alphanumeric recovery codes (bcrypt-hashed)
- **handlers/totp.ts** (118 LOC): setup, verify, disable, recovery code regeneration
- 4 new routes: `POST auth/totp/{setup,verify,disable,recovery-codes}`
- DB tables: `totp_secrets`, `recovery_codes`

### Email Change Flow

Added email change with verification:

- **email-change.ts** (221 LOC): request change (validates uniqueness), verify token (updates email, invalidates sessions), cancel
- 3 new routes: `POST auth/email/{change,verify,cancel}`
- Rate limited (one pending per user), 24-hour token expiry, session invalidation on verify

### UI Accessibility: ErrorBoundary, Toast Tones, Focus Management

**Error Boundary + Toast (Task 1):**

- `ErrorBoundary.tsx`: React class component with default fallback, render function fallback, `onError` callback, reset/retry
- Toast: `data-tone` attribute (reuses Alert CSS variables), dismiss button with `aria-label`, `role="status"`, `aria-live="polite"`

**Focus Management (Task 2):**

- `useFocusReturn.ts`: Focus restoration without full FocusTrap (dropdowns, popovers)
- `LiveRegion.tsx`: `aria-live` regions (polite + assertive) with `useAnnounce` hook
- `SkipLink.tsx`: "Skip to main content" link, visually hidden until keyboard focus
- `useRouteFocusAnnounce.ts`: Announces route changes to screen readers via LiveRegion

**Integration in `App.tsx`**: Wrapped with ErrorBoundary, LiveRegion, SkipLink, RouteFocusAnnouncer, `id="main-content"`. 42 tests passing across 6 test files.

### UI Component Standardization

Established pattern: arrow function + `forwardRef` + named function expression (for React DevTools) + explicit props interface + JSDoc. Converted Box, CloseButton, Container, LoadingContainer. Renamed FormField `helperText` → `description`.

### Auth Integration Tests

Created `auth.integration.test.ts` (767 LOC) using Fastify `inject()` for in-process HTTP testing without network overhead:

| Suite              | Coverage                                                           |
| ------------------ | ------------------------------------------------------------------ |
| Registration       | Success, duplicate email, weak password, missing fields            |
| Login              | Success, invalid credentials, unverified email, locked account     |
| Token refresh      | Valid refresh, expired token, revoked token, token reuse detection |
| Logout             | Single session, all sessions                                       |
| Password reset     | Request, verify token, expired token                               |
| Email verification | Verify, resend, already verified                                   |
| Magic link         | Request, verify, expired token                                     |
| OAuth              | Initiate flow, callback handling                                   |
| TOTP 2FA           | Setup, verify, disable (if enabled)                                |
| Email change       | Request, verify, cancel                                            |

Uses mocked database repositories and external services. Each suite uses `beforeEach` to reset mocks and create fresh Fastify instances.

### Comprehensive Code Refactoring Plan

Created thorough code refactoring roadmap in `TODO.md`:

- Architectural principles (Golden Rule, Motherboard model, Litmus Tests)
- File-by-file classification of all ~76 server files (KEEP/MIGRATE/SPLIT)
- 5-phase migration plan targeting `@abe-stack/infra` and `@abe-stack/cache`
- Risk assessment with mitigations per phase
- Post-migration server structure (~46 files target)

**Audit findings** (7 findings, 3 new phases added):

| Finding                           | Description                                                                      |
| --------------------------------- | -------------------------------------------------------------------------------- |
| Orphaned test files               | 34 test files from migrated modules (auth: 28, notifications: 3, realtime: 3)    |
| Type system duplication           | `AppContext` redefined in 6+ packages independently                              |
| Router type divergence            | Server uses concrete `AppContext`, `@abe-stack/infra` uses generic `BaseContext` |
| Barrel export coupling            | Server imports from local instead of packages                                    |
| Tier 3 cross-dependencies         | admin→auth+billing, users→auth                                                   |
| Cache service API incompatibility | Server vs package implementations differ                                         |
| Search provider encapsulation gap | Factory pattern depends on local infrastructure                                  |

### UI Hooks Test File Audit

Enforced 1-to-1 `.ts`/`.tsx` extension matching between hook source files and test files in `shared/ui/src/hooks/`. Converted 15 test files from `.tsx` to `.ts` by replacing JSX with `React.createElement` calls. 3 files were rename-only (no JSX), remaining 12 had JSX harness components refactored.

### TODO Consolidation

Merged 1,023-line code refactoring plan from `product-architecture.md` into `TODO.md` as single source of truth. Resolved merge conflicts. Removed `.clocignore`.

### Documentation Log Consolidation

Fixed date labels in W04 (corrected Thu 01-22→01-23, Fri 01-23→01-24, Sat 01-24→01-25). Removed overlapping Monday 01-26 from W04. Merged duplicate Friday Jan 30 sections. Added summary blockquote and ToC to W05. Converted 12 list-heavy sections to markdown tables.

### Documentation Created

| Document              | Content                                                                                                                                        |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| Quickstart guides (4) | Per-app setup: monorepo, web, server, desktop — self-contained with prerequisites, commands, key concepts, troubleshooting                     |
| Operations manual     | Migrations, backups, restore drills (quarterly protocol), incident response (S1-S4), troubleshooting playbooks, routine maintenance checklists |
| Profile quickstarts   | Env configs for Minimal, SaaS, Admin, Advanced with RAM estimates and docker-compose overrides                                                 |
| Production Postgres   | Connection pooling (PgBouncer transaction mode), SSL for managed databases, `pg_stat_statements`, recommended `postgresql.conf`                |
| Package architecture  | Boundary spec, 4-tier architecture (Kernel/Infrastructure/Modules/Applications), import direction litmus tests, current audit (0 violations)   |

### Security Decision Documentation (`docs/dev/security.md`)

Comprehensive rationale for 16 security subsystems:

| Subsystem            | Key Decisions                                                                                                                    |
| -------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| Argon2id parameters  | 19 MiB memory, 2 iterations, parallelism=1; lighter config for non-password tokens; dummy hash pool for timing-safe verification |
| JWT access tokens    | HS256 over RS256, 15m expiry, 32-char min secret, memory-only, algorithm validation against "none" attack                        |
| Refresh tokens       | 512-bit, 7-day expiry, full rotation per use, family tracking for reuse detection                                                |
| Grace period (30s)   | Network retry tolerance, attack window trade-off, 99th percentile retry analysis                                                 |
| Account lockout      | 10 attempts/30 min, exponential backoff formula, why delays AND lockout together                                                 |
| Rate limiting        | Per-endpoint limits (login 5/min, register 3/hr, etc.), token bucket choice                                                      |
| CSRF                 | Double-submit cookie, AES-256-GCM in production, why logout NOT exempt                                                           |
| Security headers     | X-Frame-Options DENY, HSTS 1yr, CSP opt-in rationale, prototype pollution protection                                             |
| Input sanitization   | Defense-in-depth, depth/array/string limits, SQL/NoSQL injection as secondary defense                                            |
| Cookie security      | httpOnly always, sameSite strict/lax by env, why manual implementation                                                           |
| User enumeration     | Registration silent fail, dummy hash verification, generic error messages                                                        |
| Password scoring     | Entropy-based over composition (NIST SP 800-63B), crack time assumptions                                                         |
| JWT secret rotation  | Dual-secret strategy, why only signature errors trigger fallback                                                                 |
| Audit logging        | Event types/severities, forensic data in TokenReuseError                                                                         |
| File upload security | MIME whitelist, embedded script detection, entropy analysis                                                                      |
| Config validation    | Startup-time secret length enforcement, weak secret detection                                                                    |

All decisions cite OWASP Password Storage/Session Management/CSRF cheat sheets, NIST SP 800-63B and 800-107, RFC 6585.

### Deploy Documentation Path Fixes

Fixed 66+ broken file path references across 10 documentation files in `docs/deploy/`. Every guide referenced `config/` directory structure that does not exist — actual paths use `infra/`.

| Old (broken)                            | New (correct)                                     |
| --------------------------------------- | ------------------------------------------------- |
| `config/docker/docker-compose.prod.yml` | `infra/docker/production/docker-compose.prod.yml` |
| `config/docker/docker-compose.dev.yml`  | `infra/docker/development/docker-compose.dev.yml` |
| `config/docker/Dockerfile`              | `infra/docker/Dockerfile`                         |
| `config/caddy/Caddyfile`                | `infra/runtime/caddy/Caddyfile`                   |
| `.env.example`                          | `config/env/.env.production.example`              |

Also fixed nonexistent scripts (`pnpm deploy` → `pnpm docker:prod`, `pnpm deploy:dev` → `pnpm docker:dev`).

### Kernel Purity Verification (Phase 6)

Verified `@abe-stack/shared` contains only domain-agnostic primitives and contracts:

- `kernel/src/contracts/*` — only interfaces and Zod schemas
- `kernel/src/infrastructure/monitor/*` — generic health check logic with dependency injection
- `kernel/src/modules/auth/http-mapper.ts` — infrastructure-level HTTP error mapping (kept by design)
- `kernel/src/contracts/billing/service.ts` — provider-agnostic `BillingService` interface

**Outcome**: Kernel purity confirmed. No domain-specific business logic found.

### Kernel Hygiene & Cleanup Contracts (Phase 8)

New contract files in `infra/contracts`:

| File              | Key Types/Functions                                                                                                                                                                         |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `workspace.ts`    | `WorkspaceContext`, `MaybeWorkspaceContext`, `assertWorkspaceScope()`, `createWorkspaceContext()`, `isWorkspaceScoped()`                                                                    |
| `entitlements.ts` | `SubscriptionState` (5 states), `FeatureEntitlement` with limits, `resolveEntitlements()`, `assertEntitled()`, `assertWithinLimit()`, `isEntitled()`, `hasActiveSubscription()`             |
| `audit.ts`        | `AUDIT_CATEGORIES` (resource/access/config/billing/integration/admin), `AUDIT_ACTIONS` (CRUD + share/archive/invite), `AuditService` interface, `auditEntrySchema`                          |
| `deletion.ts`     | `DeletionState` (4 states), `SoftDeletable` mixin, `DeletionRequest`/`DeletionJob`, `DeletionService` interface, `calculateHardDeleteDate()`, `isWithinGracePeriod()`, 30-day default grace |

### Server Cleanup

**Dead notification code removal**: Deleted 4 duplicate provider files from `infrastructure/notifications/` (exact copies of `@abe-stack/notifications`). Updated `app.ts` to import `createNotificationProviderService` directly from package. Fixed factory name inconsistency (`createNotificationService` → `createNotificationProviderService`).

**Infrastructure rename**: `infrastructure/` → `infra/` for consistency with root-level convention. 22 files updated (16 headers, 5 source imports, 1 config). Shorter path: `@/infra/index` vs `@/infrastructure/index`.

**Server module placement audit**:

| File                             | Decision          | Reason                                                            |
| -------------------------------- | ----------------- | ----------------------------------------------------------------- |
| `modules/system/*`               | Stay              | Deployment-specific health/introspection (Fastify-coupled)        |
| `modules/index.ts` + `routes.ts` | Stay              | Routing composition root (Tier 4 wiring)                          |
| `utils/request-utils.ts`         | Delete (future)   | Dead code — zero imports, superseded by `@abe-stack/infra` router |
| `shared/types.ts`                | Stay in `shared/` | Distinct from `types/` (.d.ts ambient vs importable interfaces)   |

---

### Weekly Summary: Metrics

| Metric                    | Start of Week | End of Week                  |
| ------------------------- | ------------- | ---------------------------- |
| Server source files       | ~116          | ~30                          |
| Total packages            | ~15           | 20+                          |
| Lines removed from server | —             | ~26,000+                     |
| Import violations         | 0             | 0                            |
| Tests (monorepo total)    | ~4,500        | ~7,500+                      |
| Business logic in server  | Some          | Zero                         |
| Re-exports in server      | 50+           | 0                            |
| AppContext variants       | 6+            | 1 base + compose             |
| Feature flags             | 0             | 3 (admin, realtime, billing) |
