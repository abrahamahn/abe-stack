name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: preview-pr-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: node_modules/.cache/turbo
          key: ${{ runner.os }}-turbo-preview-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-preview-
            ${{ runner.os }}-turbo-

      - name: Build
        run: pnpm build

      - name: Generate preview URL
        id: preview
        env:
          PR_NUMBER: ${{ github.event.number }}
        run: |
          PREVIEW_URL="pr-${PR_NUMBER}.preview.abe-stack.dev"
          echo "url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
          # Placeholder: actual preview deployment depends on infrastructure
          # For production use, this step would:
          # 1. Build Docker images tagged with the PR number
          # 2. Deploy to an isolated preview environment
          # 3. Configure DNS/routing for the preview URL

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.preview.outputs.url }}';
            const body = [
              '### Preview Deployment',
              '',
              `**URL:** https://${previewUrl}`,
              `**Commit:** \`${context.sha.slice(0, 8)}\``,
              `**Updated:** ${new Date().toISOString()}`,
              '',
              '> This preview will be automatically cleaned up when the PR is closed or merged.'
            ].join('\n');

            // Check for existing preview comment to update instead of creating duplicates
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(
              (c) => c.body && c.body.includes('### Preview Deployment')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body,
              });
            }

      - name: Preview Summary
        env:
          PR_NUMBER: ${{ github.event.number }}
          PREVIEW_URL: ${{ steps.preview.outputs.url }}
        run: |
          echo "## PR Preview Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**PR:** #${PR_NUMBER}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Preview URL:** https://${PREVIEW_URL}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Commit:** \`${GITHUB_SHA}\`" >> "$GITHUB_STEP_SUMMARY"

  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup preview environment
        env:
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "Cleaning up preview environment for PR #${PR_NUMBER}"
          echo "Preview URL: pr-${PR_NUMBER}.preview.abe-stack.dev"
          # Placeholder: actual cleanup depends on infrastructure
          # For production use, this step would:
          # 1. Remove the preview Docker containers/services
          # 2. Clean up DNS/routing entries
          # 3. Remove any preview-specific resources (databases, storage)

      - name: Cleanup Summary
        env:
          PR_NUMBER: ${{ github.event.number }}
        run: |
          echo "## Preview Cleanup" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**PR:** #${PR_NUMBER}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Action:** Preview environment removed" >> "$GITHUB_STEP_SUMMARY"
          echo "**Cleaned up at:** $(date -Iseconds)" >> "$GITHUB_STEP_SUMMARY"
