name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: preview-pr-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Cache Turbo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: node_modules/.cache/turbo
          key: ${{ runner.os }}-turbo-preview-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-preview-
            ${{ runner.os }}-turbo-

      - name: Build
        run: pnpm build

      - name: Resolve image variables
        id: image-vars
        run: |
          REGISTRY="${{ vars.REGISTRY || secrets.REGISTRY || 'ghcr.io' }}"
          IMAGE_NAME_RAW="${{ vars.IMAGE_NAME || github.event.repository.name }}"
          if [[ "$IMAGE_NAME_RAW" != */* ]]; then
            IMAGE_NAME="${{ github.repository_owner }}/$IMAGE_NAME_RAW"
          else
            IMAGE_NAME="$IMAGE_NAME_RAW"
          fi
          echo "registry=$REGISTRY" >> "$GITHUB_OUTPUT"
          echo "image_name=$IMAGE_NAME" >> "$GITHUB_OUTPUT"

      - name: Build preview Docker images (no push)
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25
        with:
          context: .
          file: ./infra/docker/Dockerfile
          push: false
          tags: ${{ steps.image-vars.outputs.registry }}/${{ steps.image-vars.outputs.image_name }}:pr-${{ github.event.number }}-${{ github.sha }}-api

      - name: Build preview web Docker image (no push)
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25
        with:
          context: .
          file: ./infra/docker/Dockerfile.web
          push: false
          tags: ${{ steps.image-vars.outputs.registry }}/${{ steps.image-vars.outputs.image_name }}:pr-${{ github.event.number }}-${{ github.sha }}-web
          build-args: |
            VITE_API_URL=

      - name: Comment preview status on PR
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const body = [
              '### Preview Deployment',
              '',
              '**Status:** Preview build validated (no live preview environment configured).',
              `**Commit:** \`${context.sha.slice(0, 8)}\``,
              `**Updated:** ${new Date().toISOString()}`,
            ].join('\n');

            // Check for existing preview comment to update instead of creating duplicates
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(
              (c) => c.body && c.body.includes('### Preview Deployment')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body,
              });
            }

      - name: Preview Summary
        run: |
          echo "## PR Preview Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**PR:** #${{ github.event.number }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Status:** Preview build validated (no live preview environment configured)." >> "$GITHUB_STEP_SUMMARY"
          echo "**Commit:** \`${GITHUB_SHA}\`" >> "$GITHUB_STEP_SUMMARY"

  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup preview environment
        run: |
          echo "PR #${{ github.event.number }} closed; no persistent preview environment to clean up."

      - name: Cleanup Summary
        run: |
          echo "## Preview Cleanup" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**PR:** #${{ github.event.number }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Action:** Preview environment removed" >> "$GITHUB_STEP_SUMMARY"
          echo "**Cleaned up at:** $(date -Iseconds)" >> "$GITHUB_STEP_SUMMARY"
