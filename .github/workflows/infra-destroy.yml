name: Infrastructure Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      provider:
        description: 'Cloud provider'
        required: true
        default: 'digitalocean'
        type: choice
        options:
          - digitalocean
          - gcp
      confirm_destroy:
        description: 'Type "DESTROY" to confirm infrastructure destruction'
        required: true
        type: string

permissions:
  contents: read
  id-token: write # Required for GCP Workload Identity

jobs:
  destroy-infrastructure:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID || '' }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY || '' }}

    steps:
      - name: Validate Destruction Confirmation
        if: inputs.confirm_destroy != 'DESTROY'
        run: |
          echo "âŒ Destruction not confirmed. Please type 'DESTROY' to confirm."
          exit 1

      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: '~1.0'

      # Configure cloud provider credentials
      - name: Configure DigitalOcean Credentials
        if: inputs.provider == 'digitalocean'
        env:
          DO_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: |
          echo "DIGITALOCEAN_TOKEN=$DO_TOKEN" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud
        if: inputs.provider == 'gcp'
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        if: inputs.provider == 'gcp'
        uses: google-github-actions/setup-gcloud@e427ad8a34f8676edf47cf7d7925499adf3eb74f

      - name: Configure AWS Credentials (for state backend)
        if: env.AWS_ACCESS_KEY_ID != '' && env.AWS_SECRET_ACCESS_KEY != ''
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      # Download terraform state if available
      - name: Download Terraform State
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: terraform-state-${{ inputs.environment }}-${{ inputs.provider }}
          path: infra/cloud/${{ inputs.provider }}/
        continue-on-error: true

      - name: Create Terraform Variables File
        env:
          ENVIRONMENT: ${{ inputs.environment || 'staging' }}
          PROVIDER: ${{ inputs.provider }}
          DOMAIN: ${{ secrets.DOMAIN }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
          DO_REGION: ${{ vars.DO_REGION || 'nyc1' }}
          DO_INSTANCE_SIZE: ${{ vars.DO_INSTANCE_SIZE || 's-1vcpu-1gb' }}
          DO_ENABLE_MANAGED_DB: ${{ vars.DO_ENABLE_MANAGED_DB || 'false' }}
          DO_DATABASE_SIZE: ${{ vars.DO_DATABASE_SIZE || 'db-s-1vcpu-1gb' }}
          GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          GCP_REGION: ${{ vars.GCP_REGION || 'us-central1' }}
          GCP_ZONE: ${{ vars.GCP_ZONE || 'us-central1-a' }}
          GCP_INSTANCE_SIZE: ${{ vars.GCP_INSTANCE_SIZE || 'e2-small' }}
          GCP_ENABLE_MANAGED_DB: ${{ vars.GCP_ENABLE_MANAGED_DB || 'false' }}
          GCP_DATABASE_SIZE: ${{ vars.GCP_DATABASE_SIZE || 'db-f1-micro' }}
          GCP_DB_USERNAME: ${{ secrets.GCP_DB_USERNAME || 'abe_user' }}
          GCP_DB_PASSWORD: ${{ secrets.GCP_DB_PASSWORD }}
        run: |
          cd infra/cloud
          cat > terraform.tfvars << EOF
          # Environment Configuration
          environment = "$ENVIRONMENT"

          # Domain Configuration
          domain = "$DOMAIN"

          # SSH Configuration
          ssh_public_key = "$SSH_PUBLIC_KEY"

          # Provider-specific configuration
          EOF

          if [ "$PROVIDER" = "digitalocean" ]; then
            cat >> terraform.tfvars << EOF
          region = "$DO_REGION"
          instance_size = "$DO_INSTANCE_SIZE"
          enable_managed_database = $DO_ENABLE_MANAGED_DB
          database_size = "$DO_DATABASE_SIZE"
          EOF
          elif [ "$PROVIDER" = "gcp" ]; then
            cat >> terraform.tfvars << EOF
          project_id = "$GCP_PROJECT_ID"
          region = "$GCP_REGION"
          zone = "$GCP_ZONE"
          instance_size = "$GCP_INSTANCE_SIZE"
          enable_managed_database = $GCP_ENABLE_MANAGED_DB
          database_size = "$GCP_DATABASE_SIZE"
          database_username = "$GCP_DB_USERNAME"
          database_password = "$GCP_DB_PASSWORD"
          EOF
          fi

      - name: Terraform Init
        env:
          PROVIDER: ${{ inputs.provider }}
        run: |
          cd "infra/cloud/$PROVIDER"
          terraform init

      - name: Terraform Plan Destroy
        env:
          PROVIDER: ${{ inputs.provider }}
        run: |
          cd "infra/cloud/$PROVIDER"
          terraform plan -destroy -var-file=../terraform.tfvars -out=tfplan-destroy

      - name: Terraform Destroy
        env:
          PROVIDER: ${{ inputs.provider }}
        run: |
          cd "infra/cloud/$PROVIDER"
          terraform apply -auto-approve tfplan-destroy

      - name: Clean up Deployment Artifacts
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          PROVIDER: ${{ inputs.provider }}
        run: |
          # Remove deployment info file if it exists
          rm -f ".deploy/${ENVIRONMENT}-${PROVIDER}.json"

          # Clean up terraform state artifacts
          rm -rf "infra/cloud/${PROVIDER}/.terraform/"

      - name: Infrastructure Destruction Summary
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          PROVIDER: ${{ inputs.provider }}
        run: |
          echo "## ðŸ—‘ï¸ Infrastructure Destroyed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "**Provider:** $PROVIDER" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Important:** Make sure to:" >> $GITHUB_STEP_SUMMARY
          echo "- Delete any DNS records pointing to the destroyed infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- Update your CI/CD secrets to remove references to destroyed resources" >> $GITHUB_STEP_SUMMARY
          echo "- Clean up any remaining cloud resources (backups, snapshots, etc.)" >> $GITHUB_STEP_SUMMARY
