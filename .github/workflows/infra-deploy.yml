name: Infrastructure Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      provider:
        description: 'Cloud provider'
        required: true
        default: 'digitalocean'
        type: choice
        options:
          - digitalocean
          - gcp
      action:
        description: 'Terraform action'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - plan
      auto_approve:
        description: 'Auto-approve terraform apply (only applies to apply action)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write # Required for GCP Workload Identity

jobs:
  validate:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '~1.0'

      - name: Configure AWS Credentials (for state backend)
        if: env.AWS_ACCESS_KEY_ID
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Terraform Format Check
        run: |
          cd infra/cloud
          terraform fmt -check -recursive

      - name: Terraform Validate
        env:
          PROVIDER: ${{ inputs.provider }}
        run: |
          cd "infra/cloud/$PROVIDER"
          terraform init -backend=false
          terraform validate

  deploy-infrastructure:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '~1.0'

      # Configure cloud provider credentials
      - name: Configure DigitalOcean Credentials
        if: inputs.provider == 'digitalocean'
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        run: |
          echo "DIGITALOCEAN_TOKEN=$DIGITALOCEAN_TOKEN" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud
        if: inputs.provider == 'gcp'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        if: inputs.provider == 'gcp'
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure AWS Credentials (for state backend)
        if: env.AWS_ACCESS_KEY_ID
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      # Create terraform.tfvars file
      - name: Create Terraform Variables File
        env:
          PROVIDER: ${{ inputs.provider }}
          ENVIRONMENT: ${{ inputs.environment || 'staging' }}
          TF_DOMAIN: ${{ secrets.DOMAIN }}
          TF_SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
          DO_REGION: ${{ vars.DO_REGION || 'nyc1' }}
          DO_INSTANCE_SIZE: ${{ vars.DO_INSTANCE_SIZE || 's-1vcpu-1gb' }}
          DO_ENABLE_MANAGED_DB: ${{ vars.DO_ENABLE_MANAGED_DB || 'false' }}
          DO_DATABASE_SIZE: ${{ vars.DO_DATABASE_SIZE || 'db-s-1vcpu-1gb' }}
          GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          GCP_REGION: ${{ vars.GCP_REGION || 'us-central1' }}
          GCP_ZONE: ${{ vars.GCP_ZONE || 'us-central1-a' }}
          GCP_INSTANCE_SIZE: ${{ vars.GCP_INSTANCE_SIZE || 'e2-small' }}
          GCP_ENABLE_MANAGED_DB: ${{ vars.GCP_ENABLE_MANAGED_DB || 'false' }}
          GCP_DATABASE_SIZE: ${{ vars.GCP_DATABASE_SIZE || 'db-f1-micro' }}
          GCP_DB_USERNAME: ${{ secrets.GCP_DB_USERNAME || 'abe_user' }}
          GCP_DB_PASSWORD: ${{ secrets.GCP_DB_PASSWORD }}
        run: |
          cd infra/cloud
          cat > terraform.tfvars << EOF
          # Environment Configuration
          environment = "$ENVIRONMENT"

          # Domain Configuration
          domain = "$TF_DOMAIN"

          # SSH Configuration
          ssh_public_key = "$TF_SSH_PUBLIC_KEY"

          # Provider-specific configuration
          EOF

          # Add provider-specific variables
          if [ "$PROVIDER" = "digitalocean" ]; then
            cat >> terraform.tfvars << EOF
          # DigitalOcean Configuration
          region = "$DO_REGION"
          instance_size = "$DO_INSTANCE_SIZE"
          enable_managed_database = $DO_ENABLE_MANAGED_DB
          database_size = "$DO_DATABASE_SIZE"
          EOF
          elif [ "$PROVIDER" = "gcp" ]; then
            cat >> terraform.tfvars << EOF
          project_id = "$GCP_PROJECT_ID"

          # GCP Configuration
          region = "$GCP_REGION"
          zone = "$GCP_ZONE"
          instance_size = "$GCP_INSTANCE_SIZE"
          enable_managed_database = $GCP_ENABLE_MANAGED_DB
          database_size = "$GCP_DATABASE_SIZE"
          database_username = "$GCP_DB_USERNAME"
          database_password = "$GCP_DB_PASSWORD"
          EOF
          fi

      - name: Terraform Init
        env:
          PROVIDER: ${{ inputs.provider }}
        run: |
          cd "infra/cloud/$PROVIDER"
          terraform init

      - name: Terraform Plan
        id: plan
        env:
          PROVIDER: ${{ inputs.provider }}
        run: |
          cd "infra/cloud/$PROVIDER"
          terraform plan -out=tfplan -var-file=../terraform.tfvars

          # Save plan output for summary
          terraform show -no-color tfplan > tfplan.txt

      - name: Terraform Plan Summary
        env:
          PROVIDER: ${{ inputs.provider }}
        run: |
          cd "infra/cloud/$PROVIDER"
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat tfplan.txt | head -50 >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "... (truncated)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Terraform Apply
        if: inputs.action == 'apply' && (inputs.auto_approve || github.event.inputs.auto_approve == 'true')
        env:
          PROVIDER: ${{ inputs.provider }}
        run: |
          cd "infra/cloud/$PROVIDER"
          terraform apply -auto-approve tfplan

      - name: Terraform Apply (Manual Approval Required)
        if: inputs.action == 'apply' && !(inputs.auto_approve || github.event.inputs.auto_approve == 'true')
        run: |
          echo "Infrastructure deployment requires manual approval."
          echo "Review the plan above and re-run with auto_approve=true if changes look correct."
          exit 1

      - name: Wait for Infrastructure to be Ready
        if: inputs.action == 'apply' && (inputs.auto_approve || github.event.inputs.auto_approve == 'true')
        run: |
          echo "Waiting for infrastructure to be fully ready..."
          sleep 60 # Give time for startup scripts to complete

      - name: Extract Infrastructure Outputs
        if: inputs.action == 'apply' && (inputs.auto_approve || github.event.inputs.auto_approve == 'true')
        id: outputs
        env:
          PROVIDER: ${{ inputs.provider }}
          ENVIRONMENT: ${{ inputs.environment }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          cd "infra/cloud/$PROVIDER"

          # Extract outputs and create deployment info
          echo "## Infrastructure Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get outputs
          INSTANCE_IP=$(terraform output -raw instance_public_ip 2>/dev/null || echo "N/A")
          SSH_CONNECTION=$(terraform output -raw ssh_connection_string 2>/dev/null || echo "N/A")
          DOMAIN=$(terraform output -raw domain_name 2>/dev/null || echo "N/A")

          echo "**Instance IP:** $INSTANCE_IP" >> $GITHUB_STEP_SUMMARY
          echo "**SSH Connection:** \`$SSH_CONNECTION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Domain:** $DOMAIN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Export for other jobs/workflows
          echo "INSTANCE_IP=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "SSH_CONNECTION=$SSH_CONNECTION" >> $GITHUB_OUTPUT
          echo "DOMAIN=$DOMAIN" >> $GITHUB_OUTPUT

          # Save deployment info to file for other workflows
          mkdir -p ../../../.deploy
          cat > "../../../.deploy/${ENVIRONMENT}-${PROVIDER}.json" << EOF
          {
            "environment": "$ENVIRONMENT",
            "provider": "$PROVIDER",
            "instance_ip": "$INSTANCE_IP",
            "ssh_connection": "$SSH_CONNECTION",
            "domain": "$DOMAIN",
            "deployed_at": "$(date -Iseconds)",
            "commit_sha": "$COMMIT_SHA"
          }
          EOF

      - name: Upload Terraform State (if using local backend)
        if: inputs.action == 'apply' && (inputs.auto_approve || github.event.inputs.auto_approve == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state-${{ inputs.environment }}-${{ inputs.provider }}
          path: |
            infra/cloud/${{ inputs.provider }}/terraform.tfstate
            infra/cloud/${{ inputs.provider }}/terraform.tfstate.backup
            infra/cloud/${{ inputs.provider }}/.terraform.lock.hcl
          retention-days: 30

      - name: Upload Deployment Info
        if: inputs.action == 'apply' && (inputs.auto_approve || github.event.inputs.auto_approve == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info-${{ inputs.environment }}-${{ inputs.provider }}
          path: .deploy/
          retention-days: 30
