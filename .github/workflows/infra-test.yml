name: Infrastructure Test

on:
  push:
    paths:
      - 'infra/**'
  pull_request:
    paths:
      - 'infra/**'
  workflow_dispatch:
    inputs:
      provider:
        description: 'Cloud provider to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - digitalocean
          - gcp

permissions:
  contents: read

jobs:
  test-infrastructure:
    # Optional repo variables:
    # - INFRA_TEST_ENABLED: "true" (default) or "false"
    # - ACTIVE_CLOUD_PROVIDER: "digitalocean" | "gcp" | "all" (default: no filter)
    if: ${{ vars.INFRA_TEST_ENABLED != 'false' && (vars.ACTIVE_CLOUD_PROVIDER == '' || vars.ACTIVE_CLOUD_PROVIDER == 'all' || matrix.provider == vars.ACTIVE_CLOUD_PROVIDER) }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        provider: ${{ fromJSON(inputs.provider == 'all' && '["digitalocean", "gcp"]' || format('["{0}"]', inputs.provider || 'digitalocean')) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '~1.0'

      - name: Check Terraform Formatting
        run: |
          cd infra/cloud
          echo "ðŸ” Checking Terraform formatting..."
          if terraform fmt -check main.tf providers.tf variables.tf outputs.tf && \
             terraform fmt -check -recursive "${{ matrix.provider }}"; then
            echo "âœ… Terraform files are properly formatted"
          else
            echo "âŒ Terraform files need formatting for shared config or provider '${{ matrix.provider }}'."
            exit 1
          fi

      - name: Validate Terraform Configuration
        run: |
          cd infra/cloud/${{ matrix.provider }}
          echo "ðŸ”§ Validating ${{ matrix.provider }} Terraform configuration..."
          terraform init -backend=false
          if terraform validate; then
            echo "âœ… ${{ matrix.provider }} Terraform configuration is valid"
          else
            echo "âŒ ${{ matrix.provider }} Terraform configuration validation failed"
            exit 1
          fi

      - name: Test Infrastructure Scripts
        run: |
          cd infra
          echo "ðŸ§ª Testing infrastructure scripts..."

          # Test the validation script
          if ./test-config.sh; then
            echo "âœ… Infrastructure test script passed"
          else
            echo "âŒ Infrastructure test script failed"
            exit 1
          fi

      - name: Test Provider-Specific Configuration
        run: |
          cd infra/cloud/${{ matrix.provider }}
          echo "ðŸ”§ Testing ${{ matrix.provider }} configuration..."

          # Initialize terraform for this provider
          terraform init -backend=false

          # Test with minimal variables for validation
          cat > test.tfvars << EOF
          environment = "test"
          domain = "test.example.com"
          ssh_public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7vbvJ... test-key"
          app_name = "abe-stack-test"
          app_port = 3000
          EOF

          # Add provider-specific test variables
          if [ "${{ matrix.provider }}" = "digitalocean" ]; then
            cat >> test.tfvars << EOF
            region = "nyc1"
            instance_size = "s-1vcpu-1gb"
            enable_managed_database = false
            EOF
          elif [ "${{ matrix.provider }}" = "gcp" ]; then
            cat >> test.tfvars << EOF
            project_id = "test-project-123456"
            region = "us-central1"
            zone = "us-central1-a"
            instance_size = "e2-small"
            enable_managed_database = false
            EOF
          fi

          # Test terraform plan with test variables
          if terraform plan -var-file=test.tfvars -out=tfplan-test >/dev/null 2>&1; then
            echo "âœ… ${{ matrix.provider }} terraform plan succeeded"
            # Clean up test plan
            rm -f tfplan-test
          else
            echo "âŒ ${{ matrix.provider }} terraform plan failed"
            exit 1
          fi

          # Clean up test files
          rm -f test.tfvars

      - name: Check for Required Documentation
        run: |
          cd infra
          echo "ðŸ“š Checking documentation completeness..."

          # Check for README
          if [ -f "README.md" ]; then
            echo "âœ… Infrastructure README exists"
          else
            echo "âŒ Infrastructure README.md is missing"
            exit 1
          fi

          # Check for example configuration
          if [ -f "cloud/terraform.tfvars.example" ]; then
            echo "âœ… Terraform example configuration exists"
          else
            echo "âŒ cloud/terraform.tfvars.example is missing"
            exit 1
          fi

      - name: Validate Terraform Module Structure
        run: |
          echo "ðŸ—ï¸ Validating module structure..."

          for provider in digitalocean gcp; do
            if [ -d "infra/cloud/$provider" ]; then
              echo "Checking $provider module..."

              # Check for required files
              required_files=("main.tf" "variables.tf" "outputs.tf")
              for file in "${required_files[@]}"; do
                if [ -f "infra/cloud/$provider/$file" ]; then
                  echo "âœ… $provider/$file exists"
                else
                  echo "âŒ $provider/$file is missing"
                  exit 1
                fi
              done
            fi
          done

      - name: Infrastructure Test Summary
        if: success()
        run: |
          echo "## âœ… Infrastructure Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tests completed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform formatting check" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform validation" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration scripts test" >> $GITHUB_STEP_SUMMARY
          echo "- Provider-specific configuration tests" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation completeness check" >> $GITHUB_STEP_SUMMARY
          echo "- Module structure validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ All infrastructure tests passed! Ready for deployment." >> $GITHUB_STEP_SUMMARY

      - name: Infrastructure Test Summary (Failed)
        if: failure()
        run: |
          echo "## âŒ Infrastructure Tests Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed tests above and fix any issues before deploying infrastructure." >> $GITHUB_STEP_SUMMARY
