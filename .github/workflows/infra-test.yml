name: Infrastructure Test
run-name: Infrastructure Test (${{ github.ref_name }})

on:
  push:
    paths:
      - 'infra/**'
  pull_request:
    paths:
      - 'infra/**'
  workflow_dispatch:
    inputs:
      provider:
        description: 'Cloud provider to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - digitalocean
          - gcp

permissions:
  contents: read

jobs:
  test-infrastructure:
    name: Infrastructure Test (${{ matrix.provider }})
    # Optional repo variables:
    # - INFRA_TEST_ENABLED: "true" (default) or "false"
    # - ACTIVE_CLOUD_PROVIDER: "digitalocean" | "gcp" | "all" (default: no filter)
    if: ${{ vars.INFRA_TEST_ENABLED != 'false' }}
    runs-on: ubuntu-latest
    env:
      DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN || '' }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY || '' }}
      DO_REGION: ${{ secrets.DO_REGION || '' }}
      DO_INSTANCE_SIZE: ${{ secrets.DO_INSTANCE_SIZE || '' }}
      DO_ENABLE_MANAGED_DB: ${{ secrets.DO_ENABLE_MANAGED_DB || '' }}
      DO_DATABASE_SIZE: ${{ secrets.DO_DATABASE_SIZE || '' }}
    strategy:
      fail-fast: false
      matrix:
        provider: ${{ fromJSON((github.event_name == 'workflow_dispatch' && inputs.provider == 'digitalocean' && '["digitalocean"]') || (github.event_name == 'workflow_dispatch' && inputs.provider == 'gcp' && '["gcp"]') || (github.event_name == 'workflow_dispatch' && inputs.provider == 'all' && '["digitalocean","gcp"]') || (vars.ACTIVE_CLOUD_PROVIDER == 'digitalocean' && '["digitalocean"]') || (vars.ACTIVE_CLOUD_PROVIDER == 'gcp' && '["gcp"]') || (vars.ACTIVE_CLOUD_PROVIDER == 'all' && '["digitalocean","gcp"]') || '["digitalocean"]') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '~1.0'

      - name: Configure DigitalOcean Credentials
        if: matrix.provider == 'digitalocean' && env.DIGITALOCEAN_TOKEN != ''
        run: |
          echo "DIGITALOCEAN_TOKEN=${DIGITALOCEAN_TOKEN}" >> "$GITHUB_ENV"

      - name: Authenticate to Google Cloud
        if: matrix.provider == 'gcp' && env.GCP_SA_KEY != ''
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Check Terraform Formatting
        run: |
          cd infra/cloud
          echo "ðŸ” Checking Terraform formatting for provider '${{ matrix.provider }}'..."
          if terraform fmt -check -diff -recursive "${{ matrix.provider }}"; then
            echo "âœ… Terraform files are properly formatted for '${{ matrix.provider }}'"
          else
            echo "âŒ Terraform files need formatting in infra/cloud/${{ matrix.provider }}."
            echo "Run: cd infra/cloud && terraform fmt -recursive ${{ matrix.provider }}"
            exit 1
          fi

      - name: Validate Terraform Configuration
        run: |
          cd infra/cloud/${{ matrix.provider }}
          echo "ðŸ”§ Validating ${{ matrix.provider }} Terraform configuration..."
          terraform init -backend=false
          if terraform validate; then
            echo "âœ… ${{ matrix.provider }} Terraform configuration is valid"
          else
            echo "âŒ ${{ matrix.provider }} Terraform configuration validation failed"
            exit 1
          fi

      - name: Test Infrastructure Scripts
        run: |
          cd infra
          echo "ðŸ§ª Testing infrastructure scripts..."

          # Test the validation script
          if ./test-config.sh; then
            echo "âœ… Infrastructure test script passed"
          else
            echo "âš ï¸ Infrastructure test script failed (non-blocking in CI); provider-specific Terraform checks remain authoritative."
          fi

      - name: Test Provider-Specific Configuration
        run: |
          set -euo pipefail
          cd infra/cloud/${{ matrix.provider }}
          echo "ðŸ”§ Testing ${{ matrix.provider }} configuration..."

          if [ "${{ matrix.provider }}" = "digitalocean" ] && [ -z "${DIGITALOCEAN_TOKEN:-}" ]; then
            echo "âš ï¸ Skipping DigitalOcean plan test: DIGITALOCEAN_TOKEN is not available in this context."
            exit 0
          fi

          if [ "${{ matrix.provider }}" = "gcp" ] && [ -z "${GCP_SA_KEY:-}" ]; then
            echo "âš ï¸ Skipping GCP plan test: GCP_SA_KEY is not available in this context."
            exit 0
          fi

          # Initialize terraform for this provider
          terraform init -backend=false

          DO_MANAGED_DB="${DO_ENABLE_MANAGED_DB:-false}"
          case "$DO_MANAGED_DB" in
            true|false) ;;
            *)
              echo "âš ï¸ Invalid DO_ENABLE_MANAGED_DB='$DO_MANAGED_DB'. Falling back to false."
              DO_MANAGED_DB=false
              ;;
          esac

          # Test with minimal variables for validation
          cat > test.tfvars << 'EOF'
          environment = "production"
          domain = "example.com"
          ssh_public_key = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBXn3QpXrUNQqXWnB6I6Q8r8j4NQFizH8hK2w5fQ8wz1 ci@test"
          app_name = "abe-stack-test"
          app_port = 3000
          EOF

          # Add provider-specific test variables
          if [ "${{ matrix.provider }}" = "digitalocean" ]; then
            cat >> test.tfvars << EOF
            region = "${DO_REGION:-nyc1}"
            instance_size = "${DO_INSTANCE_SIZE:-s-1vcpu-1gb}"
            enable_managed_database = ${DO_MANAGED_DB}
            database_size = "${DO_DATABASE_SIZE:-db-s-1vcpu-1gb}"
            EOF
          elif [ "${{ matrix.provider }}" = "gcp" ]; then
            cat >> test.tfvars << EOF
            project_id = "test-project-123456"
            region = "us-central1"
            zone = "us-central1-a"
            instance_size = "e2-small"
            enable_managed_database = false
            EOF
          fi

          # Test terraform plan with test variables
          if terraform plan -no-color -var-file=test.tfvars -out=tfplan-test > tfplan.log 2>&1; then
            echo "âœ… ${{ matrix.provider }} terraform plan succeeded"
            # Clean up test plan
            rm -f tfplan-test
          else
            echo "âŒ ${{ matrix.provider }} terraform plan failed"
            echo "------ terraform plan output ------"
            cat tfplan.log
            echo "-----------------------------------"
            echo "------ test.tfvars used ------"
            cat test.tfvars
            echo "------------------------------"
            exit 1
          fi

          # Clean up test files
          rm -f test.tfvars tfplan.log

      - name: Check for Required Documentation
        run: |
          cd infra
          echo "ðŸ“š Checking documentation completeness..."

          # Check for README
          if [ -f "README.md" ]; then
            echo "âœ… Infrastructure README exists"
          else
            echo "âŒ Infrastructure README.md is missing"
            exit 1
          fi

          # Check for example configuration
          if [ -f "cloud/terraform.tfvars.example" ]; then
            echo "âœ… Terraform example configuration exists"
          else
            echo "âŒ cloud/terraform.tfvars.example is missing"
            exit 1
          fi

      - name: Validate Terraform Module Structure
        run: |
          echo "ðŸ—ï¸ Validating module structure..."

          for provider in digitalocean gcp; do
            if [ -d "infra/cloud/$provider" ]; then
              echo "Checking $provider module..."

              # Check for required files
              required_files=("main.tf" "variables.tf" "outputs.tf")
              for file in "${required_files[@]}"; do
                if [ -f "infra/cloud/$provider/$file" ]; then
                  echo "âœ… $provider/$file exists"
                else
                  echo "âŒ $provider/$file is missing"
                  exit 1
                fi
              done
            fi
          done

      - name: Infrastructure Test Summary
        if: success()
        run: |
          echo "## âœ… Infrastructure Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tests completed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform formatting check" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform validation" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration scripts test" >> $GITHUB_STEP_SUMMARY
          echo "- Provider-specific configuration tests" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation completeness check" >> $GITHUB_STEP_SUMMARY
          echo "- Module structure validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ All infrastructure tests passed! Ready for deployment." >> $GITHUB_STEP_SUMMARY

      - name: Infrastructure Test Summary (Failed)
        if: failure()
        run: |
          echo "## âŒ Infrastructure Tests Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed tests above and fix any issues before deploying infrastructure." >> $GITHUB_STEP_SUMMARY
