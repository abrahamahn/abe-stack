name: Auto-Merge Claude Sessions

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for all branches
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current branch name
        id: branch
        run: |
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "current=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
          echo "Current Claude branch: $CURRENT_BRANCH"

      - name: Create dev branch if it doesn't exist
        run: |
          git fetch origin
          if ! git show-ref --verify --quiet refs/remotes/origin/dev; then
            echo "Creating new dev branch from main..."
            git checkout -b dev origin/main
            git push -u origin dev
          else
            echo "Dev branch already exists"
          fi

      - name: Checkout dev branch
        run: |
          git fetch origin dev
          git checkout dev
          git pull origin dev

      - name: Merge Claude session into dev
        id: merge
        run: |
          echo "Merging ${{ steps.branch.outputs.current }} into dev..."

          # Attempt merge
          if git merge --no-ff ${{ steps.branch.outputs.current }} -m "chore: auto-merge Claude session ${{ steps.branch.outputs.current }}"; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ Merge successful"
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            echo "❌ Merge conflict detected"
            git merge --abort
            exit 1
          fi

      - name: Push dev to remote
        if: steps.merge.outputs.status == 'success'
        run: |
          echo "Pushing dev branch to remote..."
          git push origin dev
          echo "✅ Dev branch updated (GROUND TRUTH)"

      - name: Summary
        if: steps.merge.outputs.status == 'success'
        run: |
          echo "════════════════════════════════════════════════════════"
          echo "✅ Claude Session Auto-Merge Complete"
          echo "════════════════════════════════════════════════════════"
          echo ""
          echo "Branch State:"
          echo "  • Session:      ${{ steps.branch.outputs.current }} (active, kept alive)"
          echo "  • Ground Truth: dev (updated and pushed)"
          echo ""
          echo "This allows multiple pushes to the same Claude session branch."
          echo "The session branch will be cleaned up when the session ends."
          echo ""
          echo "Next Steps:"
          echo "  → Pull latest: git checkout dev && git pull origin dev"
          echo ""
          echo "════════════════════════════════════════════════════════"

      - name: Handle Merge Conflict
        if: steps.merge.outputs.status == 'conflict'
        run: |
          echo "════════════════════════════════════════════════════════"
          echo "⚠️  Merge Conflict Detected"
          echo "════════════════════════════════════════════════════════"
          echo ""
          echo "Manual resolution required:"
          echo ""
          echo "  git checkout dev"
          echo "  git merge origin/${{ steps.branch.outputs.current }}"
          echo "  # Resolve conflicts"
          echo "  git add ."
          echo "  git commit -m 'chore: merge Claude session with conflict resolution'"
          echo "  git push origin dev"
          echo ""
          echo "The Claude session branch remains active for continued work."
          echo ""
          echo "════════════════════════════════════════════════════════"
          exit 1
