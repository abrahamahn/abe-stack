# Week 6: February 2–6, 2026

> **Summary**: Deep audit and gap-fix of all `packages/shared` unit tests. `packages/db` functional repository refactor — created 11 missing functional-style repositories, rewired factory imports, fixed foundation types, and added 213 new tests across 12 test files. Completed all 7 remaining DB schema files (tenant, sessions, notifications, system, features, metering, compliance) with 554 tests. Fixed `packages/db` ESLint/tsconfig registration. Major codebase consolidation: restored 155 files to `packages/db` and `packages/shared` from git history, deduplicated, updated all barrel exports, and fixed 210 broken cross-package imports (`@abe-stack/core` -> `@abe-stack/shared`, `@abe-stack/infra` -> `@abe-stack/db`).

---

## Table of Contents

- [Tuesday (02-03)](#tuesday-february-3-2026) — Shared package test audit, packages/db functional repo refactor, DB schema completion, ESLint config fix, codebase consolidation

---

## Tuesday, February 3, 2026

### Deep Audit of `packages/shared` Unit Tests

**Objective**: Audit all 31 test files in `packages/shared/src/` for meaningfulness and coverage completeness, then fix all identified gaps.

#### Audit Findings

Reviewed every test file against its source file. 26 of 31 test files had complete, meaningful coverage. 5 files had gaps:

| Severity | File | Gap |
|----------|------|-----|
| **SEVERE** | `billing.logic.test.ts` | Only 1 of 14+ exported functions tested |
| **MODERATE** | `errors.test.ts` | 11 specialized error subclasses untested |
| **MODERATE** | `storage.test.ts` | 3 of 4 exported functions untested |
| **MINOR** | `pagination.test.ts` | `PaginationError` class and schema factories untested |
| **MINOR** | `schemas.test.ts` | `passwordSchema` and `errorCodeSchema` untested |

#### Fixes Applied

**`billing.logic.test.ts`** — Added tests for 13 functions + `PLAN_FEES` constant:
- Entitlements: `getEntitlements`, `hasFeature` (key + name matching, case-insensitive)
- Limits: `isOverLimit` (boundary, unlimited, Infinity), `getLimitUsagePercentage` (rounding, cap at 100)
- Subscription status: `isSubscriptionActive`, `isSubscriptionPastDue`, `isSubscriptionInactive`, `hasActiveSubscription`
- Lifecycle: `getEffectivePlan`, `canCancelSubscription`, `canResumeSubscription`, `canChangePlan`
- Proration: `calculateProration` (upgrade, downgrade credit, same-price, edge cases)
- Removed deprecated `isLimitReached` test (lint-clean; delegates to already-tested `isOverLimit`)

**`errors.test.ts`** — Added tests for 11 error subclasses:
- Auth: `InvalidCredentialsError`, `WeakPasswordError`, `EmailAlreadyExistsError`, `EmailNotVerifiedError`, `UserNotFoundError`, `InvalidTokenError`, `TokenReuseError`
- OAuth: `OAuthError`, `OAuthStateMismatchError`
- 2FA: `TotpRequiredError`, `TotpInvalidError`
- Each test verifies message, code, statusCode, optional properties, and inheritance chain

**`storage.test.ts`** — Added tests for 3 functions:
- `joinStoragePath`: segment joining, normalization, traversal prevention, backslashes
- `generateUniqueFilename`: timestamp mode, secure ID mode, no extension, multiple dots, empty input
- `validateFileType`: extension matching, dot-prefixed types, MIME types, wildcard MIME, case-insensitivity

**`pagination.test.ts`** — Added tests for:
- `PaginationError`: constructor properties, details, instanceof, `isPaginationError()` static type guard
- `paginatedResultSchema`: valid data, invalid items, negative total, page < 1
- `cursorPaginatedResultSchema`: valid data, null nextCursor, limit < 1

**`schemas.test.ts`** — Added tests for:
- `errorCodeSchema`: accepts valid `ERROR_CODES` values, rejects invalid strings
- `passwordSchema`: accepts strong passwords, rejects short/weak/non-string values

#### Verification

- **Tests**: 31/31 files, 716/716 tests pass
- **Lint**: 0 errors across all 5 changed files
- **Type-check**: `@abe-stack/shared` clean

---

### packages/db: Functional Repository Refactor (Phases 1–5)

**Objective**: Resolve the broken `factory.ts` → `../migrations/index` import chain by creating all 11 missing functional-style repositories that the 17-key flat `Repositories` interface expects.

#### Context

The `packages/db/src/factory.ts` file defines a 17-key `Repositories` interface consumed by 80+ files across the monorepo via `@abe-stack/db`. However, 11 of the 17 repository factories did not exist — only the 6 billing repositories were implemented. All imports were routed through a broken `../migrations/index` barrel.

#### Phase 1: Fix Foundations

- **`src/client.ts`**: Replaced `any` with `unknown` in `QueryResult.values`, `RawDb.query<T>`, `queryOne<T>`, and `raw`. Made `QueryResult` fields `readonly`.
- **`src/utils.ts`**: Reimplemented `toCamelCase<T>` and `toSnakeCase` locally to avoid generic overload shadowing from `@abe-stack/shared`.
- **`src/validation.ts`**: Added 6 billing tables to `REQUIRED_TABLES`.
- **Schema files**: Updated headers from `// infra/src/db/...` to `// packages/db/src/...`.

#### Phase 2: Create 11 Functional Repositories

Each repository follows the established billing pattern: interface → `toCamelCase`/`toSnakeCase` transform → `createXxxRepository(db: RawDb)` factory.

| Directory | Repository | Key Methods |
|-----------|-----------|-------------|
| `users/` | `UserRepository` | `findByEmail`, `findById`, `update`, `create` |
| `auth/` | `RefreshTokenRepository` | `deleteByToken`, `create`, `findByFamilyId`, `deleteByUserId`, `deleteByFamilyId`, `deleteExpired` |
| `auth/` | `RefreshTokenFamilyRepository` | `findActiveByUserId`, `findById`, `create`, `revoke` |
| `auth/` | `LoginAttemptRepository` | `create`, `findRecentByEmail`, `countRecentByIp` |
| `auth/` | `PasswordResetTokenRepository` | `findValidByTokenHash`, `create`, `markAsUsed`, `deleteExpiredByUserId` |
| `auth/` | `EmailVerificationTokenRepository` | `findValidByTokenHash`, `create`, `markAsUsed` |
| `auth/` | `SecurityEventRepository` | `create`, `findByUserId`, `findRecent` |
| `magic-link/` | `MagicLinkTokenRepository` | `countRecentByEmail`, `countRecentByIp`, `create`, `deleteExpired`, `findValidByTokenHash` |
| `oauth/` | `OAuthConnectionRepository` | `findByProviderUserId`, `findByUserIdAndProvider`, `findByUserId`, `create`, `update`, `deleteByUserIdAndProvider` |
| `push/` | `PushSubscriptionRepository` | `create`, `findByUserId`, `findByEndpoint`, `deleteByEndpoint` |
| `push/` | `NotificationPreferenceRepository` | `findByUserId`, `upsert` |

Created 5 barrel `index.ts` files: `users/`, `auth/`, `magic-link/`, `oauth/`, `push/`.

#### Phase 3: Rewire Factory & Barrels

- **`src/factory.ts`**: Replaced all imports from `../migrations/index` with direct imports from subdirectories.
- **`src/repositories/index.ts`**: Added re-exports for all 11 new functional repo factories and interfaces.
- **`src/index.ts`**: Replaced `export *` with explicit named exports.
- **`migrations/index.ts`**: Replaced `export *` with explicit named exports for backward compatibility.
- **Legacy repos**: Renamed with `-legacy` suffix to avoid naming conflicts.

#### Phase 5: Tests (213 Tests, All Passing)

| Test File | Tests |
|-----------|-------|
| `factory.test.ts` | 10 |
| `users/users.test.ts` | 55 |
| `auth/refresh-tokens.test.ts` | 11 |
| `auth/refresh-token-families.test.ts` | 9 |
| `auth/login-attempts.test.ts` | 9 |
| `auth/password-reset-tokens.test.ts` | 11 |
| `auth/email-verification-tokens.test.ts` | 8 |
| `auth/security-events.test.ts` | 10 |
| `magic-link/magic-link-tokens.test.ts` | 20 |
| `oauth/oauth-connections.test.ts` | 25 |
| `push/push-subscriptions.test.ts` | 22 |
| `push/notification-preferences.test.ts` | 23 |
| **Total** | **213** |

#### Architectural Decisions

- **Functional pattern over class-based**: Matches existing billing repos. Factory functions avoid `this`-binding issues and are easier to test/compose.
- **Consumer API preserved exactly**: The 17-key flat `Repositories` interface is unchanged — zero breaking changes.
- **Legacy code retained**: Old class-based repos renamed to `*-legacy.ts` rather than deleted.
- **Column mappings**: Each repo uses explicit `COLUMNS` maps from schema for `toCamelCase`/`toSnakeCase`.

#### Remaining Work (Phase 4)

Legacy module files with broken imports are documented but not fixed:
- `src/config/database.ts`, `src/config/search.ts` — broken `@abe-stack/shared/config` imports
- `src/write/write-service.ts`, `src/write/postgres-store.ts` — broken `@abe-stack/infra` imports
- `src/pubsub/postgres-pubsub.ts` — missing `./types` module
- All `*-legacy.ts` type errors (stale schema type references)

These will be addressed when the corresponding `packages/shared` code restoration (TODO items P0–P2) is completed.

#### Verification

- **New repo tests**: 12 files, 213/213 passed, 0 failures
- **Type-check (new files)**: 0 errors. All type errors are in pre-existing legacy/broken modules.

---

### Comprehensive Unit Tests for Sessions Schema

**Objective**: Create comprehensive unit tests for `packages/db/src/schema/sessions.ts` following the established testing pattern from `users.test.ts`.

#### Test Coverage (46 Tests, All Passing)

Created `packages/db/src/schema/sessions.test.ts` with complete test coverage:

**Schema Constants (7 tests)**:
- Table name verification (`USER_SESSIONS_TABLE = 'user_sessions'`)
- Column mapping validation (`USER_SESSION_COLUMNS`)
- CamelCase to snake_case transformations
- Const object immutability checks
- String type validation
- Unique column name verification

**Type Structure (19 tests)**:
- `UserSession` interface: valid objects, nullable fields, Date types, active/revoked states
- `NewUserSession` interface: minimal required fields, optional fields, null handling, auto-generated field omission
- `UpdateUserSession` interface: activity updates, revocation, partial updates, empty updates

**Type Compatibility (2 tests)**:
- Type conversions between `NewUserSession` → `UserSession`
- Partial updates from `UserSession` → `UpdateUserSession`

**Edge Cases (15 tests)**:
- Boundary values: far-future dates, past dates, same timestamps
- String boundaries: empty strings, long strings (10k chars), special characters, Unicode
- IP addresses: IPv4 (0.0.0.0, 127.0.0.1, 192.168.1.1, 255.255.255.255), IPv6 (::1, 2001:db8::, fe80::1)
- User agent formats: Windows, macOS, Linux, iPhone, Postman
- Device ID formats: UUID, Android, iOS, web, desktop
- Session lifecycle: creation, activity updates, revocation, immediate revocation

**Column Mapping Consistency (3 tests)**:
- Field mapping completeness
- No extra fields
- SQL column name accuracy

#### Architectural Decisions

- **Pattern matching**: Exactly follows `users.test.ts` structure for consistency
- **Test organization**: Grouped by category (Constants, Type Structure, Compatibility, Edge Cases, Mapping)
- **Real-world scenarios**: Tests include actual IP addresses, user agents, device IDs
- **Session lifecycle**: Covers active sessions, revoked sessions, immediate revocation patterns
- **Comprehensive edge cases**: IP address formats (v4/v6), Unicode, special chars, long strings

#### Verification

- **Tests**: 46/46 passed
- **Coverage**: All exports tested (`USER_SESSIONS_TABLE`, `UserSession`, `NewUserSession`, `UpdateUserSession`, `USER_SESSION_COLUMNS`)
- **Lint**: 0 errors
- **Format**: Prettier validated (unchanged)
---

### Comprehensive Unit Tests for Tenant Schema

**Objective**: Create comprehensive unit tests for `packages/db/src/schema/tenant.ts` following the established testing pattern from `users.test.ts` and `auth.test.ts`.

#### Test Coverage (109 Tests, All Passing)

Created `packages/db/src/schema/tenant.test.ts` with complete test coverage for multi-tenant architecture:

**Schema Constants (15 tests)**:
- Table name verification (`TENANTS_TABLE`, `MEMBERSHIPS_TABLE`, `INVITATIONS_TABLE`)
- Column mapping validation for all three tables
- CamelCase to snake_case transformations
- Unique table names and snake_case format validation
- String type validation and unique column names
- Const object immutability checks

**Enum/Type Validation (8 tests)**:
- `TenantRole` type: 'owner', 'admin', 'member', 'viewer'
- `InvitationStatus` type: 'pending', 'accepted', 'revoked', 'expired'
- `TENANT_ROLES` constant: array validation, length check, type matching
- `INVITATION_STATUSES` constant: array validation, length check, type matching

**Type Structure (47 tests)**:
- `Tenant` interface: valid objects, nullable fields (logoUrl), Date types, metadata Record<string, unknown>
- `NewTenant` interface: minimal required fields (name, slug, ownerId), optional fields, auto-generated field omission
- `UpdateTenant` interface: partial updates, nullable fields, immutable field exclusion (id, ownerId, createdAt)
- `Membership` interface: valid objects, all TenantRole values, Date types
- `NewMembership` interface: minimal required fields (tenantId, userId), optional role
- `UpdateMembership` interface: role updates, immutable field exclusion (id, tenantId, userId)
- `Invitation` interface: valid objects, all TenantRole/InvitationStatus values, nullable acceptedAt
- `NewInvitation` interface: minimal required fields (tenantId, email, invitedById, expiresAt)
- `UpdateInvitation` interface: status and acceptedAt updates, immutable field exclusion

**Type Consistency (4 tests)**:
- Column constants coverage of interface properties
- Date field naming consistency (_at suffix)
- All tables have id and createdAt fields
- New* type compatibility with base types

**Column Mapping Consistency (6 tests)**:
- Field mapping completeness for all three tables
- No extra fields validation
- SQL column name accuracy

**Edge Cases (23 tests)**:
- Boundary values: empty strings, long strings (10k chars), special characters, Unicode (株式会社)
- Far-future/past dates
- Role/status transitions across all valid values
- Metadata: empty objects, complex nested structures, mixed types
- Email formats: standard, plus-addressing, subdomains, underscores

**Integration Scenarios (6 tests)**:
- Tenant creation workflow: NewTenant → Tenant
- Membership creation workflow: NewMembership → Membership
- Invitation lifecycle: pending → accepted (with acceptedAt update)
- Role change workflow: viewer → admin
- Tenant deactivation workflow: isActive flag toggle
- Invitation revocation workflow: pending → revoked

#### Architectural Coverage

**Tenants Table**:
- Workspace/organization representation with TEXT slug for vanity URLs
- Owner relationship via `ownerId` (immutable after creation)
- Active/inactive state toggle via `isActive`
- Flexible metadata JSONB field for custom properties

**Memberships Table**:
- Many-to-many relationship between tenants and users
- UNIQUE constraint on (tenantId, userId) enforced at schema level
- Role hierarchy: owner > admin > member > viewer
- Only `role` and `updatedAt` can be changed (relationship fields immutable)

**Invitations Table**:
- Email-based invitation system with expiration
- UNIQUE constraint on (tenantId, email) for pending invites
- Status lifecycle: pending → accepted/revoked/expired
- `acceptedAt` timestamp captures acceptance moment
- `invitedById` tracks who initiated invitation

#### Quality Checks

- **Tests**: 109/109 passed (vitest)
- **Lint**: 0 errors (ESLint)
- **Type Safety**: No type errors in test file
- **Pattern Consistency**: Matches `users.test.ts` and `auth.test.ts` structure exactly

---

### Complete DB Schema Files (All 34 Tables)

**Objective**: Create TypeScript schema files for the remaining 7 domain modules, completing the `packages/db/src/schema/` layer with explicit interfaces, column mappings, and constants for all 34 database tables.

#### Files Created

| File | Tables | Interfaces | Tests |
|------|--------|-----------|-------|
| `notifications.ts` | `notifications` | Notification, NewNotification, UpdateNotification | 55 |
| `system.ts` | `jobs`, `audit_events`, `webhooks`, `webhook_deliveries` | 10 interfaces + 4 enum types | 119 |
| `features.ts` | `feature_flags`, `tenant_feature_overrides` | 6 interfaces + column maps | 80 |
| `metering.ts` | `usage_metrics`, `usage_snapshots` | 6 interfaces + AggregationType enum | 73 |
| `compliance.ts` | `legal_documents`, `user_agreements`, `consent_logs` | 7 interfaces + column maps | 72 |
| **Total** | **11 tables** | **29+ interfaces** | **399** |

Combined with sessions.ts (46 tests) and tenant.ts (109 tests) from earlier, the full schema layer now has **13 test files, 951 tests, 0 failures**.

#### Key Design Decisions

- **`NotificationLevel`** (`'info'|'success'|'warning'|'error'`) named to avoid collision with existing `NotificationType` in `push.ts`
- **Append-only tables** (`audit_events`, `user_agreements`, `consent_logs`) have no `Update*` type
- **TEXT primary keys** for `feature_flags` and `usage_metrics` (not UUID)
- **`unknown` vs `unknown | null`**: Changed `defaultValue` and `value` in `features.ts` from `unknown | null` to `unknown` since `unknown` is the top type (ESLint `no-redundant-type-constituents`)
- **Barrel exports**: Updated `index.ts` with explicit named exports for all 7 new modules

#### Verification

- **Tests**: 13 files, 951/951 passed
- **ESLint**: 0 errors on all schema files + barrel
- **Type-check**: 0 errors in new files (pre-existing errors in legacy modules unchanged)

---

### Fix `packages/db` ESLint & TypeScript Registration

**Objective**: Resolve ESLint parsing errors where all `packages/db` files were unknown to the TypeScript parser and boundary checker.

#### Root Cause

`packages/db` was never registered in:
1. Root `tsconfig.json` project references
2. ESLint `parserOptions.project` overrides
3. ESLint `boundaries/elements` element types

This affected ALL files in `packages/db`, not just new ones.

#### Changes

| File | Change |
|------|--------|
| `packages/db/tsconfig.lint.json` | **NEW** — Extends `tsconfig.json`, includes test files, no emit |
| `tsconfig.json` | Added `packages/db` to project references |
| `eslint.config.ts` | Added `packages/db/tsconfig.json` to import resolver |
| `eslint.config.ts` | Added `packages/db` override with `tsconfig.lint.json` for parser |
| `eslint.config.ts` | Added `db` boundary element type |
| `eslint.config.ts` | Updated boundary rules: `app`, `module`, `backend-core` can import `db`; `db` can import `shared` |

#### Architectural Decision

The `db` package sits at the infrastructure layer:
- **Can import from**: `shared` (core types)
- **Can be imported by**: `app`, `module`, `backend-core`
- **Cannot import from**: `client`, `premium`, `app`

This matches the hexagonal architecture where `db` is a low-level infrastructure adapter.

#### Verification

- **ESLint**: 0 errors on all `packages/db/src/schema/` files (was 7 parsing errors before)
- **Boundary rules**: `db` properly classified, no unknown-file errors

---

### Housekeeping: W05 Log Cleanup

Removed 370 lines of misplaced Feb 3 entries that background test-writer agents incorrectly appended to `2026-W05.md` (which covers Jan 26–31). The consolidated entries for those tests already exist in this W06 log under the "Complete DB Schema Files" section.

---

### Tuesday Summary (Earlier Session)

| Category | Count |
|----------|-------|
| Schema files created | 7 (tenant, sessions, notifications, system, features, metering, compliance) |
| Schema test files created | 7 (matching) |
| Functional repositories created | 11 |
| Repository test files created | 12 |
| Shared package test files fixed | 5 |
| Config files created/updated | 4 (tsconfig.lint.json, tsconfig.json, eslint.config.ts x2) |
| **New tests written** | **951 schema + 213 repo + ~80 shared = ~1,244** |
| **Total tests passing** | **951 schema, 213 repo, 716 shared** |
| Tables with complete schema coverage | **34 / 34** |
| ESLint errors (new files) | **0** |
| Type errors (new files) | **0** |

---

### Codebase Consolidation: DB + Shared Package Restoration & Import Repair

**Objective**: During prior refactoring, code was scattered and deleted across `core/`, `infra/`, `kernel/`, and `tools/`. This session restored all missing code to its correct package, deduplicated overlaps, updated barrel exports, and repaired all broken cross-package imports.

#### Phase 0: Audit & Restore `packages/db`

Identified and restored DB-related code from git history and other directories into `packages/db/src/`:

| Restored Directory | Files | Source |
|--------------------|-------|--------|
| `builder/` | 17 | `infra/db/src/builder/` (SQL query builder) |
| `config/` | 5 | `infra/db/src/config/` (DB config) |
| `search/` extras | 5 | `infra/db/src/search/` (elasticsearch, sql-provider) |
| `testing/` | 4 | `infra/db/src/testing/` (json-db, mocks) |
| `scripts/` | 8 | `tools/scripts/db/` (db-push, seed, bootstrap-admin, migrate) |
| `repositories/billing/` | 12 | `infra/db/src/repositories/billing/` |
| `pubsub/` | 2 | `core/src/infrastructure/pubsub/` (postgres-pubsub) |
| `write/` | 6 | `packages/backend-core/src/queue/` + `infra/jobs/src/queue/` |
| `benchmark/` | 1 | Commit `c324ce3d` (deleted separately) |
| `builder/types.test.ts` | 1 | Commit `7c345cb5` (deleted separately) |
| `vitest.config.ts` | 1 | Commit `69f6fdc3~1` (deleted separately) |

**packages/db grew from ~40 to 103 source files.**

#### Phase 1: Audit & Restore `packages/shared`

Identified 155 missing files from 3 deleted source directories and restored into `packages/shared/src/`:

| Restored Directory | Files | Source |
|--------------------|-------|--------|
| `contracts/` | 38 | `infra/contracts/src/` + `kernel/src/contracts/` |
| `config/` | 17 | `packages/backend-core/src/config/` (live copies) |
| `utils/search/` | 10 | `core/src/infrastructure/search/` |
| `utils/logger/` | 10 | `core/src/infrastructure/logger/` |
| `utils/monitor/` | 4 | `core/src/infrastructure/monitor/` |
| `utils/pubsub/` | 6 | `core/src/infrastructure/pubsub/` (non-DB parts) |
| `utils/constants/` | 5 | `core/src/shared/constants/` |
| `utils/pagination/` | 7 | `core/src/shared/pagination/` (cursor-based) |
| `utils/cache/` extras | 3 | `core/src/infrastructure/cache/` (errors, types) |
| `utils/` individual | 13 | token, jwt, port, http-types, etc. |
| `core/errors/` | 11 | `core/src/infrastructure/errors/` |
| `core/` | 1 | module-registration |
| `domain/auth/` | 10 | auth errors, http-mapper, password logic |
| `domain/billing/` | 2 | billing errors |
| `domain/notifications/` | 5 | notification errors, types, push-schemas |
| `__tests__/` | 7 | Integration tests |

**packages/shared grew from 93 to 248 files.**

#### Phase 2: Deduplication

Removed 17 duplicate files and resolved conflicts:

| Duplicate | Resolution |
|-----------|------------|
| `core/errors/` directory (11 files) | Subset of consolidated `core/errors.ts`. Moved unique `response.ts` to `core/response.ts`, deleted directory. |
| `utils/shared-async.ts` | Identical to `utils/async/delay.ts`. Deleted. |
| `utils/misc.ts` | `randomId()` covered by `utils/crypto.ts` `generateUUID()`. Deleted. |
| `utils/pagination/error.ts` | Duplicate of `PaginationError` in `utils/pagination.ts`. Deleted. |
| `utils/cookie.ts` | Subset of `utils/http.ts` `parseCookies`. Deleted. |
| `contracts/index.ts` | Removed dead `export * from './notifications'` line. |

**packages/shared settled at 231 files after dedup.**

#### Phase 3: Barrel Export Updates

Updated 7 barrel `index.ts` files to export all restored code:

- **`utils/index.ts`**: Added Search, Logger, Monitor, PubSub, TimeConstants namespaces + token, jwt, port, http-types, PaginationError exports
- **`core/index.ts`**: Added all 22 error class exports (was 10), response types, module-registration types, HTTP_STATUS, utility functions (isAppError, toAppError, etc.)
- **`domain/auth/index.ts`**: Added auth.errors (13 classes), auth.http-mapper exports
- **`domain/billing/index.ts`**: Added billing.errors (25 classes + type guards)
- **`domain/notifications/index.ts`**: Added notification errors (14 classes), types (22 exports), push-schemas
- **`utils/cache/index.ts`**: Added cache errors + types
- **`index.ts` (root)**: Added Contracts and Config namespace exports

#### Phase 4: Fix Broken Cross-Package Imports

| Old Package | New Package | Files Fixed |
|-------------|-------------|-------------|
| `@abe-stack/core/config` | `@abe-stack/shared/config` | 32 |
| `@abe-stack/core` (bare) | `@abe-stack/shared` | 12 |
| `@abe-stack/infra` | `@abe-stack/db` | 161 |
| **Total** | | **205 files** |

Zero broken references remain for `@abe-stack/core`, `@abe-stack/infra`, or `@abe-stack/kernel` in source code or `package.json` files.

#### Phase 5: Package.json Exports

Updated `packages/shared/package.json`:
- Added `"./contracts"` and `"./config"` export paths
- Removed stale `"./schemas"` and `"./infra"` entries

#### Architectural Decisions

- **Restore-then-dedup**: Restored all files first, then systematically compared and removed duplicates. This ensures nothing is lost.
- **Namespace exports for large modules**: `Contracts`, `Config`, `Search`, `Logger`, `Monitor`, `PubSub`, `TimeConstants` are exported as namespaces to avoid naming collisions in the flat re-export.
- **`@abe-stack/infra` -> `@abe-stack/db`**: The old mega-package's DB exports now route to `@abe-stack/db`. HTTP/routing types (`RouteMap`, `registerRouteMap`) also point to `@abe-stack/db` for now but actually live in `apps/server/src/http/router/` -- relocating to `@abe-stack/backend-core` is a follow-up.
- **Config duplication preserved**: `packages/backend-core/src/config/` still has copies alongside `packages/shared/src/config/`. Backend-core should re-export from shared in a future pass.

#### Known Follow-ups

1. Routing types (`createRouteMap`, `registerRouteMap`, `AuthGuardFactory`) need relocation from `apps/server` to `@abe-stack/backend-core`
2. Root barrel `index.ts` uses `export *` -- should convert to explicit named exports
3. `packages/backend-core/src/config/` should re-export from `@abe-stack/shared/config`
4. Restored files have old path comments (e.g., `// core/src/infrastructure/search/...`) -- headers need updating

#### Final State

| Package | Files | Directories |
|---------|-------|-------------|
| `packages/shared/src/` | 231 | 28 |
| `packages/db/src/` | 103 | ~15 |

---
