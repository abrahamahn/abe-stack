# Week 2: January 6-12, 2026

> **Summary**: Established server architecture patterns. Adopted ServerEnvironment context object pattern (inspired by chet-stack) for explicit dependencies and easier testing. Separated infrastructure (`infra/`) from business logic (`modules/`). Added custom error types, validation patterns, and comprehensive security hardening.

---

## Table of Contents

- [2026-01-12: Architecture Refinement](#2026-01-12)
- [2026-01-10: Security Hardening & Documentation](#2026-01-10)

---

## 2026-01-12

### Hybrid Infra/Modules Architecture

Adopted a hybrid architecture separating infrastructure from business modules:

**Infrastructure Layer (`infra/`):**

- `ctx.ts` - ServerEnvironment type definition
- `factory.ts` - createEnvironment, createMockEnvironment factories
- `email/` - ConsoleEmailService, SmtpEmailService implementations
- `security/` - Login lockout, security events

**Modules Layer (`modules/`):**

- `auth/` - Authentication middleware, handlers, utilities (JWT, password, refresh-token)

**Pattern Change:**

- Routes now import handlers from `modules/auth`
- Backwards-compatible re-exports maintained in `lib/` and `services/`

### ServerEnvironment Context Object Pattern

Following the pattern from chet-stack, implemented a single `ServerEnvironment` object that acts as an entry point for all server dependencies. This is the "Context Object" pattern, standard in GraphQL (Apollo) and Go backend services.

**New Files:**

- `apps/server/src/infra/ServerEnvironment.ts` - Type definition
- `apps/server/src/infra/index.ts` - Barrel exports

**Pattern Change:**

- Before: Services decorated on Fastify (`app.db`, `app.storage`)
- After: Single `ServerEnvironment` passed to handlers (`env.db`, `env.log`)

**Benefits:**

- Explicit dependencies (handler signature shows what it needs)
- Easy to test (pass mock env object)
- Framework agnostic (handlers don't depend on Fastify)
- Single source of truth for all services

**ServerEnvironment Type:**

```typescript
type ServerEnvironment = {
  config: ServerEnv;
  db: DbClient;
  storage: StorageProvider;
  email: EmailService;
  log: FastifyBaseLogger;
};
```

**Updated Files:**

- `apps/server/src/server.ts` - Creates environment, passes to routes
- `apps/server/src/modules/index.ts` - All handlers now receive `env: ServerEnvironment`
- `apps/server/src/infra/email.ts` - Exported `ConsoleEmailService` and `SmtpEmailService` classes
- `apps/server/src/types/fastify.d.ts` - Removed storage decoration (kept db for health check)
- Test files updated with mock ServerEnvironment

### Custom HTTP Error Types

Added type-safe custom error classes with HTTP status codes to `shared/core`:

**New File:** `shared/core/src/errors.ts`

**Error Classes:**
| Class | Status | Purpose |
|-------|--------|---------|
| `HttpError` | - | Abstract base class |
| `ValidationError` | 400 | Invalid input |
| `UnauthorizedError` | 401 | Missing/invalid auth |
| `PermissionError` | 403 | Lacks permission |
| `NotFoundError` | 404 | Resource not found |
| `ConflictError` | 409 | Transaction conflict |
| `UnprocessableError` | 422 | Semantic validation error |
| `BrokenError` | 424 | Server-side invariant broken |
| `RateLimitError` | 429 | Rate limited |

**Utilities:**

- `isHttpError()` - Type guard
- `getSafeErrorMessage()` - Safe message for API responses
- `getErrorStatusCode()` - Get status code from error

### Configuration Fix

- Renamed `.npmrc` to `.pnpmrc` to fix npm warning about unknown `store-dir` config

---

## 2026-01-10

### Phase 2 Security Hardening

**Database Transaction Support:**

- Created transaction wrapper utilities with `withTransaction()` helper
- Applied atomic transactions to registration, login, and token rotation
- Prevents orphaned database records during auth operations

**Token Reuse Security Event Logging:**

- Added `security_events` table with comprehensive indexing
- Created security event logging infrastructure with severity levels
- Logs token reuse attempts, family revocations, account lockouts, admin unlocks
- Added metrics and user activity query functions

**IP Extraction Proxy Validation:**

- Enhanced IP extraction with proxy validation
- Only trusts x-forwarded-for when `TRUST_PROXY=true`
- Validates immediate proxy against `TRUSTED_PROXIES` list
- Limits proxy chain depth to prevent spoofing
- Supports CIDR notation for trusted proxy ranges

**Admin Unlock Endpoint:**

- Added `POST /api/admin/auth/unlock` endpoint
- Requires admin role with JWT authentication
- Logs unlock events with admin user ID for audit trail

**Error Message Audit:**

- Centralized all error messages in constants
- Removed inline error strings from route handlers
- Prepared for future internationalization (i18n)

### Documentation Reorganization

- Reorganized documentation into hierarchical structure under `apps/docs/`
- Created consolidated README.md, CHANGELOG.md, and ROADMAP.md
- Organized architecture docs under `apps/docs/architecture/`
- Moved realtime docs to `apps/docs/architecture/realtime/`
- Security docs now under `apps/docs/todo/security/`
- Development guides under `apps/docs/dev/`

### Technical Fixes

- Fixed TypeScript strict mode errors in test files
- Added proper null checks to array access in tests
- Installed `@types/nodemailer` for email service
